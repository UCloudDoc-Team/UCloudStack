# 5 物理资源管理

平台为管理员提供全平台所有物理资源的生命周期管理和运维能力，使平台管理员可通过控制台统一管控运行云平台的整体物理资源，包括物理机资源（宿主机）、物理机纳管、镜像资源及外网网段资源。

## 5.1 物理机管理

物理机管理是指对地域内的所有计算节点的管理，包括查看物理机、锁定、解锁、进入维护模式、退出维护模式等，同时可查看每个计算节点中已存在的计算实例。

### 5.1.1 查看物理机列表

管理员可在计算资源/物理机页面查看地域下所有物理机节点列表及相关信息，包括物理机 ID、物理机 IP、计算集群 ID、CPU 类型、总核数、已分配核数、总内存、已分配内存、状态、更新时间及操作项，如下图所示：

![computenode](../images/adminguide/computenode.png)

- 物理机 ID：计算节点在平台的唯一标识符。
- 物理机 IP：计算节点的 IP 地址。
- 计算集群 ID：计算节点所属计算集群的 ID。
- CPU 类型：计算节点的 CPU 类型，如 Intel、AMD 等。
- 总核数：计算节点的总 vCPU 核数。
- 已分配核数：计算节点中已分配的核数。
- 总内存：计算节点的总内存容量，如 256GB。
- 已分配内存：计算节点中已分配的内存容量。
- 更新时间：计算节点的更新时间。
- 状态：计算节点的运行状态，包括可用、已锁定、进入维护模式中、维护模式。
  - 可用：代表计算节点可提供计算服务，计算实例会被调度并部署至物理机。
  - 已锁定：代表计算节点已被锁定，新建计算实例不会被调度至计算节点，不影响节点内已有计算实例。
  - 进入维护模式中：代表计算节点正在进入维护模式中，即物理机上的虚拟资源将被自动迁移到同计算集群的其他节点，使计算节点进入维护模式。
  - 维护模式：代表计算节点上的所有计算实例已被迁移至同集群其它节点并已正常进入维护模式，可对节点进行维护，如扩展内存、升级、修复硬件等。

管理员可在列表上对每台计算节点进行锁定、解锁、进入维护模式、退出维护模式等操作，以方便对计算节点进行维护；同时支持对物理机节点进行搜索，支持模糊搜索。

### 5.1.2 查看物理机详情

管理员可在物理机列表中，通过目标物理机器名称或者右侧的“详情”按钮进入物理机器详情页面，查看物理机的基本信息及监控信息，同时可查询计算节点已运行的计算实例，如下图所示：

![computenodeinfo](../images/adminguide/computenodeinfo.png)

**（1）基本信息**

包括物理机 ID、物理机 IP 地址、集群 ID、CPU 类型、状态、总核数、已分配核数、总内存、已分配内存及更新时间。

**（2）监控信息**

支持查看物理机器的监控信息，包括：网卡入带宽、网卡出带宽、硬盘读吞吐、硬盘写吞吐、平均负载、内存使用率、空间使用率、硬盘读此书、网卡入包量、硬盘写次数、网卡出包量、CPU 使用率、TCP 连接数、阻塞进程数。

**（3）计算实例**

支持管理员通过物理机详情页面，查看物理机中的计算实例列表及信息，包括名称、计算实例 ID、资源 ID、所属租户、物理机 IP、镜像 ID、GPU、CPU、内存、状态、创建时间及更新时间，并支持对计算实例进行搜索，支持模糊搜索，如下图所示：

![nodeinstance](../images/adminguide/nodeinstance.png)

计算实例包括虚拟机的实例，同时也包括平台网关及 PaaS 产品的实例，可通过实例名称及资源 ID 进行区分。

### 5.1.3 锁定物理机

物理机被锁定后，新建计算实例不会被调度至计算节点，不影响节点内已有计算实例，可配合物理机进入维护模式功能，以实现物理机维护、升级等操作。

![lock](../images/adminguide/lock.png)

仅支持物理机在【可用】状态下进行锁定操作，锁定物理机后，物理机的状态即流转为【已锁定】，在已锁定状态下新的虚拟机实例不会被创建至节点，同时可在已锁定状态下使计算节点进入维护模式。

> 锁定物理机为敏感操作，可能导致租户创建资源失败，操作前需确认平台有足够的资源。

### 5.1.4 解锁物理机

管理员将锁定的物理机进行解锁，可对外提供计算服务，计算实例可被调度并部署至物理机。

![unlock](../images/adminguide/unlock.png)

仅支持物理机在【已锁定】状态下进行解锁操作，解锁后物理机的状态即流转为【可用】，在可用状态下计算实例会被调度并创建至节点。

### 5.1.5 进入维护模式

当需要维护物理机时，比如扩展内存、升级、修复硬件等维护场景下，平台支持将物理机进入维护模式，使物理机上的虚拟资源自动迁移至同计算集群中其他物理节点上，使节点处于空闲状态，确保对物理节点维护时不影响平台的虚拟资源运行，保证业务的可用性。

物理机进入维护模式前必须保证节点状态为已锁定，即需要将物理机进行锁定，才可进行【进入维护模式】的操作，如下图所示：

![maintenance](../images/adminguide/maintenance.png)

管理员将物理机锁定并进入维护模式前，需请执行以下检查：

* 物理机上是否有不可迁移的资源，如 GPU 虚拟机或处于中间状态的虚拟机。
* 若存在不可迁移的资源，物理机器可进入进入维护模式，但中间状态的虚拟机和GPU虚拟机无法被迁移成功。
* 集群内空闲资源是否足够迁移当前物理机的所有计算实例。

确保物理机可进入维护模式时，可通过物理机列表操作项进行操作，具体步骤如下：

1. 选择目标物理机器，点击右侧“锁定”按钮，使物理机进入已锁定状态；

2. 点击“进入维护模式”按钮，将物理机器进入到维护模式，物理机将自动流转为“进入维护模式中”状态，如下图所示：

   ![inmaintain](../images/adminguide/inmaintain.png)

3. 系统会自动执行在线迁移功能，将此物理机器上的资源随机迁移至本计算集群中其他合适的物理机节点，关机状态的计算实例在下次启动后会自动调度至其它物理机。

4. 待所有虚拟计算实例被迁移至其它节点后，物理机节点将自动进入【维护模式】状态。

> 如果物理机器上有无法被成功迁移的资源，进入维护模式将被中断，物理机器将停留在锁定状态。您可以继续执行物理机进入维护模式操作，再次尝试迁移未被成功迁移的资源。

### 5.1.6 退出维护模式

退出维护模式是指将物理机重新加入至调度系统，为平台提供计算能力。仅支持状态为【维护模式】的物理机退出维护模式，退出维护模式，物理机将会自动恢复并进入至锁定状态，需进行解锁才可加入智能调度系统以提供计算能力。

平台管理员可通过物理机节点列表操作项中的【退出维护模式】按钮进行操作，如下图所示：

![outmaintain](../images/adminguide/outmaintain.png)

退出维护模式后，物理机节点的状态会自动流转为【已锁定】状态，需通过解锁操作使物理机可正常提供服务。

## 5.2 物理机纳管

### 5.2.1 概述

物理机纳管是平台为用户应用提供专属物理服务器的服务，可保证核心数据库、关键应用系统、高性能计算业务及暂时无法云化业务的高性能和稳定性。

结合云平台对资源的弹性管理，可实现物理机的按需分配、灵活申请、自动安装操作系统，同时结合 IPMI 和 PXE 可支持物理机设备的批量部署，并通过自动化系统配置，实现远程批量启动和部署。支持自定义安装物理机设备的操作系统及网络自助配置，并提供物理服务器生命周期管理，包括服务器的启动、关机及释放等。

平台通过部署服务器提供 PXE 远程自助装机服务，引导相同网络中多台物理服务器由 PXE 网络启动，通过部署服务器下载并安装操作系统软件包为物理机安装操作系统，并根据操作系统配置的网络模板信息，配置服务器网络信息，将服务器与平台外网网络打通，结合平台统一管理服务，使用户通过平台即可自助申请并管理物理服务器。具体价值举例如下：

* 通过物理机纳管服务，平台租户可将虚拟机和物理机混合部署，构建异构基础设施的统一管理和灵活组网，物理机的网络可与平台虚拟机的外网网络互通，满足虚拟机业务与物理机互访等场景的诉求。
* 租户可根据需求自助申请平台管理者提供的物理机，并独享物理服务器的计算、网络及本地磁盘资源，可充分满足对高性能、稳定性、数据安全性的要求；结合物理服务器的独享网络，可满足对网络的低时延和高吞吐业务场景。

租户通过申请平台的物理机，可应用于核心数据库、大数据服务及关键应用等应用场景，如可将数据库集群 OracleRAC 部署于平台纳管的物理机，将业务应用部署于平台虚拟机，并使用虚拟机的外网 IP 与物理机直接通过物理设备进行互联，提升业务性能和稳定性的同时提升资源管理的便捷性。

### 5.2.2 使用流程

在使用物理机纳管服务前，必须提前准备好物理机设备，并根据需求将物理服务器的 IPMI 网络及业务网络与平台网络进行打通，在通过平台录入设备信息，将设备分配给租户，由租户自助申请后，自动安装操作系统并配置服务器网络。物理机纳管服务的使用流程分为【平台管理员流程】和【租户流程】两大部分，其中前 6 步为平台管理员进行操作，具体如下：

1. **硬件环境装备**

   准备好硬件环境，配置物理网络交换机及服务器 IPMI 网络，使平台物理网络与 IPMI 网络可互相通信。

2. **管理物理机资源池**

   由【平台管理员】创建并管理物理机资源池，用于定义一批物理机服务器操作系统使用的网段及 Vlan 信息，同时也用于定义网卡配置模板。

3. **管理网卡配置模板**

   由【平台管理员】创建并管理网卡配置模板，用于定义一批物理机服务器操作系统具体的网卡配置信息，如双网卡聚合及网卡使用的 Vlan 和 CIDR 网段，可在安装操作系统时根据模板自动配置网卡并配置 IP 等信息。

4. **为资源池添加物理机**

   由【平台管理员】为物理机资源池添加物理机信息，包括服务器的 SN 序列号、IPMI 用户名、密码及服务器操作系统的网卡模板，支持批量导入物理机信息。

5. **PXE 引导初始化**

   物理机信息录入后，如果 IPMI 网络及登录信息可正常访问，平台将通过 IPMI 和 PXE 自动引导录入的物理机重新启动并进行平台准备好的部署系统并对服务器进行初始化。初始化过程中物理机的状态为【准备中】，待服务器初始化成功后，服务器的状态置为【正常】，此时可在物理机的详情中查看物理服务器的详细硬件配置，如 CPU、内存、磁盘信息、网卡信息等。

6. **物理服务器分配**

   由【平台管理员】将已初始化的已纳管的物理服务器分配给租户，一个物理机同一时间仅支持分配给一个租户，有权限的租户可至控制台自助申请物理机并安装操作系统。

7. **租户申请物理机**

   由【平台租户】通过控制台物理机功能，根据需求自助申请有权限的物理机，可指定需要申请的特定物理机，并可指定物理机的系统盘、操作系统、IP 地址及管理员登录密码。

8. **自动化装机**

   平台根据用户指定的系统盘及操作系统，通过 PXE 远程自动安装操作系统，并在系统安装成功后，根据申请时指定的配置信息自动配置网络及密码，使用户可管理已安装好的物理机。

9. **纳管物理机管理**

   由【平台租户】对已申请的物理机进行全生命周期管理，支持重装系统、关机、开机，并可在不用物理机时将设备重新释放给平台，由平台重新分配给其它租户。

平台租户在使用物理机纳管服务的前提是物理机准备好并分配给租户，租户只需要简单的申请，即可便捷的使用平台提供的裸金属设备，并可灵活部署业务系统至物理机设备，组建混合异构的基础设施环境。

### 5.2.3 物理机资源池

物理机资源池用于定义一批物理机服务器操作系统使用的网段及 Vlan 信息，可在一个资源池中添加多台物理机，每台物理机可绑定网卡模板，用于配置物理机安装操作系统后的网卡配置，如网卡聚合配置、子接口配置等。

平台管理员可对物理机资源池进行全生命周期管理，包括创建资源池、查看资源池信息、修改资源池、删除资源池，同时可为资源池添加物理机，并管理已添加的物理机，如修改物理机网卡模板、移除物理机、修改物理机信息等，通过一系列配置后租户即可通过控制台申请并使用已配置好的物理机。

#### 5.2.3.1 添加资源池 

在使用物理机纳管服务时，需要管理先添加一个物理机资源池和网卡模板，并在资源池中添加物理机，同时为资源池中的物理机绑定网卡模板，准备物理机装机前的配置。

管理员可通过控制台导航栏【物理机纳管】进入物理机资源池列表页面，通过【创建资源池】指定资源池的名称、Vlan、网段及网关进行创建操作，如下图所示：

![createbmspool](../images/adminguide/createbmspool.png)

* 名称：资源池在平台的名称标识，如 Dell-pool 。
* Vlan ：资源池网段的所属 Vlan ，无 Vlan 时可为空。
* 网段：资源池内物理机操作系统网络所使用的网段，创建时必须指定，格式必须为网段，如 172.12.1.0/24 ，一个资源池仅支持配置一个 CIDR 网段。
* 网关：资源池网段的网关信息，可为空。

创建成功后，资源池的列表会生成一条资源池信息，管理员可通过资源池列表查看并管理物理机资源池。

#### 5.2.3.2 查看资源池

管理员可平台控制台查看物理机资源池的列表及相关信息，包括名称、资源 ID、Vlan、网段、网关、物理机数量及操作项，如下图所示：

![bmspoollist](../images/adminguide/bmspoollist.png)

* 名称：物理机资源池的名称标识。
* 资源 ID：物理机资源池的全局唯一标识符。
* Vlan：物理机资源池网段的所属 Vlan。
* 网段：物理机资源池的网段信息，CIDR 格式。
* 网关：物理机资源池网段的网关信息。
* 物理机数量：物理机资源池内已添加的物理机数量。

管理员可通过列表上操作项对资源池进行修改和删除操作，同时支持批量删除操作；管理员可通过详情按钮进入资源池的详情页面查看资源池的物理机信息，如下图所示：

![bmspoolinfo](../images/adminguide/bmspoolinfo.png)

通过详情页面管理员可查看物理机资源池的基本信息，同时可通过物理机模块进行资源池的物理机管理，其中基本信息包括名称、资源 ID、Vlan、网段、网关、物理机数量及申请时间。

资源池中的物理机模块可支持管理员在资源池内添加物理机、查看物理机信息、移除物理机、修改物理机、修改网卡模板等操作，同时支持管理员按照平台的规范批量导入物理机信息。

#### 5.2.3.3 修改资源池

支持平台管理员修改物理机资源池的信息，包括名称、 Vlan、网段、网关，如下图所示：

![updatebmspool](../images/adminguide/updatebmspool.png)

由于资源池的网段和 Vlan 信息会被资源池中的物理机使用，若物理机资源池中已添加物理机，则不允许修改 Vlan 和网段信息，可修改名称及网关信息。

#### 5.2.3.4 删除资源池

支持平台管理员删除物理机资源池，删除后租户将无法再申请和管理资源池中的物理机，但不影响已申请物理机的正常运行。管理员可通过物理机资源池列表操作项中的删除按钮进行资源池的删除，如下图所示：

![rmbmspool](../images/adminguide/rmbmspool.png)

资源池被删除后即直接销毁，删除前需确保资源池中的物理机未被租户申请和使用，避免影响租户对物理机的管理和使用。

#### 5.2.3.5 修改资源池名称

修改物理机资源池的名称和备注，在任何状态下均可进行操作。可通过点击物理机资源池的列表页面每个资源池名称右侧的“编辑”按钮进行修改；也可通过修改资源池操作进行资源池的名称修改。

#### 5.2.3.6 添加物理机

物理机资源池添加成功后，平台管理员可通过资源池中的物理机管理添加物理机，使平台租户可申请资源池中的物理机进行系统安装及业务部署。为资源池添加物理机的必须准备好以下条件：

* 通过物理机的 IPMI 或 IDRAC 系统查询物理机的整机序列号（SN）、IPMI IP 地址、IPMI 用户名及密码，用于平台对物理机进行初始化和准备工作，以方便后续租户安装操作系统。
* 需提前创建好一个网卡模板，用于添加物理机，也可在添加物理机后修改网卡模板，有关网卡模板的相关管理详见[网卡模板](#_524-网卡模板)章节。

在准备好前提条件后，管理员可进入物理机资源池详情页面，通过指定名称、SN、IPMI IP、IPMI 用户名、IPMI 密码及网卡模板添加一台物理机，如下图所示：

![createbms](../images/adminguide/createbms.png)

* 名称：指物理机在平台的名称标识，添加时必须指定。
* SN：指物理机的硬件整机序列号，添加时必须指定，可通过 IPMI 系统或硬件上进行查看。
* IPMI IP：指物理机的 IPMI IP 地址，添加时必须指定，IP 地址必须从平台可达
* IPMI 用户：物理机的 IPMI 用户名，添加时必须指定。
* IPMI 密码：物理机的 IPMI 密码，添加时必须指定。
* 网卡模板：物理机安装的操作系统使用的网卡配置，如网卡聚合，IP 网段、子接口等，仅用于物理机安装操作系统或重装系统时使用。添加时可不指定，待物理机添加成功后在进行网卡模板的修改和绑定。

管理员确认添加物理机后，平台即会通过 IPMI 触发物理机进行初始化的准备操作，通过 IPMI 远程可查看到物理机已进行开启并引导至 PXE 初始化模块。

* 初始化过程中平台上物理机的状态为【准备中】，待初始化完成后，平台会将物理机进行关机，即代表物理机初始化成功。
* 初始化完成后平台上物理机的的状态为【已就绪】，即代表物理机可被租户申请被进行自动安装操作系统。

物理机在准备中状态时无法进行修改操作，包括修改网卡模板及修改物理机信息，待物理机进入【已就绪】状态时可进入物理机详情页面，查看物理机的硬件配置信息，包括 CPU、内存、磁盘及网卡信息。

#### 5.2.3.7 批量导入物理机

为方便运维人员快捷添加物理机，平台提供批量导入物理机的能力，可根据平台规范上传 CSV 格式的表格文件，批量导入一批物理机，如下图所示：

![importbms](../images/adminguide/importbms.png)

仅支持 CSV 格式且按照平台规范的文件，可参考【物理机列表示例】文件进行表格制作，表格中的信息包括 Name、SN、IPMIIP、IPMIUsername、IPMIPassword 及 NICTemplateID ，分别代表物理机名称、SN 整机序列号、IPMI  IP 地址、IPMI 用户名、IPMI 密码及网卡模板，如下图所示：

![bmcsr](../images/adminguide/bmcsr.png)

批量导入的物理机和手动添加的物理机一致，均会进行初始化准备工作，并将物理机最终置为【已就绪】状态，若物理机一直在准备中，需要登录 IPMI 系统查看物理机的网络及相关配置是否准确。

#### 5.2.3.8 查看物理机

物理机添加至资源池后，管理员可通过资源池详情中的物理机列表查看物理机的相关信息，包括名称、资源 ID、SN、IPMI IP、SMIP User、所属租户、关联网卡模板、状态及操作项，如下图所示：

![bmslist](../images/adminguide/bmslist.png)

* 资源 ID/名称： 为物理机添加至平台后的唯一标识符和名称。
* 所属租户：代表申请该台物理机的租户，未被申请的物理机租户为空。
* 关联网卡模板：物理机添加时指定的网卡模板，物理机安装操作系统时会根据网卡模板配置操作系统的网卡。
* 状态：物理机的状态信息，包括准备中、已就绪、装机中、启动中、关机中、成功及失败。
  * 准备中：指物理机添加后平台对物理机的初始化及准备工作。
  * 已就绪：指物理机已初始化成功，可被租户申请并安装操作系统。
  * 装机中：指物理机正在被租户安装操作系统。
  * 启动中：物理机正在开机中。
  * 关机中：物理机正在关机中。
  * 成功：指物理机已被租户申请并成功安装操作系统。
  * 失败：指物理机安装操作系统失败，可进行重装或由管理员删除物理机。

管理员可通过列表上的操作项对物理机进行移除、修改模板、修改物理机、修改名称和备注等操作，同时支持通过列表对物理机进行批量移除，方便运维操作。管理员也可通过物理机名称进入物理机的详情页面，查看物理机的硬件配置信息，包括 CPU、内存、磁盘及网卡信息，如下图所示共分为基本信息、磁盘信息及网卡信息：

![bmsinfo1](../images/adminguide/bmsinfo1.png)

![bmsinfo2](../images/adminguide/bmsinfo2.png)

**（1）基本信息**

基本信息展示物理机的基本配置及相关信息，包括资源 ID、名称、IPMIIP、配置、申请时间及状态，其中配置信息包括 CPU、内存及总磁盘容量。

**（2）磁盘信息**

磁盘信息展示物理机当前的所有物理磁盘信息，包括磁盘数量、总容量及每一块磁盘的列表信息，其中磁盘列表信息可查看每一块磁盘的名称、容量、厂商、类型及接口协议。

* 磁盘数量和总容量展示当前物理机的总物理磁盘数量和总容量。
* 磁盘的类型指当前磁盘的介质类型，如 HDD 或 SSD 。

**（3）网卡信息**

网卡信息展示物理机当前的所有硬件网卡信息，包括网卡名称、MAC 地址、厂商、型号、硬件地址、最大速率及当前速率。

**由于不同服务器硬件配置及接口类型不同，所对应的网卡名称也会不同（如 eth0、em0、enp61s0f0 等），管理员需要通过网卡信息中的网卡名称进行网卡模板的配置，以确保租户在为物理机安装操作系统时网络配置失败，无法通过网络访问已安装操作系统的物理机。**

#### 5.2.3.9 修改物理机网卡模板

管理员在添加物理机时可指定物理机的网卡模板，用于定义物理机操作系统中网卡的配置信息，如双网卡 bond 、子接口及相关 IP 地址信息。由于不同服务器的网卡名称可能不同可能导致网卡模板的配置不符合现状，可能导致网络配置失败。

为应对灵活配置网卡的应用场景，平台支持管理员修改已添加的物理机网卡模板，以适应物理机的真实网卡配置。仅支持修改状态为【已就绪】及【成功】的物理机网卡模板，具体操作如下图所示：

![upbmsnet](../images/adminguide/upbmsnet.png)

修改物理机的网卡模板不影响运行中的物理机，装机或重装系统时会根据新的网卡模板生效。

#### 5.2.3.10 修改物理机

物理机添加至资源池后，支持管理员修改物理机的基本信息，包括名称、IPMIIP、IPMI 用户名及  IPMI 密码，如下图所示：

![upbms](../images/adminguide/upbms.png)

修改物理机 IPMI 相关信息时，需确保修改的信息准确性，否则可能影响物理机的装机及管理操作。

#### 5.2.3.11 移除物理机

平台支持管理员移除未被租户申请的物理机资源，如下图所示：

![rmbms](../images/adminguide/rmbms.png)

删除物理机后，会自动解绑与网卡模板的关联，且租户无法管理物理机，但不影响物理机本身的正常运行；若物理机已被租户申请且未释放，则无法进行删除。

#### 5.2.3.12 修改物理机名称

修改物理机的名称和备注，在任何状态下均可进行操作。可通过点击物理机列表页面每个物理机名称右侧的“编辑”按钮进行修改；也可通过修改物理机操作进行资源池的名称修改。

### 5.2.4 网卡模板

网卡模板用于定义一批物理机服务器操作系统具体的网卡配置信息，如双网卡聚合及网卡使用的 Vlan 和 CIDR 网段，可在安装操作系统时根据模板自动配置网卡并配置 IP 等信息。

网卡模板用于添加物理机时指定，多个资源池的物理机均可绑定一个网卡模板，即物理机均使用网卡模板上定义的网卡配置参数进行操作系统安装时的网络配置依据。

物理机纳管中的网卡模板可定义网卡的配置，同时可支持网卡聚合（bond）及虚拟网卡（即操作系统中的子接口）配置，其中聚合参数需要指定 bond 网卡名称及需要做 bond 的网卡名称。

网卡名称需要通过物理机的信息进行获取，因此建议在物理机成功添加并进入【已就绪】状态时，通过物理机的网卡信息获取适合物理机的网卡模板；管理员也可自定义多个网卡模板，为不同型号及配置的物理机绑定不同的网卡模板，用于部署和安装操作系统。

#### 5.2.4.1 添加网卡模板

在添加物理机前需要为资源池中的物理机准备一个网卡模板，管理员可通过物理机纳管控制台的网卡模板标签页进行网卡模板的创建操作，如下图所示：

![nictem](../images/adminguide/nictem.png)

创建网卡模板时需指定名称、厂商、型号、网卡设置及虚拟网卡：

* 名称：指网卡模板的名称，用于添加物理机时指定网卡模板的标识。
* 厂商/型号：指网卡模板对应的网卡厂商及型号，添加时可不指定。
* 网卡设置：指服务器操作系统的需要配置的网卡设置，包括基础网卡名称和多网卡聚合。
  * 基础网卡名称：指安装操作系统时需要配置的网卡名称，如 eth0 或 eh1 ；若需要做双网卡 bond ，则需要输入 bond 的网卡名称，如 bond0 或 bond1 。
  * 多网卡聚合：需要做网卡聚合的网卡名称，多个网卡间使用英文的逗号进行分隔；仅在需要做双网卡聚合时指定，如基础网卡为 bond0 所对应的 eth0 和 eth1 ，即代表 eth0 和 eth1 聚合为 bond0 网卡。
* 虚拟网卡：指服务器操作系统中一个网卡对应的子接口，也可为基础网卡。
  * 通常在操作系统中为：interfacename.vlan ，如 eth0.200 工中 bond0.200 。
  * 通过虚拟网卡可以将一个物理网卡拆分为多个虚拟子接口，分别配置不同的 Vlan ，使一个网卡可以同时透传多个 Vlan 的网络数据至交换机。

> 网卡名称可通过已添加的物理机信息进行查看，如 eth0、em0 等。

管理员确认信息无误后，点击确认即在网卡模板列表生成一条网卡模板信息，可通过列表信息查看网卡模板的配置，也可对网卡模板进行修改。

#### 5.2.4.2 查看网卡模板

管理员可通过网卡模板列表查看网卡模板的基本信息，包括名称、资源 ID、厂商、型号及操作项，如下图所示：

![nictemlist](../images/adminguide/nictemlist.png)

可通过列表上的对网卡模板进行修改及删除操作，支持批量删除。

#### 5.2.4.3 修改网卡模板

管理员可随时修改网卡模板的配置信息，与创建模板时一致，可进行修改名称、厂商、型号、网卡设置及虚拟网卡，如下图所示：

![upnictem](../images/adminguide/upnictem.png)

修改网卡模板配置仅对需要安装操作系统或重装系统的物理机生效。

#### 5.2.4.4 删除网卡模板

管理员可通过控制台删除无用的网卡模板，仅支持删除未被使用的网卡模板，即未被物理机关联的网卡模板才可进行删除。

![rmnictem](../images/adminguide/rmnictem.png)

## 5.3 镜像管理

镜像是虚拟机所使用的镜像模板文件，如 CentOS、Windows、Ubuntu 等操作系统模板文件，平台的镜像文件均为 QCOW2 格式。镜像管理是平台为虚拟机提供的镜像仓库，支持基础镜像和自制镜像两种类型：

- 基础镜像是由平台官方默认提供，包括多发行版 Centos 、Ubuntu 及 Windows 等原生操作系统；
- 自制镜像由租户或管理员通过虚拟机自行导出或自定义导入的自有镜像，可用于创建虚拟机，除平台管理员外仅账号自身有权限查看和管理。

### 5.3.1 基础镜像管理

平台默认会提供多发行版 Centos 、Ubuntu 及 Windows 等原生操作系统的基础镜像，基础镜像默认所有租户均可使用。默认提供的镜像包括 Centos 6.5 64 、Centos 7.4 64 、Windows 2008r2 64 、Windows 2012r2 64 、Ubuntu 14.04 64 、Ubuntu 16.04 64。

支持管理将租户自制或导入的镜像复制为基础镜像，作为默认基础镜像共享给平台所有租户使用；同时支持管理员修改基础镜像的名称备注及删除基础镜像。

#### 5.3.1.1 查看基础镜像

在基础镜像列表可查看平台所有基础镜像及镜像信息，包括名称、iD、系统类型、操作系统状态及操作项，如下图所示：

![baseimagelist](../images/adminguide/baseimagelist.png)

- 镜像名称：镜像的标识名称，创建虚拟机时展示在镜像列表中的标识。
- 资源 ID：镜像文件在平台的唯一标识符。
- 系统类型：镜像文件的操作系统类型，包括 Linux、Windows 等。
- 操作系统：镜像文件的 Base 操作系统版本，如 CentOS 6.5 x86_64。
- 状态：基础镜像的状态，包括制作中、可用、删除中。
  - 制作中：指基础镜像正在被制作中，通过自制镜像复制基础镜像时会展示为制作中。
  - 可用：指镜像可被租户使用并可正常创建虚拟机。
  - 删除中：指镜像被删除中。

管理员可通过基础镜像列表对镜像进行删除操作，支持批量删除；同时为方便管理运维，支持搜索基础镜像。

#### 5.3.1.2 删除基础镜像

可以通过删除基础镜像下线平台不需要使用的基础镜像，仅支持删除可用状态的基础镜像，如下图所示：

![rmbaseimage](../images/adminguide/rmbaseimage.png)

**如果平台存在通过此基础镜像创建的虚拟机，则基础镜像无法被删除。**

#### 5.3.1.3 修改名称和备注

修改基础镜像的名称和备注，在任何状态下均可进行操作，可通过点击基础镜像列表页面每个镜像名称右侧的“编辑”按钮进行修改。

### 5.3.2 自制镜像管理

自制镜像由租户或管理员通过虚拟机自行导出或自定义导入的自有镜像，可用于创建虚拟机，除平台管理员外仅账号自身有权限查看和管理。

* 支持管理将为租户导入自定义镜像，并支持管理员将租户的虚拟机导出为自制镜像；同时管理员可下载镜像仓库中的所有自制镜像。

* 支持管理员通过自制镜像创建虚拟机、删除自制镜像、修改自制镜像名称。

为方便平台镜像模板文件的共享，平台支持管理员将一个自制镜像复制为一个基础镜像，使一个租户的自制镜像共享给所有租户使用，适用于运维部门制作模板镜像的场景，如自制镜像操作系统的漏洞修复或升级后，制作一个自制镜像并复制为基础镜像，使所有租户可使用新的镜像文件升级虚拟机系统。

#### 5.3.2.1 查看自制镜像

在自制镜像列表可查看平台所有租户在一个地域内的自制镜像列表信息，包括镜像名称、资源 ID、所属租户、系统类型、操作系统、状态及操作项，如下图所示：

![customeimage](../images/adminguide/customeimage.png)

- 镜像名称：自制镜像的标识名称。

- 资源 ID：自制镜像在平台的唯一标识符。

- 所属租户：自制镜像所归属的租户的主账号的邮箱和 ID。

- 系统类型：自制镜像的操作系统类型，包括 Linux 和 Windows 等。

- 操作系统：自制镜像的 Base 操作系统版本，如 CentOS 6.5 x86_64。

- 状态：自制镜像的状态，包括创建中、可用、删除中、上传中、上传失败。
  - 创建中：指正在通过虚拟机制作自制镜像。
  - 可用：指自制镜像可被租户使用并可正常创建虚拟机。
  - 删除中：自制镜像正在被删除中。
  - 导入中：指自制镜像正在导入中或上传中。
  - 导入失败：指自制镜像导入失败。

管理员可通过自制镜像列表对单个自制镜像进行操作，包括创建虚拟机、复制为基础镜像、下载镜像及删除镜像，支持批量删除；同时支持管理员为某一个租户导入自定义镜像。

#### 5.3.2.2 导入自制镜像

导入镜像是指租户或平台管理员将第三方业务虚拟机以镜像的方式迁移到平台镜像仓库，使租户可以在通过导入的镜像创建并部署业务虚拟机，是用户将业务迁移的重要通道。

支持用户导入 Linux 和 Windows 发行版及自定义镜像，并支持 X86 架构和 aarch64 两种系统架构镜像的导入；云平台的镜像格式默认为 RAW ，用户上传 VHD、VMDK、QCOW2、OVA、ISO 等格式的镜像时，需先将镜像转换为 QCOW2 格式的镜像才可导入，有关转换镜像及自定义镜像的具体操作可参考自制镜像列表上展示的[自定义镜像指南]() 。 

制作好自定义镜像后，可通过镜像管理控制台资源列表上方的【导入镜像】功能，进入导入镜像向导页面：

![upimage](../images/adminguide/upimage.png)

- 租户邮箱：通过租户主账号邮箱选定自制镜像归属的租户。
- 镜像名称/描述：镜像的名称及相关描述信息；
- 镜像地址：平台导入镜像时读取并下载镜像的 URL 地址，导入镜像时必须提供，平台会从提供的 URL 地址自动下载镜像并自动导入至镜像仓库，用于创建虚拟机。
  * 当前仅支持 HTTP、HTTPS 等协议的 URL 地址，格式包括 `https://path/file` 或`ftp://hostname[:port]/path/file` 或 `ftp://user:password@hostname[:port]/path/file` ；
  * 镜像的地址必须从云平台可达，即云平台组件可访问的 URL 地址，建议使用云平台相同外网的 IP 地址或外网 IP 地址可通信的地址。
- 操作系统：导入镜像的操作系统类型，包括 Linux 和 Windows ，需根据导入镜像 OS 类型进行选择；
- 系统架构：导入镜像的系统架构，包括 `x86_64` 和 `aarch64` ，需根据导入镜像进行选择；
- 系统平台：指导入镜像的操作系统平台；
  * Linux 操作系统的系统平台包括 Centos 和 Ubuntu ；
  * Windows 操作系统的系统平台仅支持 Windows ；
- 系统版本：当前需导入镜像的操作系统版本；
  * CentOS x86_64 架构支持  `6.5~6.10` 及 `7.0~7.9` 版本；
  * CentOS aarch64 架构支持 `7.6~7.9` 版本；
  * Ubuntu x86_64 架构支持 14.04 和 16.04 版本；
  * Ubuntu aarch64 架构支持 16.04 和 18.04 版本；
  * Windows  支持 2008、2008R2、2012、2012R2 及 2016 版本；
- 目标镜像大小：当前导入镜像的目标大小，最小 20GB ，最大不能超过 500GB ；
- SHA256 ：用于校验文件完整性的值，默认无需指定。

镜像导入后，自制镜像列表生成一条状态为 “导入中” 的镜像，由于平台需要先下载镜像至镜像仓库且镜像通常较大，导入镜像的时间通常比较长。

镜像状态转换为可用时，即代表镜像导入成功，可进行虚拟机创建、进行镜像下载及复制为基础镜像等操作；若镜像导入过程中出现意外导致失败，则镜像的状态会转换为“导入失败” ，可对失败的镜像进行删除并重新导入镜像。

> 导入镜像前需确保镜像地址可被访问且可读取并下载到镜像。

#### 5.3.2.3 创建虚拟机

管理员可从自制镜像为租户启动一台虚拟机，创建的虚拟机将归属于自制镜像所归属的租户，虚拟机中的程序及数据保持自制镜像的创建时的状态。

使用自制镜像创建虚拟机的过程与基础镜像相同，可根据提示进行操作。从镜像创建虚拟机时设置的管理员密码会覆盖原镜像操作系统中的密码，需使用新密码登录创建的虚拟机。	

#### 5.3.2.4 复制为基础镜像

为方便平台镜像模板文件的共享，平台支持管理员将一个自制镜像复制为一个基础镜像，使一个租户的自制镜像共享给所有租户使用，适用于运维部门制作模板镜像的场景，如自制镜像操作系统的漏洞修复或升级后，制作一个自制镜像并复制为基础镜像，使所有租户可使用新的镜像文件升级虚拟机系统。

若平台需要其它基础镜像系统，可先上传为自制镜像，再通过“复制为基础镜像”的功能转化为平台基础镜像。可通过目标自制镜像右侧“复制为自制镜像”操作，如下图所示：

![cloneimage](../images/adminguide/cloneimage.png)

输入目标基础镜像名称，即可触发复制为基础镜像的操作，自制镜像复制过程中会在基础镜像列表生成一条状态为【制作中】的基础镜像信息，待状态转换为【可用】时，代表复制成功，平台上的所有租户可使用此镜像创建虚拟机，进行业务部署。

#### 5.3.2.5 下载自制镜像

下载镜像指用户将平台自制的镜像下载至本地，用于备份或迁移。虚拟机镜像通过为 GB 级别文件，为保证下载镜像的断点续传等功能，平台以提供下载地址的方式支持镜像下载；可通过 FTP、 SFTP 及相关工具进行镜像下载，以保证断点续传功能，提升镜像下载的成功率。

管理员如果需要下载镜像至本地时，可通过自制镜像列表操作项中的【下载】进入镜像下载向导页面，如下图：

![downloadimage](../images/adminguide/downloadimage.png)

点击生成下载地址后，平台会跳转至下载地址展示向导页面，通过向导页面，用户通过复制下载地址链接，通过 HTTP、FTP 及相关下载工具下载镜像。

![downloadimage1](../images/adminguide/downloadimage1.png)

> 镜像下载地址有效期为 24 小时，需在 24 小时内进行镜像下载。若镜像下载地址过期，则无法进行下载，需到平台重新生成镜像下载地址。

#### 5.3.2.6 删除自制镜像

管理员可对自制镜像进行删除操作，被删除的自制镜像会自动进入所属租户的“**回收站**”，可通过回收站进行还原和销毁操作。管理员可通过自制镜像管理控制台的“删除”功能进行自制镜像的删除，删除后可到回收站中查看已删除的自制镜像，如下图所示：

![rmimage](../images/adminguide/../UserGuide/rmimage.png)

仅支持删除状态为可用或导入失败的的自制镜像；若已通过自制镜像创建虚拟机，则不可删除自制镜像，需要将虚拟机删除，才可进行自制镜像的删除。

#### 5.3.2.7 修改名称和备注

修改自制镜像的名称和备注，在任何状态下均可进行操作。可通过点击自制镜像列表页面每个镜像名称右侧的“编辑”按钮进行修改。

## 5.4 外网网段管理

外网网段是平台对外通信的网络，一般由管理员或运维人员通过物理网络分配并配置至云平台。外网网段是平台为租户分配外网 IP （弹性 EIP）的 IP 资源池，支持 IPv4 和 IPv6 两种 IP 类型，并支持配置网段路由并自动下发路由至平台虚拟机。

平台在部署时默认为配置一段外网网段，如果平台业务需求，也可由管理员在管理控制台上自助添加 IP 网段，在添加 IP 网段前需要保证物理交换机上已为节点外网网络配置 Vlan 及相关网段信息。

网段管理仅作为平台管理员将物理网络上的网段信息录入至云平台，使云平台的租户可申请外网网段是的 IP 地址作为虚拟资源的外网 IP ，与平台外网进行通信。

支持管理员对外网 IP 的网段进行维护及管理，包括 IP 网段、网关、外网网卡、VLAN、路由及网段权限等配置，方便云平台管理员对外网 IP 地址池的管理，同时支持 IPv4 和 IPv6 双栈 IP 资源池管理。

* 支持通过私有 IP 地址段模拟外网网段，在交换机或上层路由将私有 IP 地址段 NAT 到互联网。
* 支持为每个网段配置路由策略，即租户申请网段的外网 IP 绑定至虚拟资源后，下发目的路由地址的流量自动以绑定的外网 IP 为网络出口。路由策略提供默认路由、指定路由及暂不指定三种模式：
  - 默认路由：即下发路由的目的地址为 0.0.0.0/0 ，代表默认所有流量均以绑定的外网 IP 为出口。
  - 指定路由：即管理员指定目的地址（如 10.0.2.0/24 ）的流量以绑定的外网 IP 为出口。
  - 暂不指定：即该网段不自动下发路由，仅可通过此外网 IP 地址与本网段进行通信。
* 支持管理员为云平台添加 IPv4 或 IPv4 版本的网段，使平台租户可同时申请 IPv4 和 IPv6 版本的外网 IP ，并绑定至虚拟机提供网络服务。
* 支持管理对每个网段的开放范围进行控制及修改，默认为所有租户（所有租户可申请并使用网段 IP），支持配置为部分租户（指定的租户才可申请并使用网段 IP，未指定租户无法查看并申请网段 IP）

为方便管理员和运维人员，平台提供外网网段的创建、查看、修改及删除等生命周期管理。外网网段中 IP 地址的带宽规格可参考全局配置中的【规格配置】

> 外网网段管理与平台部署的物理网络及架构拓扑紧密相关，在维护外网网段前需确保物理网络配置完善后，至平台录入 IP 网段后才可使用。

### 5.4.1 创建外网网段

管理员在物理网络设备配置好 Vlan 及网段信息后，通过平台资源管理进入外网网段资源控制台，指定网段名称、描述、IP 版本、网段、网关、网卡、Vlan、路由及租户权限创建一个外网网段，如下图所示：

![createnet](../images/adminguide/createnet.png)

* 名称/描述：指外网网段的名称和描述，名称会作为租户端申请外网 IP 时展示的网段名称。
* IP 版本：指外网网段的 IP 版本，支持 IPv4 或 IPv6 ，创建时必须指定，默认为 IPv4。
* 网段：指外网网段的 CIDR 网段，创建时必须指定。若版本为 IPv4 ，则必须输入 IPv4 版本的网段，如 192.168.1.0/24 ；若版本为 IPv6 ，则必须输入 IPv6 版本的网段。
* 网关：指外网网段的网关地址，创建时必须指定，网关必须在网段的范围内且与物理网络上配置一致，否则会影响网络通信。
* 网卡：指外网网段在物理节点上对应的网卡名称，即物理网络设备上网段与平台计算节点外网相连的网卡，如 bond0  或 eth0。
* Vlan：指外网网段在物理网络设备中配置的 Vlan 信息，平台在通信时会带上 Vlan 信息透传至物理网络，若无 Vlan 可不配置。
* 路由：为网段配置路由策略，即租户申请网段的外网 IP 绑定至虚拟资源后，下发目的路由地址的流量自动以绑定的外网 IP 为网络出口。路由策略提供默认路由、指定路由及暂不指定三种模式，默认值为默认路由。
  - 默认路由：即下发路由的目的地址为 0.0.0.0/0 ，代表默认所有流量均以绑定的外网 IP 为出口。
  - 指定路由：即管理员指定目的地址（如 10.0.2.0/24 ）的流量以绑定的外网 IP 为出口，支持多条指定路由策略。
  - 暂不指定：即该网段不自动下发路由，仅可通过此外网 IP 地址与本网段进行通信。
* 租户权限：管理对每个网段的开放范围进行控制，支持所有租户和指定租户，默认为所有租户。
  * 所有租户指平台上所有租户可申请并使用网段的 IP 地址。
  * 部分租户是指指定的租户才可申请并使用网段 IP，未指定租户无法查看并申请网段 IP。

创建网段后，外网网段列表会生成一条可用状态的网段信息，代表网段已可被申请和使用。

### 5.4.2 查看外网网段

管理员可通过外网网段控制台的列表查看已创建的外网网段的列表信息，包括网段 ID、名称、IP 版本、网段、网关、网卡、Vlan、租户权限、状态及更新时间。

租户权限中或指定所有租户展示为【所有租户】，若指定的为部分租户，则展示有权限的租户邮箱地址信息。

### 5.4.3 修改租户权限

当需要将一段外网网段独享给部分租户时，管理员可修改外网网段的租户权限，如下图所示：

![upnetauth](../images/adminguide/upnetauth.png)

修改租户权限后，无权限的租户即无法查看并使用外网网段的 IP 地址，但不影响已申请外网 IP 地址的使用，若租户释放了外网 IP ，则无法在申请该网段的  IP 地址。

### 5.4.4 删除外网网段

 支持管理员删除不再使用的外网网段，如下图所示：

![rmnet](../images/adminguide/rmnet.png)

若网段中的 IP 地址已被租户申请，则无法删除，需要租户将所有的外网 IP 地址释放后，才可进行删除；管理员也可通过虚拟资源管理中为租户释放外网 IP 地址。

