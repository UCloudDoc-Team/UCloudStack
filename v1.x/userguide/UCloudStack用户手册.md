<center>
<img src="../images/introduction/ustacklog.png" width="60%" height="60%" />
</center> 



<center>
<B><font size=7>UCloudStack 用户手册 </font></B>
</center>












<center>
<B><font size=5>产品版本：V1.22.0 </font></B>
</center>



<center>
<B><font size=4>文档版本：202104 </font></B>
</center>































[toc]





































# 版权声明

版权所有 ©  优刻得科技股份有限公司 2021 保留一切权利。

非经本公司书面许可，任何单位和个人不得擅自摘抄、复制本文档内容的部分或全部，并不得以任何形式传播。

UCloudStack 商标和 UCloud 商标为优刻得科技股份有限公司所有。对于本手册中可能出现的其它公司的商标及产品标识，由各自权利人拥有。

注意您购买的产品、服务或特性等应受优刻得科技股份有限公司商业合同和条款约束，本文档中描述的全部或部分产品、服务或特性可能不在您的购买或使用权利范围之内。除非合同另有约定，优刻得科技股份有限公司对本文档内容不做任何明示或暗示的声明或保证。

由于产品版本升级或其它原因，本文档内容会不定期更新，除非另有约定，本文档仅作为使用指导，本文档中的所有陈述、信息和建议不构成任何明示或暗示的担保。

本文档描述 UCloudStack （v1.22.0）云平台的功能说明和操作指南，适用于需深入了解平台并使用控制台管理资源的租户，开发者可参考 UCloudStack API 开发者文档。









































# 1 产品简介

## 1.1 产品概述

UCloudStack 企业私有云平台，提供虚拟化、SDN 网络、分布式存储、数据库缓存等核心服务的统一管理、资源调度、监控日志及运营运维等一整套云资源管理能力，助力企业数字化转型。

![core](../images/userguide/core.png)

平台基于 UCloud 公有云基础架构，复用内核及核心虚拟化组件，将公有云架构私有化部署，具有自主可控、稳定可靠、持续进化及开放兼容等特点，企业可通过控制台或 APIs 快速构建资源及业务，支持与公有云无缝打通，灵活调用公有云能力，帮助企业快速构建安全可靠的业务架构。

UCloudStack 定位为轻量级交付，3 节点即可构建生产环境且可平滑扩容，不强行绑定硬件及品牌，兼容 X86 和ARM 架构，并提供统一资源调度和管理，支持纯软件、超融合一体机及一体机柜多种交付模式，有效降低用户管理维护成本，为用户提供一套安全可靠且自主可控的云服务平台。

## 1.2 核心优势

* 自主可控——基于公有云架构，复用核心虚拟化组件自主研发，可控性高且可靠性经上万家企业验证。

* 稳定可靠——平台服务高可用，虚拟资源智能调度，数据存储多副本，自愈型分布式网络，为业务保驾护航。

* 简单易用——3 节点构建生产环境，规模轻量可水平扩展，支持业务平滑迁移，助力企业轻松上云。

* 开放兼容——不绑定硬件品牌，兼容 X86 和 ARM 架构及生态适配，设备异构搭建统一管理。

## 1.3 产品架构

![平台架构图](../images/userguide/arch.png)

UCloudStack 平台整体产品架构由基础硬件设施、虚拟核心引擎、智能调度系统、核心产品资源、统一云管平台及运维管理平台组成，为平台租户、管理员及运营人员提供云平台管理和服务。

- **基础设施**：用于承载 UCloudStack 平台的服务器、交换机及存储设备等。

  - 平台支持并兼容通用 X86、ARM 及 MIPS 架构硬件服务器，不限制服务器和硬件品牌；
  - 支持 SSD 、SATA 、SAS 等磁盘存储，同时支持计算存储超融合节点及对接磁盘阵列设备，无厂商锁定；
  - 支持华为、思科、H3C 等通用交换机、路由器网络设备接入，所有网络功能均通过 SDN 软件定义，仅需物理交换机支持 Vlan、Trunk、IPv6、端口聚合、堆叠等特性；
  - 支持混合云接入并适配客户现有硬件资源，充分利用资源的同时，无缝对接现有资源服务。
- **虚拟核心引擎**：承载平台核心的操作系统内核、虚拟化计算、存储、网络的实现和逻辑。
  - 内核模块：承载云平台运行的服务器操作系统及内核模块，复用公有云深度优化的 Linux 内核；同时兼容 ARM 生态的 UOS、银河麒麟等服务器操作系统及内核；
  - 虚拟化计算：通过 KVM 、Libvirt 及 Qemu 实现计算虚拟化，支持标准虚拟化架构，提供虚拟机全生命周期管理，兼容 X86 和 ARM 架构体系，支持热升级、重装系统、CPU 超分、GPU 透传、在线迁移、宕机迁移、反亲和部署等特性，并支持导入导出虚拟机镜像满足业务迁移上云需求；
  - 分布式网络 SDN ：通过 OVS + VXLAN 实现虚拟网络，纯软件定义分布式网络，提升网络转发性能的同时对传统数据中心物理网络进行虚拟化，为云平台资源提供 VPC 隔离网络环境、弹性网卡、外网IP、NAT 网关、负载均衡、防火墙、VPN连接、混合云接入及网络拓扑等网络功能，并支持 IPv4&IPv6 双栈；
  - 分布式存储 SDS ：基于 Ceph 实现分布式高性能存储，为平台提供块存储服务，支持云盘在线扩容、克隆、快照及回滚功能；同时底层数据多副本存储并支持数据重均衡和故障重建能力，保证性能和数据安全性。
- **智能调度系统**
  - 支持反亲和性调度部署策略，保证业务的高可用性和高可靠性；
  - 支持在线迁移技术，实时感知物理机状态和负载信息；
  - 物理主机故障或超过负载时，自动迁移虚拟机至低负载物理主机；
  - 创建虚拟机时，根据业务调度策略，自动启动虚拟机至低负载健康的物理主机；
  - 支持计算额度分配和资源抢占，保障公平的前提下，有效共享物理资源；
  - 支持平台虚拟资源的网络流表控制及下发，保证分布式网络架构的性能及可用性。
- **核心产品资源**
  - **地域（数据中心）**：数据中心指资源部署的物理位置分类，数据中心之间相互独立，如无锡数据中心、上海数据中心等。平台支持多数据中心管理，使用一套管理平台管理遍布各地数据中心的私有云平台；
  - **集群**：用于区分不同资源在一个数据中心下的分布情况，如 x86 计算集群、ARM 计算集群、 SSD 存储集群 及 SATA 存储集群，一个数据中心可以部署多个集群；
  - **多租户**：平台支持多租户模式，提供租户隔离功能、子账号、权限控制、配额配置及价格配置等功能；
  - **子账号及权限**：支持一个租户拥有多个子账号，支持资源隔离并可对子账号进行资源管理的权限控制；
  - **计量计费**：支持按需、按月、按年三种计费方式，支持过期续费及回收策略，同时提供完整的计费订单及消费明细；
  - **弹性计算**：运行在物理主机上的虚拟机，支持从镜像创建、重启/关机/启动、删除、VNC登陆、重装系统、重置密码、热升级、绑定外网 IP及安全组、挂载数据盘及反亲和策略部署等虚拟机全生命周期功能，同时支持将虚拟机制作为镜像及磁盘快照能力，提供快捷的业务部署及备份能力；
  - **GPU虚拟机**：平台提供 GPU 设备透传能力，支持用户在平台上创建并运行 GPU 虚拟机，让虚拟机拥有高性能计算和图形处理能力；
  - **弹性伸缩**：支持弹性伸缩功能，用户可通过定义弹性伸缩策略，在业务需求增长时自动增加计算资源（虚拟机）以保证计算能力；在业务需求下降时自动减少计算资源以节省成本。基于负载均衡和健康检查机制，可同时适用于请求量波动和业务量稳定的业务场景；
  - **镜像**：虚拟机运行时所需的操作系统，提供 CentOS 、Windows 、Ubuntu 等常用基础操作系统镜像；支持将虚拟机导出为镜像，通过自制镜像重建虚拟机；同时支持镜像的导入导出，便于用户自定义镜像；
  - **云硬盘**：一种基于分布式存储系统为虚拟机提供持久化存储空间的块设备。具有独立的生命周期，支持随意绑定/解绑至多个虚拟机使用，基于网络分布式访问，并支持容量扩容、克隆、快照等特性，为虚拟资源提供高安全、高可靠、高性能及可扩展的磁盘；
  - **快照**：提供磁盘快照及快照回滚能力，可应用于容灾备份及版本回退等业务场景，降低因误操作、版本升级等导致的数据丢失风险；
  - **VPC 网络**：软件定义虚拟专有网络，用于租户间数据隔离，提供自定义 VPC 网络、子网规划及网络拓扑;
  - **外网 IP**：用于虚拟机、负载均衡、NAT 网关及 VPN 网关等资源的外网 IP 接入，用于与平台外网络进行连接，如虚拟机访问互联网或访问 IDC 数据中心的物理机网络；支持同时绑定多个外网 IP 至虚拟资源，并提供 IPv6 网络连接服务；
  - **安全组**：虚拟防火墙，提供出入双方向流量访问控制规则，定义哪些网络或协议能访问资源，用于限制虚拟资源的网络访问流量，支持 TCP 、UDP 、ICMP 及多种应用协议，为云平台提供必要的安全保障；
  - **弹性网卡**：一种可随时附加到虚拟机的弹性网络接口，支持绑定和解绑，可在多个虚拟机间灵活迁移，为虚拟机提供高可用集群搭建能力，同时可实现精细化网络管理及廉价故障转移方案；
  - **NAT 网关**：企业级 VPC 网关，为云平台资源提供 SNAT 和 DNAT 代理，支持自动和白名单两种网络出口模式，并为 VPC 网络提供端口映射代理服务，使外部网络通过 NAT 网关访问虚拟机和 MySQL 。
  - **负载均衡**：基于 TCP/UDP/HTTP/HTTPS 协议将网络访问流量在多台虚拟机间自动分配的控制服务，类似于传统物理网络的硬件负载均衡器，用于多台虚拟机间实现流量负载及高可用，提供内外网 4 层和 7 层监听及健康检查服务；
  - **IPSecVPN**：提供 IPSecVPN 网关服务，通过 IPSec 协议加密的隧道技术，将 UCloudStack 与 UCloud 公有云、IDC 数据中心、第三方公有云的内网打通，在互联网上为两个私有网络提供安全通道，通过加密保证连接的安全；同时 IPSecVPN 服务还可作为 UCloudStack 平台 VPC 间通信的桥梁；
  - **监控告警**：支持虚拟机、弹性伸缩、磁盘、弹性 IP 、NAT网关、负载均衡、IPSecVPN、MySQL、Redis 等资源各维度监控数据收集及展示，同时可通过告警模板快速配置资源监控指标的告警策略和通知规则；
  - **操作日志**：云平台所有资源及云平台自身的操作和审计日志，支持多时间跨度的日志收集和展示，提供操作失败原因；
  - **回收站**：资源删除后暂存的位置，支持回收资源、恢复资源及彻底删除资源等操作；
  - **定时器**：提供定时器任务执行功能，可用来定期执行一系列任务，支持定时创建快照， 可在指定的周期重复执行，也可仅执行一次，且每个任务支持多个资源批量操作。
- **统一云管平台**
  - UCloudStack 平台提供 Web 控制台 和 API 接口两种方式接入和管理云平台；
  - 通过 WEB 控制台用户可快捷的的使用并管理云平台资源，如虚拟机、弹性 IP 、负载均衡 、计费等；
  - 开发者可通过 APIs 自定义构建云平台资源，支持无缝迁移上云。
- **运维管理平台**：为云平台管理员提供的运维运营管理平台，包括租户管理、资源管理、账务管理、监控告警、日志审计、系统管理及部署升级等功能模块。
  - **租户管理**：用于管理整个云平台的租户及账号信息，提供创建/冻结租户及充值功能，支持查看租户拥有资源信息、订单记录、交易记录及配额价格等信息，同时支持修改租户的资源配额及产品价格；
  - **资源管理**：支持查看并管理平台所有物理资源和虚拟资源；
    - 物理资源包括物理数据中心、集群、宿主机资源、存储资源、网络IP网段资源池及镜像资源池等；
    - 虚拟资源包括所有租户及子账号所拥有的资源，包括虚拟机、VPC 、负载均衡、外网 IP 、弹性网卡、弹性伸缩、NAT 网关、MySQL、Redis、IPSecVPN、监控告警、安全组、回收站等；
  - **账务管理**：支持查看平台所有订单记录、交易记录、充值记录及全局产品价格，支持配置平台整体产品价格，同时支持财务报表导出；
  - **平台监控告警**：提供 UCloudStack 自身物理设备、组件及所有虚拟资源的监控数据，并支持自定义监控报警和通知；
  - **日志事件**：提供平台所有租户、子账号及管理员的操作日志和审计信息，可进行多维度的筛选和搜索；
  - **系统管理**：提供云平台全局配置、规格配置和配额管理功能。
    - 全局配置包含邮箱设置、回收策略、网络设置、计费、资源管理、配额设置、登录态、控制台及网站设置等；
    - 规格配置支持对虚拟机的 CPU 内存规格、磁盘容量范围、外网 IP 带宽及 MySQL/Redis 内存规格进行自定义配置；
    - 全局配额支持查看并修改全局每个地域虚拟资源的配额值。
  - **部署升级**：平台支持自动化脚本安装物理服务器节点，包括操作系统、云平台组件及管理服务等。
- **基础监控服务**：云平台基础硬件资源的外围监控服务，包括云平台接入的所有网络设备、服务器、磁盘阵列等硬件设备的运行状态和性能指标进行监控告警，同时也可对集群中 MySQL、Redis、MongoDB 等常用服务进行监控和告警。

# 2 主账号

## 2.1 主账号注册登录

UCloudStack 云平台支持多租户模式，租户即为主账号，平台管理员可通过管理员控制台自主创建主账号并为主账号充值，同时平台提供自助注册流程，用户可通过注册链接，自动化的进行注册并使用云平台。可通过平台注册链接进入账号页面，进行简单的账号注册。

![register](../images/userguide/register.png)

1. 如上图注册界面所示，注册需要的信息如下：
   * 登录邮箱：用于登录云平台的邮箱账号，邮箱账号需要支持接收验证邮件；
   * 登录密码：密码须包含有大小写字母、数字、符号中的两种，密码长度为6-20个字符；
2. 提交注册后，平台会给邮箱账号发送激活邮件，您可以登录邮箱完成激活操作；
3. 点击邮箱中 “**UCloudStack 激活账户**” 邮件的链接后，完成注册，如下图所示。

![register1](../images/userguide/register1.png)

4. 通过注册的邮件和密码登录 UCloudStack 云平台，本文使用 **[UCloudStack 在线 POC 环境]** 作为示例。

![login.png](../images/userguide/login.png)

> 云平台资源支持计量计费，在使用前需要联系平台管理员对账号进行充值，才可正常创建并使用资源。

5. 登录成功后，会为用户展示 UCloudStack 云平台的概览页面，如下图所示：

![generalview](../images/userguide/generalview.png)

云平台用户登录控制台会默认进入概览页面，概览是当前登录账号的账户信息和资源的综合统计信息，包括登录账号信息、账户余额、免费余额、最近 12 小时的告警记录信息、资源利用率统计信息及账号配额使用状况信息等，并可对平台进行登出操作：

- 登录账号信息展示当前登录平台的账户属性及邮箱地址，若使用子账号登录平台，则展示为子账号及邮箱。
- 最近 12 小时告警记录信息展示当前账号拥有资源最近 12 小时的告警记录，方便快速查看资源健康状况。
- 资源利用率统计信息：当前账号 CPU 、内存、磁盘、宽带的平均使用率，如上图 CPU 平均使用率约为 2% 。
- 配额使用状况信息：当前账号各种资源的配额及占用信息，包括虚拟机、镜像、硬盘、网卡、VPC、外网IP、安全组、NAT 网关、负载均衡、VPN网关、Redis 及 MySQL 等资源配额，资源配额值可通过管理员控制台进行配置，并可通过账号信息查看当前租户的资源配额。

通过点击概览页面账户名可进入账户详情信息页面，查看当前账户的详细信息、子账号及配额相关信息。点击告警记录的可进入告警历史记录页面，查看更多告警记录。

## 2.2 OAuth 登录认证

平台支持第三方 OAuth 2.0 登录认证，用户可通过将企业内 OAuth 统一认证登录系统与云平台进行对接，使用企业统一登录用户即可登录并使用云平台的资源。

如 2.1 章节登录示例图所示，平台已于 OAuth 2.0 系统进行对接，并在登录页面提供第三方登录入口。企业用户可通过自有的 OAuth 统一认证平台登录跳转至云平台，同时也可通过云平台第三方登录入口通过统一用户密码认证登录云平台，如下图所示：

![OAuth](../images/userguide/OAuth.png)

用户在第三方登录平台使用用户名和密码登录平台后，即可跳转至云平台概览页面，使用统一的用户认证方式管理云平台资源。

## 2.3 找回密码

平台支持主账号在忘记密码时通过控制台自主找回密码，找回密码时需通过邮箱进行验证，请确保管理员添加的账号为真实可用的邮箱。通过登录页面的【找回密码】功能，即可使用邮箱地址验证重新为主账号设置新密码，如下图所示：

![resetpass](../images/userguide/resetpass.png)

重置密码成功后，即可使用最新设置的密码登录云平台，进行云平台资源的使用和管理。







# 3 虚拟机

## 3.1 概述

虚拟机是 UCloudStack 云平台的核心服务，提供可随时扩展的计算能力服务，包括 CPU 、内存、操作系统等最基础的计算组件，并与网络、磁盘、安全等服务结合提供完整的计算环境。通过与负载均衡、数据库、缓存、对象存储等服务结合共同构建 IT 架构。

- UCloudStack 云平台通过 KVM ( Kernel-based Virtual Machine ) 将物理服务器计算资源虚拟化，为虚拟机提供计算资源；
- 一台虚拟机的计算资源只能位于一台物理服务器上，当物理服务器负载较高或故障时，自动迁移至其它健康的物理服务器；
- 虚拟机计算能力通过虚拟 CPU ( vCPU ) 和虚拟内存表示，存储能力通过云存储容量和性能体现；
- 虚拟机管理程序通过控制 vCPU、内存及磁盘的 QoS ，用于支持虚拟机资源隔离，保证多台虚拟机在同一台物理服务器上互不影响；

虚拟机是云平台用户部署并运行应用服务的基础环境，与物理计算机的使用方式相同，提供创建、关机、断电、开机、重置密码、重装系统、升降级等完全生命周期功能；支持 Linux、Windows 等不同的操作系统，并可通过 VNC 、SSH 等方式进行访问和管理，拥有虚拟机的完全控制权限。虚拟机运行涉及资源及关联关系如下：

![VM_Arch](../images/userguide/VM_Arch.png)

如图所示，实例规格、镜像、VPC 网络是运行虚拟机必须指定的基础资源，即指定虚拟机的 CPU 内存、操作系统、虚拟网卡及 IP 信息。在虚拟机基础之上，可绑定云硬盘、弹性 IP 及安全组，为虚拟机提供数据盘、公网 IP 及网络防火墙，保证虚拟机应用程序的数据存储和网络安全。

在虚拟化计算能力方面，平台提供 GPU 设备透传能力，支持用户在平台上创建并运行 GPU 虚拟机，让虚拟机拥有高性能计算和图形处理能力。**支持透传的设备包括 NVIDIA 的 K80、P40、V100、2080、2080Ti、T4 及 华为 Atlas300** 等。

## 3.2 创建虚拟机

云平台用户可以通过指定机型、规格、镜像、云硬盘、VPC 网络、公网 IP、安全组及虚拟机相关基础信息一键创建多台虚拟机，用于部署自己的应用和服务。

### 3.2.1 前提条件

* 在创建虚拟机前，已拥有一个可登录云平台的账号，并已为账号充值金额；
* 在创建虚拟机前，需通过控制台左上角的【地域】选择需要创建并运行的虚拟机的数据中心；
* 确认用户所指定区域及账户的配额足够；若配额不足，需向云平台管理申请资源配额；
* 若不使用系统提供的默认安全组，需要在目标地域创建一个安全组并添加能满足用户业务需求的安全规则。

### 3.2.2 创建操作

1. 选择虚拟资源需运行的地域（数据中心）后，在左侧导航栏选择虚拟机，进入虚拟机控制台，点击“创建虚拟机” ，弹出虚拟机创建向导；

   ![vmbase](../images/userguide/vmbase_1.png)

2. 选择虚拟机的机型，并确定虚拟机运行的操作系统镜像；

   * 机型是运行虚拟机的宿主机的集群类型，代表不同架构、不同型号的 CPU 或硬件特征，可由管理员自定义，如 x86 机型、GPU 机型、ARM 机型等，通过 ARM 机型创建的实例为 ARM 版虚拟机实例，已适配国产芯片、服务器及操作系统，并可运行国产化操作系统，如 UOS 或 银河麒麟。
   * 镜像即虚拟机实例运行环境的模板，可以选择基础镜像和自制镜像；
     * 基础镜像是由平台官方默认提供，包括多发行版 Centos 、Ubuntu 及 Windows 等原生操作系统，同时基础镜像的默认时区为上海。
     * 自制镜像由用户通过虚拟机自行导出或自定义导入的自有镜像，可用于创建虚拟机，仅账号自身有权限查看和管理。
   
3. 选择虚拟机的规格配置，即定义提供计算能力的 CPU 内存及 GPU 配置，规格可由平台管理员进行自定义；

   * CPU 机型默认提供 1 核 2G 、2 核 4G 、4 核 8G 、8 核 16G 、16 核 32G 及 64 核 128G 等虚机规格；
   * 平台提供 GPU 设备透传能力，若机型为 GPU 机型，可创建并运行拥有 GPU 能力的虚拟机；
   * 针对 GPU 机型，平台支持最高配置 4 颗 GPU 芯片，为使 GPU 虚拟机发挥最佳性能，平台限制最小 CPU内存规格为 GPU 颗数的 4 倍以上，如 1 颗 GPU 芯片最小需要 4 核 8G 规格，2 颗 GPU 芯片最小需要 8 核16G 规格，4 颗 GPU 芯片最小需要 16 核 32G 规格。

4. 选择并配置虚拟机的系统盘和数据盘，可分别配置系统盘和云硬盘的容量。

  * 系统盘：运行虚拟机镜像的系统盘，创建虚拟机时必须选择系统盘类型及系统盘容量；
      * 选择系统盘的磁盘类型，如 SSD 磁盘 或 HDD 磁盘，磁盘类型可由管理员进行自定义；
      * 配置系统盘容量，Linux 和 Windows 镜像默认系统盘均为 40GB ，支持扩容系统盘容量至 500GB，步长为 1GB ，即容量应为 1GB 的倍数 。

  > 扩容系统盘是增加块设备的容量，并未对系统内的文件系统进行扩容，即系统盘扩容后需进入虚拟机内部进行文件系统的扩容(resize)操作，具体操作步骤详见：[系统盘扩容](#_317-系统盘扩容) 。

  * 数据盘：一种基于分布式存储系统为虚拟机提供持久化存储空间的弹性块设备，创建虚拟机支持同时创建一块云盘并自动绑定至虚拟机，同时会对硬盘进行自动格式化及挂载操作。
      * 默认数据盘挂载路径为 `/data` ，用户也可选择虚拟机创建后再添加数据云硬盘；
      * 选择并配置数据盘类型及容量，容量范围的规格可由管理员进行自定义；
      * 平台默认规格最小支持 10GB 容量，最大支持 8000GB，步长为 1GB ，即容量应为 1GB 的倍数。

5. 配置网络相关设置，包括虚拟机需要加入的 VPC 网络、子网、内网 IP 地址、内网安全组、外网 IP 及外网安全组等选项：

  ![vmbase1](../images/userguide/vmbase2.png)

  * VPC 网络是一个属于用户的、逻辑隔离的二层网络广播域环境。在一个 VPC 网络内，用户可以构建并管理多个三层网络，即子网（ Subnet ），VPC 私有网络是子网的容器，不同 VPC 间网络绝对隔离；
      * 创建虚拟机时必须选择 VPC 网络和所属子网，即选择虚拟要加入的网络及 IP 网段；
      * 控制台已为用户计算所选子网的可用 IP 数量，创建时需指定可用 IP 数量足够的子网；
      * 平台默认会从所属子网的网段中为虚拟机自动分配 IP 地址，可通过【内网 IP 】选项手动指定虚拟机的 IP 地址。
  * 安全组是平台提供的虚拟防火墙，提供出入双方向流量访问控制规则，定义哪些网络或协议能访问资源；
      * 外网安全组用于控制虚拟机南北向（外网 IP）的流量，内网安全组用于虚拟机东西向（网卡间）的安全访问控制；
      * 外网安全组和内网安全组默认为暂不绑定，可在创建虚拟机后再进行绑定；
      * 系统提供默认安全组，若无法满足需求，可自行创建安全组并绑定至虚拟机。
  * 外网 IP 为虚拟机提供的弹性外网出口服务，支持创建虚拟机时申请并绑定一个外网 IP 至虚拟机。平台支持 IPv4/IPv6  双栈网络，可在虚拟机创建成功后为虚拟机绑定多个外网 IP 地址，最多支持绑定 50 个 IPv4 和 10 个 IPv6 外网 IP 地址，并支持手动设置虚拟机默认出口。

  > 平台支持在虚拟机中查看已绑定的外网 IP 地址及网络路由，虚拟机访问外网的流量直接通过虚拟网卡透传至物理网卡与外部网络通信，提升网络传输的性能。

6. 选择并配置虚拟机基础管理配置，包括虚拟机名称、登录方式及登录密码等。

![vmmanager](../images/userguide/vmmanager1.png)

  * 虚拟机名称：平台默认配置名称为 `host` ，用户可自定义虚拟机名称，可通过名称进行搜索和筛选；
  * 登录方式：为虚拟机设置登录凭证，即登录虚拟机的密码；
      * CentOS 的管理员为 `root` ，Ubuntu 的管理员为 `ubuntu` ，Windows 系统的管理员名称为  `administrator` ；
      * Linux 操作系统可在虚拟机创建成功后，通过 SSH 密钥的方式进行登录及管理。

9. 选择购买数量和付费方式，如下图所示确认订单并点击“立即购买” 进行虚拟机创建操作。

![vmorder](../images/userguide/vmorder.png)

  * 购买数量：按照所选配置及参数批量创建多台虚拟机，最多可批量创建 10 台虚拟机，批量创建时不支持手动设置虚拟机的 IP 地址；
  * 付费方式：选择虚拟机的计费方式，支持按时、按年、按月三种方式，可根据需求选择适合的付费方式；
  * 合计费用：用户选择虚拟机 CPU、内存、数据盘、外网 IP 等资源按照付费方式的费用展示；
  * 立即购买：点击立即购买后，会返回虚拟机资源列表页，在列表页可查看该台主机的创建过程，通常会先显示“启动中”的状态，在1~2分钟内即可创建完成。

## 3.3 查看虚拟机

通过导航栏进入虚拟机控制台，可查看虚拟机资源的列表，通过列表上的虚拟机名称，可进入虚拟机详情，查看虚拟机及相关资源的详细信息。

### 3.3.1 虚拟机列表

虚拟机列表页可查看当前账户下已有的虚拟机资源列表，包括名称/备注、资源 ID、VPC、子网、机型、配置、 IP、计费方式、创建时间、过期时间、状态及操作等，同时也可通过“自定义列表”按钮，自定义列表所需信息。

![vmlist1](../images/userguide/vmlist2.png)

* 主机名称：虚拟机的名称和备注，可通过列表页的编辑按钮进行修改；
* 资源 ID：虚拟机的全局唯一 ID，可通过复制按钮对 ID 进行复制操作；
* VPC/子网：虚拟机创建时所指定的 VPC 网络和子网，即虚拟机 IP 所在的 VPC 网络和子网信息；
* IP 地址：虚拟机的 IP 地址，包括内网 IP 和外网 IP (若有)，并可通过复制按钮对 IP 地址进行复制操作；
* 机型：虚拟机所运行物理机的集群类型，代表不同架构、不同型号的 CPU 或硬件特征；
* 配置：虚拟机基本配置信息，包括 CPU 内存规格、GPU 颗数、系统盘镜像、系统盘总容量及数据盘总容量；
* 计费方式：虚拟机创建时指定的付费方式，包括按时、按月、按年；
* 创建时间/过期时间：虚拟机的创建时间和计费周期内的过期时间；
* 状态：虚拟机当前的运行状态，包括启动中、运行、关机中、关机、启动中、修改配置中、重装中、删除中及迁移中和宕机迁移中等；
* 操作：对单台虚拟机的更多操作，包括详情、登录、启动、关机、删除、断电、重启、续费、修改告警模板、制作镜像、重置密码、重装系统、热升级、绑定外网 IP、修改外网安全组、修改内网安全组、修改配置及获取 VNC 信息等。

默认列表每页可显示 10 条虚拟机信息，支持分页并设置每页可展示的虚拟机数量，每页最多可展示 100 条虚拟机数据，可通过搜索框对虚拟机列表进行搜索和筛选，支持模糊搜索。

为方便租户对虚拟机进行维护和操作，平台支持下载当前用户所拥有的所有虚拟机资源列表信息为 Excel  表格；同时支持对虚拟机的批量操作，包括批量启动、关机、断电及删除操作，可通过选中多个虚拟机，点击批量操作按钮进行批量操作，如下图所示：

![vmbatch](../images/userguide/vmbatch2.png)

### 3.3.2 虚拟机详情信息

在虚拟机列表上，点击虚拟机的名称或 ID 可进入当前虚拟机的概览页面查看虚拟机详情及监控信息，同时可切换到硬盘、网络及操作日志页面查看虚拟机的相关磁盘、网络、IP 地址、弹性网卡及操作日志信息，如下图概览页所示：

![vmdetails](../images/userguide/vmdetails2.png)

#### 3.3.2.1 虚拟机概览

**概览页面展示基本信息、配置信息及监控图表等信息，同时可通过概览页对虚拟机进行操作及管理。**

* 基本信息包括资源 ID、名称、内网 IP、VPC、子网、状态、创建时间及告警模板；
  * 可点击名称右侧按钮修改虚拟机的名称和备注信息；
  * 可点击告警模板右侧按钮修改虚拟机所关联的告警模板，虚拟机默认会绑定 Default 告警模板；
* 配置信息包括机型、镜像、CPU、内存、系统盘总容量和系统盘总容量，其中数据盘容量为当前虚拟机所关联所有云硬盘的容量之和；
* 监控图表：包括 CPU 使用率、内存使用率、空间使用率、网卡的出/入带宽、网卡的出/入包量、磁盘的读/写吞吐、磁盘的读/写次数、平均负载、 TCP 连接数和阻塞进程数量。

> 用户可开启监控图表右上角的【自动刷新】，使页面每隔 30 秒自动刷新，以获取最新监控图表数据。

#### 3.3.2.2 虚拟机硬盘

**磁盘页面展示当前虚拟机的系统盘及已挂载的数据盘信息，包括每个硬盘的名称、ID、集群架构、集群、硬盘类型、硬盘容量、挂载点、计费方式、状态、创建时间、过期时间及对单个硬盘的快照操作信息。如下图所示：**

![vmdiskinfo](../images/userguide/vmdiskinfo2.png)



* 集群架构是指虚拟机系统盘或数据盘所属物理机所在的集群架构，包括 HDD、SSD、NVME 等，代表集群的磁盘介质类型；
* 集群指虚拟机系统盘或数据盘所属物理机所在的集群，可由管理员自定义，如容量型或性能型等；
* 硬盘类型包括系统盘和数据盘，除系统盘外，额外绑定的云硬盘均为数据盘；
* 硬盘容量为每块硬盘的当前容量大小；
* 挂载点为硬盘在虚拟机中真实的挂载盘符，如 `vdb` ；
* 仅数据盘支持计费方式和过期时间信息，系统盘与虚拟机的生命周期一致。

在虚拟机硬盘管理列表的操作项中，支持对虚拟机的系统盘和数据盘进行扩容、续费及快照操作，其中续费仅支持数据盘，系统盘与虚拟机生命周期一致。

##### 3.3.2.2.1 硬盘快照

支持对系统盘和数据盘分别进行快照操作，快照仅捕获已写入硬盘的数据，不包含应用程序或操作系统缓存在内存中的数据，为确保快照中捕获所有应用程序的数据，建议将虚拟机关机或卸载数据盘后再进行快照。具体操作如下图所示：

![vmsnapshot](../images/userguide/vmsnapshot2.png)

##### 3.3.2.2.2 硬盘扩容

支持对系统盘和数据盘分别进行扩容操作，扩容云硬盘是增加块设备的容量，并未对系统内的文件系统进行扩容，即系统盘和数据盘扩容后需进入虚拟机内部进行文件系统的扩容(resize)操作，系统盘具体操作步骤详见：[系统盘扩容](#_317-系统盘扩容) 。

![upgradedisk](../images/userguide/upgradedisk2.png)

扩容会按照新容量进行收费，按小时付费的硬盘，升级容量下个付费周期按新配置扣费；按年按月付费的硬盘，升级容量即时生效，并按比例自动补差价。

##### 3.3.2.2.3 数据盘续费

支持在虚拟机中对已挂载至虚拟机的数据盘直接进行续费操作，续费时会按照续费时长收取费用，如下图所示：

![Renewdisk](../images/userguide/Renewdisk2.png)

云盘续费的时长与资源的计费方式相匹配，当数据盘的计费方式为【小时】，则续费时长可选择 1 至 24 小时；当数据盘的计费方式为【按月】，则续费时长可选择 1 至 11 月；当数据盘的计费方式为【按年】，则数据盘的续费时长为 1 至 5 年。

#### 3.3.2.3 虚拟机网络

**网络页面展示当前虚拟机的基本网络信息，同时可管理虚拟机的外网 IP 及弹性网卡资源 。**其中基本网络信息包括当前虚拟机的属 VPC、所属子网、内网 IP、外网安全组及内网安全组信息，并可通过安全组右侧的按钮更新虚拟机的外网安全组和内网安全组。如下图所示：

![vmnetinfo](../images/userguide/vmnetinfo2.png)

有关虚拟机的外网 IP 和弹性网卡资源详情及管理详见：[外网 IP 管理](#_3324-外网-IP-管理)和[弹性网卡管理](#_3325-弹性网卡管理)。

#### 3.3.2.4 外网 IP 管理

平台支持 IPv4/IPv6  双栈网络，每个虚拟机最多支持绑定 50 个 IPv4 和 10 个 IPv6 外网 IP 地址，默认以第一个有默认路由的 IP 地址（包括外网弹性网卡的 IP 地址）作为虚拟机的默认网络出口；同时在虚拟机中查看已绑定的外网 IP 地址及网络路由，虚拟机访问外网的流量直接通过虚拟网卡透传至物理网卡与外部网络通信，提升网络传输的性能。

外网 IP 信息包括虚拟机及绑定的外网弹性网卡 IP ，仅支持将有默认路由的外网 IP 设为虚拟机默认网络出口。可通过列表信息查看已绑定外网 IP 的详细信息及相关管理操作，如图所示已绑定外网 IP 信息包括 IP 地址、IP 版本、出口、带宽、路由类型、绑定时间及状态。

* IP 指当前已绑定外网 IP 的 IP 地址及网段名称（网段是由平台管理员自定义的外网 IP 地址池）；
* IP 版本是指当前已绑定外网 IP 的 IP 版本，包括 IPv4 和 IPv6 ；
* 出口指当前 IP 是否为虚拟机的默认出口，一台虚拟机最多支持两个默认出口（IPv4 和 IPv6 各一个）；
* 带宽指当前 IP 地址的带宽上限，带宽上限由申请外网 IP 地址时指定；
* 路由类型指当前 IP 地址所属网段下发路由的类型（网段路由策略由平台管理员自定义），包括默认路由和非默认路由，仅支持将有默认路由的外网 IP 设为虚拟机默认网络出口。
  * 默认路由类型指虚拟机绑定该 IP 地址时，会自动下发目标地址为 `0.0.0.0/0`  的路由到虚拟机中；
  * 非默认路由指虚拟机绑定该 IP 地址时，会下发管理员为网段配置的指定目标地址路由，如为虚拟机下发目标地址为 `10.0.0.0/24` 的路由；
  * 若绑定至虚拟机的多个外网 IP 地址均为默认路由类型，默认以第一个有默认路由的 IP 地址作为虚拟机的默认出口。

用户可通过外网 IP 管理控制台的操作项，进行外网 IP 地址的绑定、解绑及设为默认出口操作，并支持批量解绑。

> 绑定至虚拟机的外网弹性网卡的 IP 地址同时会展示至外网 IP 列表，支持设为出口操作但不支持解绑，可通过解绑弹性网卡进行弹性网卡外网 IP 的解绑和释放。

##### 3.3.2.4.1 绑定外网 IP

最多支持绑定  50 个 IPv4 和 10 个 IPv6 外网 IP 地址，默认以第一个有默认路由的 IP 地址作为虚拟机的默认网络出口。

![vmbindeip](../images/userguide/vmbindeip2.png)

绑定成功后，可在虚拟机中查看已绑定的 IP 地址已配置在虚拟机的第二块网卡上，本章节以 `Centos` 操作系统为例，如下图所示：

![ipeth1](../images/userguide/ipeth1.png)

##### 3.3.2.4.2 解绑外网 IP

支持虚拟机解绑外网 IP 地址，若解绑了默认出口外网IP，则自动选择下一个有默认路由的外网 IP 作为虚拟机的默认网络出口。

![vmunbindeip](../images/userguide/vmunbindeip2.png)

绑定至虚拟机的外网弹性网卡 IP 不支持解绑操作，如需解绑弹性网卡的 IP 地址，可直接解绑弹性网卡。

##### 3.3.2.4.3 设为默认出口

支持用户手动将一个已绑定的外网 IP 设置为虚拟机的默认网络出口，仅支持将有默认路由的外网 IP 设为虚拟机默认网络出口。用户可通过虚拟机外网 IP 管理控制台，为虚拟机绑定的 IPv4 和 IPv6 外网 IP 分别设置默认网络出口。如下图所示：

![vmsetgw](../images/userguide/vmsetgw.png)

设为出口后，可登录虚拟机验证虚拟机访问外网的 IP 地址是否为设置的外网 IP 地址，本节以 Centos 7.4 系统设置 IPv4 默认出口为 `106.75.234.39` 为例，如下图所示，已绑定外网 IP 地址列表已将新 IP 地址设置为出口：

![vmsetgw1](../images/userguide/vmsetgw1.png)

登录 Centos 虚拟机，输入 `curl ifconfig.io` 查看虚拟机访问外网的出口已更换为 `106.75.234.39`，如下图输出结果所示：

![curlifconifg](../images/userguide/curlifconifg.png)

> 外网 IP 地址池资源由管理员自定义，支持使用私有 IP 地址段模拟公网 IP 地址，并在上层物理网络设备上做 NAT 转换访问互联网或 IDC 数据中心网络。

#### 3.3.2.5 弹性网卡管理

x86 架构虚拟机最多支持绑定 6 块弹性网卡，ARM 架构虚拟机最多支持绑定 3 块网卡，用于精细化网络管理或高可用业务等应用场景。虚拟机中可查看已绑定的弹性网卡及关联的 IP 地址等信息，在 `Linux` 操作系统中通常会以 `eth2` 开始命名。

![vnniclist](../images/userguide/vnniclist.png)

如上图所示，弹性网卡标签页可查看当前虚拟机已绑定的弹性网卡列表信息及解绑操作，支持批量解绑操作。已绑定的弹性网卡信息包括名称、ID、网卡类型、所属网络、IP 地址、安全组及状态信息。

* 网卡类型：指当前绑定至虚拟机的弹性网卡类型，包括内网网卡和外网网卡。
  * 内网类型的弹性网卡仅可从关联的 VPC 子网中自动或手动分配 IP 地址。
  * 外网类型的弹性网卡仅可从关联的外网网段中自动或手动分配 IP 地址，且分配的 IP 地址与弹性网卡生命周期一致，仅支持随弹性网卡销毁而释放。
* 所属网络：弹性网卡的 IP 地址所属网络，内网类型的所属网络为弹性网卡所在的 VPC 网络和子网信息；外网类型的所属网络为弹性网卡所属外网网段信息。

* IP 地址：指当前弹性网卡的 IP 地址，内网类型的网卡 IP 为 VPC 子网分配的内网 IP 地址，外网类型的网卡 IP 为所属外网网段分配的外网 IP 地址。
* 安全组：指当前弹性网卡已绑定的安全组，若未绑定安全组，则为空。平台安全组为作用于网卡，即每块弹性网卡均可指定属于自己的安全组，分别对所关联的网卡进行流量控制。

支持在虚拟机详情中，将已绑定的弹性网卡进行解绑，解绑后可将弹性网卡绑定至其它虚拟机，通过已绑定弹性网卡列表操作项中的解绑操作可对网卡进行解绑，具体操作如下：

![vmunbindnic](../images/userguide/vmunbindnic2.png)



## 3.4 VNC 登录

VNC（ Virtual Network Console ）是 UCloudStack 为用户提供的一种通过 WEB 浏览器连接虚拟机的登录方式，适应于无法通过远程登录客户端（如 SecureCRT、远程桌面等）连接虚拟机的场景。通过 VNC 登录连到虚拟机，可以查看虚拟机完整启动流程，并可以像 SSH 及 远程桌面一样管理虚拟机操作系统及界面，支持发送操作管理指令，如  `CTRL+ALT+DELETE`。

用户可通过虚拟机列表或详情概览页面操作中的“**登录**”按钮，使用 VNC 链接登录当前虚拟机，提供如同显示器的功能，可登入虚拟机操作系统，对虚拟机进行系统级别的操作和管理。如下图所示：

![vmvnc](../images/userguide/vmvnc.png)

> 登录虚拟机的前提条件是拥有操作系统账号和密码，VNC 登录适合虚拟机没有外网 IP 地址的场景。

## 3.5 启动/关机/断电/重启

用户可以对虚拟机进行关机、启动、断电及重启等基本操作，且均支持多台 API 批量操作。如下图所示：

![vmoperating](../images/userguide/vmoperating.png)

* 关机
  * 用户可使用系统命令进行关机，如 Windows 系统下的关机和 Linux 系统下的 shudown 命令；
  * 支持用户通过控制台点击【关机】进行关机操作，关机时虚拟机的状态必须为运行状态；
  * 虚拟机关机时，状态会从运行转换为关机中，最后转换为已关机，代表关机成功；
  * 若虚拟机卡在关机中，支持对虚拟机进行断电操作；
  * 关机后，虚拟机的内存信息丢失，所有磁盘的数据将被保留；
  * 关机后可进行启动、删除、制作镜像、重装系统、修改配置、绑定外网 IP及修改安全组等操作。
* 启动
  * 用户可通过控制台点击【启动】按钮开启虚拟机，仅在虚拟机状态为已关机时可用；
  * 虚拟机开启时，状态会从已关机转换为启动中，最后转换为运行，代表启动成功；
  * 若虚拟机卡在启动中，支持对虚拟机进行断电操作；
  * 运行的虚拟机可执行关闭、登录、删除、断电、重启、重置密码、热升级、绑定外网 IP 、修改安全组及修改告警模板等操作。
* 断电
  * 断电是将虚拟机强行关机，与物理机直接断电操作相同，断电操作可能导致丢失数据甚至损坏操作系统；
  * 断电操作适用于虚拟机死机及极端测试的场景，可通过虚拟机列表操作中的“断电”按钮，对虚拟机进行强行关机操作；
  * 强行关机时，虚拟机直接会进入关机状态，可再次进行启动操作。
* 重启
  * 重启是将虚拟机的操作系统进行正常的重新启动，与物理机操作系统重启操作一致；
  * 虚拟机重启时，状态会从运行转换为重启中，最后转换为运行；
  * 若虚拟机卡在重启中，支持对虚拟机进行断电操作；
  * 重启后，虚拟机的内存信息丢失，所有磁盘的数据将被保留。

## 3.6 制作镜像

自制镜像由云平台账户通过虚拟机自行导出，可用于创建虚拟机，仅账户自身有权限查看和管理，仅支持**虚拟机关机状态下制作镜像**，即在关机状态才可进行虚拟机导出为镜像操作。

用户可通过点击虚拟机列表操作中的“制作镜像” 按钮进行镜像制作，需输入镜像名称及镜像描述，如下图所示：

![creatimage](../images/userguide/createimage2.png)

* 镜像名称：自制镜像的名称和标识；
* 镜像描述：自制镜像的描述和备注信息，可选项；

制作镜像过程中，请勿对虚拟机进行停止、启动、断电、重装系统或修改配置等操作，以免影响镜像制作过程。镜像制作成功后，会展示在虚拟机控制台——镜像管理页面，可通过页面查看镜像的制作过程，待镜像状态转换为可用时，即可使用自制镜像创建虚拟机。

> 通过虚拟机制作镜像时，仅导出系统盘的数据和信息，不支持数据盘。

## 3.7 重装系统

重装系统是重置虚拟机的操作系统，即更换虚拟机镜像，Linux 虚拟机仅支持更换 Centos 和 Ubuntu 操作系统，Windows 虚拟机仅支持更换 Windows 其它版本的操作系统，重装系统的前提是虚拟机必须为关机状态。

虚拟机关机后，通过虚拟机控制台操作中的“重装系统”按钮更换虚拟机的镜像，如下图所示，可以在重装时进行密码重置操作：

![vmreinstall](../images/userguide/vmreinstall_1.png)

重装系统将会自动清除虚拟机已创建的系统盘快照，可通过制作镜像对虚拟机系统盘数据进行备份。在重装系统过程中，虚拟机的状态自动转换为“重装中”，重装成功后转换为“关机”，可以通过启动操作开启虚拟机，虚拟机启动时，会使用新的镜像运行虚拟机。

> 注：重装系统后，虚拟机之前操作系统及数据内容将被清空，挂载的云硬盘及快照不受影响。

## 3.8 重置密码

重置密码是指在线修改虚拟机操作系统的登录密码，适应于忘记登录密码或想通过控制台快速修改密码的场景。

Linux 操作系统是修改 `root` 账号的密码，Windows 操作系统是修改 `administrator` 账号的密码。重置密码时虚拟机必须运行状态。用户通过点击虚拟机控制台操作中的“重置密码”按钮进行密码的重置，如下图所示：

![vmresetpd](../images/userguide/vmresetpd2.png)

* 虚拟机名称：当前需要修改密码的虚拟机名称和标识；
* 管理员密码/确认密码：需要修改的新密码；
* 若用户主动修改了虚拟机操作系统的管理员账号，则无法进行密码重置；

> 请勿在制作镜像过程中重置密码，用户也可以通过登录操作系统，使用操作系统命令或界面进行密码修改。

## 3.9 修改配置（升降级）

修改配置即更改虚拟机的 CPU  和内存规格，支持升级和降级，适应于业务发生变化需调整虚拟机配置的场景。

修改配置前需将虚拟机进行关机，即必须在关机状态下进行配置修改操作，配置变更后，需重新启动才可生效。用户可点击虚拟机控制台资源列表操作中的“修改配置” 进行虚拟机 CPU 内存的调整，如下图所示：

![vmupspec](../images/userguide/vmupspec2.png)

虚拟机降级配置，下个付费周期按新配置扣费。按小时付费的虚拟机，升级配置下个付费周期按新配置扣费；按年按月付费的虚拟机，升级配置即时生效，并按比例自动补差价。

* 虚拟机 ID 和名称：当前需要变更规格配置的虚拟机名称和全局唯一 ID 标识；
* 计费方式：当前虚拟机的付费方式；
* 目前规格：当前虚拟机变更前的 CPU 内存配置；
* 更改规格：当前虚拟机需要变更的新规格配置，支持升级或降级配置；
* 预计收费：变更配置后，系统预计需要扣除的费用；

点击确定后，虚拟机依然处于关机状态，下次启动时，会使用新变更的配置运行虚拟机。用户可在虚拟机开机后，登录操作系统查看变更后的配置。

> 修改配置仅对 CPU 内存生效，若虚拟机附带 GPU 能力，不支持对 GPU 颗数进行升降配。

## 3.10 热升级

虚拟机提供热升级能力，支持虚拟机开机状态下升级 CPU 和内存。使用热升级前，需先熟悉以下基本概念：

* 修改配置： 即在虚拟机关机状态下，升级或者降级虚拟机的CPU 和内存规格；
* 热升级： 即在虚拟机开机（running ）状态下，支持升级虚拟机的CPU、内存；
* Base镜像：即基础镜像，用户可以通过Base镜像启动一台虚拟机，并基于该虚拟机制作一个自定义镜像。

> 注：目前仅支持 Base 镜像为 Centos7.4 的虚拟机热升级，不支持在线降级操作。

平台支持热升级的虚拟机，在列表上会自动显示支持热升级，如下图所示：

![hotupgrade](../images/userguide/hotupgrade.png)

（1）当用户看到热升级提示后，可通过列表操作项中的 “**热升级**” 对该虚拟机进行在线配置调整，如下图：

![hotupgrade1](../images/userguide/hotupgrade1.png)

（2）在热升级的向导中，可以对虚拟机的 CPU 内存规格进行热升级操作，热升级后立即生效，按小时购买的虚拟机下个付费周期按新配置扣费，按年按月购买的虚拟机按比例自动补差价，如下图所示：

![hotupgrade2](../images/userguide/hotupgrade3.png)

> 若用户自定义镜像，其 Base 镜像是基于 Centos7.4 制作的，则默认允许热升级操作。

## 3.11 修改告警模板

修改告警模板是对虚拟机的监控数据进行告警的配置，通过告警模板定义的指标及阈值，可在虚拟机相关指标故障及超过指标阈值时，触发告警，通知相关人员进行故障处理，保证虚拟机及业务的正常运行。

用户可点击虚拟机详情概览页中告警模板右侧的按钮进行告警模板修改操作，在修改告警模板向导中选择新虚拟机告警模板，点击确定立即生效。

![vmalarm](../images/userguide/vmalarm.png)

* 资源 ID ：当前需要添加或修改告警模板的虚拟机 ID ；
* 资源类型：当前需要添加或修改告警模板的资源类型；
* 告警模板：需要变更的告警模板，一台虚拟机仅支持关联一个告警模板。

> 若系统提供的默认告警模板无法满足需求时，可前往“告警模板”页面进行添加和配置。

## 3.12 绑定外网 IP

绑定外网 IP 指将租户外网 IP 地址绑定至虚拟机，为虚拟机提供外部网络出口。平台支持 IPv4/IPv6  双栈网络，每个虚拟机最多支持绑定 50 个 IPv4 和 10 个 IPv6 外网 IP 地址，同时也可将外网弹性网卡绑定至虚拟机提供外网通信能力，默认以第一个有默认路由的 IP 地址作为虚拟机的默认网络出口。

绑定外网 IP 地址后，平台会将指定的外网 IP 地址配置至虚拟机的网卡，包括外网 IP 地址所属网段的网关、子网掩码及路由相关信息，用户可在虚拟机中查看已绑定的外网 IP 地址及网络路由，虚拟机访问外网的流量直接通过虚拟网卡透传至物理网卡与外部网络通信，提升网络传输的性能。

每台虚拟机创建时会自带两张默认网卡，分别为内网网卡和外网网卡，以 Linux 操作系统为例，内网网卡一般为为 `eth0` ，外网网卡一般为 `eth1` ，默认绑定的外网 IP 均会被配置在虚拟机的 `eth1`  ，即 50 个外网 IP 均会被绑定至外网网卡，并共用虚拟机的外网安全组；在虚拟机绑定外网弹性网卡时，会在虚拟机中直接增加一张弹性网卡，并自动配置外网弹性网卡配置 IP  地址及安全组策略。

![vmbindeip](../images/userguide/vmbindeip2.png)

虚拟机必须处于运行或关机状态才可进行外网 IP 绑定，可通过虚拟机管理控制台列表或虚拟机详情网络管理的操作项“绑定外网 IP” 按钮，进行外网 IP 绑定操作，具体操作步骤可参考[虚拟机外网 IP 管理](#_3324-外网-IP-管理) 。绑定操作需指定要绑定的外网 IP 地址，仅支持绑定 50 个 IPv4 和 10 个 IPv6 外网 IP 地址。

* 若虚拟机已绑定 50 个 IPv4 外网 IP 地址，则不可再次绑定 IPv4 外网 IP 地址；
* 若虚拟机已绑定 10 个 IPv6 外网 IP 地址，则不可再次绑定 IPv6 外网 IP 地址；
* 若虚拟机已同时绑定 50 个 IPv4  和 10 个 IPv6 外网 IP 地址，则无法再绑定外网  IP 地址，可继续增加外网弹性网卡。

外网 IP 地址绑定成功后，可通过虚拟机列表 IP 信息查看已绑定的外网 IP 地址，用户也可通过虚拟机详情网络管理的外网 IP 标签页查看已绑定外网 IP 地址的详情信息，并可进行设为默认出口及解绑等相关操作。

![vmeiplist](../images/userguide/vmeiplist.png)

> 仅支持绑定同一数据中心的外网 IP 地址，被绑定的外网 IP 必须处于未绑定状态。如需解绑虚拟机的外网 IP 地址，详参考：[虚拟机外网 IP 管理](#_3324-外网-IP-管理)  。

## 3.13 修改安全组

平台用户创建的虚拟机，默认会自带两个与虚拟机生命周期一致的虚拟网卡，即内网网卡和外网网卡，同时也可在虚拟机上绑定弹性网卡资源。

* 内网网卡：配置虚拟机创建时指定 VPC/子网的 IP 地址及相关网络信息；
* 外网网卡：配置绑定至虚拟机的所有外网 IP 地址，包括 50 个 IPv4 和 10 个 IPv6 地址；
* 弹性网卡：配置弹性网卡所属网络所分配的 IP 地址及安全组，若弹性网卡为内网类型则所属网络为 VPC 和子网，若弹性网卡为外网类型则所属网络为外网网段。

云平台安全组（软件定义的虚拟防火墙）为网卡级别，即绑定的安全组会对虚拟机中网卡流量做出入限制。平台将绑定至虚拟机内网网卡的安全组定义为内网安全组；绑定至虚拟机外网网卡安全组定义为外网安全组；绑定至弹性网卡的安全组为弹性网卡的所属安全组。

**内网安全组用于虚拟机东西向（网卡间）的安全访问控制；外网安全组用于控制虚拟机南北向（外网 IP）的流量。**在创建虚拟机时可进行内网安全组和外网安全组的指定，同时在虚拟机运行后也可修改内网安全组和外网安全组。

### 3.13.1 修改外网安全组

修改外网安全组是指修改虚拟机外网网卡所关联的安全组，即更改绑定至外网网卡上所有外网 IP 地址的安全组。

用户可通过虚拟机列表及虚拟机详请网络页面的“修改外网安全组”按钮进行操作，如下图所示：

![vmbindsg](../images/userguide/vmbindsg.png)

选择需修改的的外网安全组，一台虚拟机仅支持绑定一个外网安全组。修改成功后，用户可通过虚拟机详情的网络信息查看已修改的外网安全组信息。

> 外网安全组规则的访问限制作用于当前虚拟机所绑定的所有外网 IP 。

### 3.13.2 修改内网安全组

修改内网安全组是指修改虚拟机内网网卡所关联的安全组，即更改虚拟机内网的安全策略，用于虚拟机与虚拟机间的流量管控。用户可通过虚拟机列表及虚拟机详请网络页面的“修改内网安全组”按钮进行操作，如下图所示：

![vmbindnwsg.png](../images/userguide/vmbindnwsg.png)

选择需要修改的内网安全组，支持修改为 “暂不绑定” 用于解绑内网安全组，一台虚拟机仅支持绑定一个内网安全组。修改成功后，用户可通过虚拟机详情的网络信息查看已修改的内网安全组信息。

> 内网安全组和外网安全组支持绑定同一个安全组，即内外网安全组使用相同的安全组及策略。

## 3.14 修改名称和备注

修改虚拟机的名称和备注，在任何状态下均可进行操作。点击虚拟机列表页面虚拟机名称右侧的按钮即可进行修改，如下图所示：

![vmname](../images/userguide/vmname.png)

## 3.15 虚拟机续费

支持用户手动对虚拟机进行续费，续费操作只针对资源本身，不对资源额外关联的资源进行续费，如外网 IP、云硬盘、外网弹性网卡等。额外关联的资源到期后，会自动解绑，为保证业务正常使用，需及时对相关资源进行续费操作，如下图所示：

![renewvm](../images/userguide/renewvm1.png)

虚拟机续费时会按照续费时长收取费用，续费时长与资源的计费方式相匹配，当虚拟机的计费方式为【小时】，则续费时长可选择 1 至 24 小时；当虚拟机的计费方式为【按月】，则续费时长可选择 1 至 11 月；当虚拟机的计费方式为【按年】，则虚拟机的续费时长为 1 至 5 年。

## 3.16 获取 VNC 登录信息

支持用户获取虚拟机的 VNC 登录信息，适用于使用 VNC 客户端连接虚拟机的场景。如桌面云场景中，桌面云服务商的桌面终端通常会以 VNC、Spice 及 RDP 等协议连接平台提供的桌面虚拟机，其中 VNC 和 Spice 协议基本作为桌面服务商的通用协议。

用户可通过 API 接口或虚拟机控制台操作项中的【获取 VNC 信息】查看虚拟机的 VNC 登录信息，包括虚拟机 ID、VNCIP 地址、VNC 端口及 VNC 客户端登录密码，如下图所示：

![getvncinfo](../images/userguide/getvncinfo.png)

* VNCIP 地址：当前云平台外网 IP 地址池中分配的地址，可访问外网 IP 地址的网络均可使用 VNCIP:端口和密码通过 VNC 客户端连接虚拟机，如 VNCView 客户端软件。
* VNC  端口：VNC 登录时使用的端口，为保证安全平台会在每次获取 VNC 信息时更换一个未被使用的端口。
* VNC 密码：VNC 登录时使用的密码，每一次查看均会根据算法随机提供新的  VNC 登录密码，为保证虚拟机 VNC 登录安全性（场景举例：用户首次使用 VNC 登录虚拟机后，通过虚拟机操作系统的登录密码进入到桌面或命令行，则下一次登录 VNC 会自动进入至桌面和命令行，对用户的虚拟机带来不可避免的安全隐患。）

为确保 VNC 连接的安全性，每一次调用 API 或通过界面所获取的 VNC 登录信息有效期为 300 秒，如果 300 秒内用户未使用 IP 和端口进行连接，则信息直接失效，需要重新获取新的登录信息；同时用户使用 VNC 客户端登录虚拟机后，300 秒内无任何操作将会自动断开连接。

> 用户在使用云平台时，至少会提供的一段可访问到云平台的外网 IP 网段，VNC IP 地址即为该网段中分配的 IP 地址，以确保网络可达。

用户可在网络可达平台的环境中，使用诸如 VNCView 客户端登录平台虚拟机，如下图所示：

![vncviewlogin](../images/userguide/vncviewlogin.png)

![vncviewlogin1](../images/userguide/vncviewlogin1.png)

## 3.17 删除虚拟机

平台用户可在控制台删除账户内已关机或正在运行的虚拟机资源，支持批量删除。虚拟机被删除后自动进入“**回收站**”，可通过回收站进行还原或彻底销毁。可通过虚拟机列表操作项中的“删除”进行操作，如下图所示：

![rmvm](../images/userguide/rmvm.png)

* 删除虚拟机时会自动解绑虚拟机已绑定的外网 IP、弹性网卡、云硬盘等资源；
* 若虚拟机已添加至 NAT 网关白名单或负载均衡的服务节点中，删除虚拟机时会自动进行解绑操作；

- 支持用户在删除虚拟机时选择删除已绑定的资源，即自动解绑并删除已绑定的外网 IP、弹性网卡及云硬盘；
- 删除虚拟机时同时删除的外网 IP 和云硬盘将自动进入回收站，同时删除的弹性网卡将被彻底销毁；
- 若虚拟机过期，在允许时间内未续费成功，则虚拟机会被自动回收，关联的资源将自动解绑。

虚拟机删除后，随虚拟机创建的 2 个默认网卡、系统盘及系统盘数据将随虚拟机一起进入回收站，可进入回收站对虚拟机进行销毁或恢复操作。

> 随虚拟机同时进入回收站的外网 IP 及云硬盘在恢复时，不会保持原有绑定关系，需重新进行资源绑定操作。

## 3.18 远程登录

远程登录是指通过远程管理客户端软件通过网络远程登录并管理虚拟机，针对 Linux 和 Windows 的虚拟机分别提供不同的方式进行远程登录。远程登录的前提条件为虚拟机必须绑定外网 IP 地址，并可通过外网正常访问服务器的远程登录端口（ Linux SSH 为 22 、Windows 远程桌面为 3389 ）。

### 3.18.1 远程登录 Linux

为方便验证，本手册假设本地用的客户端操作系统为 Linux 或 Mac OS ，即默认自带 SSH 客户端，可通过命令行直接使用 SSH 命令登录远端 SSH 服务端。具体操作步骤为：

1. 为需要远程登录的虚拟机绑定外网 IP 地址且外网安全组允许 SSH 22 端口访问，如下图所示：

![sshlogin](../images/userguide/sshlogin.png)

2. 用户打开系统自带的终端 （Terminal）并输入 SSH 命令登录：`ssh root@虚拟机的外网 IP 地址` ,如下例：

```bash
# ssh root@106.75.234.31
```

3. 输入虚拟机的登录密码，即可直接登录 Linux 服务器，如下图所示即代表登录成功。

![sshlogin1](../images/userguide/sshlogin1.png)

### 3.18.2 远程登录 Windows

为方便验证，本手册假设本地用的客户端操作系统为 Mac OS ，使用微软远程桌面连接 MAC 版程序 [RDC](http://downinfo.myhostadmin.net/RDC.dmg) 进行登录，操作步骤同 Windows 远程桌面相同，仅需要在工具输入 Windows 的公网 IP 地址即可连接，如下图所示：

![rdc](../images/userguide/rdc.png)

> 远程桌面连接的前提是虚拟机必须绑定外网 IP 地址，且绑定的外网安全组允许 3389 端口通行，若在操作系统内部修改了远程桌面的默认端口，则安全组需允许修改后的端口通行。

## 3.19 系统盘扩容

虚拟机默认系统盘容量为 40GB ，平台支持用户对系统盘容量进行扩容，最大支持扩容至 500GB 。默认 40GB 系统盘容量不能满足业务需求时，可指定所需系统盘容量进行虚拟机的创建，如下图指定 200GB 系统盘容量创建虚拟机，则创建的虚拟机系统盘块设备容量即为 200GB 。

![sysdiskresize](../images/userguide/sysdiskresize2.png)

对系统盘容量的扩容，是对系统盘块设备的容量扩容，并未对虚拟机操作系统内的文件系统进行扩容操作，即系统盘扩容后需进入虚拟机内部进行文件系统的扩容（resize）操作。

针对不同类型的操作系统分区扩容操作有所不同，如 Windows 通常使用自带的磁盘管理工具进行扩容操作。根据不同 OS 系统盘扩容场景大致分类如下：

* Linux 系统盘分区扩容
* Windows 系统盘分区扩容

在执行系统内分区扩容及文件系统扩展前，需保证已在控制台对系统盘的存储容量进行调整。

### 3.19.1 Linux 系统盘分区扩容

Linux 系统通常使用 `growpart` 和 `resize2fs` 工具完成系统盘分区扩容及文件系统扩展操作。 本示例以 Centos 7.4 操作系统为例 ，具体操作如下：

1、安装  `growpart` 文件系统扩容工具。

* Centos

  ```bash
  yum install -y epel-release
  yum install -y cloud-utils
  ```

* Ubuntu

  ```bash
  sudo apt-get install cloud-initramfs-growroot
  ```

2、通过 `fdisk -l ` 查看系统盘容量为 200GB ，运行 `df -Th` 查看系统盘分区`/dev/vda1` 容量为 40GB ，文件系统类型为 ext4 。

```bash
[root@localhost ~]# fdisk -l

磁盘 /dev/vda：214.7 GB, 214748364800 字节，419430400 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000ba442

   设备 Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048    83883775    41940864   83  Linux
[root@localhost ~]# 
[root@localhost ~]# df -Th
文件系统       类型      容量  已用  可用 已用% 挂载点
devtmpfs       devtmpfs  1.9G     0  1.9G    0% /dev
tmpfs          tmpfs     1.9G     0  1.9G    0% /dev/shm
tmpfs          tmpfs     1.9G  8.4M  1.9G    1% /run
tmpfs          tmpfs     1.9G     0  1.9G    0% /sys/fs/cgroup
/dev/vda1      ext4       40G  1.4G   36G    4% /
tmpfs          tmpfs     382M     0  382M    0% /run/user/0
```

3、运行 `growpart <DeviceName> <PartionNumber>` 命令扩容分区并重启虚拟机，本示例`growpart /dev/vda 1` 表示扩容系统盘的分区 1 的容量。

```bash
[root@localhost ~]# LANG=en_US.UTF-8
[root@localhost ~]# growpart /dev/vda 1
CHANGED: partition=1 start=2048 old: size=83881728 end=83883776 new: size=419428319 end=419430367
[root@localhost ~]# reboot
```

4、待虚拟机重启后，扩展虚拟机系统盘的文件系统，不同文件系统类型使用不同的方式进行扩展。

* ext 类型的文件系统，可使用`resize2fs <PartitionName> ` 工具进行扩容，如下所示：

  ```bash
  [root@localhost ~]# resize2fs /dev/vda1
  resize2fs 1.42.9 (28-Dec-2013)
  Filesystem at /dev/vda1 is mounted on /; on-line resizing required
  old_desc_blocks = 5, new_desc_blocks = 25
  The filesystem on /dev/vda1 is now 52428539 blocks long.
  ```

* 若xff 类型的文件系统，可使用 `xfs_growfs <mountpoint>` 工具进行扩容。

5、运行 `df -Th` 查看系统盘分区`/dev/vda1` 容量为 200GB 。

```bash
[root@localhost ~]# df -Th
文件系统       类型      容量  已用  可用 已用% 挂载点
devtmpfs       devtmpfs  1.9G     0  1.9G    0% /dev
tmpfs          tmpfs     1.9G     0  1.9G    0% /dev/shm
tmpfs          tmpfs     1.9G  8.3M  1.9G    1% /run
tmpfs          tmpfs     1.9G     0  1.9G    0% /sys/fs/cgroup
/dev/vda1      ext4      197G  1.5G  187G    1% /
tmpfs          tmpfs     382M     0  382M    0% /run/user/0
```

### 3.19.2 Windows 系统盘分区扩容

Windows 系统通常使用"管理工具——计算机管理" 中的 “磁盘管理” 工具进行扩展卷操作。具体操作如下：

1、在磁盘管理工具中选择操作>重新扫描磁盘，用于识别新扩容的未分配空量空间，如下图 20GB 未分配空间；

![sysdisk_step1](../images/userguide/sysdisk_step1.jpg)

2、右键点击 C 盘，选择扩展卷，对系统盘进行扩展卷操作。

![sysdisk_step2](../images/userguide/sysdisk_step2.jpg)

3、在扩展卷向导中，使用默认配置进行扩展卷操作。

![sysdisk_step3](../images/userguide/sysdisk_step3.jpg)

4、扩展卷操作完成后，新增系统盘容量会自动合并至 C 盘，代表系统盘文件系统扩展成功。

# 4 自制镜像管理

自制镜像归属于云平台租户，用户从虚拟机导出的自制镜像及自定义上传导入的镜像均属于自制镜像，平台管理员、租户及有权限的子账号均有权限查看和管理。

自制镜像可用于创建虚拟机，并支持用户下载虚拟机镜像到本地，同时镜像管理支持查看镜像、修改名称和备注、从镜像创建虚拟机、导入镜像、下载镜像及删除镜像等生命周期管理。

## 4.1 查看自制镜像

通过导航栏进入虚拟机控制台，切换至镜像管理页面可查看当前账户下自制镜像资源的列表及相关详细信息，包括镜像名称、资源 ID、系统类型、操作系统、状态及操作项，如下图所示：

![selfimage1](../images/userguide/selfimage11.png)

- 镜像名称/资源 ID：当前自制镜像的名称及全局唯一 ID 标识；
- 系统类型：代表当前自制镜像的操作系统类型，如 Linux、 Windows、Kylin 等；
- 操作系统：指当前自制镜像的基础操作系统发行版，如 CentOS 7.4 x86_64 ；
- 状态：当前自制镜像的状态，包括创建中、导入中、导入失败、可用、删除中、已删除；
  - 创建中：通过虚拟机自制镜像过程中，镜像的状态为创建中；
  - 导入中：用户通过导入镜像功能导入镜像的过程中，镜像的状态为导入中；
  - 导入失败：指用户导入镜像失败；
  - 可用：指当前镜像为可用状态，可创建虚拟机或进行下载；
  - 删除中：指当前镜像被删除中；
  - 已删除：指当前镜像已被删除，并进入回收站。
- 操作：对单个自制镜像的操作，包括从镜像创建虚拟机、下载镜像及删除镜像；

为方便租户对镜像资源进行维护和操作，平台支持下载当前用户所拥有的所有自制镜像资源列表信息为 Excel 表格，同时支持对自制镜像进行批量删除操作，可通过选中多个自制镜像，点击批量删除按钮进行批量操作。

平台支持用户导入自定义镜像，列表上为用户提供自行制作镜像文档，可通过查看文档阅读镜像制作及格式转换的操作步骤，方便镜像导入和业务迁移。

## 4.2 从镜像创建虚拟机

从镜像创建主机指通过自制或自定义导入的镜像重新创建一台虚拟机，创建的虚拟机使用自制镜像启动，虚拟机中的程序及数据保持自制镜像的创建时的状态。

用户可通过镜像管理资源列表的操作项“从镜像创建主机”进行创建，如下图所示，虚拟机创建向导自动为用户选择指定的自制镜像。

![selfimage](../images/userguide/selfimage2.png)

使用自制镜像创建虚拟机的过程与基础镜像相同，可根据提示进行操作。从镜像创建虚拟机时设置的管理员密码会覆盖原镜像操作系统中的密码，需使用新密码登录创建的虚拟机。

## 4.3 导入镜像

导入镜像是指租户或平台管理员将第三方业务虚拟机以镜像的方式迁移到平台镜像仓库，使租户可以在通过导入的镜像创建并部署业务虚拟机，是用户将业务迁移的重要通道。

支持用户导入 Linux 和 Windows 发行版及自定义镜像，并支持 X86 架构和 aarch64 两种系统架构镜像的导入；云平台的镜像格式默认为 RAW ，用户上传 VHD、VMDK、QCOW2、OVA、ISO 等格式的镜像时，需先将镜像转换为 QCOW2 格式的镜像才可导入，有关转换镜像及自定义镜像的具体操作可参考自制镜像列表上展示的[自定义镜像指南]() 。 

用户制作好自定义镜像后，可通过镜像管理控制台资源列表上方的【导入镜像】功能，进入导入镜像向导页面：

![importimage](../images/userguide/importimage_1.png)
![importimage](../images/userguide/importimage_url.png)

* 镜像名称/描述：镜像的名称及相关描述信息；
* 导入方法：用户可以自行选择本地文件或者是URL导入 QCOW2 格式的镜像文件；
* 镜像文件：在选择导入方法为本地文件时，可以选择当前浏览器选择的本地文件进行上传；
* 镜像地址：在选择导入方法为URL时，平台导入镜像时读取并下载镜像的 URL 地址，导入镜像时必须提供，平台会从提供的 URL 地址自动下载镜像并自动导入至镜像仓库，用于创建虚拟机。
  * 当前仅支持 HTTP、HTTPS 等协议的 URL 地址，格式包括 `https://path/file` 或`ftp://hostname[:port]/path/file` 或 `ftp://user:password@hostname[:port]/path/file` ；
  * 镜像的地址必须从云平台可达，即云平台组件可访问的 URL 地址，建议使用云平台相同外网的 IP 地址或外网 IP 地址可通信的地址。
* 操作系统：导入镜像的操作系统类型，包括 Linux 和 Windows ，需根据导入镜像 OS 类型进行选择；
* 系统架构：导入镜像的系统架构，包括 `x86_64` 和 `aarch64` ，需根据导入镜像进行选择；
* 系统平台：指导入镜像的操作系统平台；
  * Linux 操作系统的系统平台包括 Centos 和 Ubuntu ；
  * Windows 操作系统的系统平台仅支持 Windows ；
* 系统版本：当前需导入镜像的操作系统版本；
  * CentOS x86_64 架构支持  `6.5~6.10` 及 `7.0~7.9` 版本；
  * CentOS aarch64 架构支持 `7.6~7.9` 版本；
  * Ubuntu x86_64 架构支持 `14.04` 和 `16.04` 版本；
  * Ubuntu aarch64 架构支持 `16.04` 和 `18.04` 版本；
  * Windows  支持 `2008、2008R2、2012、2012R2` 及 `2016` 版本；
* 目标镜像大小：当前导入镜像的目标大小，最小 20GB ，最大不能超过 500GB ；
* SHA256 ：用于校验文件完整性的值，默认无需指定。

镜像导入后，自制镜像列表生成一条状态为 “导入中” 的镜像，由于平台需要先下载镜像至镜像仓库且镜像通常较大，导入镜像的时间通常比较长。

镜像状态转换为可用时，即代表镜像导入成功，可进行虚拟机创建或进行镜像下载操作；若镜像导入过程中出现意外导致失败，则镜像的状态会转换为“导入失败” ，可对失败的镜像进行删除并重新导入镜像。

> 导入镜像前需确保镜像地址可被访问且可读取并下载到镜像。

## 4.4 下载镜像

下载镜像指用户将平台自制的镜像下载至本地，用于备份或迁移。虚拟机镜像通过为 GB 级别文件，为保证下载镜像的断点续传等功能，平台以提供下载地址的方式支持镜像下载；可通过 FTP、 SFTP 及相关工具进行镜像下载，以保证断点续传功能，提升镜像下载的成功率。

用户如果需要下载镜像至本地时，可通过自制镜像列表操作项中的【下载】进入镜像下载向导页面，如下图所示：

![downloadimage](../images/userguide/downloadimage2.png)

点击生成下载地址后，平台会跳转至下载地址展示向导页面，通过向导页面，用户通过复制下载地址链接，通过 HTTP、FTP 及相关下载工具下载镜像。

![downloadimage1](../images/userguide/downloadimage3.png)

> 镜像下载地址有效期为 24 小时，需在 24 小时内进行镜像下载。若镜像下载地址过期，则无法进行下载，需到平台重新生成镜像下载地址。

## 4.5 删除自制镜像

用户可对自制镜像进行删除操作，被删除的自制镜像会自动进入“**回收站**”，可进行还原和销毁操作。用户可通过自制镜像管理控制台的“删除”功能进行自制镜像的删除，删除后可到回收站中查看已删除的自制镜像。

![rmimage](../images/userguide/rmimage1.png)

仅支持删除状态为可用或导入失败的的自制镜像；若已通过自制镜像创建虚拟机，则不可删除自制镜像，需要将虚拟机删除，才可进行自制镜像的删除。

## 4.6 修改名称和备注

修改自制镜像的名称和备注，在任何状态下均可进行操作。可通过点击自制镜像列表页面每个镜像名称右侧的“编辑”按钮进行修改。
# 5 弹性网卡

弹性网卡（ Elastic Network Interface, ENI ）是一种可随时附加到虚拟机的弹性网络接口，支持绑定和解绑，可在多个虚拟机间灵活迁移，为虚拟机提供高可用集群搭建能力，同时可实现精细化网络管理及廉价故障转移方案。

弹性网卡与虚拟机自带的默认网卡（一个内网网卡和一个外网网卡）均是为虚拟机提供网络传输的虚拟网络设备，分为内网网卡和外网网卡两种类型，同时均会从所属网络中分配  IP 地址、网关、子网掩码及路由相关网络信息。

* 内网类型的弹性网卡所属网络为 VPC 和子网，同时从 VPC 中自动或手动分配 IP 地址。
* 外网类型的弹性网卡所属网络为外网网段，同时会从外网网段中自动或手动分配 IP 地址，且分配的 IP 地址与弹性网卡生命周期一致，仅支持随弹性网卡销毁而释放。
* 当网卡类型为外网时，网卡会根据所选外网 IP 的带宽规格进行计费，用户可根据业务需要，选择适合的付费方式和购买时长。

> 虚拟机自带的默认网卡所属网络为虚拟机创建时指定的 VPC 和子网，为虚拟机绑定一块不同 VPC 的弹性网卡，虚拟机即可与不同 VPC 网络的虚拟机进行通信。

弹性网卡具有独立的生命周期，支持绑定和解绑管理，可在多个虚拟机间自由迁移；虚拟机被销毁时，弹性网卡将自动解绑，可绑定至另一台虚拟机使用。

弹性网卡具有地域（数据中心）属性，仅支持绑定相同数据中心的虚拟机。**一块弹性网卡仅支持绑定至一个虚拟机，x86 架构虚拟机最多支持绑定 6 块弹性网卡，ARM 架构虚拟机最多支持绑定 3 块网卡。**外网弹性网卡被绑定至虚拟机后，不影响虚拟机默认网络出口策略，包含虚拟机上弹性网卡绑定的外网 IP 在内，以第一个有默认路由的 IP 作为虚拟机的默认网络出口，用户可设置某一个有默认路由的外网 IP 为虚拟机默认网络出口。

每块弹性网卡仅支持分配一个 IP 地址，并可根据需要绑定一个安全组，用于控制进出弹性网卡的流量，实现精细化网络安全管控；如无需对弹性网卡的流量进行管控，可将弹性网卡的安全组置空。

用户可通过平台自定义创建网卡，并对网卡进行绑定、解绑及修改安全组等相关操作，对于外网弹性网卡还可进行【调整带宽】操作，用于调整外网弹性网卡上的外网 IP 地址的带宽上限。

## 5.1 创建弹性网卡

云平台用户可通过 API 接口或控制台创建一块弹性网卡，用于扩展虚拟机的网络接口。创建弹性网卡前需保证账户至少拥有一个 VPC 网络和子网或外网网段。通过导航栏进入虚拟机控制台，切换至【弹性网卡】网卡管理页面，点击“**创建网卡**”按钮进入弹性网卡创建向导弹窗，如下分别是创建内网类型和外网类型的示意图：

![createnic](../images/userguide/createnic.png)

![createnic2](../images/userguide/createnic2.png)

* 名称：当前需要创建弹性网卡的名称及标识；
* 网卡类型：弹性网卡的类型，包括内网网卡和外网网卡，分别从 VPC 和外网网段中分配 IP  地址。
* 所属网络：弹性网卡的所属网络，创建时必须指定。
  * 内网类型的弹性网卡所属网络为 VPC 和子网，同时从 VPC 中自动或手动分配 IP 地址，创建时需指定可用 IP 数量充足的子网。
  * 外网类型的弹性网卡所属网络为外网网段，同时会从外网网段中自动或手动分配 IP 地址，创建时需指定可用 IP 数量充足的外网网段，并配置外网 IP 地址的带宽上限。
* IP 地址：当前网卡的 IP 地址，默认会从所属网络的 IP 地址段中自动分配 IP 地址，如需自定义 IP 地址，可在 IP 地址栏中输入指定的 IP 地址。
* 安全组：当前网卡需要绑定的安全组，用于管控进出弹性网卡的网络流量；支持暂不绑定操作，即当前网卡暂不绑定安全组。

> 弹性网卡绑定的安全组与虚拟机绑定的内/外网安全组互不影响，弹性网卡的绑定的安全组仅对关联的弹性网卡流量进行安全管控。

创建外网弹性网卡时，会根据外网 IP 的带宽规格进行计费，用户可根据需要选择适合的付费方式和购买时长。弹性网卡创建时状态为“创建中”，待状态转换为“未绑定” 时，即代表网卡创建成功，可进行绑定虚拟机操作，同时可修改弹性网卡的安全组。

## 5.2 查看网卡

通过导航栏进入虚拟机控制台，切换至网卡管理页面可查看弹性网卡资源的列表及相关信息，包括网卡的名称、资源 ID、网卡类型、所属网络、IP 地址、绑定资源、安全组、状态、创建时间及操作项，如下图所示：

![niclist](../images/userguide/niclist.png)

* 名称/资源ID：弹性网卡的名称及全局唯一标识符。
* 网卡类型：弹性网卡的类型，包括内网网卡和外网网卡两种类型，分别对应 VPC 网络和外网网络。
* 所属网络：弹性网卡的所属网络，内网类型时所属网络为指定的 VPC 和子网，外网类型时所属网络为指定的外网网络和网段。
* IP 地址：当前弹性网卡从所属网络中分配的 IP 地址，同时也是绑定至虚拟机后弹性网卡上所配置的 IP 地址；若弹性网卡为外网类型，在 IP 地址后会展示该 IP 地址的带宽上限。
* 绑定资源：弹性网卡已绑定的虚拟机资源名称和 ID ，若未指定则为空。
* 安全组：弹性网卡绑定的安全组名称或 ID，若未指定则为空，可通过修改安全组绑定安全组。
* 创建时间：当前弹性网卡的创建时间。
* 状态：弹性网卡的当前状态，包括创建中、未绑定、绑定中、已绑定、解绑中、已删除等状态，状态流转如下图所示：

![nic_status](../images/userguide/nic_status.png)

列表上的操作项是指对单块弹性网卡的操作，包括绑定、解绑、修改安全组、调整带宽及删除等，可通过搜索框对弹性网卡列表进行搜索和筛选，支持模糊搜索。

为方便租户对弹性网卡资源的统计及维护，平台支持下载当前用户所拥有的所有弹性网卡资源列表信息为 Excel  表格；同时支持对弹性网卡进行批量解绑和批量删除操作。

## 5.3 绑定网卡

绑定网卡是指将一块弹性网卡绑定至一台虚拟机，用于扩展虚拟机的网络接口。

* 一块弹性网卡仅支持绑定至一个虚拟机，仅支持绑定相同数据中心且处于关机或运行状态的虚拟机；
* **X86 架构虚拟机最多可绑定 6 块弹性网卡，ARM 架构虚拟机最多支持绑定 3 块弹性网卡；**

可通过弹性网卡资源列表操作项的“**绑定**”按钮，进行虚拟机绑定操作，如下图所示：

![niclink](../images/userguide/niclink.png)

绑定时需选择需要绑定网卡的虚拟机，绑定过程中弹性网卡的状态为“绑定中”，待状态变更为“**已绑定**”即代表绑定成功，用户也可通过虚拟机的网络信息查看已绑定的网卡资源及信息。绑定成功后，虚拟机的操作系统中即会增加一块网卡，并配置弹性网卡上所分配的 IP 地址及相关信息，同时会在操作系统中下发所属网络的路由信息。

场景举例：一个虚拟机默认无默认网络出口，为虚拟机绑定一个外网类型且有默认路由的弹性网卡后，由于该网卡上的外网 IP 成为虚拟机第一个有默认路由的外网 IP ，系统会自动在虚拟机中下发默认路由，虚拟机中的所有请求默认将以弹性网卡作为默认网络出口。

## 5.4 解绑网卡

解绑网卡是指将弹性网卡从虚拟机上分离出来，并可重新绑定至其它虚拟机，仅支持解绑已绑定状态的弹性网卡资源。用户可通过弹性网卡列表或已绑定虚拟机详情网络页面进行弹性网卡的解绑操作，如下图所示：

![nicunlink](../images/userguide/nicunlink.png)

解绑时，虚拟机的状态必须处于关机或运行状态。解绑操作执行过程中，弹性网卡的状态会转换为“解绑中”，待网卡状态转换为“未绑定”，即代表解绑成功。解绑后弹性网卡的 IP 地址及安全组信息保持不变，可将网卡绑定至其它虚拟机。

解绑成功后，虚拟机的操作系统中原有的弹性网卡信息将会自动被清除，若解绑前弹性网卡为当前虚拟机的默认网络出口，解绑后虚拟机将会从虚拟机已绑定的外网 IP 中自动选择一个有默认路由的外网 IP 作为虚拟机的默认网络出口。

## 5.5 修改安全组

支持在弹性网卡的视角修改弹性网卡的安全组，同时支持配置 “暂不绑定”用于解绑安全组。安全组作用的最小单位是网卡，若弹性网卡被绑定至虚拟机，弹性网卡的安全组策略仅对当前网卡的流量出入进行限制，不影响虚拟机默认网卡及其它弹性网卡的流量出入。

用户可通过弹性网卡管理控制台列表上的“修改安全组”进行修改，如下图所示：

![nicbindsg](../images/userguide/nicbindsg.png)

一块网卡仅支持绑定一个安全组，修改成功后用户可通过弹性网卡列表信息查看已修改的安全组信息。

> 仅当弹性网卡已绑定安全组时，才可通过“暂不绑定“解绑已绑定的安全组。

## 5.6 删除网卡

支持用户删除未绑定状态的弹性网卡资源，即仅支持删除【未绑定】状态的弹性网卡。删除弹性网卡后，会自动解绑与之关联的安全组。用户可通过弹性网卡列表进行弹性网卡的删除操作，支持批量删除。

![rmnic](../images/userguide/rmnic.png)

## 5.7 修改名称和备注

修改弹性网卡的名称和备注，在任何状态下均可进行操作。可通过弹性网卡列表页面每个网卡名称右侧的“编辑”按钮进行修改。

## 5.8 调整带宽

支持用户调整外网弹性网卡的 IP 带宽，可通过弹性网卡列表操作项中的【调整带宽】进行操作，如下图所示：

![ModifyEIPBandwidth](../images/userguide/ModifyEIPBandwidth.png)

仅支持外网类型的弹性网卡进行带宽调整操作，同时会根据 IP 带宽进行计费，需确保账户余额充足。
# 6 云硬盘

## 6.1 云硬盘概述

云硬盘是一种基于分布式存储系统为虚拟机和数据库服务提供持久化存储空间的块设备。具有独立的生命周期，支持随意绑定/解绑至多个虚拟机使用，并能够在存储空间不足时对云硬盘进行扩容，基于网络分布式访问，为云主机提供高安全、高可靠、高性能及可扩展的数据磁盘。

![cbs](../images/userguide/cbs.png)

存储系统兼容并支持多种底层存储硬件，如通用服务器（计算存储超融合或独立通用存储服务器）和商业存储，并将底层存储硬件分别抽像不同类型集群的存储资源池，由分布式存储系统统一调度和管理。在实际应用场景中，可以将普通 SATA 接口的机械盘统一抽像为【SATA 存储集群】，将 SSD 全闪磁盘统一抽象为【SSD 存储集群】，分别由统一存储封装后提供平台用户使用。

如示意图所示，将 SATA 存储集群的资源封装为普通云盘，将 SSD 全闪存储集群的资源封装为高性能云盘。平台的虚拟机和数据库服务可根据需求挂载不同存储集群类型的磁盘，支持同时挂载多种集群类型的云硬盘。云平台管理员可通过管理员控制台自定义存储集群类型的别名，用于标识不同磁盘介质、不同品牌、不同性能或不同底层硬件的存储集群，如 EMC 存储集群、SSD 存储集群等。

> 通常 SSD 磁盘介质的云硬盘的性能与容量的大小成线性关系，容量越大提供的 IO 性能越高，如对 IO 性能有强烈需求，可考虑扩容 SSD 磁盘介质的云硬盘。

分布式存储底层数据通过条带化、PG 映射的方式进行数据存储，同时以多副本存储的方式保证数据安全，即写入至云平台存储集群的数据块会同时保存多份至不同服务器节点的磁盘。多副本存储的数据提供一致性保证，可能导致写入的多份数据因误操作或原始数据异常导致数据不准确；为保证数据的准确性，云平台提供硬盘快照能力，将云盘数据在某一时间点的数据文件及状态进行备份，在数据丢失或损坏时，可通过快照快速恢复数据，包括数据库数据、应用数据及文件目录数据等，可实现分钟级恢复。

云硬盘由统一存储从存储集群容量中分配，为平台虚拟资源提供块存储设备并共享整个分布式存储集群的容量及性能；同时通过块存储系统为用户提供云硬盘资源及全生命周期管理，包括云硬盘的创建、绑定、解绑、扩容、克隆、快照及删除等管理。

* 支持秒级创建云硬盘，最小支持 10G 的容量，步长为 10GB ，管理员可自定义单块云硬盘的最大容量；
* 具有独立的生命周期，可自由绑定至任意虚拟机或数据库服务，解绑后可重新挂载至其它虚拟机；
* X86 架构的虚拟机最多支持绑定 6 块云硬盘，ARM 架构虚拟机最多支持绑定 3 块云硬盘；
* 支持在线和离线的方式扩容磁盘容量，磁盘存储容量扩容后需在虚拟机操作系统中进行文件系统及分区扩展；
* 为保证数据安全性及准确性，云硬盘仅支持磁盘扩容，不支持磁盘缩容。
* 支持云硬盘克隆，即将云硬盘内的数据复制成为一个新的云硬盘；
* 支持对云硬盘进行快照备份，包括虚拟机的系统盘快照及弹性云盘快照，并可从快照回滚数据至云硬盘，用于数据恢复和还原场景；
* 支持对全局及每一块云硬盘的 QoS 进行配置，可根据不同业务模式调整磁盘的性能，以平衡平台整体性能；
* 支持设置存储集群类型权限，即可以将部分存储资源设置为租户独享，满足需要独享底层存储资源的场景。

支持自动精简配置，在创建云硬盘时，仅呈现分配的逻辑虚拟容量。当用户向逻辑存储容量中写入数据时，按照存储容量分配策略从物理空间分配实际容量。如一个用户创建的云硬盘为 1TB 容量，存储系统会为用户分配并呈现 1TB 的逻辑卷，仅当用户在云硬盘中写入数据时，才会真正的分配物理磁盘容量。

## 6.2 创建云硬盘

在平台控制台上，用户可通过指定云硬盘的类型、容量及名称即可快速创建一块云硬盘，作为虚拟机的数据盘。创建前需确认账户的余额及硬盘配额充足。

1、通过控制台进入硬盘资源控制台，通过“**创建硬盘**”按钮，即可进入云硬盘创建向导页面，如下图所示，根据需求选择并配置硬盘类型、硬盘容量、硬盘名称等参数。

![createstorage](../images/userguide/createstorage.png)

* 硬盘类型：即云硬盘类型，即存储集群类型，由平台管理员自定义，如 HDD 云盘或 SSD 高性能云盘；
* 硬盘容量：云硬盘分配的逻辑容量，默认最小 10GB ，步长为 10GB ，最大支持 8000GB ，可由云平台管理员在控制台自定义容量规格；
* 云硬盘名称：需要创建的云硬盘名称；

2、选择购买数量和付费方式，如下图所示确认订单并点击“立即购买” 进行云硬盘购买及创建操作：

![vmorder](../images/userguide/vmorder.png)

- 购买数量：选择需要创建的云硬盘数量，一次最多支持批量创建 10 块相同规格的云硬盘。
- 付费方式：选择虚拟机的计费方式，支持按时、按年、按月三种方式，可根据需求选择适合的付费方式；
- 合计费用：用户选择创建云硬盘资源按照付费方式的费用展示；
- 立即购买：点击立即购买后，会返回云硬盘资源列表页，在列表页可查看云硬盘的创建过程，创建成功后，云硬盘状态显示为“未绑定”。

## 6.3 查看云硬盘

通过导航栏进入虚拟机控制台，切换至硬盘管理页面可查看当前账户下云硬盘资源的列表及相关详细信息，包括名称、资源 ID、集群类型、硬盘容量、绑定资源、计费方式、状态、创建时间、过期时间及操作项，如下图所示：

![storagelist](../images/userguide/storagelist.png)

* 名称/ID：云硬盘的名称和全局唯一标识符；
* 集群类型：即云硬盘类型，即存储集群类型，由平台管理员自定义，如 HDD 云盘或 SSD 高性能云盘；
* 硬盘容量：云硬盘的容量，GB 为单位；
* 绑定资源：云硬盘已绑定的虚拟机名称和 ID ，未指定则为空；
* 计费方式：云硬盘在创建时指定的计费方式，如按月、按年、按时；
* 创建时间/过期时间：云硬盘的创建时间和计费周期过期时间；
* 状态：云硬盘的当前状态，包括创建中、未绑定、绑定中、已绑定、解绑中、扩容中、被克隆中、快照中及删除中等，其中被克隆中指当前硬盘正在克隆，快照中指当前硬盘正在快照备份中。

列表上的操作项是指对单块硬盘的操作，包括绑定、解绑、扩容、克隆、快照及删除等，可通过搜索框对硬盘列表进行搜索和筛选，支持模糊搜索。

为方便租户对硬盘资源的统计及维护，平台支持下载当前用户所拥有的所有硬盘资源列表信息为 Excel  表格；同时支持对硬盘进行批量解绑和批量删除操作。

## 6.4 绑定云硬盘

绑定是指将一块云硬盘挂载至一台虚拟机，为虚拟机添加数据磁盘，用于数据存储。

* 仅支持状态为“未绑定”的硬盘进行绑定，为保证数据安全，一块云硬盘同时仅支持绑定至一台虚拟机；
* 云硬盘具有地域（数据中心）属性，仅支持绑定相同数据中心且处于关机或运行状态的虚拟机；
* **X86 架构虚拟机最多可绑定 6 块硬盘，ARM 架构虚拟机最多支持绑定 3 块硬盘；**

可通过硬盘管理资源列表操作项的“**绑定**”功能，进行硬盘绑定操作，如下图所示：

![storagelink](../images/userguide/storagelink.png)

绑定时需选择绑定硬盘的虚拟机，绑定过程中硬盘的状态为“绑定中”，待状态变转换为“已绑定” 即代表绑定成功。用户可通过虚拟机的硬盘信息查看已绑定云盘资源及信息，包括容量、挂载等，同时用户也可登录虚拟机操作系统中查看是否已识别到新的磁盘设备，如 Linux 操作系统用户可输入 `fdisk -l`  查看新增块设备的信息。

**云硬盘绑定后，默认不进行格式化（如需）和系统挂载操作，需用户登录已挂载的虚拟机操作系统，根据需求对云盘进行格式化及挂载(`mount`) 操作，有关操作系统内格式化及挂载数据盘，详见[格式化并挂载数据盘](#_66-格式化并挂载数据盘)。**

## 6.5 解绑云硬盘

解绑云硬盘是指将云硬盘从虚拟机上分离出来，解绑的云硬盘可重新绑定至其它虚拟机，解绑后云硬盘的数据不会丢失，重新挂载新虚拟机后，可直接使用云硬盘上的数据。

仅支持解绑已绑定状态的硬盘资源，用户可通过硬盘列表或已绑定虚拟机详情硬盘页面进行硬盘的解绑操作，如下图所示：

![storageunlink](../images/userguide/storageunlink.png)

解绑时，虚拟机的状态必须处于关机或运行状态。解绑操作执行过程中，云硬盘的状态会转换为“解绑中”；状态转换为“未绑定”，即代表解绑成功，可将硬盘重新绑定至其它虚拟机。

> 为保存数据完整性，解绑操作前建议暂停对当前硬盘所有文件系统的读写操作，并进入操作系统进行 `umount`或脱机操作（Linux 系统需确认已 `umount` 硬盘所对应的文件系统； Windows 系统需确认至磁盘管理中进行磁盘下线操作），避免因强制解绑云硬盘卖到文件系统损坏或丢失。

## 6.6 格式化并挂载数据盘

云硬盘成功挂载到虚拟机后，需要格式化后才可正常读写数据。本章节主要描述如何用一块新的云硬盘创建一个单分区的数据盘。Linux 的虚拟机和 Windows 的虚拟机使用云硬盘的方式不同，Linux 虚拟机格式化后，需要挂载到文件系统的一个目录中使用；Windows 的虚拟机首先需要初始化磁盘，进行分区并格式化后即可正常使用。

> 格式化和分区磁盘具有一定的风险，格式化后云硬盘中的数据将被清空，请慎重操作。

### 6.6.1 Linux 虚拟机

Linux 虚拟机挂载的云硬盘设备名是由系统默认分配的，从 `/dev/vdb` 递增排列，包括`/dev/vdb 到 /dev/vdz`。本示例挂载一块 100GB 的云硬盘至 Linux 虚拟机，设备名为 `/dev/vdb` 。具体操作步骤如下：

1. 创建云硬盘，并挂载至一台 Linux 的虚拟机，并通过 SSH 远程连接并登录虚拟机；
2. 使用 `fdisk -l ` 命令查看虚拟机上的云硬盘，检测是否挂载成功，如下图所示挂载的数据盘为 100GB `/dev/vdb` 设备；

![fdisk](../images/userguide/fdisk.png)

3. 创建文件系统，使用 `mkfs.ext4 /dev/vdb` 命令进行格式化并新建一个文件系统，分区格式化可选择`ext3`、`ext4   `等文件系统的格式，示例采用 `ext4 ` 格式；

```bash
[root@localhost ~]# mkfs.ext4 /dev/vdb
mke2fs 1.41.12 (17-May-2010)
文件系统标签=
操作系统:Linux
块大小=4096 (log=2)
分块大小=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
6553600 inodes, 26214400 blocks
1310720 blocks (5.00%) reserved for the super user
第一个数据块=0
Maximum filesystem blocks=4294967296
800 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
	4096000, 7962624, 11239424, 20480000, 23887872

正在写入inode表: 完成                            
Creating journal (32768 blocks): 完成
Writing superblocks and filesystem accounting information: 完成
```

4. 挂载数据盘，创建挂载点 `/data` 目录，使用 `mount /dev/vdb /data` 命令挂载新分区，并使用 `df -h` 验证云硬盘是否挂载成功；

```bash
[root@localhost ~]# mkdir /data
[root@localhost ~]# mount /dev/vdb /data
[root@localhost ~]# df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/vda1        20G  874M   18G   5% /
tmpfs           1.9G     0  1.9G   0% /dev/shm
/dev/vdb         99G  188M   94G   1% /data
```

5. 配置开机自动挂载，添加云硬盘的挂载信息至 `/etc/fstab` ，如下：

```bash
echo '/dev/vdb /data ext4 defaults 0 0' >> /etc/fstab
```

6. 挂载成功，即可正常使用云硬盘，若云硬盘在控制台被解绑，重新绑定至虚拟机后，需要重复执行 `mount /dev/vdb /data` 命令，或者需要重启虚拟机进行自动挂载；
7. 若云硬盘在控制台被解绑，重新绑定至其它 Linux 虚拟机后，需要按照第 4~5 步骤执行挂载操作。 

### 6.6.2 windows 虚拟机

Windwos 虚拟机挂载云硬盘后，需要进行初始化和格式化分区操作，才可正常使用。Windows 操作系统可进入 “磁盘管理” 界面进行分区与格式化操作，本章节以 Windows 2012 R2 为例进行格式化与分区操作，如下：

1. 创建云硬盘，并挂载至一台 windows 的虚拟机，通过 VNC 或远程桌面远程连接并登录虚拟机；
2. 点击【开始】—【管理工具】—【计算机管理】—【磁盘管理】，打开“磁盘管理” 界面，查看已挂载的云硬盘，如下图所示的磁盘 1 ：

![windows](../images/userguide/windows.png)

3. 在磁盘 1 上右键单击，选择【联机】，如下图所示：

![onlinewindows](../images/userguide/onlinewindows.png)

4. 在磁盘 1 上右键单击，选择【初始化磁盘】，进入磁盘初始化向导界面，如下图所示：

![init](../images/userguide/init.png)

5. 根据分区形式的不同，选择【GPT】或【MBR】，单击【确定】按钮；

* MBR 目前仍是最常用的分区形式，支持处理不大于 2 TB 的数据盘，仅支持分 4 个主区，如果您要将磁盘分成更多的区，需要将某个主区作为扩展区并在其中创建逻辑分区。
* GPT 是一种新的分区形式，早期版本的 Windows 不能识别这种分区形式。GPT 能处理的数据盘容量由操作系统和文件系统决定。在 Windows 操作系统里，GPT 最多可以支持 128 个主分区。

6. 磁盘分区，右键点击磁盘 1 右侧【未分配】的区域，选择【新建简单卷】，进入新建简单卷向导，如下图：

![newvolume](../images/userguide/newvolume.png)

7. 点击下一步，输入分区所需的磁盘大小，若只需一个分区，使用默认值，单击下一步；

![newvolume1](../images/userguide/newvolume1.png)

8. 分配驱动器号和路径，选择一个驱动器号（即盘符），如本示例中选择 D，单击 **下一步**；

![newvolume2](../images/userguide/newvolume2.png)

9. 格式化分区，选择格式化设置，包括文件系统、分配单元大小和卷标，确认是否 **执行快速格式化** 和 **启用文件和文件夹压缩**，这里使用默认设置，单击 **下一步**；

![newvolume3](../images/userguide/newvolume3.png)

10. 点击完成，开始创建新简单卷，返回磁盘管理工具，磁盘 1 的状态良好，如下图所示：

![newvolume4](../images/userguide/newvolume4.png)

## 6.7 扩容云硬盘

### 6.7.1 扩容云盘容量

平台支持用户扩容云硬盘的容量，适应于业务发生变化需扩容磁盘容量的场景。平台仅支持扩容磁盘容量，不支持磁盘容量的缩容。支持在线和离线两种硬盘扩容方式：

* 在线是指对运行状态虚拟机上绑定的云盘进行容量扩容；
* 离线是指对未绑定至虚拟机或关机状态虚拟机上绑定的云盘进行容量扩容。

磁盘容量扩容范围即当前硬盘类型的规格，默认为 10GB~8000GB ，平台管理员可至平台管理后台全局配置中，进行磁盘规格配置。

扩容硬盘容量会对虚拟机费用产生影响，按小时付费的硬盘，扩容容量下个付费周期按新配置扣费；按年按月付费的硬盘，扩容容量即时生效，并按比例自动补差价。用户可点击云硬盘控制台操作中的“**扩容**” 进行硬盘容量扩容操作，如下图所示：

![storageup.png](../images/userguide/storageup.png)

如图所示，**扩容硬盘需指定更改容量的大小**，即硬盘需要扩容的容量。平台已展示当前硬盘的容量大小，由于不支持缩容，扩容时更改容量必须大于当前容量大小。

扩容过程中硬盘的状态转换为“升级中”，待状态转换为“已绑定” 或 “未绑定” 状态即代表扩容成功。用户可通过硬盘列表或虚拟机硬盘信息查看硬盘的新容量；若硬盘已绑定虚拟机，用户也可登录虚拟机操作系统中查看绑定磁盘设备的容量，如 Linux 操作系统用户可输入 `fdisk -l`  查看新增块设备的信息。

> 由于 MBR 格式分区不支持大于 2TB 的磁盘容量。在扩容云硬盘时，若待扩容的硬盘采用 MBR 分区格式且需要扩容到 2TB 及以上容量时，建议重新创建并挂载一块硬盘，使用 GPT 分区方式并将数据拷贝至新硬盘中。

扩容操作仅对硬盘的块设备容量进行增加，并未对操作系统内文件系统和分区进行扩展。在容量扩容成功后，需进入挂载的虚拟机操作系统进行分区扩展或新建分区操作，详见【6.7.2 磁盘分区扩容】。

### 6.7.2 磁盘分区扩容

扩容硬盘容量后，需要进入操作系统对磁盘分区进行扩容，即需对文件系统进行扩容，才可使操作系统正常使用已扩容的磁盘容量。针对不同的操作系统分区扩容操作有所不同，如 Linux 通常通过 `fdisk` 或`parted`  工具；Windows 通常使用自带的磁盘管理工具进行扩容操作。根据不同磁盘扩容场景，分区扩容大致分为如下场景：

* 裸磁盘扩容（Linux）
* 单分区磁盘扩容（Linux）
* 单分区磁盘扩容（Windows）
* 多分区磁盘扩容（Linux）
* 多分区磁盘扩容（Windows）
* 2TB 硬盘分区扩容（Linux）
* 2TB 硬盘分区扩容（Windows）

#### 6.7.2.1 裸磁盘扩容（Linux）

裸磁盘是指未进行分区的云硬盘，即创建的云硬盘挂至主机后，直接对磁盘进行格式化进行使用，用户可通过对硬盘扩容容量后，进入操作系统对裸磁盘进行扩容操作。

> 裸磁盘直接格式化使用，仅适用于 Linux 系统，Windows 必须进行格式化并分区才可进行挂载使用。

本示例以 CentOS 6.5 操作系统（内核版本为 2.6.32-431.el6.x86_64  ）为示例环境版本，云硬盘大小为 40GB ，扩容至 50GB ，挂载点为 `/dev/vdb` ，实际环境中需根据实际情况进行操作。

* 查看当前磁盘的信息，包括挂载点、文件系统类型及分区情况。

  ![df-h](df-h.png)

  注：结果显示 vdb 磁盘为 ext4 分区且磁盘下无分区，为裸磁盘，可按照本文档所述方案扩容；若 vdb 下有分区，需参考单分区扩容或多分区扩容章节内容。

* 通过控制台或 API 对硬盘进行容量扩容操作，并在操作系统中查看磁盘的容量，如下图所示，扩容至50GB；

  ![fdiskvdb](../images/userguide/fdiskvdb.png)

* umount 磁盘，进行文件系统扩容操作，不同的文件系统扩容命令操作不同，本文分别以 ext4 及 xfs 文件系统为例进行扩容操作；

* ext4 文件系统扩容，执行 `resize2fs /dev/vdb`  进行系统磁盘扩容操作，最后重新 mount 挂载磁盘即可；

  ![resize2fs](../images/userguide/resize2fs.png)

  如上图所示，扩容并挂载磁盘后，`/data` 目录所显示的容量为扩容后的 50GB 。

* 若磁盘为 xfs 文件系统，则需要执行 `xfs_growfs /data/` 命令进行磁盘扩容操作

> 注意：xfs 文件系统的磁盘扩容，需要在操作系统中将磁盘 `mount` 后操作。

#### 6.7.2.2 单分区扩容（Linux）

单分区磁盘是指云盘在扩容之前已被挂载过虚拟机且只划分过 1 个分区，用户可通过对硬盘扩容容量后，进入操作系统对单分区磁盘进行分区扩容操作。单分区扩容在 Linux 及 Windows 操作系统上的操作不同，本章节为 Linux 单分区扩容操作指南。

本示例以 CentOS 6.5 操作系统（内核版本为 2.6.32-431.el6.x86_64  ）为示例环境版本，云硬盘大小为 10G 单分区，扩容至 20GB ，挂载点为 `/dev/vdb1` ，实际环境中需根据实际情况进行操作。若磁盘上划分多个分区，可参考多分区扩容章节。

> 本操作示例默认磁盘容量小于 2TB ，若磁盘容量大于 2TB 请参考《2TiB磁盘分区扩容（Linux）》章节。

* 通过 `lsblk` 查看当前磁盘的信息，包括挂载点、文件系统类型及分区情况；

  ![onelsblk](../images/userguide/onelsblk.png)

  注：结果显示 vdb 下只有一个 10GB 的分区，分区格式为 ext4 ，挂载至 `/mnt` 目录 。

* 通过控制台或 API 对硬盘进行容量扩容操作，并在操作系统中通过 fdisk 或 lsblk 查看扩容后的磁盘容量；

* 在操作系统中 umount 磁盘，使用 `fdisk /dev/vdb` 命令删除原来的分区并创建新分区；

  ![fdisk10](../images/userguide/fdisk10.png)

  > 注：删除分区不会造成磁盘内数据丢失。

* 检查文件系统并进行文件系统扩容操作，不同的文件系统扩容命令操作不同，本文分别以 ext4 及 xfs 文件系统为例进行扩容操作；

* ext4 文件系统扩容，执行 `e2fsck -f /dev/vdb1` 和  `resize2fs /dev/vdb1` 进行检查和扩容操作；

  ![resize2fs10](../images/userguide/resize2fs10.png)

  如上图所示，扩容分区扩容成功后，重新 mount 分区，并查看分区大小及相关信息。

* 若磁盘为 xfs 文件系统，则先执行 `xfs_repair /dev/vdb1` 检查文件系统，如下图所示：

  ![xfs_repair](../images/userguide/xfs_repair.png)

  最后使用 mount 重新挂载磁盘，并执行 `xfs_growfs /mnt` 对磁盘分区进行扩容操作。

#### 6.7.2.3 单分区扩容（Windows）

单分区磁盘是指云盘在扩容之前已被挂载过虚拟机且只划分过 1 个分区，用户可通过对硬盘扩容容量后，进入操作系统对单分区磁盘进行分区扩容操作。单分区扩容在 Linux 及 Windows 操作系统上的操作不同，本章节为 windows 单分区扩容操作指南。

本示例以 Windows Server 2012R2 操作系统为示例环境版本，云硬盘大小为 10GB ，扩容至 20GB ，挂载点为 Disk1 ，实际环境中需根据实际情况进行操作。具体操作如下：

> 本操作示例默认磁盘容量小于 2TB ，若磁盘容量大于 2TB 请参考《2TiB磁盘分区扩容（Windows）》章节。

* 查看当前磁盘的分区及挂载信息，确认磁盘是当前需要扩容的磁盘，如下图所示：

  ![windisk](../images/userguide/windisk.png)

* 在操作系统中对磁盘进行脱机操作，并通过控制台及 API 对当前磁盘进行容量扩容操作，并通过操作系统磁盘管理工具查看扩容后的磁盘大小，如下图所示：

  ![windisk10](../images/userguide/windisk10.png)

* 右键单击新分区 D 空白处，选择扩展卷（Extend Volume），并在弹出的对话框中，对磁盘分区进行扩展操作，如以下图示：

  ![windisk](../images/userguide/windisk11.png)

  ![windisk](../images/userguide/windisk12.png)

  ![windisk](../images/userguide/windisk13.png)

  ![windisk](../images/userguide/windisk14.png)

  

* 分区扩展成功后，查看扩容后分区信息，如下图所示：

  ![windisk](../images/userguide/windisk15.png)

#### 6.7.2.4 多分区扩容（Linux）

多分区磁盘是指云盘在扩容之前已被挂载过虚拟机且划分过多个分区，用户可通过对硬盘扩容容量后，进入操作系统对多分区磁盘进行分区扩容操作。由于新扩容的空间是附加在虚拟云盘的末端，对于多分区的场景，只支持对排在最后的分区进行扩容操作。

多分区扩容在 Linux 及 Windows 操作系统上的操作不同，本章节为 Linux 多分区扩容操作指南。本示例以 CentOS 6.5 操作系统为示例环境版本，云硬盘大小为 20G ，两个分区分别 10GB ，挂载点分别为 `/dev/vdb1`和`/dev/vdb2` ，扩容至 30GB ，即将最后一个分区扩容为 20GB ，实际环境中需根据实际情况进行操作。

> 本操作示例默认磁盘容量小于 2TB ，若磁盘容量大于 2TB 请参考《2TiB磁盘分区扩容（Linux）》章节。

* 通过 `lsblk` 及 `df` 查看当前磁盘的信息，包括挂载点、文件系统类型及分区情况；

  ![lsblk20](../images/userguide/lsblk20.png)

  结果显示 vdb 下有两个 10GB 的分区（vdb1 和 vdb2），且分别挂载至 /mnt 及 /data 目录下，扩容操作仅可对 vdb2 分区进行扩容操作，即将 vdb2 扩容为 20GB 。

* 通过控制台或 API 对硬盘进行容量扩容操作，并在操作系统中通过 fdisk 或 lsblk 查看扩容后的磁盘容量；

* 在操作系统中 umount 磁盘，使用 `fdisk /dev/vdb` 命令删除最后一个分区（vdb2）并创建新分区；

  ![fdiskvdb30](../images/userguide/fdiskvdb30.png)

  > 注：删除分区不会造成磁盘内数据丢失，以上示例为删除 vdb2 ，即磁盘的最后一个分区。

* 检查文件系统并进行文件系统扩容操作，不同的文件系统扩容命令操作不同，本文分别以 ext4 及 xfs 文件系统为例进行扩容操作；

* ext4 文件系统扩容，执行 `e2fsck -f /dev/vdb2 ` 和  `resize2fs /dev/vdb2` 进行检查和扩容操作，扩容分区扩容成功后，重新 mount 分区，并查看分区大小及相关信息；

* 若磁盘为 xfs 文件系统，则先执行 `xfs_repair /dev/vdb2` 检查文件系统后，使用 mount 将磁盘重新挂载至 `/data`目录，最后使用 `xfs_growfs  /data` 命令对 vdb2 磁盘分区进行扩容操作。

#### 6.7.2.5 多分区扩容（Windows）

多分区磁盘是指云盘在扩容之前已被挂载过虚拟机且划分过多个分区，用户可通过对硬盘扩容容量后，进入操作系统对多分区磁盘进行分区扩容操作。由于新扩容的空间是附加在虚拟云盘的末端，对于多分区的场景，只支持对排在最后的分区进行扩容操作。

多分区扩容在 Linux 及 Windows 操作系统上的操作不同，本章节为 Windows 多分区扩容操作指南。本示例以 Windows Server 2012R2 操作系统为示例环境版本，云硬盘大小为 10G ，两个分区分别 5GB ，挂载点 Disk1 ，扩容至 20GB ，即将最后一个分区扩容为 15GB ，实际环境中需根据实际情况进行操作。

> 本操作示例默认磁盘容量小于 2TB ，若磁盘容量大于 2TB 请参考《2TiB磁盘分区扩容（Linux）》章节。

* 查看当前磁盘的分区及挂载信息，确认磁盘是当前需要扩容的磁盘，如下图所示：

  ![windisk20.png](../images/userguide/windisk20.png)

* 在操作系统中对磁盘进行脱机操作，并通过控制台及 API 对当前磁盘进行容量扩容操作，并通过操作系统磁盘管理工具查看扩容后的磁盘大小，如下图所示：

  ![windisk21](../images/userguide/windisk21.png)

* 右键点击新分区 E （最后一个分区）空白处，选择扩展卷（Extend Volume），对分区进行扩容；

  ![windisk22](../images/userguide/windisk22.png)

  通过点击下一步及相关配置，完成新分区的容量扩容；

* 完成扩容后，查看扩容后分区情况，如下图所示：

  ![windisk23](../images/userguide/windisk23.png)

  如结果显示，E 盘被扩展为 15GB ，即在原来的基础之上扩容 10GB 的容量。

#### 6.7.2.6 2TB 磁盘分区扩容（Linux）

当一块磁盘的容量大于 2TB 时，在 linux 下无法通过 fdisk 工具命令对对进行分区，需通过 parted 命令进行分区及扩容操作。2TB 以上磁盘在 Linux 及 Windows 操作系统上的操作不同，本章节为 Linux 下大于 2TB 磁盘扩容操作指南。

本示例以 CentOS 6.5 操作系统为示例环境版本，云硬盘大小为 2TB  ，挂载点为 `/dev/vdb` ，扩容至 2.1TB ，即将云盘及分区扩容为 100GB ，实际环境中需根据实际情况进行操作。具体操作如下：

（1）若磁盘为新创建，则需要通过 parted 工具先进行分区，具体操作如下图：

* 通过输入 `parted /dev/vdb` 进行分区操作，其中 `mklabel gpt` 是将磁盘分区设置为 GPT 格式；

  ![parted2t](../images/userguide/parted2t.png)

* 分区后，可通过 lsblk 查看磁盘分区是否成功，并通过 mkfs.ext4  /dev/vdb1 将分区进行格式化并进行挂载才可正常使用，如下图所示：

  ![parted31](../images/userguide/parted31.png)

* 格式化成功后，通过挂载并查看磁盘的信息，如下图所示 `/dev/vdb1` 被挂载至 `/mnt` ，容量为 2TB 。

  ![parted32](../images/userguide/parted32.png)

（2）扩容大于 2TB 磁盘的具体操作如下：

* 通过 `lsblk` 及 `df` 查看当前磁盘的信息，包括挂载点、文件系统类型及分区情况；

* 通过控制台或 API 对硬盘进行容量扩容操作，并在操作系统中通过 fdisk 或 lsblk 查看扩容后的磁盘容量，本示例中将磁盘扩容为 2.1TB ，即 2100GB ，如下图所示：

  ![parted33](../images/userguide/parted33.png)

* 在操作系统中 umount 磁盘，使用 `parted /dev/vdb` 命令删除原来分区并创建新分区，同时使用 `lsblk` 命令查看 vdb1 分区信息。若为多分区则删除最后一个分区并创建新分区；

  ![parted34](../images/userguide/parted34.png)

  如图所示，其中`unit s 代表将显示和操纵单位变成 sector ` ；`rm 1` 是删除当前分区；` mkpart test 2048s 100% ` 是创建一个名称为 test ，起始扇区为 2048s ，使用磁盘全部空间的新分区 。注：删除当前分区不会造成磁盘内数据丢失。

* 执行`e2fsck -f /dev/vdb1`命令检查文件系统，并使用 `resize2fs /dev/vdb1` 对分区进行扩容操作；

  ![parted35](../images/userguide/parted35.png)

* 重新 mount  磁盘并查看磁盘情况，检查扩容是否成功

  ![parted36](../images/userguide/parted36.png)

#### 6.7.2.7 2TB 磁盘分区扩容（Windows）

当一块磁盘的容量大于 2TB 时，在 Windows 下无法使用 MBR 分区形式，需要使用 GPT 分区表形式进行磁盘初始化，并通过磁盘管理工具进行分区及扩容操作。2TB 以上磁盘在 Linux 及 Windows 操作系统上的操作不同，本章节为 Windows 下大于 2TB 磁盘扩容操作指南。

本示例以 Windwos Server 2012R2 操作系统为示例环境版本，云硬盘大小为 2TB  ，挂载点为 Disk1（磁盘1） ，扩容至 2.1TB ，即将云盘及分区扩容为 100GB ，实际环境中需根据实际情况进行操作。具体操作如下：

（1）若磁盘为新创建，则需要磁盘管理工具对磁盘进行联机并初始化操作，具体操作如下：

* 当在控制台创建一台 2T 的硬盘挂载至 Windows 虚拟机后，在磁盘管理工具会出现类似 磁盘1 或 Disk1 的磁盘，并且磁盘的状态为脱机；

  ![windisk01](../images/userguide/windisk01.png)

* 如上图所示，右键点击磁盘1 右边空白处，单击联机，将磁盘置为联机状态；

* 磁盘联机后，磁盘状态为 “没有初始化” ，可点击磁盘空白处，点击初始化磁盘；

  ![windisk03](../images/userguide/windisk03.png)

* 在初始化磁盘界面，选择 “GPT（GUID分区表）” 选项，进行磁盘初始化操作；

  ![windisk02](../images/userguide/windisk02.png)

* 磁盘初始化成功后，右键点击磁盘1 未分配区域，点击单建简单卷进行分区及格式化操作；

  ![windisk04](../images/userguide/windisk04.png)

* 在新建简单卷导向中，选择卷大小、驱动器号及格式化选项后，成功创建新的分区，如下图所示：

  ![windisk05](../images/userguide/windisk05.png)

（1）若要扩容 Windows 上 2T 的磁盘，可按如下操作进行扩容：

* 通过控制台或 API 对磁盘 1 进行扩容，扩容后可通过 Windows 操作系统的磁盘管理工具"重新扫描磁盘"查看新扩容磁盘信息，如下图所示磁盘1多出来 100GB 的未分配空间；

  ![windisk06](../images/userguide/windisk06.png)]

* Windows 扩容分区，可将多余的 100GB 单独划分一个分区，也支持将 100GB 空间扩容至已有分区中，本示例演示将 100GB 未分配的容量扩容至已有分区 D 盘中；

* 右键点击已有分区的空白处（本示例为 D 盘），单击扩展卷，通过扩展卷向导将未分配容量扩展至 D 盘中；

  ![windisk07](../images/userguide/windisk07.png)

* 在扩展卷向导中，选择磁盘1，并输需扩展的容量，通常系统已默认选择所有未分配容量，并确认扩展卷操作

  ![windisk08](../images/userguide/windisk08.png)

* 扩展成功后，未分配容量已成功扩容至已有分区 D 盘中，如上图所示，磁盘总容量为 2.1T ；

  ![windisk09](../images/userguide/windisk09.png)

## 6.8 硬盘克隆

硬盘克隆是指将云硬盘内的数据复制到一个新的云硬盘，硬盘大小和类型与原硬盘一致。仅支持克隆状态为未绑定状态的硬盘，同时在硬盘克隆过程中，源硬盘不可进行绑定、克隆、扩容等操作。

用户可通过云硬盘硬盘资源列表上的“**克隆**”功能，进行云硬盘克隆操作，如下图所示：

![diskclone](../images/userguide/diskclone.png)

* 源硬盘名称/ID：需要进行克隆的硬盘名称和 ID ；
* 源硬盘容量：需要进行克隆操作硬盘的容量，即源硬盘容量；
* 目标硬盘名称：新克隆的硬盘名称。

克隆会基于源硬盘复制出一块新的硬盘，需选择新硬盘的相关计费配置，包括购买数量、付费方式及合计费用等：

- 购买数量：按照所选配置及参数批量创建多块云硬盘，目前仅支持同时克隆一块硬盘。
- 付费方式：选择硬盘的计费方式，支持按时、按年、按月三种方式，可根据需求选择适合的付费方式；
- 合计费用：用户选择创建云硬盘资源按照付费方式的费用展示；
- 确认：点击确认购买后，会返回云硬盘资源列表页，在列表页可查看云硬盘的克隆过程，克隆成功后，云硬盘状态显示为“未绑定”。

> 硬盘克隆可用于硬盘数据的备份及快照等应用场景，克隆出的硬盘与源硬盘数据完全一致。

## 6.9 删除云硬盘

支持用户删除"未绑定"状态的云硬盘资源，被删除的云硬盘会自动进入“**回收站**”中，可进行还原及销毁。删除云硬盘后，通过当前云硬盘创建的快照资源会同时被销毁。

用户可通过云硬盘管理控制台的“删除”功能删除云硬盘，删除后可在回收站查看已删除的云硬盘资源。如图所示：

![diskrm](../images/userguide/diskrm.png)

## 6.10 修改名称和备注

修改硬盘的名称和备注，在任何状态下均可进行操作。可通过硬盘列表页面每个硬盘名称右侧的“编辑”按钮进行修改。

## 6.11 续费云硬盘

支持用户手动对云硬盘进行续费，续费操作只针对资源本身，不对资源额外关联的虚拟机资源进行续费。额外关联的资源到期后，会自动解绑，为保证业务正常使用，需及时对相关资源进行续费操作。

云硬盘续费时会按照续费时长收取费用，续费时长与资源的计费方式相匹配，当云硬盘的计费方式为【小时】，则续费时长可选择 1 至 24 小时；当云硬盘的计费方式为【按月】，则续费时长可选择 1 至 11 月；当云硬盘的计费方式为【按年】，则云硬盘的续费时长为 1 至 5 年。

## 6.12 快照管理

云平台分布式存储支持磁盘快照能力，可降低因误操作、版本升级等导致的数据丢失风险，是平台保证数据安全的一个重要措施。

### 6.12.1 快照概述

快照是某一时间点一块云盘的数据状态文件，可以理解云硬盘某个时刻的数据备份，云硬盘的数据写入和修改不会对已创建的快照造成影响。

支持**定时快照策略**，即一个可周期性执行的自动创建快照的策略，快照策略与快照分离，拥有独立的生命周期。在实际应用中，磁盘快照可降低因误操作、版本升级等导致的数据丢失风险，可大致应用于以下业务场景：

- **容灾备份：** 定时为云硬盘制作快照，当系统出现问题时，可快速回退，避免数据丢失。
- **版本回退：** 在业务做重大升级时，建议预先做好快照，当升级版本出现系统问题无法修复时，可通过快照恢复到历史版本。

平台支持对已绑定虚拟机的系统盘及数据盘进行快照操作，同时支持将快照回滚操作，即将快照数据回滚到关联的云硬盘，以满足数据恢复的应用场景。

### 6.12.2 创建快照

用户可在云硬盘列表页面，为某块云硬盘创建快照；若硬盘已挂载虚拟机，也可通过虚拟机详情页面的硬盘信息列表对硬盘进行快照操作， 同时支持对虚拟机系统盘进行快照备份。为保证数据及磁盘的安全：

* 仅支持对未绑定及已绑定的硬盘进行快照操作，若硬盘在扩容或快照中，无法进行快照备份；
* 创建快照时，不可进行磁盘挂载/卸载及修改虚拟机状态（如开机或关机），否则可能会导致快照创建异常；
* 快照仅捕获已写入硬盘的数据，不包含应用程序或操作系统缓存在内存中的数据，建议在快照暂停对硬盘的 I/O 操作后进行快照制作，如关机或卸载硬盘。

在实际操作中，可通过云硬盘列表页或虚拟机详情磁盘列表操作项中的“**快照**”为云硬盘创建快照。如创建快照向导页面所示，用户可通过核验所需创建的硬盘信息，并输入快照名称，进行快照创建操作。

![createsnapshot](../images/userguide/createsnapshot.png)

一个硬盘同时一时间仅支持创建一个快照，快照创建过程中硬盘的状态为“快照中”，待状态转换为“未绑定”或“已绑定”即代表快照创建成功，用户可通过快照列表页面查看已创建的快照状态及相关信息。

### 6.12.3 查看快照信息

快照创建成功后，用户可通过虚拟机控制台，切换至快照管理页面查看快照资源列表信息及相关信息，包括名称、资源 ID、磁盘、磁盘类型、状态、创建时间及操作项，如下图所示：

![snapshostlist](../images/userguide/snapshostlist.png)

* 资源名称/ID ：代表当前快照的名称及全局唯一标识符；
* 磁盘：代表当前快照对应的磁盘，即代表该快照是由该磁盘创建；
* 磁盘类型：代表当前快照所属硬盘的属性，如数据盘或系统盘；
* 状态：代表当前快照的运行状态，包括创建中、正常、回滚中、删除中，其中回滚中代表当前快照正在进行回滚操作；
* 创建时间：当前快照的创建时间。

列表上的操作项是指对单个快照的操作，包括回滚和删除。为方便租户对快照资源的统计及维护，平台支持下载当前用户所拥有的所有快照资源列表信息为 Excel  表格，同时支持对快照进行批量删除操作。

### 6.12.4 回滚快照

回滚快照是将某一时刻的快照数据回滚到关联的云硬盘，应对快照数据恢复的应用场景。

* 回滚时云硬盘必须处于未绑定或绑定的虚拟机必须处于关机状态；
* 仅支持正常状态的快照进行回滚操作。

用户可通过快照资源列表操作项中的 “**回滚**” 对快照进行回滚操作，仅支持回滚快照至所属硬盘，如下图所示：

![snapshotroll](../images/userguide/snapshotroll.png)

点击确认后，即返回快照列表页面，快照及所属硬盘均转换为 “回滚中” 状态，待回滚成功后，硬盘转换为 “未绑定” 状态，快照转换为 “正常” 状态。快照回滚成功后，所属父硬盘上回滚操作前的数据将被清除，由快照中的数据覆盖，即父硬盘中的数据与当前快照上捕获的数据一致。

![snapshotrol2](../images/userguide/snapshotrol2.png)

若快照所属硬盘处于挂载状态且挂载的虚拟机为开机状态，则无法进行数据回滚操作，如下图所示，需先关闭虚拟机或解绑硬盘。

### 6.12.5 删除快照

平台快照为增量快照，后续快照只保留前一块快照的变化数据，当用户删除中间某个快照后，只会删除该快照中未被后序快照引用的 Block，被引用部分的 Block 将记录到后续快照。

支持用户删除一块硬盘的任何一个快照，假设用户对一块硬盘做了 10 个快照，删除任何一个快照，都不影响快照回滚后的数据。

* 如用户删除第 1 个快照，则系统会将第 1 个快照中的数据合并至第 2 个快照中，保证通过第 2 个快照回滚的数据准确性；
* 如用户只删除了第 2 个快照，则系统会只会删除快照 2 中未被快照 3 引用的数据块，被 3 引用的数据块会被自动记录至快照 3 中，保证快照 3 快照回滚数据的准确性。

![snapshotrm](../images/userguide/snapshotrm.png)

仅支持删除正常状态的快照，如上图所示，用户可通过控制台快照列表页面对某个快照进行删除操作，快照删除后将彻底销毁。

### 6.12.6 修改快照名称

修改快照的名称和备注，在任何状态下均可进行操作。可通过快照资源列表页面每个快照名称右侧的“编辑”按钮进行修改。
# 7 外置存储

## 7.1 产品简述

### 7.1.1 概述

云平台默认提供分布式存储作为虚拟化的后端存储，为云平台用户提供高可用、高性能、高可靠及高安全的存储服务。同时云平台虚拟化支持对接商业存储设备，如 IPSAN 等存储阵列，为云平台虚拟机提供集群中高性能块存储服务，同时可利旧企业用户的集中存储设备，整体节省信息化转型的总拥有成本。

外置存储服务是云平台为企业用户提供的商业存储服务，通过 ISCSI 协议对接商业存储，将商业存储作为虚拟化后端存储池，提供存储池管理及逻辑卷分配，可直接作为虚拟机的系统盘及数据盘进行使用，即只要支持 ISCSI 协议的存储设备均可作为平台虚拟化的后端存储，适应多种应用场景。

平台支持存储设备的对接和管理，并支持将存储设备中的 LUN 分配给租户，由租户将 LUN 分配或挂载至虚拟机的系统盘或数据盘，进行数据的读写，具体功能特性如下：

* 支持存储设备资源池的录入管理，并支持一键扫描 ISCSI 设备中已创建的 LUN 存储卷信息。
* 支持将已扫描的 LUN 存储卷分配给平台租户，使租户有权限使用磁盘作为虚拟机的系统盘或数据盘。
* 支持租户将有权限的 LUN 存储卷信息作为虚拟机的系统盘，使虚拟机直接运行直商业存储中，提升性能。
* 支持租户将有权限的 LUN 存储卷信息作为虚拟机的数据盘。
* 支持将存储卷重新分配给平台其它租户。

基于以上功能特性，平台可支持直接使用商业存储设备作为虚拟化的后端存储，为虚拟机提供传统商业存储设备的存储空间，同时不影响商业存储中的其它 LUN 为其它业务提供存储服务。

平台基于 ISCSI 协议对接商业存储，在对接中需要将存储设备的 LUN 映射到平台计算节点，使平台计算节点上运行的虚拟机可直接使用映射的 LUN ；同时为保证虚拟机的高可用，需要将 LUN 同时映射到一个集群内的所有计算节点，即所有计算节点均可挂载并使用映射的存储卷，以保证宕机迁移时可在每个计算节点挂载该存储卷信息。

* 当虚拟机所在的计算节点故障时，平台会自动触发虚拟机宕机迁移，即将虚拟机迁移至计算集群内正常的计算节点上，使虚拟机可正常提供服务。
* 虚拟机使用的 LUN 存储卷已被映射到集群内所有计算节点，当虚拟机在集群内迁移至新节点后，可直接使用已映射的 LUN 存储启动虚拟机的系统盘或数据盘，并正常挂载至虚拟机，保证虚拟机迁移后业务正常。

平台仅将商业存储的 LUN 作为存储卷进行使用，不对存储卷本身进行管理，如 LUN 的创建、映射、扩容、快照、备份、回滚、克隆等。

### 7.1.2 使用流程

在使用外置存储前，需要平台管理者或存储设备管理者，将外置存储与平台的计算节点网络打通，使计算节点可与存储设备间直接内网可互相通信。

物理存储设备及网络准备好后，即可与平台进行对接并使用平台提供的外置存储服务，整个对接过程需要存储设备管理员、平台管理员及平台租户三个角色进行操作，其中与平台相关的为平台管理员和平台租户的操作，如下图流程所示：

![storageflow](../images/userguide/storageflow.png)

1. **存储设备管理员管理存储卷**

   所有存储卷的管理均由存储设备管理员自行在商业存储的管理系统上进行操作，包括存储卷（Lun）的创建和映射，同时包括存储卷的扩容、快照、备份及删除等相关生命周期管理。

2. **存储设备管理员映射存储卷至集群计算节点**

   创建好的 Lun ，由存储设备管理员在存储设备上映射到所有计算节点（如果新增计算节点，需再次进行映射），同时也可进行多路径映射。

3. **平台管理员录入并管理存储设备**

   存储卷 LUN 映射成功后，由【平台管理员】在管理控制台“外置存储集群”中进行 ISCSI 存储池或存储设备的录入，录入时需要指定存储设备的 ISCSI 地址，如 172.18.12.8:8080 。

4. **平台管理员扫描已映射的 LUN 信息**

   录入的存储设备后，由【平台管理员】在存储设备中一键扫描 ISCSI 存储设备中已被映射至集群节点上的存储卷设备及信息。

5. **平台管理员为租户分配 LUN 设备**

   由【平台管理员】将扫描成功的 LUN 存储卷设备指定给租户，一个存储卷同一时间仅支持分配给一个租户，分配后租户在外置存储设备中即可查询已分配的存储卷设备，并可进行创建虚拟机或挂载虚拟机。

6. **平台租户使用 LUN 存储卷设备**

   平台租户通过控制台外置存储可直接查询已分配的存储卷，并在创建虚拟机时指定系统盘类型为外置存储，或者也可直接将 LUN 存储卷直接挂载给已有虚拟机，作为虚拟机的数据盘进行使用。

平台租户使用外置存储服务的前提是存储卷已映射并分配给租户，租户只需要简单的绑定即可便捷的使用平台提供的外置存储设备，并可进行弹性绑定和解绑。

## 7.2 查看外置存储设备

在平台已提供外置存储服务并已分配存储卷 LUN 设备给租户时，租户的主账号和子账号可在平台上直接查询有权限的存储卷设备，并可将存储卷设备挂载至虚拟机进行数据存储。管理员分配存储卷如下图所示：

![AllocateLUN](../images/userguide/AllocateLUN.png)

用户可登录控制台，通过控制台导航栏【硬盘】进入【外置存储】资源控制台，通过外置存储列表查看已有权限的 LUN 存储卷信息，包括名称、资源 ID、类型、容量大小、状态、集群、LUNID、挂载资源及操作项，如图所示：

![lunlist](../images/userguide/lunlist.png)

* 名称/资源ID：当前存储卷的名称及全局唯一标识符。
* 类型：存储卷的类型，包括系统盘和数据盘，当创建虚拟机选择外置存储卷作为系统盘时类型为系统盘；当存储卷绑定给虚拟机时类型为数据盘。
* 容量大小：存储卷的容量大小，由存储设备管理员创建时指定的大小。
* 状态：存储卷的状态，包括未绑定、已绑定。
* 集群：存储卷的所属存储池集群。
* LUNID：当前存储卷在商业存储中的 LUNID 。
* 挂载资源：当前存储卷已挂载的虚拟机名称和 ID 。

列表上的操作项是指对存储卷的绑定和解绑操作，支持批量解绑操作，同时列表上支持对存储卷设备进行搜索，支持模糊搜索。

## 7.3 外置存储作为系统盘

平台支持将一块 LUN 存储卷设备作为虚拟机的系统盘，当租户被分配外置存储卷时，会自动在外置存储卷列表中获取到有权限的 LUN 设备，同时创建虚拟机时系统盘类型可选择有权限的存储卷的存储池集群。

用户只需要创建虚拟机时选择系统盘类型为平台管理员录入的【存储池名称】，并选择存储池中有权限的存储卷设备作为虚拟机的系统盘，即可将一台虚拟机的系统盘直接运行在外置存储卷设备上。

![createvm-lun](createvm-lun.png)

如上图所示，选择 EMCPowerStore 商业存储中的一个外置存储卷作为系统盘，即可将外置存储卷作为虚拟机的系统盘。作为虚拟机的系统盘后，可通过虚拟机详情【外置存储】中查看已使用的外置存储卷信息。

> 作为虚拟机系统盘的外置存储 LUN 设备与虚拟机的生命周期一致，不支持解绑操作。

## 7.4 外置存储作为数据盘

平台支持将一块 LUN 存储卷设备作为虚拟机的数据盘，当租户被分配外置存储卷时，会自动在外置存储卷列表中获取到有权限的 LUN 设备，LUN 存储卷作为数据盘的使用方式与平台默认的云硬盘一致，只需要简单的绑定操作即可。

用户只需要在外置存储设备列表上将 LUN 设备直接绑定至虚拟机，即可将一块 LUN 存储卷作为虚拟机的数据盘进行使用，仅支持绑定状态为【未绑定】状态的存储卷设备，同时平台支持用户随时将存储卷从虚拟机上解绑。

## 7.5 解绑外置存储

平台支持将已挂载至虚拟机 LUN 存储卷进行解绑，重新绑定至其它虚拟机。仅支持解绑状态为【已绑定】状态的存储卷，解绑操作不影响虚拟机系统盘的正常访问，同时不影响存储卷设备中的数据。

# 8 私有网络

## 8.1 VPC 简介

### 8.1.1 概述

UCloudStack 通过软件定义网络 （ SDN ）对传统数据中心物理网络进行虚拟化，采用 OVS 作为虚拟交换机，VXLAN 隧道作为 OverLay 网络隔离手段，通过三层协议封装二层协议，用于定义虚拟私有网络 VPC 及不同虚拟机 IP 地址之间数据包的封装和转发。

私有网络（ VPC ——Virtual Private Cloud ）是一个属于用户的、逻辑隔离的二层网络广播域环境。在一个私有网络内，用户可以构建并管理多个三层网络，即子网（ Subnet ），包括网络拓扑、IP 网段、IP 地址、网关等虚拟资源作为租户虚拟机业务的网络通信载体。

私有网络 VPC 是虚拟化网络的核心，为云平台虚拟机提供内网服务，包括网络广播域、子网（IP 网段）、IP 地址等，是所有 NVF 虚拟网络功能的基础。私有网络是子网的容器，不同私有网络之间是绝对隔离的，保证网络的隔离性和安全性。

可将虚拟机、负载均衡、弹性网卡、NAT 网关等虚拟资源加入至私有网络的子网中，提供类似传统数据中心交换机的功能，支持自定义规划网络，并通过安全组对虚拟资源 VPC 间的流量进行安全防护。

> 可通过 IPSecVPN、专线及外网 IP 接入等方式将云平台私有网络及虚拟资源与其它云平台或 IDC 数据中心组成一个按需定制的混合云网络环境。

VPC 网络具有数据中心属性，每个 VPC 私有网络仅属于一个数据中心，数据中心间资源和网络完全隔离，资源默认内网不通。租户内和租户间 VPC 网络默认不通，从不同维度保证租户网络和资源的隔离性。

### 8.1.2 VPC 逻辑结构

一个 VPC 网络主要由私有网络网段和子网两部分组成，如下图所示：

![vpccom](../images/userguide/vpccom.png)

**（1）私有网络网段**

VPC 网络所属的 CIDR  网段，作为 VPC 隔离网络的私网网段。关于 CIDR 的相关信息，详见 [CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing) 。创建 VPC 网络需指定私有网段，平台管理员可通过管理控制台自定义 VPC 私有网络的网段，使租户的虚拟资源仅使用管理员定义网段的 IP 地址进行通信。平台 VPC 私有网络 CIDR 默认支持的网段范围如下表所示：

| 网段           | 掩码范围 | IP 地址范围                   |
| -------------- | -------- | ----------------------------- |
| 10.0.0.0/8     | 8 ~ 29   | 10.0.0.0 - 10.255.255.255     |
| 172.16.0.0/12  | 12 ~ 29  | 172.16.0.0 - 172.31.255.255   |
| 192.168.0.0/16 | 16 ~ 29  | 192.168.0.0 - 192.168.255.255 |

> 由于 DHCP 及相关服务需占用 IP 地址，私有网络 CIDR 网段不支持 `30` 位掩码的私有网段。

**（2）子网**

子网（ Subnet ）是 VPC 私有网络的基础网络地址空间，用于虚拟资源间内网连接。

* 一个私有网络至少由一个子网组成，子网的 CIDR 必须在 VPC 的 CIDR 网段内；
* 同一私有网络内子网间通过`公共网关`连接，资源默认内网互通，可部署虚拟机、负载均衡、NAT 网关、Redis、MySQL 及 IPSecVPN 网关等；
* 同一个 VPC 子网间默认通过公共网关进行互通；
* 子网 CIDR 网段拔码最小为 `29` 位，不支持 `30` 、`32` 位掩码的子网网段； 
* 每个子网中，使用第一个可用 IP 地址作为网关，如 `192.168.1.0/24` 的网关地址是 `192.168.1.1` 。

> 当子网中存在虚拟资源时，不允许删除并销毁私有网络和子网资源。

### 8.1.3 VPC 连接

平台对常用网络设备均进行软件定义及组件抽像，通过将 VPC 网络与虚拟机、弹性网卡、外网 IP、安全组、NAT 网关、负载均衡、VPN 网关、MySQL 数据库、Redis 缓存及专线等组件连接，可快速构建和配置繁杂的网络环境及混合云场景，如下图所示：

![vpccon.png](../images/userguide/vpccon.png)

* 虚拟机默认内网网卡（创建时自带的虚拟网卡）加入同一个 VPC 网络实现虚拟机间网络通信，并可通过安全组保证虚拟机东西向流量安全。
* 虚拟机默认外网网卡（创建时自带的虚拟网卡）可直接绑定多个外网 IP 地址实现 Internet 访问，同时可绑定与 IDC 物理网络相连的外网 IP 地址实现物理网络打通，结合安全组管控虚拟机南北向流量的同时，构建安全可靠的混合接入环境。
* 虚拟机的弹性网卡加入不同的 VPC 网络及子网，实现精细化网络管理及廉价故障转移方案，同时将安全组与弹性网卡绑定，通过安全组规则多维度保障私有网络及虚拟资源的安全。
* 虚拟机与 UDB、URedis 服务加入同一个 VPC 网络，满足业务应用和数据库、缓存服务连通场景。
* 相同 VPC 网络的虚拟机可通过 NAT 网关及外网 IP 连接，共享外网 IP 访问 Internet 或 IDC 数据中心网络，并可通过 DNAT 端口映射对外提供业务服务。
* 相同 VPC 网络的虚拟机加入至内网 ULB 后端服务节点，提供 VPC 网络内负载均衡服务。
* 相同 VPC 网络的虚拟机加入到外网 ULB 后端服务节点，结合 ULB 关联的外网 IP ，提供外网负载均衡服务。
* 相同 VPC 网络的虚拟机通过 IPSecVPN 网关可与不同 VPC 网络的虚拟机进行内网互联，实现 VPC 间互通。
* 通过 IPSecVPN 网关打通不同 VPC 间的网络，使两个 VPC 间的虚拟机可直接进行内网通信。
* 采用 IPSecVPN 网关或专线将平台与本地 IDC 数据中心及第三方云平台连通，构建安全可靠的混合云环境。

> 外网 IP 可用于打通 IDC 数据中心的物理网络，应用与虚拟机直接与物理机进行内网通信的场景；IPSecVPN 网关用于打通第三方云平台或 IDC 数据中心的虚拟网络，应用于不同云平台间通过 VPN 安全连接场景。

### 8.1.4 功能与特性

平台 VPC 网络基于租户控制台和 API 提供隔离网络环境、自定义子网、子网通信及安全防护等功能，并可结合硬件及 DPDK 等技术特性提供高性能的虚拟网络。

* 隔离的网络环境

  私有网络基于 [OVS](http://www.openvswitch.org/)（ Open vSwitch）组件，通过 [VXLAN](https://datatracker.ietf.org/doc/rfc7348/) 隧道封装技术实现隔离的虚拟网络。每一个 VPC 网络对应一个 VXLAN 隧道号（VNI），作为全局唯一网络标识符，为租户提供一张独立且完全隔离的二层网络，可通过在私有网络中划分多个子网作为虚拟资源的通信载体，用于连通多个虚拟资源。不同的 VPC 网络间完全隔离，无法直接通信。

* 自定义子网

  支持在一个 VPC 网络内进行三层网络规划，即划分一个或多个子网。提供自定义 IP 网段范围、可用 IP 网段及默认网关，可在子网中通过虚拟机部署应用程序和服务。支持在子网中增加多个弹性网卡，分别指定子网中的 IP 地址，并绑定至部署应用程序的虚拟机，用于精细化管理应用服务的网络访问。

* 子网通信

  每一个子网都属于一个广播域，VPC 网络默认提供网关服务，同一个 VPC 内不同子网通过网关进行通信。

* 安全防护

  云平台提供内网安全组和外网防火墙，通过协议、端口为虚拟资源提供多维度安全访问控制，同时基于虚拟网卡及虚拟实例的网络流量进行上下行的 QoS 控制，全方位提高 VPC 网络的安全性。安全组为有状态安全层，可分别设置出入方向的安全规则，用于控制并过滤进出子网 IP 的数据流量。

* 高性能虚拟网络

  SDN 网络分布式部署于所有计算节点，节点间通过 20GE 冗余链路进行通信，并通过所有计算节点负载内网流量，为云平台提供高可靠及高性能的虚拟网络。

云平台在保证网络隔离、网络规模、网络通信及安全的同时，为租户和子账号提供 VPC 子网的创建、修改、删除及操作审计日志等全生命周期管理。用户创建虚拟机、NAT 网关、负载均衡、VPN 网关、MySQL 及  Redis 等虚拟资源时可指定需加入的VPC 网络和子网，并可查询每个子网的可用 IP 数量。

VPC 网络具有数据中心属性，不同数据中心之间的虚拟资源默认内网不互通，同数据中心内不同 VPC 间默认内网不互通，同一个 VPC 的所有子网和资源默认内网互通。仅支持指定相同数据中心的虚拟资源到 VPC 网络中，且每个 VPC 网络的子网网段必须在 VPC 网络的 CIDR 网段中。

平台会通过管理员配置的 VPC 网络，为每个租户和子账号提供默认的 VPC 网络和子网资源，方便用户登录云平台快速部署业务。

## 8.2 创建 VPC

用户可通过指定 VPC 名称和 [CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing) 网段一键添加一个 VPC 网络，用于搭建不同业务的网络环境。VPC 创建成功网段即不可修改，创建 VPC 网络需提前规划网络，如规划业务 IP 网段及 IP 地址。

通过导航栏进入 “VPC 网络”资源列表页面，即可创建 VPC 网络，如下图所示：

![createvpc](../images/userguide/createvpc.png)

选择并配置 VPC 网络的名称及网段信息：

- VPC 名称：当前需要创建的 VPC 网络的名称标识；
- VPC 网段：VPC 网络所包含的 IP 网段，创建成功后无法修改，VPC 下所有子网共享该网段 IP 地址。

VPC 网络创建时状态为“创建中”，待状态转换为“有效”时，即代表 VPC 网络创建成功，通常可在 5 秒内完成 VPC 网络的创建，用户可通过 VPC 列表查看已创建的 VPC 资源信息。

## 8.3 查看私有网络

通过导航栏进入 VPC 网络控制台，可查看 VPC 网络资源的列表，并可通过列表上 VPC 名称可进入详情页面查看 VPC 网络及子网资源的详情信息。

### 8.3.1 私有网络列表

VPC 网络列表页可查看当前账户下 VPC 资源的列表及相关信息，包括名称、资源 ID、网段、子网数量、状态、创建时间及操作项，如下图所示：

![vpclist](../images/userguide/vpclist.png)

- 名称/ID ：VPC 私有网络的名称及全局唯一标识符；
- 网段：当前 VPC 网络在创建时指定的 CIDR 网段信息；
- 子网数量：当前 VPC 网络包含的子网数量；
- 状态：当前 VPC 网络的状态，一般为有效；
- 创建时间：当前 VPC 网络资源的创建时间；

列表上的操作项是可对单个 VPC 网络进行删除操作，可通过搜索框对 VPC 列表进行搜索和筛选，支持模糊搜索。

为方便租户对资源的统计及维护，平台支持下载当前用户所拥有的所有 VPC 网络资源列表信息为 Excel 表格；同时支持对 VPC 网络进行批量删除操作。

### 8.3.2 私有网络详情

在 VPC 网络列表上，点击 VPC 名称或 ID 可进入概览页面查看当前 VPC 网络的详情及子网信息，同时可切换至操作日志页面查看当前 VPC 网络及子网的操作日志信息，如下图概览页所示：

![vpcdetails](../images/userguide/vpcdetails.png)

**（1）基本信息**

VPC 网络的基本信息，包括资源 ID、资源名称、地域（数据中心）、网段、创建时间及状态。

**（2）子网管理**

VPC 详情页面展示当前 VPC 网络中已创建的子网资源列表，包括名称、资源 ID、网段、状态、创建时间及对子网的操项，其中网段指当前子网的网段，包含在 VPC 网络的网段中。

子网列表上的操作项是可对单个子网进行删除操作，仅支持删除未被资源使用的子网资源。为方便租户对子网资源的维护，平台支持子网的批量删除操作。

## 8.4 修改名称和备注

修改 VPC 私有网络的名称和备注，在任何状态下均可进行操作。可通过 VPC 私有网络列表页面每个 VPC 名称右侧的“编辑”按钮进行修改。

## 8.5 删除私有网络

支持用户删除并释放未被任何资源占用 IP 地址的 VPC 网络。VPC 网络删除后会被彻底销毁，删除前须保证已清空 VPC 网络已创建的资源。删除操作如下图所示：

![deletevpc](../images/userguide/deletevpc.png)

## 8.6 添加子网

添加子网是指为一个 VPC 网络添加子网，即三层网络，用于组建属于用户业务的私有网段，每一个网段是一个独立的广播域。子网的 CIDR 网段必须在 VPC 的 CIDR 网段内，同一子网内的资源默认内网互通，同一 VPC 下的所有子网默认互通。

用户可通过指定子网名称、子网 CIDR 网段为一个 VPC 网络添加一个或多个子网，用于构建内网不同的业务网络。创建子网前需保证 VPC 网络 CIDR 内有充足的 IP 网段，可通过 VPC 网络详情页面子网列表的“**创建子网**”进入创建向导页面，如下图所示

![createsubnet](../images/userguide/createsubnet.png)

- 名称/描述：当前需要创建的子网的名称和描述信息；
- 子网网段：当前需要创建的子网的 CIDR 网段，子网网段必须在 VPC 的 CIDR 网段内，可以与 VPC CIDR 网段相同，即代表该子网包括 VPC 下所有的网络 IP 地址。

子网创建时状态为“创建中”，子网创建成功后，子网的状态转换为“有效”，可用于资源创建。

> 注：若子网网段的与 VPC 网段相同，则当前私有网络仅支持一个子网。

## 8.7 删除子网

用户可通过子网列表上的“**删除**”功能删除当前子网资源，被删除的子网将被直接销毁。删除子网前须保证子网内的资源已被清空，包含回收站的资源，否则不允许删除当前子网，如下图所示：

![rmsubnet](../images/userguide/rmsubnet.png)

## 8.8 修改子网名称

修改子网的名称和备注，在任何状态下均可进行操作。可通过点击子网列表页面每个子网名称右侧的“编辑”按钮进行修改。

# 9 外网弹性 IP

##  9.1 EIP 简介

### 9.1.1 概述

外网弹性 IP（ Elastic IP Address ，简称 EIP ），是平台为用户的虚拟机、NAT 网关、VPN 网关及负载均衡等虚拟资源提供的外网 IP 地址，为虚拟资源提供平台 VPC 网络外的网络访问能力，如互联网或 IDC 数据中心物理网络，同时外部网络也可通过 EIP 地址直接访问平台 VPC 网络内的虚拟资源。

EIP 资源支持独立申请和拥有，用户可通过控制台或 API 申请 IP 网段资源池中的 IP 地址，并将 EIP 绑定至虚拟机、 NAT 网关、负载均衡、VPN 网关上，为业务提供外网服务通道。

### 9.1.2 物理架构

在私有云平台中，允许平台管理员自定义平台外网 IP 资源池，即由平台管理员自定义平台访问外网的方式，外网 IP 网段资源池在添加至云平台前，需要通过物理网络设备下发至计算节点连接的交换机端口。

![EIPtopology](../images/userguide/EIPtopology.png)

如上图物理架构示意图所示，所有计算节点需要连接网线至物理网络的外网接入交换机，并在物理网络的交互机上配置所连接端口允许透传 Vlan 的网络访问方式，使运行在计算节点上虚拟机可通过外网物理网卡直接与外部网络进行通信：

* 若通过外网 IP 访问互联网，需要物理网络设备上将自定义的外网 IP 网段配置为可直通或 NAT 到互联网；
* 若通过外网 IP 访问 IDC 数据中心的物理网络，需要在物理网络设备上将自定义的外网 IP 网段配置为可与 IDC 数据中心网络通信，如相同的 Vlan 或 Vlan 间打通等。

> 物理网络架构为高可用示意图，实际生产环境架构可进行调整，如内外网接入交换机可合并为一组高可用接入交换机，通过不同的 Vlan 区分内外网等。

### 9.1.3 逻辑架构

物理网络架构及配置确认后，在平台层面需要分别添加互联网 IP 网段和 IDC 物理网段至云平台 IP 网段资源池中，租户可申请不同网段的 EIP 地址，并将通往不同网络的 EIP 地址绑定至虚拟机默认外网网卡，使虚拟机可通过外网 IP 地址同时访问互联网和 IDC 数据中心物理网络。

![eiparch](../images/userguide/eiparch.png)

如逻辑架构图所示，用户在平台中分别添加通往 Internet (Vlan200) 和通往 IDC 物理网络（Vlan100）的网段至云平台。网段举例如下：

* Vlan200 的网段为`106.75.236.0/25` ，配置下发默认路由，即虚拟机绑定网段的 EIP 将会自动下发目标地址为 0.0.0.0/0 的默认路由；
* Vlan100 的网段为`192.168.1.0/24` ，仅下发当前网段路由，即虚拟机绑定网段的 EIP 仅下发目标地址为 192.168.1.0/24 的指定路由。

租户可分别申请 Vlan200 和 Vlan100 的 EIP 地址，并可将两个 EIP 同时绑定至虚拟机。平台会将 EIP 地址及下发路由直接配置至虚拟机外网网卡，并通过 SDN 控制器下发流表至虚拟机所在的物理机 OVS ，物理机 OVS 通过与物理机外网网卡接口及交换机进行互联，通过交换机设备与互联网或 IDC 物理网络进行通信。

当虚拟机需要访问互联网或物理网络时，数据会通过虚拟机外网网卡直接透传至物理机的 OVS 虚拟交换机，并通过 OVS 流表将请求转发至物理机外网网卡及物理交换机，经由物理交换机的 Vlan 或路由配置将数据包转发至互联网或 IDC 物理网络区域，完成通信。

如上图 VPC1 网络的虚拟机同时绑定了 Vlan100 和 Vlan200 网段的 EIP 地址，Vlan100 EIP 为 `192.168.1.2` ，Vlan200 EIP 为 `106.75.236.2` 。平台会直接将两个 IP 地址直接配置至虚拟机的外网网卡，通过虚拟机操作系统可直接查看配置到外网网卡的 EIP 地址；同时自动下发两个 IP 地址所属网段需要下发的路由到虚拟机操作系统中，虚拟机的默认路由指定的下一跳为 Vlan200 互联网网段的网关，使虚拟机可通过 `106.75.236.2`  IP 地址与互联网进行通信，通过 `192.168.1.2`  与物理网络区域的 Oracle 及 HPC 高性能服务器进行内网通信。

整个通信过程直接通过虚拟机所在物理机的物理网卡进行通信，在物理网卡和物理交换机性能保障的前提下，可发挥物理网络硬件的最佳转发性能，提升虚拟机对外通信的转发能力。同时所有外网 IP 流量均可通过平台安全组在平台内进行流量管控，保证虚拟机访问平台外部网络的安全性。

### 9.1.4 功能特性

EIP 为浮动 IP ，可随故障虚拟机恢复漂移至健康节点，继续为虚拟机或其它虚拟资源提供外网访问服务。

![eip](../images/userguide/eip.png)

当一台虚拟机所在的物理主机发生故障时，智能调度系统会自动对故障主机上的虚拟机进行宕机迁移操作，即故障虚拟机会在其它健康的主机上重新拉起并提供正常业务服务。若虚拟机已绑定外网 IP ，智能调度系统会同时将外网 IP 地址及相关流表信息一起漂移至虚拟迁移后所在的物理主机，并保证网络通信可达。

* 支持平台管理员自定义外网 IP 资源池，即自定义外网 IP 网段，并支持配置网段的路由策略。租户申请网段的外网 IP 绑定至虚拟资源后，下发目的路由地址的流量自动以绑定的外网 IP 为网络出口。
* 外网 IP 网段支持下发默认路由和指定路由，下发默认路由代表默认所有流量均以绑定的外网IP为出口，指定路由为管理员指定目的地址的流量以绑定的外网IP为出口。
* **提供 IPv4/IPv6 双栈能力，管理员可自定义管理 IPv4 和 IPv6 网段资源池，并支持同时绑定 IPv4/IPv6 地址到虚拟机，为虚拟机提供双栈网络通信服务。**

- 支持外网 IP 网段的权限管控，可指定所有租户或部分租户使用，未被指定的租户无权限申请并使用网段 EIP。
- EIP 具有弹性绑定的特性，支持随时绑定至虚拟机、NAT 网关、负载均衡、VPN 网关等虚拟机资源，并可随时解绑绑定至其它资源。
- 虚拟机支持绑定 10 个外网 IPv4 和 10 个外网 IPv6 地址，以第一个有默认路由的外网 IP 作为虚拟机的默认网络出口。
- 提供外网 IP 网段获取服务，支持租户手动指定 IP 地址申请  EIP，并提供 IP 地址冲突检测，方便用户业务网络地址规划。
- 平台管理员可自定义外网 IP 网段的带宽规格，租户可在带宽规格范围内配置外网 IP 的带宽上限。

外网 IP 具有数据中心属性，仅支持绑定相同数据中心的虚拟资源。用户可通过平台自定义申请 EIP ，并对 EIP 进行绑定、解绑、调整带宽等相关操作。

## 9.2 申请外网 IP 

申请 EIP 是指租户通过控制台从管理员自定义的外网 IP 网段中申请一个 IPv4 或 IPv6 的外网 IP 地址，并将 IP 地址绑定至虚拟机、负载均衡、NAT 网关、VPN 网关、MySQL 及 Redis 等资源，为虚拟资源提供外网访问能力。

申请 EIP 时需指定 IP 版本、所属网段、IP 地址、资源名称及带宽上限等信息，可通过导航栏进入【外网 IP】资源控制台，通过“申请外网 IP” 进入向导页面，如下图所示：

![createEIP](../images/userguide/createEIP.png)

1. 选择并配置所申请外网 IP 基础配置及管理设置信息：

* 名称/描述：申请外网 IP 的名称和描述，申请时必须指定名称。

- 计费方式：资源的计费方式，目前仅支持带宽计费，即以带宽作为计费对象和出口上限，不限制流量。
- IP 版本：外网 IP 地址的 IP 版本，支持 IPv4 和 IPv6 。
  - 选择 IPv4 时，则网段仅展示 IPv4 的网段；
  - 选择 IPv6 时，则网段仅展示 IPv6 的网段，若平台管理员未定义 IPv6 网段，则 IP 版本仅支持 IPv4 。
- 网段：所申请外网 IP 的所属网段，由平台管理员自定义，同时会展示该网段的 IP 网段，手动指定的 IP 地址必须在网段 IP 地址范围内。
- IP 地址：用户手动指定 IP 地址申请 EIP ，指定的 IP  地址必须在所选网段的 IP 范围内。
- 带宽：所申请 EIP 资源的带宽出口上限，规格范围由平台管理员自定义，单位为 Mbps 。

2. 选择购买数量和付费方式，确认订单金额并点击“立即购买” 进行 EIP 的申请和创建。

- 购买数量：按照所选配置及参数批量创建多个 EIP 地址，当前支持批量创建 10 个 EIP ；
- 付费方式：选择 EIP 的计费方式，支持按时、按年、按月三种方式，可根据需求选择适合的付费方式；
- 合计费用：用户选择 EIP 资源按照付费方式的费用展示；
- 立即购买：点击立即购买后，会返回 EIP 资源列表页，在列表页可查看 EIP 的申请过程，通常会先显示“申请中”的状态，几秒内转换为“未绑定”状态，即代表申请成功。

## 9.3 查看外网 IP

通过导航栏进入外网 IP 控制台，可查看外网 IP 资源列表，并可通过列表上名称和 ID 进入详情页面查看外网 IP 的详细信息及操作日志等。

### 9.3.1 外网 IP 列表

外网 IP 列表可查看当前账户下所有 EIP 资源的列表信息，包括名称、资源 ID、IP、IP 版本、带宽、绑定资源、路由类型、计费方式、创建时间、过期时间、状态及操作项，如下图所示：

![eiplist](../images/userguide/eiplist.png)

- 名称/ID：EIP 资源的名称及全局唯一标识符。
- IP 地址：EIP 资源的 IP 地址及网段名称，若 IP 版本为 IPv6 则显示为 IPv6 地址。
- IP 版本：EIP 地址的 IP 版本，如 IPv4 或 IPv6 。
- 带宽：EIP 资源申请时指定的带宽出口上限。
- 绑定资源：EIP 已绑定的资源名称和资源 ID ，资源类型可以为虚拟机、NAT 网关、负载均衡及 VPN 网关。
- 路由类型：EIP 地址所属网段定义的路由类型，包括默认路由和非默认路由（指定路由或未指定路由）。
  - 默认路由绑定至虚拟资源，会自动下发目标地址为 0.0.0.0/0 的路由，即默认路由；
  - 非默认路由绑定至虚拟资源，仅会下发用户指定目标地址的路由。
- 计费方式：EIP 地址的付费方式，包括按时、按年、按月。
- 创建时间/过期时间：EIP 资源的创建时间和费用过期时间。
- 状态：EIP 资源的状态，包括申请中、未绑定、绑定中、已绑定、解绑中、修改带宽中、删除中等状态。

列表上的操作项是指对单个外网 IP 地址的操作，包括绑定、解绑、修改带宽及删除等，可通过搜索框对外网 IP 列表进行搜索和筛选，支持模糊搜索。

为方便租户对资源的统计及维护，平台支持下载当前用户所拥有的所有外网 IP 资源列表信息为 Excel 表格；同时支持对外网 IP 进行批量解绑和批量删除操作。

### 9.3.2 外网 IP 详情

在外网 IP 资源列表上，点击名称或 ID 可进入概览页面查看当前外网 IP 的详细信息，同时可切换至操作日志页面查看当前外网 IP 的操作日志，如概览页所示：

![eipdetails](../images/userguide/eipdetails.png)

- 基本信息：外网 IP 地址的基本信息，包括名称、ID、IP 地址、IP 版本、带宽、绑定资源、状态、创建时间及告警模板信息。

  - 可点击名称右侧按钮修改外网 IP 的名称和备注信息；
  - 可点击告警模板右侧按钮修改外网 IP 所关联的告警模板，默认会绑定 Default 告警模板。

  > 仅当外网 IP 被绑定至虚拟机资源时，才可修改告警模板。

- 监控信息：当前外网 IP 地址的监控信息，包括网卡出带宽使用率、出/入带宽及出/入包量。

- 操作日志：操作日志页面展示当前外网 IP 的操作日志。可提供自定义时间级别的日志展示，同时可对日志进行模糊搜索，默认提供两周内的操作日志，可通过切换日期周期查看不同时间周期的操作日志。

## 9.4 绑定外网 IP

绑定外网 IP 是指将 EIP 地址绑定至虚拟机、NAT 网关、负载均衡及 VPN 网关，为虚拟资源提供外网服务能力。

* 虚拟机支持绑定 50 个 IPv4 和 10 个 IPv6 外网 IP 地址，默认以第一个有默认路由的 IP 地址作为虚拟机的默认网络出口。
* IPv6 外网 IP 仅支持绑定至虚拟机，不支持绑定至其它资源。
* 虚拟机绑定外网 IP 地址后，系统会将外网 IP 地址及所属网段下发路由直接配置至虚拟机自带的默认外网网卡，通过虚拟机操作系统可直接查看所有绑定至虚拟机的外网 IP 地址及相关路由信息。
* NAT 网关仅支持绑定一个外网 IPv4 且有默认路由的 IPv4 地址，不支持绑定 IPv6 外网 IP 地址。
* VPN 网关仅支持绑定一个外网且有默认路由 IPv4 地址，不支持绑定 IPv6 外网 IP 地址。
* 负载均衡仅支持绑定一个外网 IPv4  且有默认路由 IPv4 地址，不支持绑定 IPv6 外网 IP 地址。

一个外网 IP 同时仅支持绑定一个虚拟资源，仅支持未绑定状态的外网 IP 进行绑定操作，且被绑定的资源必须处于运行中、有效或关机状态。用户可通过外网 IP 资源列表操作项的“绑定”进入外网 IP 绑定向导页面，进行资源绑定操作，如下图所示：

![eiplink](../images/userguide/eiplink.png)

绑定时需选择被绑定资源的类型及绑定资源对象：

（1）资源类型：指被绑定对象的资源类型，支持绑定给虚拟机、负载均衡、NAT 网关、VPN 网关。

（2）资源对象：指被绑定的资源对象，不同的资源类型可选的资源对象不同。
* 虚拟机：可根据虚拟机名称及内网 IP 地址选择需绑定的虚拟机资源，不可选择至已绑定 50 个 IPv4 或 10 个 IPv6 地址的虚拟机；
* 负载均衡：可根据名称和 ID 选择需绑定的负载均衡资源，仅支持选择未绑定外网 IP 地址且类型为外网的负载均衡实例，不支持为负载均衡绑定 IPv6 外网 IP。
* NAT 网关：可根据名称和 ID 选择需绑定的 NAT 网关资源，仅支持选择未绑定外网 IP 地址的 NAT 网关，不支持为 NAT 网关绑定 IPv6 外网 IP。
* VPN 网关：可根据名称和 ID 选择需绑定的 VPN 网关资源，仅支持选择未绑定外网 IP 地址的 VPN 网关，不支持为 VPN 网关绑定 IPv6 外网 IP。

绑定过程中外网 IP 地址的状态为“**绑定中**”，待状态变更为“**已绑定**”即代表绑定成功，用户也可通过被绑定资源查看绑定外网 IP 地址的信息。通常绑定会即时完成，可通过 `ping `  外网 IP 或相关网络工具测试绑定是否生效；若发现网络不通时，需先查看资源已绑定的安全组规则是否放通网络访问，针对虚拟机需针对场景分别检测内网安全组和外网安全组的规则策略。

## 9.5 解绑外网 IP

解绑外网 IP 是指将 EIP 地址从一个虚拟资源上分离出来，并可重新绑定至其它虚拟资源。仅支持解绑已绑定状态的外网 IP 资源。用户可通过外网 IP 列表操作项进行外网 IP 的解绑操作，如下图所示：

![eipunlink](../images/userguide/eipunlink.png)

解绑时，外网 IP 的状态转换为“解绑中”，待外网 IP 地址的状态转为换 “未绑定” ，即代表解绑成功，被解绑的资源网络或服务可能会受到影响。

* 虚拟机的外网 IP 地址被解绑后，不会影响虚拟机本身的内网通信。若解绑的外网 IP 地址为虚拟机默认网络出口，则系统会自动选择下一个有默认路由的外网 IP 作为虚拟机的默认网络出口。
* 若 NAT 网关仅绑定一个外网 IP 地址，则外网 IP 地址被解绑后，会影响 NAT 网关的网络服务，所有 SNAT 及 DNAT 服务失效，即 SNAT 和 DNAT 规则中关联的资源均无法通过 NAT 网关访问外网或对外提供端口映射服务，需重新绑定一个外网 IP 地址才可正常生效。
* 若 NAT 网关绑定多个外网 IP 地址，则解绑一个外网 IP 地址，只会影响 NAT 网关中使用到已解绑外网 IP 的 SNAT 及 DNAT 规则及相关联的资源。
* 负载均衡的外网 IP 地址被解绑后，会影响负载均衡的网络服务，用户无法通过原外网 IP 地址负载访问服务节点中部署的服务。
* VPN 网关的外网 IP 地址被解绑后，会影响 VPN 网关的网络服务，IPSecVPN 两端内网无法进行通信，需重新绑定外网 IP 地址，并在对端平台或数据中心 VPN 网关处修改对端网关的 IP 地址为新绑定的 EIP 才可正常进行连接。

## 9.6 调整带宽

调整带宽是指对一个外网 IP 的带宽上限进行升级或降级，以适应业务对带宽的不同需求。可调整的带宽规格由云平台管理员在管理控制台上自定义，不同外网 IP 资源池支持不同的带宽规格配置。

支持在线或离线调整带宽，即可在不停止服务的情况下实时调整外网 IP 的带宽，且不会影响已绑定资源的网络通信。根据不同的付费方式，带宽调整可能会对费用及生效时间产生影响。

- 按小时付费的的弹性IP，升降带宽，下个付费周期生效；
- 按年，按月付费的弹性IP，升级带宽，即时生效，并自动补差价；
- 按年，按月付费的弹性IP，直到当前付费周期的最后一天才允许降级带宽，下个付费周期生效。

用户可通过外网 IP 资源列表操作项 “**调整带宽**” 进入修改向导页面，进行带宽调整，如下图所示：

![upbandwidth](../images/userguide/upbandwidth.png)

修改带宽中 EIP 状态转换为 “调整带宽中” ，成功后转换为 “未绑定”或“已绑定”状态。在私有云环境中，外网 IP 地址可以由“内网 IP 地址” 模拟，即管理员在物理网络上为云平台下发的外网 IP 网段为一个 NAT 后的内网 IP 地址段，则外网 IP 地址的真正带宽，是控制在物理网络层面。

平台的带宽调整仅作为一个 IP 地址可通信的带宽上限，如果外网 IP 地址网段是作为与 IDC 数据中心物理网络进行纯内网通信时，可将带宽规格设置为内网最大带宽，如 10000Mbps 。

## 9.7 修改告警模板

修改告警模板是对外网 IP 的监控数据进行告警的配置，通过告警模板定义的指标及阈值，可在外网 IP 相关指标故障及超过指标阈值时，触发告警，通知相关人员进行故障处理，保证外网 IP 网络通信正常。

![eipalarm](../images/userguide/eipalarm.png)

用户可点击外网 IP 详情概览页中告警模板右侧的按钮进行告警模板修改操作，在修改告警模板向导中选择新外网 IP 告警模板，点击确定立即生效。

> 仅当外网 IP 地址被绑定至虚拟资源后，才可进行告警模板的修改。

## 9.8 修改外网 IP 名称

修改外网 IP 资源的名称和备注，在任何状态下均可进行操作。可通过点击外网 IP 资源列表名称右侧的“编辑”按钮进行修改。

## 9.9 删除外网 IP

用户可在控制台删除账户内未绑定虚拟资源的外网 IP 地址，支持批量删除。仅支持删除未绑定状态的外网 IP 资源。被删除的外网 IP 会自动进入“**回收站**”，可进行恢复和彻底销毁等操作。

可通过外网 IP 列表操作项中的“删除”进行操作，如下图所示：

![eiprm](../images/userguide/eiprm.png)

## 9.10 续费外网 IP

支持用户手动对外网 IP 进行续费，续费操作只针对资源本身，不对资源额外关联的资源进行续费，如虚拟机、NAT 网关、负载均衡、VPN 网关等。额外关联的资源到期后，会自动解绑，为保证业务正常使用，需及时对相关资源进行续费操作。

外网 IP 续费时会按照续费时长收取费用，续费时长与资源的计费方式相匹配，当外网 IP 的计费方式为【小时】，则续费时长可选择 1 至 24 小时；当外网 IP 的计费方式为【按月】，则续费时长可选择 1 至 11 月；当外网 IP 的计费方式为【按年】，则续费时长为 1 至 5 年。

# 10 安全组

## 10.1 安全组简介

### 10.1.1 概述

安全组（ Security Group ）是一种类似 [IPTABLES](https://en.wikipedia.org/wiki/Iptables) 的虚拟防火墙，提供出入双方向流量访问控制规则，定义哪些网络或协议能访问资源，用于限制虚拟资源的网络访问流量，支持 IPv4 和 IPv6 双栈限制，为云平台提供必要的安全保障。

平台安全组基于 Linux Netfilter 子系统，通过在 [OVS](http://www.openvswitch.org/) 流表中添加流表规则实现，需开启宿主机 IPv4 和IPv6 包转发功能。每增加一条访问控制规则会根据网卡作为匹配条件，生成一条流表规则，用于控制进入 OVS 的流量，保证虚拟资源的网络安全。

安全组仅可作用于**同一个数据中心** 内具有相同安全需求的虚拟机、弹性网卡、负载均衡及 NAT 网关，工作原理如下图所示：

![Secrity_group](../images/userguide/Secrity_group.png)

安全组具有独立的生命周期，可以将安全组与虚拟机、弹性网卡、负载均衡、NAT 网关绑定在一起，提供安全访问控制，与之绑定的虚拟资源销毁后，安全组将自动解绑。

- 安全组对虚拟机的安全防护针对的是一块网卡，即安全组是与虚拟机的默认虚拟网卡或弹性网卡绑定在一起，分别设置访问控制规则，限制每块网卡的出入网络流量；
- 如安全组原理图所示，安全组与提供外网 IP 服务的虚拟外网网卡绑定，通过添加出入站规则，对南北向（虚拟机外网）的访问流量进行过滤；
- 安全组与提供私有网络服务的虚拟网卡或弹性网卡绑定，通过添加出入站规则，控制东西向（虚拟机间及弹性网卡间）网络访问；
- 安全组与外网类型的负载均衡关联，通过添加出入站规则，可对进出外网负载均衡的外网 IP 流量进行限制和过滤，保证外网负载均衡器的流量安全；
- 安全组与 NAT 网关绑定，通过添加出入站规则，可对进入 NAT 网关的流量进行限制，保证 NAT 网关的可靠性和安全性；
- 一个安全组支持同时绑定至多个虚拟机、弹性网卡、NAT 网关及外网负载均衡实例；
- 虚拟机支持绑定一个内网安全组和一个外网安全组，分别对应虚拟机默认的内网网卡和外网网卡上，其中外网安全组对绑定至虚拟机的所有外网 IP 地址生效；
- 弹性网卡仅支持绑定一个安全组，与虚拟机默认网卡绑定的安全组相互独立，分别限制对应网卡的流量；
- 外网负载均衡和 NAT 网关实例仅支持绑定一个安全组，可更换安全组应用不同的网络访问规则。

创建虚拟机时必须指定外网安全组，支持随时修改安全组的出入站规则，新规则生成时立即生效，可根据需求调整安全组出/入方向的规则。支持安全组全生命周期管理，包括安全组创建、修改、删除及安全组规则的创建、修改、删除等生命周期管理。

### 10.1.2 安全组规则

安全组规则可控制允许到达安全组关联资源的入站流量及出站流量，提供双栈控制能力，支持对 IPv4/IPv6 地址的 TCP、UPD、ICMP、GRE 等协议数据包进行有效过滤和控制。

每个安全组支持配置多条规则，根据优先级对资源访问依次生效。**规则为空时，安全组将默认拒绝所有流量；规则不为空时，除已生成的规则外，默认拒绝其它访问流量。**

**支持有状态的安全组规则，可以分别设置出入站规则，对被绑定资源的出入流量进行管控和限制。**每条安全组规则由协议、端口、地址、动作、优先级及方向六个元素组成：

- 协议：支持 TCP、UDP、ICMPv4、ICMPv6 四种协议数据包过滤。
  - ALL 代表所有协议和端口，ALL TCP 代表所有 TCP 端口，ALL UDP 代表所有 UDP 端口；
  - 支持快捷协议指定，如 FTP、HTTP、HTTPS、PING、OpenVPN、PPTP、RDP、SSH 等；
  - ICMPv4 指 IPv4 版本网络的通信流量；ICMPv6 指 IPv6 版本网络的通信流量。
- 端口：源地址访问的本地虚拟资源或本地虚拟资源访问目标地址的 TCP/IP 端口。
  - TCP 和 UDP 协议的端口范围为 1~65535 ；
  - ICMPv4 和 ICMPv6 不支持配置端口。
- 地址：访问安全组绑定资源的网络数据包来源地址或被安全组绑定虚拟资源访问的目标地址。
  - 当规则的方向为入站规则时，地址代表访问被绑定虚拟资源的源 IP 地址段，支持 IPv4 和 IPv6 地址段；
  - 当规则的方向为出站规则时，地址代表被绑定虚拟资源访问目标 IP 地址段，支持 IPv4 和 IPv6 地址段；
  - 支持 CIDR 表示法的 IP 地址及网段，如 `120.132.69.216` 、 `0.0.0.0/0` 或 `::/0` 。
- 动作：安全组生效时，对数据包的处理策略，包括 “接受” 和 “拒绝” 两种动作。
- 优先级：安全组内规则的生效顺序，包括高、中、低三档规则。
  - 安全组按照优先级高低依次生效，优先生效优先级高的规则；
  - 同优先级的规则，优先生效精确规则。
- 方向：安全组规则所对应的流量方向，包括出站流量和入站流量。

**安全组支持数据流表状态，规则允许某个请求通信的同时，返回数据流会被自动允许，不受任何规则影响。即安全组规则仅对新建连接生效，对已经建立的链接默认允许双向通信。**如一条入方向规则允许任意地址通过互联网访问虚拟机外网 IP 的 80 端口，则访问虚拟机 80 端口的返回数据流（出站流量）会被自动允许，无需为该请求添加出方向允许规则。

> 注：通常建议设置简洁的安全组规则，可有效减少网络故障。

## 10.2 安全组管理

### 10.2.1 创建安全组

系统默认提供的安全组无法满足需求时，可指定安全组名称并添加相关安全组规则，快速创建一个属于用户独立的安全组，可关联或绑定至相关资源，为相关资源提供内网或外网的访问控制，保证网络访问的安全性。

用户可通过导航栏进入【安全组】资源控制台，通过“**创建安全组**”可进入安全组创建向导页面，如下图所示：

![createsg](../images/userguide/createsg.png)

可根据向导页面的提示，选择并配置安全组名称，并根据需求配置安全组规则，包括协议类型、端口、地址、动作、优先级、方向及描述等。

其中安全组名称指当前需要创建的安全组的名称标识。添加规则指增加安全组相应的入和出的流量规则，可批量增加多条，也可在安全组创建后在进行规则的添加。

- 协议：一条规则仅支持一种协议，可选择 ALL 或 ALL TCP、ALL UDP 等。
- 端口：端口可指定单个端口号或端口范围，端口范围的格式如 `56-60` 。
- 地址：地址栏支持输入 IPv4 和 IPv6 地址，支持批量输入多个 IP 地址，多个地址间用逗号进行分隔。
- 动作：规则的协议、端口、地址及方向相同时，不支持同时配置接受和拒绝两种动作。
- 方向：规则的流量方向，包括入站和出站，一条规则仅支持选择一个方向。
- 描述：指当前安全组规则的描述。

点击确定后，自动返回至安全组列表页面，在列表页面可查看新建安全组的创建过程，待安全组的状态由“创建中”转换为“有效”时，即代表创建成功。

### 10.2.2 查看安全组

通过导航栏进入安全组资源控制台，可查看当前账户安全组资源列表，并可通过列表上安全组名称进入详情页面查看安全组基本信息、安全组规则及已绑定的资源等信息。

#### 10.2.2.1 安全组列表

安全组列表页面可查看当前账户下安全组资源列表及相关信息，包括名称、ID、规则数量、绑定资源数量、创建时间、状态及操作项等，如下图所示：

![sglist](../images/userguide/sglist.png)

- 名称/ID ：安全组的名称及全局唯一标识符；
- 规则数量：安全组已添加的安全组规则数量，以数字表示；
- 绑定资源数量：安全组已绑定的资源数量，以数字表示，未绑定时显示为 0 ；
- 创建时间：安全组的创建时间；
- 状态：安全组的运行状态，包括有效、创建中、删除中等；

列表上的操作项是可对单个安全组进行删除操作，支持安全组批量删除操作，可通过搜索框对安全组列表进行搜索和筛选，支持模糊搜索。

#### 10.2.2.2 安全组详情

在安全组资源列表上，点击安全组名称可查看当前安全组的详情及安全组规则信息，同时可切换至资源页面查看当前安全组已绑定的资源信息，如下图概览页所示：

![sgdetails](../images/userguide/sgdetails.png)

- 基本信息：当前安全组的基本信息，包括名称、ID、规则数量、已绑定资源数量及创建时间等信息。
- 安全组规则管理：当前安全组的访问控制规则管理，包括添加、查看、编辑、删除等，详见[安全组规则管理](#_93-安全组规则管理)。
- 已绑定资源：当前安全组已绑定资源的列表信息，详见[已绑定资源](#_9223-已绑定资源)。

#### 10.2.2.3 已绑定资源

已绑定资源指安全组已绑定资源的列表信息，可通过列表信息查看当前安全组已经绑定或关联的虚拟资源信息。用户可通过安全组详情页面进入“**资源**”子页面，查看已绑定的资源信息。

![sgresource](../images/userguide/sgresource.png)

如上图列表图所示，已绑定资源的列表信息包括资源名称、资源类型、资源ID等信息，其中资源类型包括虚拟机、弹性网卡、NAT 网关、负载均衡等。

### 10.2.3 修改安全组名称

修改安全组资源的名称和备注，在任何状态下均可进行操作。可通过点击安全组资源列表页面每个安全组名称右侧的“编辑”按钮进行修改。

### 10.2.4 删除安全组

支持用户删除未被任何资源绑定的安全组资源。安全组删除后，会被彻底销毁，删除前需保证安全组未被任何资源绑定或关联。可通过安全组列表页面操作项中的“删除”进行安全组的删除，如下图所示：

![sgrm](../images/userguide/sgrm.png)

## 10.3 安全组规则管理

### 10.3.1 新建规则

为已绑定资源提供网络安全访问控制的主要手段是制定合理的安全组规则，每个安全组支持配置多条规则，根据优先级对资源访问依次生效。**规则为空时，安全组将默认拒绝所有流量；规则不为空时，除已生成的规则外，默认拒绝其它访问流量。**

用户可指定规则的协议类型、端口、地址、动作、优先级、方向及描述等信息进行规则的添加，通过安全组详情页面的“**新建规则**”即可进入新建规则向导页面，具体操作与 [创建安全组](#_921-创建安全组) 中的添加规则相同，可根据具体业务网络安全控制需求，新建安全组规则。

### 10.3.2 查看规则

通过安全组详情页面的规则列表可查看当前安全组已生成的规则信息，并可通过列表的操作项对已有规则进行编辑和删除等操作。规则列表信息包括协议类型、端口、地址、动作、优先级、方向、描述、创建时间及操作项等，如下图所示：

![rulelist](../images/userguide/rulelist.png)

### 10.3.3 编辑规则

已有安全组规则不能满足业务需求时，可通过安全组规则列表操作项中的“**编辑**”进行修改及变更操作，修改项与新建规则时指定的参数相同，可根据实际情况修改指定参数。

- 当协议类型为 ALL 或 ICMPv4/ICMPv6 时，端口不可选择并显示为`“/”` ；
- 地址支持 IP 地址和 CIDR IP 网段格式，若需指定所有 IP 地址可配置为 `0.0.0.0/0` 或 `::/0`。

>  规则编辑后即时生效，同时会对已绑定的资源网络访问产生影响，请慎重操作。

### 10.3.4 删除规则

已有安全组规则需被删除时，可通过安全组规则列表操作项中的“**删除**”操作，删除的规则会被即时销毁。为避免影响业务，建议删除前确认安全组规则是否有必要删除。删除安全组规则后，安全组信息中的规则数量会重新统计，显示最新的规则数量。

# 11 负载均衡

## 11.1 负载均衡简介

### 11.1.1 概述

负载均衡（ Load Balance ）是由多台服务器以对称的方式组成一个服务器集合，每台服务器都具有等价的地位，均可单独对外提供服务而无须其它服务器的辅助。平台负载均衡服务（简称 ULB—UCloudStack Load Balance）是基于 TCP/UDP/HTTP/HTTPS 协议将网络访问流量在多台虚拟机间自动分配的控制服务，类似于传统物理网络的硬件负载均衡器。

通过平台负载均衡服务提供的虚拟服务地址，将相同数据中心、相同 VPC 网络的虚拟机添加至负载均衡转发后端，并将加入的虚拟机构建为一个高性能、高可用、高可靠的应用服务器池，根据负载均衡的转发规则，将来自客户端的请求均衡分发给服务器池中最优的虚拟机进行处理。

支持内外网两种访问入口类型，分别提供 VPC 内网和 EIP 外网的负载访问分发，适应多种网络架构及高并发的负载应用场景。提供四层和七层协议的转发能力及多种负载均衡算法，支持会话保及健康检查等特性，可自动隔离异常状态虚拟机，同时提供 **SSL Offloading** 及 SSL 证书管理能力，有效提高整体业务的可用性及服务能力。

ULB 支持收集并展示负载流量各种网络指标的监控数据，并可根据告警模板进行监控报警及通知，保证业务的正常运行。当前负载均衡为接入的虚拟机服务池提供基于 NAT 代理的请求分发方式，在 NAT 代理模式下，所有业务的请求和返回数据都必须经过负载均衡，类似 LVS 的 NAT 工作模式。

### 11.1.2 应用场景

平台提供外网和内网两种类型的负载均衡服务，分别对应外网服务和内网服务两种场景。用户可根据业务需求，选择创建对外公开或对内私有的负载均衡实例，平台会根据负载均衡类型分别分配外网 IP 地址或 VPC 私有网络的 IP 地址，即负载均衡的服务访问地址。

- 外网类型的负载均衡使用场景：
  - 部署在平台的业务服务需要构建高可用虚拟机集群，且需对互联网提供统一访问入口。
  - 部署在平台的业务服务需要构建高可用虚拟机集群，且需对 IDC 数据中心提供统一访问入口。
- 内网负载均衡使用场景：
  - 部署在平台的业务服务需要构建高可用虚拟机集群，且仅需对 VPC 内网提供统一访问入口。
  - 部署在 VPC 私有网络的虚拟机集群需要对其它用户或服务屏蔽真实 IP 地址，对客户端提供透明化服务。

> 用户也可将负载均衡服务分配的 IP 地址与自有域名绑定在一起，通过域名访问后端应用服务。

### 11.1.3 架构原理

一个提供服务的负载均衡，主要由 LB 实例（ LoadBalancer ）、虚拟服务器（ VServer ）、后端服务器（ Backend Real Server ）三部分组成。如架构图所示：

![ulbarch](../images/userguide/ulbarch.png)

- LoadBalancer（ LB ）：负载均衡实例为主备高可用集群架构，可实现负载均衡器故障自动切换，提高接入负载均衡服务的可用性。同时结合内外网 IP 地址，根据 VServer 配置的监听器，将虚拟机加入到 Backend 成为 Real Server ，以实现业务的流量均衡与服务容错。
- Virtual Server（ VServer ）：监听器，每个监听器是一组负载均衡的监听端口配置，包含协议、端口、负载算法、会话保持、连接空闲超时及健康检查等配置项，用于分发和处理访问 LB 的请求。
- Backend Server Pool ：后端一组虚拟机服务器池，实际处理请求的真实服务器（RealServer），即真实部署业务的虚拟机实例。
- 外网 IP（ EIP ）：外网弹性 IP 地址，绑定至外网类型的 LB 实例上，对互联网或 IDC 数据中心提供业务负载均衡访问入口。
- 内网 IP （Private IP）：内网 IP 地址，内网类型 LB 实例提供服务的访问地址，通常是由创建内网负载均衡器时指定的 VPC 自动分配。

负载均衡器用于承载 VServer 及访问入口，VServer 负责访问入口地址的端口监听及请求分发。当负载均衡器接受到来自客户端的请求后，会通过一系列负载均衡算法，将访问请求路由分发到后端虚拟机服务器池进行请求处理，同时由 VServer 将处理结果返回给客户端。

* 通过加权轮询、最小连接数及基于源地址的负载均衡调度策略，进行业务请求流量转发，满足多场景业务负载需求，如加权轮询是按照后端服务器的权重进行请求转发，权重越大转发的请求越多。

- 通过会话保持机制，在请求会话的生命周期内，会将来自同一个客户端的会话转发至同一个虚拟机进行处理，适用于 TCP 长连接等应用场景。
- 通过健康检查机制，监控 RealServer 的运行状况及业务可用性，确保只将流量分发至业务健康的虚拟机。当 后端虚拟机业务不可访问时，调度器会停止向虚拟机分发负载流量；待虚拟机业务恢复正常后，会将虚拟机重新加入至 VServer 后端并分发流量至虚拟机。

**负载均衡器的工作模式为 NAT 请求代理，请求和返回均由负载均衡器进行转发和处理，即后端 RealServer 虚拟机处理请求后，会将请求返回给负载均衡 ，由负载均衡将结果返回给客户端。**

### 11.1.4 功能特性

平台负载均衡服务提供四层和七层转发能力，支持内网和外网两种网络入口，在多种负载调度算法基础之上支持健康检查、会话保持、连接空闲超时、内容转发及 **SSL Offloading** 和 SSL 证书管理等功能，保证后端应用服务的可用性和可靠性。

- 支持内网和外网两种类型负载均衡器，满足 VPC 内网、IDC 数据中心及互联网服务负载均衡应用场景。
- 提供四层和七层业务负载分发能力，支持基于 TCP、UDP、HTTP 及 HTTPS 协议的监听及请求转发。
- 支持加权轮询、最小连接数和基于源地址的的负载调度算法，满足不同场景的流量负载业务。
  - 加权轮询：基于权重的轮询调度，负载均衡器接收到新的访问请求后，根据用户指定的权重，按照权重概率分发流量至各后端虚拟机，进行业务处理；
  - 最小连接数：基于后端服务器最小连接数进行调度，负载均衡器接收到新的访问请求后，会实时统计后端服务器池的连接数，选择连接数最低的虚拟机建立新的连接并进行业务处理；
  - 源地址：基于客户端源 IP 地址的调度策略，采用哈希算法将来源于相同 IP 地址的访问请求均转发至一台后端虚拟机进行处理。
- 提供会话保持功能，在会话生命周期内，保证同一个客户端的请求转发至同一台后端服务节点上。四层和七层分别采用不同的方式进行会话保持 。
  - 针对 UDP 协议，基于 IP 地址保证会话保持，将来自同一 IP 地址的访问请求转发到同一台后端虚拟机进行处理，支持关闭会话 UDP 协议的会话保持；
  - 针对 HTTP 和 HTTPS 协议，提供 Cookie 植入的方式进行会话保持，支持自动生成KEY 和自定义 KEY。自动生成 KEY 是由平台自动生成 Key 进行植入，自定义 Key 是由用户自定义 Key 进行植入。
- 支持 TCP、HTTP 及 HTTPS 协议的连接空闲超时配置，自动中断在超时时间内一直无访问请求的连接。
  - 客户端向 LB 地址发送的请求，在平台会维护两个连接，一个由客户端到 LB，一个由 LB 到后端虚拟机；
  - 连接空闲超时是指由客户端到 LB 的连接空闲超时，若在超时周期内没有发送或接收任何数据，将自动中断从客户端到 LB 的连接；
  - 默认连接空闲超时周期为 60 秒，即在建立连接后的 60 秒内一直没有新的数据请求，将自动中断连接。
- 健康检查：支持端口检查和 HTTP 检查，根据规则对后端业务服务器进行业务健康检查，可自动检测并隔离服务不可用的虚拟机，待虚拟机业务恢复正常后，会将虚拟机重新加入至 VServer 后端并分发流量至虚拟机。
  - 端口检查：针对四层和七层负载均衡，支持按 IP 地址 + 端口的的方式探测后端服务节点的健康状况，及时剔除不健康的节点；
  - HTTP 检查：针对七层负载均衡，支持按 URL 路径和请求 HOST 头中携带的域名进行健康检查，筛选健康节点。
- 内容转发：针对七层 HTTP 和 HTTPS 协议的负载均衡，支持基于域名和 URL 路径的流量分发及健康检查能力，可将请求按照域名及路径转发至不同的后端服务节点，提供更加精准的业务负载均衡功能。
- SSL 证书：针对 HTTPS 协议，提供统一的证书管理服务和 **`SSL Offloading `** 能力，并支持 HTTPS 证书的单向和双向认证。SSL 证书部署至负载均衡，仅在负载均衡上进行解密认证处理，无需上传证书到后端业务服务器，降低后端服务器的性能开销。
- 获取客户端真实 IP：HTTP 监听器支持附加 HTTP header 字段，通过 X-Forwarded-For 和 X-Real-IP 获取客户端真实 IP 地址。
- 获取监听器协议：HTTP 监听器支持附加 HTTP header 字段，通过 X-Forwarded-Proto 获取监听器的协议。
- 附加 HTTP HOST：HTTP 监听器支持附加 HTTP header 字段，通过 Host 附加 HOST 域名至 HTTP 请求中，用于适配需要检测 HTTP 头 HOST 字段的业务。
- 监控数据：负载均衡级别提供每秒连接数、每秒出/入流量、每秒出/入包数量的监控及告警；VServer 级别提供连接数、HTTP 2XX、HTTP 3XX、HTTP 4XX、HTTP 5XX 等监控数据及告警。
- 安全控制：通过安全组对外网负载均衡的访问进行安全管控，仅允许安全组规则内的流量透传负载均衡到达后端真实服务器，保证业务负载的安全性。

负载均衡为用户提供业务级别的高可用方案，可以将业务应用同时部署至多个虚拟机中，通过负载均衡和 DNS 域名的方案设置流量均衡转发，实现多业务级别的流量负载均衡。当大并发流量通过负载均衡访问虚拟机业务时，可通过最小连接数、加权轮询等算法，将请求转发给后端最健壮的虚拟机进行处理，请通过负载均衡将请求结果返回给客户端，保证业务可用性和可靠性。

> 用户可通过智能 DNS 服务，将两个数据中心的负载均衡实例同时绑定至一个域名，使用 DNS 实现跨数据中心的业务容灾方案。

### 11.1.5 负载均衡隔离性

- 资源隔离
  - 负载均衡具有数据中心属性，不同数据中心间负载均衡资源物理隔离；
  - 负载均衡资源在租户间相互隔离，租户可查看并管理账号及子账号下所有负载均衡资源；
  - 一个租户内的负载均衡资源，仅支持绑定租户内同数据中心的 VPC 子网资源；
  - 一个租户内的负载均衡资源，仅支持绑定租户内同数据中心的外网 IP 资源；
  - 一个租户内的负载均衡资源，仅支持绑定租户内同数据中心的安全组资源。
- 网络隔离
  - 不同数据中心间负载均衡资源网络相互物理隔离；
  - 同数据中心负载均衡网络采用 VPC 进行隔离，不同 VPC 的负载均衡资源无法相互通信；
  - 负载均衡绑定的外网 IP 网络隔离取决于用户物理网络的配置，如不同的 Vlan 等。

## 11.2 负载均衡管理

### 11.2.1 使用流程

在使用负载均衡服务前，需根据业务需求规划负载均衡的网络类型及监听类型，并根据业务需求在平台部署并配置好业务虚拟机，具体流程如下：

1. 根据业务需求和规划，在平台创建并部署多台业务虚拟机，并保证业务在单台虚拟机的可用性；
2. 根据业务需求，选择负载均衡的网络入口类型及所属 VPC ，在云平台部署高可用负载均衡实例；
3. 在已创建的负载均衡实例中，根据需求配置监听器 VServer ，包括服务的协议、端口、负载均衡算法、证书、会话保持及健康检查等参数；
4. 为已配置的 VServer 添加服务节点来确定负载均衡入口请求路由的目标，即将第 1 步部署的业务虚拟机实例添加至 VServer 的服务节点；
5. 负载均衡会对添加至 VServer 的服务节点立即进行业务健康检查，并及时剔除不健康的服务节点；
6. 通过负载均衡服务提供的统一入口 IP 地址访问业务服务。

### 11.2.2 创建负载均衡

用户在平台创建负载均衡需指定所属集群类型、网络类型、VPC 网络、子网、外网 IP 及安全组等信息，可通过导航栏进入【负载均衡】资源控制台，通过“创建负载均衡”进入向导页面，如下图所示：

![createlb1](../images/userguide/createlb1.png)

> 本文以创建外网类型的负载均衡进行描述，内网类型的负载均衡无需指定外网 IP 和安全组信息。

1. 选择并配置负载均衡器的基础配置及网络信息：

- 机型：负载均衡实例所在宿主机的集群类型，由平台管理员自定义，如 x86 机型和 ARM 机型，通过 ARM 机型创建的实例为 ARM 版负载均衡实例，已适配国产芯片、服务器及操作系统。
- 网络类型：负载均衡实例网络入口的类型，可选择内网和外网。内网类型提供所属 VPC 的网络入口地址，外网类型以绑定的外网 IP 地址为负载均衡的网络入口地址。
- VPC 网络：负载均衡所服务的 VPC 网络，仅支持将相同 VPC 网络的虚拟机加入到负载均衡服务节点中提供负载均衡服务，同时负载均衡实例本身会运行在所指定的 VPC 网络中。
- 子网：负载均衡实例所在子网，系统将自动根据所选子网分配内网 IP 地址作为内网负载均衡的入口地址，通常常建议选择可用 IP 数量充足的子网。
- 外网 IP ：当网络类型为外网时，可配置负载均衡实例自动绑定的外网 IP 地址，仅支持绑定 IPv4 且有默认路由的 外网 IP 地址作为负载均衡的入口地址。
- 安全组：当网络类型为外网时，可配置负载均衡自动绑定的外网安全组，用于外网访问负载均衡的安全控制。
- 实例名称/备注：负载均衡实例的名称及备注信息。

2. 选择购买数量和付费方式，确认订单金额并点击“立即购买” 进行负载均衡实例的创建。

- 购买数量：按照所选配置及参数批量创建多个负载均衡实例，一次仅支持创建 1 个负载均衡实例； 
- 付费方式：选择负载均衡的计费方式，支持按时、按年、按月三种方式，可根据需求选择适合的付费方式；
- 合计费用：用户选择负载均衡资源按照付费方式的费用展示；

确认订单无误后点击立即购买，点击立即购买后，会返回负载均衡资源列表页，在列表页可查看资源的创建过程，通常会先显示“创建中”的状态，分钟内转换为“**有效**”状态，即代表创建成功。

### 11.2.3 查看负载均衡

通过导航栏进入负载均衡控制台，可查看负载均衡资源列表，并可通过列表上名称和 ID 进入详情页面查看负载均衡的概览及监控信息，同时可切换至 VServer 标签页对负载均衡的 VServer 进行管理。

#### 11.2.3.1 负载均衡列表

负载均衡列表可查看当前账户下所有负载均衡资源信息，包括名称、资源 ID、IP、VPC、子网、VServer 数量、创建时间、过期时间、计费方式、状态及操作项，如下图所示：

![lblist](../images/userguide/lblist.png)

- 名称/ID：负载均衡的名称及全局唯一标识符。
- IP 地址：负载均衡对外提供服务的访问地址，网络类型为内网时为所属子网自动分配的 IP 地址，网络类型为外网时为所绑定的外网 IP 地址。
- VServer 数量：负载均衡实例上已创建的监听器 VServer 数量。
- 创建时间/过期时间：负载均衡的创建时间及费用过期时间。
- 计费方式：负载均衡创建时指定的计费方式。
- 状态：负载均衡的的运行状态，包括创建中、有效、删除中等。

列表上操作项是指对单个负载均衡实例的操作，包括删除、修改告警模板、修改安全组等，可通过搜索框对负载均衡资源列表进行搜索和筛选，支持模糊搜索。

为方便租户对资源的统计及维护，平台支持下载当前用户所拥有的所有负载均衡资源列表信息为 Excel 表格；同时支持对负载均衡进行批量删除操作。

#### 11.2.3.2 负载均衡详情

在负载均衡资源列表上，点击“**名称**” 可进入概览页面查看当前负载均衡实例的详细信息，同时可切换至 VServer 页面对当前负载均衡的 VServer 监听器进行管理，如概览页所示：

![lbdetails](../images/userguide/lbdetails.png)

**（1）基本信息**

负载均衡器的基本信息，包括资源 ID、名称、创建时间、过期时间、计费方式、状态及告警模板信息，可点击告警模板右侧按钮修改负载均衡所关联的告警模板。

**（2）网络信息**

负载均衡的网络入口相关信息，包括 VPC 网络、子网及内网 IP 地址，若负载均衡为外网类型，会展示外网 IP 地址及所绑定的安全组信息。

**（3）监控信息**

负载均衡实例相关的监控图表及信息，包括新建连接数、出/入流量及出/入包数量，支持查看 1 小时、6 小时、12 小时、1 天及自定义时间的监控数据。

**（4）VServer 管理**

当前负载均衡的监听器生命周期管理，包括 VServer 的添加、查看、修改、删除操作管理，同时还可对 VServer 的后端服务节点及七层内容转发规则进行管理，详见 [VServer 管理](#_103-VServer 管理) 。

### 11.2.4 修改告警模板

修改告警模板是对负载均衡器的监控数据进行告警的配置，通过告警模板定义的指标及阈值，可在负载均衡相关指标故障及超过指标阈值时，触发告警，通知相关人员进行故障处理，保证负载均衡及业务的网络通信。

用户可通过负载载均衡列表或详情概览页的操作项进行告警模板修改操作，在修改告警模板向导中选择新负载均衡告警模板进行修改。

### 11.2.5 修改安全组

支持在负载均衡的视角修改安全组，仅当负载均衡实例的网络类型为**外网**时才可修改负载均衡的安全组。可通过负载均衡列表操作项中的“**修改安全组**”进行修改操作，如下图所示：

![updatelbsg](../images/userguide/updatelbsg.png)

一个负载均衡仅支持绑定一个安全组，修改成功后外网负载均衡会以新的安全组策略对进出流量进行限制，用户可通过负载均衡详情网络信息查看已绑定的安全组信息。

### 11.2.6 修改名称和备注

修改负载均衡资源的名称和备注，在任何状态下均可进行操作。可通过点击负载均衡资源列表页面每个负载均衡名称右侧的“编辑”按钮进行修改。

### 11.2.7 删除负载均衡

用户可通过控制台或 API 的方式删除不需要的负载均衡实例，删除负载均衡时会自动解绑已关联的外网 IP 、后端服务节点及绑定的 SSL 证书，并清除负载均衡已创建的 VServer 监听器及内容转发规则策略。

![rmlb](../images/userguide/rmlb.png)

负载均衡实例删除即被直接销毁，删除前需确保负载均衡无业务流量请求，否则可能影响业务的正常访问。

### 11.2.8 负载均衡续费

支持用户手动对负载均衡进行续费，续费操作只针对资源本身，不对资源额外关联的资源进行续费，如绑定至负载均衡的外网 IP 资源。额外关联的资源到期后，会自动与负载均衡解绑，为保证业务正常使用，需及时对相关资源进行续费操作。

负载均衡续费时会按照续费时长收取费用，续费时长与资源的计费方式相匹配，当负载均衡的计费方式为【小时】，则续费时长可选择 1 至 24 小时；当负载均衡的计费方式为【按月】，则续费时长可选择 1 至 11 月；当负载均衡的计费方式为【按年】，则负载均衡的续费时长为 1 至 5 年。

## 11.3 VServer 管理

VServer 即负载均衡的监听器，主要承载负载均衡业务网络的四层和七层监听，通过负载均衡 IP 地址的请求仅能访问被监听的协议和端口，并根据调度算法定义的转发策略将请求流量分发至后端服务节点。

用户可对监听器进行添加、修改、删除、查看管理，同时可对 VServer 的后端服务节点及七层内容转发规则进行管理。针对每一个 VServer 监听器，用户可对监听协议、端口、负载均衡算法、会话保持及健康检查进行配置，若协议为 HTTP 或 HTTPS，可进行七层内容转发或 SSL 证书的配置和管理。一个负载均衡支持多个 VServer 监听器，每个监听器对应一个应用负载均衡服务。

### 11.3.1 添加 VServer

添加 VServer 是指为一个负载均衡器添加监听器，用于对负载均衡的 IP 地址进行服务监听，使用户可通过负载均衡的 IP 地址进行业务负载访问。支持用户根据应用需求，分别创建 TCP、UDP、HTTP、HTTPS 协议的监听器，如为负载均衡器添加一个 `HTTP:80` 的 VServer 监听器，基于负载均衡提供高可用 WEB 服务。

* TCP 监听器：基于 TCP 协议的监听器，即仅监听 TCP 的端口，适用于注重可靠性，对数据准确性要求高，如文件传输 FTP、发送或接收邮件 SMTP&POP3、远程登录 22/3389 等。
* UDP 监听器：基于 UDP 协议的监听器，关注实时性而相对不注重可靠性的场景，如 DNS 应用等。
* HTTP 监听器：基于 HTTP 协议及内容转发策略的监听器 ，适用于 WEB 服务及应用服务。
* HTTPS 监听器：基于 HTTPS 及证书加密的监听器，适用于加密传输的应用服务。

#### 11.3.1.1 添加 TCP 监听器

用户为负载均衡实例创建一个基于 TCP 协议的监听器，提供注重可靠性的负载均衡服务，本文以创建 `TCP:23` （Telnet）服务为例进行创建。用户可通过负载均衡详情页面 VServer 左侧导航栏的【添加】进入 VServer 监听器的创建向导页面，如下图所示：

![tcpvs](../images/userguide/tcpvs.png)

根据向导页面配置 VServer 监听器，包括协议、端口、负载均衡算法、连接空闲超时及健康检查：

* 监听协议：负载均衡业务的网络协议，支持 TCP、UDP、HTTP、HTTPS ，本示例中选择 TCP 。

* 端口：负载均衡业务对外或对内提供服务时用来接收请求的应用端口，端口范围为 `1~65535` ，本示例使用 23 端口，用于提供高可用的 Telnet 服务。

  > 323、9102、9103、9104、9105、60909、60910 等端口被占用，在任何协议下均不可使用。

* 负载均衡算法：负载均衡分发请求到后端 RealServer 的调度计算策略，支持加权轮询、最小连接数和源地址三种算法。

* 连接空闲超时：客户端至负载均衡的连接空闲超时限制，范围为 `1~86400` 秒。默认值为 60 秒，即在 60 秒内客户端对负载均衡一直无访问请求，平台会自动中断连接。

* 健康检查：根据规则对后端服务节点进行健壮性检查，可自动检测并隔离服务不可用的后端服务节点。TCP 协议仅支持端口检查，即通过 IP:端口的方式检测业务的可用性。

创建过程中 VServer 的资源状态为“创建中”，待状态更新为“运行”即代表创建成功，用户可通过 VServer 列表及详情查看已添加的 TCP 监听器，并可查看 VServer 下所有服务节点的健康状态。

#### 11.3.1.2 添加 UDP 监听器

用户为负载均衡实例创建一个基于 UDP 协议的监听器，提供基于 UDP 协议的负载均衡业务服务，本文以创建 `UDP:53` （DNS）服务为例进行创建。用户可通过负载均衡详情页面 VServer 左侧导航栏的【添加】进入 VServer 监听器的创建向导页面，如下图所示：

![udpvs](../images/userguide/udpvs.png)

根据向导页面配置 VServer 监听器，包括协议、端口、负载均衡算法、会话保持及健康检查：

* 监听协议：负载均衡业务的网络协议，支持 TCP、UDP、HTTP、HTTPS ，本示例中选择 UDP 。

* 端口：负载均衡业务对外或对内提供服务时用来接收请求的应用端口，端口范围为 `1~65535` ，本示例使用 53端口，用于提供高可用的 DNS 服务。

  > 323、9102、9103、9104、9105、60909、60910 等端口被占用，在任何协议下均不可使用。

* 负载均衡算法：负载均衡分发请求到后端 RealServer 的调度计算策略，支持加权轮询和源地址三种算法。

* 会话保持：针对 UDP 协议，基于 IP 地址保证会话保持，将来自同一 IP 地址的访问请求转发到同一台后端虚拟机进行处理，可选择开启或关闭 UDP 协议的会话保持功能。

* 健康检查：根据规则对后端服务节点进行健壮性检查，可自动检测并隔离服务不可用的后端服务节点。UDP 协议仅支持端口检查，即通过 IP:端口的方式检测业务的可用性。

创建过程中 VServer 的资源状态为“创建中”，待状态更新为“运行”即代表创建成功，用户可通过 VServer 列表及详情查看已添加的 UDP 监听器，并可查看 VServer 下所有服务节点的健康状态。

#### 11.3.1.3 添加 HTTP 监听器

用户为负载均衡实例创建一个基于 HTTP 协议的监听器，提供基于 HTTP 协议的负载均衡业务服务，本文以创建 `HTTP:80` （WEB）服务为例进行创建。用户可通过负载均衡详情页面 VServer 左侧导航栏的【添加】进入 VServer 监听器的创建向导页面，如下图所示：

![httpvs](../images/userguide/httpvs.png)

根据向导页面配置 VServer 监听器，包括协议、端口、负载均衡算法、会话保持、连接空闲超时及健康检查：

* 监听协议：负载均衡业务的网络协议，支持 TCP、UDP、HTTP、HTTPS ，本示例中选择 HTTP 。

* 端口：负载均衡业务对外或对内提供服务时用来接收请求的应用端口，端口范围为 `1~65535` ，本示例使用 80端口，用于提供基于 HTTP 协议的高可用 WEB 服务。

  > 323、9102、9103、9104、9105、60909、60910 等端口被占用，在任何协议下均不可使用。

* 负载均衡算法：负载均衡分发请求到后端 RealServer 的调度计算策略，支持加权轮询、最小连接数和基于源地址三种算法。

* 会话保持：针对 HTTP 和 HTTPS 协议，提供 Cookie 植入的方式进行会话保持，支持自动生成KEY 和自定义 KEY。选择自动生成 KEY 则由平台自动生成 Key 进行植入，选择自定义 Key 时需输入 KEY 值（只能输入数字、字母及_字符）。

* 连接空闲超时：客户端至负载均衡的连接空闲超时限制，范围为 `1~86400` 秒。默认值为 60 秒，即在 60 秒内客户端对负载均衡一直无访问请求，平台会自动中断连接。

* 健康检查：根据规则对后端服务节点进行健壮性检查，可自动检测并隔离服务不可用的后端服务节点。HTTP协议端检查和 HTTP 检查两种方式，其中 HTTP 检查支持按 URL 路径和请求 HOST 头中携带的域名进行健康检查，筛选健康节点。

  * HTTP 健康检查路径：默认为 `/` ，可输入 Linux 格式的路径，只能使用字母、数字、和-/.%?#& 这些字符，必须以 `/` 开头，例如 `/data` ；
  * HTTP 健康域名：检查时校验请求的 HOST 字段中的域名，可输入标准域名用于校验请求 host 字段中携带的域名。

> HTTP 健康检查中的域名作用：某些应用服务器会对请求中的 host 字段做校验，即要求请求头中必须存在 host 字段。若在健康检查中配置了域名，则负载均衡会将域名配置到 host 字段中，并在健康检查时携带域名对后端服务节点进行检查，若健康检查请求被服务节点拒绝，则健康检查失败，即代表服务节点状态为异常；若应用服务器需要校验请求的host字段，则需要配置相关域名，确保健康检查正常工作。

创建过程中 VServer 的资源状态为“创建中”，待状态更新为“运行”即代表创建成功，用户可通过 VServer 列表及详情查看已添加的 HTTP 监听器，并可查看 VServer 下所有服务节点的健康状态。

#### 11.3.1.4 添加 HTTPS 监听器

用户为负载均衡实例创建一个基于 HTTP 协议的监听器，提供基于 HTTPS 协议的负载均衡业务服务，本文以创建基于 SSL 证书加密的 `HTTPs:443` （WEB）服务为例进行创建。用户可通过负载均衡详情页面 VServer 左侧导航栏的【添加】进入 VServer 监听器的创建向导页面，如下图所示：

![httpsvs](../images/userguide/httpsvs.png)

根据向导页面配置 VServer 监听器，包括协议、端口、SSL 解析模式、服务器证书、客户端证书、负载均衡算法、会话保持、连接空闲超时及健康检查：

* 监听协议：负载均衡业务的网络协议，支持 TCP、UDP、HTTP、HTTPS ，本示例中选择 HTTPS 。

* 端口：负载均衡业务对外或对内提供服务时用来接收请求的应用端口，端口范围为 `1~65535` ，本示例使用 443 端口，用于提供基于 HTTPS 协议且使用 SSL 证书加密认证的高安全、高可用 WEB 服务。

  > 323、9102、9103、9104、9105、60909、60910 等端口被占用，在任何协议下均不可使用。

* SSL 解析模式：HTTPS 协议的 SSL 证书认证的解析模式，支持单向认证和双向认证，通常选择单向认证。

  * 单向认证：由网站服务端提供  SSL 证书并进行身份验证，保证 HTTPS 网站的数据安全性，任何访问网站的用户无需拥有 CA 证书即可随时访问网站；
  * 双向认证：网站服务端和用户双方均需提供 SSL 证书，只有提供 CA 证书的客户端才允许访问网站。

* 服务器证书：用户证明服务器的身份，HTTPS 检查服务器发送的证书是否是由自己信赖的中心签发。
  * 部署并配置于负载均衡服务器中，为负载均衡后端服务节点的网站提供 SSL 服务器证书及验证。
  * 在创建时需提前上传服务器证书到平台，可通过新建服务器证书进行上传，详见 [SSL 证书管理](#_106-SSL-证书管理)。

* 客户端证书：客户端CA公钥证书用于验证客户端证书的签发者，HTTPS 双向认证中需验证客户端提供的证书，才可成功建立连接。
  * 网站服务器用 CA 证书验证客户端证书的签名，如果没有通过验证，则拒绝连接；
  * 在创建时需提前上传客户端证书到平台，可通过新建客户端证书进行上传，详见 [SSL 证书管理](#_106-SSL-证书管理)。
* 负载均衡算法：负载均衡分发请求到后端 RealServer 的调度计算策略，支持加权轮询、最小连接数和基于源地址三种算法。

* 会话保持：针对 HTTP 和 HTTPS 协议，提供 Cookie 植入的方式进行会话保持，支持自动生成KEY 和自定义 KEY。选择自动生成 KEY 则由平台自动生成 Key 进行植入，选择自定义 Key 时需输入 KEY 值（只能输入数字、字母及_字符）。
* 连接空闲超时：客户端至负载均衡的连接空闲超时限制，范围为 `1~86400` 秒。默认值为 60 秒，即在 60 秒内客户端对负载均衡一直无访问请求，平台会自动中断连接。
* 健康检查：根据规则对后端服务节点进行健壮性检查，可自动检测并隔离服务不可用的后端服务节点。HTTP协议端检查和 HTTP 检查两种方式，其中 HTTP 检查支持按 URL 路径和请求 HOST 头中携带的域名进行健康检查，筛选健康节点。
  * HTTP 健康检查路径：默认为 `/` ，可输入 Linux 格式的路径，只能使用字母、数字、和-/.%?#& 这些字符，必须以 `/` 开头，例如 `/data` ；
  * HTTP 健康域名：检查时校验请求的 HOST 字段中的域名，可输入标准域名用于校验请求 host 字段中携带的域名。

创建过程中 VServer 的资源状态为“创建中”，待状态更新为“运行”即代表创建成功，用户可通过 VServer 列表及详情查看已添加的 HTTPS 监听器，并可查看 VServer 下所有服务节点的健康状态。

> VServer 监听器配置完成后，需添加业务虚拟机至监听器的服务节点中才可正常提供服务。 HTTP 和 HTTPS 协议的监听器可根据需求配置内容转发规则，根据请求的域名和 URL 进行精准的请求分发。

### 11.3.2 查看 VServer

通过负载均衡详情页面进入 VServer 资源控制台，可查看当前负载均衡实例中已拥有 VServer 列表信息及所属服务节点的健康状况，并可通过列表名称切换 VServer 在右侧概览中查看 VServer 的基本信息及监控信息，同时可切换至服务节点和内容转发标签页进行服务节点和内容转发规则的管理。

#### 11.3.2.1 VServer 列表

VServer 列表页面可查看当前负载均衡实例中已拥有的 VServer 资源列表，包括协议端口和状态，如下图所示：

![vslist](../images/userguide/vslist.png)

- 协议端口：VServer 监听器协议和端口，是负载均衡处理请求的入口依据；
- 状态：VServer 监听器的服务状态，包括绿色、黄色和红色；
  - 绿色：VServer 中添加的所有服务节点的健康状态均为正常；
  - 黄色：VServer 中添加的部分服务节节异常；
  - 红色：VServer 中添加的所有服务节点健康状态为异常，即代表 VServer 停止工作；若未添加任何服务节点，VServer 的默认状态为全部异常。

在列表页可对 VServer 进行添加、修改及删除操作，通过点击 VServer 可在右侧查看当前 VServer 的详细信息，点击状态按钮可显示状态描述。

#### 11.3.2.2 VServer 详情

通过 VServer 资源列表的“**协议端口**” 可在右侧查看 VServer 详情页面，可查看当前 VServer 资源的详细信息，如下图所示，详情页面分为基本信息、VServer 监控信息、服务节点管理及内容转发信息：

![vsdetails](../images/userguide/vsdetails.png)

**（1）基本信息**

VServer 的基本信息，包括 ID、协议端口、负载均衡算法、会话保持、会话保持 Key、连接空闲超时、健康检查方式、运行状态、VS 状态、告警模板及创建时间等信息。若 VServer 监听协议为 HTTP/HTTPS ，可查看 HTTP 健康检查路径、HTTP 检查域名、SSL解析模式、服务器证书及客户端证书等信息。

- 会话保持：会话保持的开关和类型。UDP 协议值为开启或关闭，HTTP/HTTPS 协议值为关闭、自动生成 KEY 或自定义 KEY 。
- 运行状态：VServer 监听器的服务状态，包括全部异常、部分异常、全部正常。
- VS 状态：VServer 监听器资源的状态，包括可用、更新中、已删除。
- 告警模板：VServer 绑定的监控告警模板，若未绑定则展示为无。
- 服务器证书/客户端证书：HTTPS 监听器 SSL 证书名称，可通过查看证书查询证书的内容。

**（2）监控信息**

VServer 实例相关监控图表及信息，包括新建连接数、HTTP 2XX 、HTTP 3XX 、HTTP 4XX 、HTTP 5XX ，支持查看 1 小时、6 小时、12 小时、1 天及自定义时间的监控数据。

**（3）服务节点和内容转发**

- 服务节点：VServer的服务节点生命周期管理，包括服务节点的添加、查看、修改、启用、禁用及删除等，详见[服务节点管理](#_104-服务节点管理)。
- 内容转发规则：当前 VServer 配置的内容转发规则生命周期管理，包括转发规则的添加、查看、修改及删除，详见[内容转发规则管理](#_105-内容转发规则管理)。

### 11.3.3 修改 VServer

用户通过控制台修改 VServer 监听器配置，如修改监听器的负载均衡算法、会话保持、连接空闲超时及健康检查配置信息，若协议为 HTTPS 可更换监听器的 SSL 解析模式及 SSL 证书。可通过 VServer 列表上的 “修改” 按钮进行修改操作，如修改向导所示：

![updatevs](../images/userguide/updatevs.png)

修改配置的参数设置与创建 VServer 时一致，不支持修改 VServer 的协议和端口。修改过程中 VS 状态由 “运行” 变更为 “更新中” ，更新成功后流转为 “运行” ，即代表更新成功，可通过详情页面查看新修改的配置。修改成功后，平台会立即根据新配置重新对服务节点进行健康检查，同时会根据新修改的调度算法分发请求。

> 修改 VServer 的调度算法、会话保持、连接空闲超时，仅对新连接生效，不影响已建立连接的服务。

### 11.3.4 修改告警模板

修改告警模板是对 VServer 的监控数据进行告警的配置，通过告警模板定义的指标及阈值，可在 VServer 相关指标故障及超过指标阈值时，触发告警，通知相关人员进行故障处理，保证负载均衡及业务的网络通信。

用户可通过 VServer 详情概览页的操作项进行告警模板修改操作，在修改向导页面中选择新告警模板进行修改。VServer 和 负载均衡器可共用一个负载均衡监控告警模板，即在负载均衡的告警模板中即可定义 LB 实例的指标告警策略，同时可定义 VServer 的监控指标告警，可根据需求自定义告警模板的规则。

### 11.3.5 删除 VServer

用户可通过控制台或 API 的方式删除 VServer 资源，删除时会自动清除 VServer 下已创建的内容转发规则策略，同时会自动解绑已关联的 SSL 证书，仅当 VServer 中不存在后端 RealServer 资源时才可进行删除操作。

![rmvs](../images/userguide/rmvs.png)

VServer 删除后不可恢复，在删除时需检查并确认是否有必要删除 VServer 资源，控制台 VServer 标签页可查看删除过程，待被删除的 VServer 资源被清空时，代表删除成功。

## 11.4 服务节点管理

服务节点指负载均衡架构中的后端真实服务器，即 RealServer ，用于提供真正业务并处理业务请求的服务池，一般是由多台虚拟机集群构成。

- 添加服务节点需要在 VServer 监听器创建完成后才可进行添加。
- 服务节点添加后，负载均衡即通过健康检查 Check 服务节点的业务是否正常。
- 若业务节点无法正常处理 VServer 发送的请求，平台会提示服务节点状态为无效，需检测服务节点中部署的业务状况。
- 若业务节点可正常处理 Check 请求，即服务节点状态为有效，则代表负载均衡可正常工作。

### 11.4.1 添加服务节点

添加服务节点前，需确保服务节点上业务正常运行且可进行正常访问。可通过 VServer 详情页面进入“**服务节点**”资源控制台，点击“**添加服务节点**”进行后端 RealServer 的添加。添加服务节点时，仅可选择与负载均衡实例在相同 数据中心且 VPC 网络相同的虚拟机。如下图所示：

![creaters](../images/userguide/creaters.png)

* 虚拟机：即需要添加至负载均衡当前 VServer 服务节点的虚拟机，支持指定服务节点暴露的端口及权重。
* 端口：后端服务节点暴露的服务端口，如 VServer 监听 80 ，服务节点监听 8080 端口，则在端口处输入 8080 即可，负载均衡会将到达 VServer 80  端口的请求分发至服务节点的 8080 端口。
* 权重：后端服务节点的权重，范围为 1~100 。数字越大即代表权重越高，负载均衡会优先将请求分发至权重较高的服务节点，默认值为 1 。

> 支持添加同一个虚拟机的多个端口到 VServer 的服务节点，即将 VServer 监听器端口的请求分别转发至同一个服务节点的多个端口上，满足不同应用场景的负载分发需求。

添加服务节点后，可在服务节点资源列表页面查看添加服务节点过程，待服务节点的状态为“有效”或“无效”时，即代表添加服务节点成功。若服务节点状态为无效，则需要检测服务节点中业务的运行状态，服务状态“有效”的前提是通过虚拟机的网络地址及健康检查方式可正常访问业务。

**负载均衡服务的服务模式为 NAT 请求代理模式，若添加虚拟机至提供外网的负载均衡后端，无需在后端服务节点上配置环回服务地址即可通过外网直接访问至服务节点。**

### 11.4.2 查看服务节点

通过 VServer 详情页面的"服务节点"标签页，可查看 VServer 监听器后端已添加的服务节点资源列表信息，包括服务节点 ID、资源ID、内网 IP、端口、权重、节点模式、节点状态及操作项，如下图所示：

![rslist](../images/userguide/rslist.png)

- 服务节点：当前服务节点的全局 RS 唯一标识符。
- 资源ID：当前服务节点已绑定的虚拟机名称和 ID。
- IP/端口：当前服务节点的内网 IP 地址及配置的服务端口。
- 权重：当前服务节点配置的转发权重。
- 节点模式：当前服务节点的启用和禁用模式。
- 状态：当前服务节点的业务负载状态，包括有效、无效。
  - 有效：指当前服务节点中的业务服务正常运行且可通过网络进行访问，即服务节点为健康；
  - 无效：指当前服务节点中的业务服务未正常运行或无法通过网络进行访问，即代表服务节点不不健康。

列表上操作项是指对单个服务节点的操作，包括启用、禁用、删除及修改等，支持服务节点的批量启用、批量禁用及批量删除操作。

### 11.4.3 启用/禁用

用户对添加至负载均衡 VServer 的服务节点进行启用和禁用操作，支持批量启用和禁用。

* 禁用：禁用服务节点，禁用后负载均衡将停止向该服务节点分发请求，并停止对其健康检查；
* 启用：启用服务节点，启用后负载均衡将对其进行健康检查，若健康检查通过则分根据调度算法，分发新的请求至该服务节点；
* 仅当节点模式为启用时才可进行禁用操作；
* 仅当节点模式为禁用时，才可进行启用操作。

### 11.4.4 修改服务节点

用户可对负载均衡 VServer 服务节点的服务端口及权重进行修改，如下图所示：

![updaters](../images/userguide/updaters.png)

修改端口和权重不会影响已建立的业务连接，仅对负载均衡新分发请求生效。点击确定后，即返回至服务节点列表页面，节点状态由 “有效” 或 “无效” 流转为“更新中” ，待修改成功后，重新流转回“有效”或“无效” ，有效则代表健康检查成功，服务节点可正常提供服务。

### 11.4.5 删除服务节点

如需对一个服务节点的业务进行变更或从负载均衡后端服务节点下线，可通过删除服务节点功能进行下线操作，下线后不影响虚拟机本身的运行和使用。用户可通过服务节点列表操作项中的“删除”进行服务节点的删除，删除后可重新添加至负载均衡实例。

![rmrs](../images/userguide/rmrs.png)

> 若负载均衡 VServer 的监听协议为 HTTP/HTTPS 且已配置内容转发规则 ，则删除服务节点时，会自动解绑内容转发规则。

## 11.5 内容转发规则管理

平台支持为 HTTP 监听器添加转发规则，支持为域名+ URL 路径的请求分发至不同的服务节点，满足精准负载分发业务需求。仅当负载均衡的 VServer 监听协议为 HTTP 或 HTTPS 时，才可进行内容转发规则的配置，包括内容转发规则的添加、查看、修改及删除。

### 11.5.1 添加内容转发规则

用户可通过 VServer 详情页面进入“**内容转发**”资源标签页，点击“**添加内容转发**”进行内容转发规则的添加。平台会自动生成一条默认内容转发规则，即代表所有请求默认转发至所有已添加的服务节点。

内容转发规则中的服务节点，仅可从当前 VServer 已存在的服务节点中进行选择，支持为一个域名添加多个 URL 路径，如下图所示：

![createpolicy](../images/userguide/createpolicy.png)

* 域名：内容转发规则匹配的域名，代表请求该域名时及 URL 时，将请求转发至 URL 配置的服务节点。
  * 域名值可以为空，代表无域名请求，仅匹配路径，即通过 IP 地址+ URL 路径的方式；
  * 支持泛域名，如 `*.test.com` 或 `*abc.test.com`；
* URL 路径：内容转发规则匹配的 URL 路径，URL 必须属于一个域名；
  * URL 长度限制为 1~30 个字母、数字和` -/.%?#&`这些字符， 且必须以 `/` 开头 ；
  * URL 可以为 `/` ，代表请求该域名的根目录时，转发请求至匹配的服务节点；
* 服务节点：当前内容转发规则所对应的服务节点，即当请求匹配 域名+路径 时，将请求转发发配置的服务节点，转发规则中的服务节点必须为 VServer 中已添加的服务节点。

点击确定后，返回内容转发规则的列表，可查看创建内容转发规则的过程，待添加的内容转发规则状态由 “创建中” 流转为 “有效” 时，即代表创建成功。

### 11.5.2 查看内容转发规则

通过 VServer 详情页面的"内容转发"标签进入内容转发规则管理控制台，可查看当前 VServer 监听器已添加的内容转发规则列表，同时可对内容转发规则进行添加、修改及删除操作。

内容转发规则列表页面可查看当前 VServer 已添加的内容转发规则信息，包括域名、URL 路径、转发节点、节点数量、规则状态及操作项，如下图所示：

![policylist](../images/userguide/policylist.png)

* 域名：内容转发规则匹配的域名，代表请求该域名时及 URL 时，将请求转发至 URL 配置的服务节点。
* URL 路径：内容转发规则匹配的 URL 路径，URL 必须属于一个域名。
* 转发节点：匹配当前内容转发规则时，请求分发的服务节点。
* 节点数量：当前转发规则已添加的服务节点数量。
* 状态：当前转发规则的状态，包括创建中、有效和删除中。

列表上操作项是指对域名或单条转发规则的修改及删除操作。点击域名右侧的修改和删除，即修改和删除整个域名及包括的所有转发规则；点击单条 URL 规则的修改和删除，即仅对单条规则进行删除和修改操作。

默认转发规则仅支持查看和修改，不支持删除。默认转发规则的节点数量即 VServer 中所包含的所有服务节点数量，可修改默认转发规则中的服务节点数量，以匹配精准转发策略。

### 11.5.3 修改内容转发规则

用户可对一个域名或所包含的 URL 规则进行修改，包括域名、 URL 路径、转发的服务节点，如下图所示：

![updatepolicy](../images/userguide/updatepolicy.png)

修改内容转发规则仅对新负载分发请求生效，不影响已建立并在处理的业务请求。点击确定后，即返回至内容转发规则列表页面，内容转发规则由 “有效” 流转为 “更新中” ，待修改成功后，重新流转回“有效” ，则代表新的匹配规则请求会直接分发到规则所配置的服务节点。

### 11.5.4 删除内容转发规则

用户可通过控制台或 API 的方式删除不需要的内容转发规则，删除内容转发规则会自动解绑已关联的后端服务节点。内容转发规则被删后，即即直接销毁，在删除前需确保负载均衡转发规则无业务流量的负载请求，否则可能影响业务的正常访问。如下图所示，删除域名时即直接删除该域名下所包括的所有 URL 规则信息：

![rmpolicy.png](../images/userguide/rmpolicy.png)

## 11.6 SSL 证书管理

负载均衡支持 HTTPS 负载转发及 SSL 证书装载能力，确保用户业务受到加密保护并得到权威机构的身份认证。针对 HTTPS 协议的服务器证书和客户端证书，平台提供统一的证书管理服务，包括证书的上传、绑定、删除操作。

证书无需上传到服务节点，解密处理在负载均衡上进行，降低后端服务器的CPU开销，即 HTTPS 协议的监听器仅实现客户端至负载均衡器的 HTTPS 请求和 SSL 加解密，负载均衡至后端服务节点依然采用 HTTP 协议转发请求。

在上传和创建证书前需确认需要上传的证书类型，包括服务器证书和客户端证书，并按照证书格式要求上传或输入证书内容至平台。

* 服务器证书：用户证明服务器的身份，HTTPS 检查服务器发送的证书是否是由自己信赖的中心签发。部署并配置于负载均衡服务器中，为负载均衡后端服务节点的网站提供 SSL 服务器证书及验证。单向认证和双向认证均需要上传服务器证书和私钥内容。

* 客户端证书：客户端CA公钥证书用于验证客户端证书的签发者，HTTPS 双向认证中需验证客户端提供的证书，才可成功建立连接。网站服务器用 CA 证书验证客户端证书的签名，如果没有通过验证，则拒绝连接。仅在双向认证时需要上传客户端证书并绑定到 VServer 监听器。

证书具有地址（数据中心）属性，仅支持关联相同数据中心的负载均衡资源，若一个证书需要在多个数据中心同时使用，需要在多个数据中心同时创建并上传证书。

### 11.6.1 证书格式要求

负载均衡 SSL 证书支持用户上传 `.crt`和`.pem` 格式的证书文件，当 SSL 证书被 VServer 监听器关联时，平台会自动读取文件中的证书内容并装载至负载均衡 VServer 监听器中，使用户 HTTPS 应用通过 SSL 证书进行加解密。

证书文件格式支持 Linux 环境下 PEM 或 CRT ，不支持其他格式的证书，需进行证书格式转换才可上传。用户也可通过直接输入证书内容创建证书，在上传证书或输入证书内容前，需确保证书、证书链及私钥内容符合证书的格式要求。

#### 11.6.1.1 Root CA 机构颁发的证书

若证书是 Root CA 机构颁发的唯一证书，则无需额外的证书，配置的站点即可被浏览器等访问设备认为可信。证书内容格式要求如下：

* 以`-----BEGIN CERTIFICATE-----` 开头，以` -----END CERTIFICATE-----` 结尾。
* 每行 64 个字符，最后一行长度可以不足 64 个字符。
* 证书内容不能包含空格。

Root CA 机构颁发的证书格式规范如下，可参考以下文本内容和证书示例：

```
-----BEGIN CERTIFICATE-----
用户证书(BASE64编码)
-----END CERTIFICATE-----
```

```
-----BEGIN CERTIFICATE-----
MIIFnDCCBISgAwIBAgIQD1pxAmxfzY+R4k4Ua1cVWDANBgkqhkiG9w0BAQsFADBy
MQswCQYDVQQGEwJDTjElMCMGA1UEChMcVHJ1c3RBc2lhIFRlY2hub2xvZ2llcywg
SW5jLjEdMBsGA1UECxMURG9tYWluIFZhbGlkYXRlZCBTU0wxHTAbBgNVBAMTFFRy
dXN0QXNpYSBUTFMgUlNBIENBMB4XDTE5MDQyMzAwMDAwMFoXDTIwMDQyMjEyMDAw
MFowHDEaMBgGA1UEAwwRKi51Y2xvdWRzdGFjay5jb20wggEiMA0GCSqGSIb3DQEB
AQUAA4IBDwAwggEKAoIBAQC2SDT5pJEQhRhQQ98vzuAvK1zUFMD1p1E3YyJGDISY
SINH38QTtVqWbZgmVkU6v2R1GrBz0iMfevO0/sjxefwHmiGYd1ytG9dm8D3fVZox
piST9hoIyjOFRstBLGXuxWSa2LdjVSePaFfxaN3UZLYY6MIHkdqxVZLhM4ANSLNr
PI6cRUZVBU29V3A2znkVEbx5dwKA3SGFVWfqjfzXqC+NTylLKb7H304BxspZlKDi
n+/aV/vSovVM7zg57AOtxjkSNzBDjdz+Ud3wqaT1O4vEG4tqqAnsIyJeaMueFti0
cjiMwLVsFsmV1eVSBiYWGO8U/YRFv+dNg4XG2MqYUFsRAgMBAAGjggKCMIICfjAf
BgNVHSMEGDAWgBR/05nzoEcOMQBWViKOt8ye3coBijAdBgNVHQ4EFgQUJYEWLiyn
YgqKaGaT8thKWAnuWfEwLQYDVR0RBCYwJIIRKi51Y2xvdWRzdGFjay5jb22CD3Vj
bG91ZHN0YWNrLmNvbTAOBgNVHQ8BAf8EBAMCBaAwHQYDVR0lBBYwFAYIKwYBBQUH
AwEGCCsGAQUFBwMCMEwGA1UdIARFMEMwNwYJYIZIAYb9bAECMCowKAYIKwYBBQUH
AgEWHGh0dHBzOi8vd3d3LmRpZ2ljZXJ0LmNvbS9DUFMwCAYGZ4EMAQIBMH0GCCsG
AQUFBwEBBHEwbzAhBggrBgEFBQcwAYYVaHR0cDovL29jc3AuZGNvY3NwLmNuMEoG
CCsGAQUFBzAChj5odHRwOi8vY2FjZXJ0cy5kaWdpdGFsY2VydHZhbGlkYXRpb24u
Y29tL1RydXN0QXNpYVRMU1JTQUNBLmNydDAJBgNVHRMEAjAAMIIBBAYKKwYBBAHW
eQIEAgSB9QSB8gDwAHYA7ku9t3XOYLrhQmkfq+GeZqMPfl+wctiDAMR7iXqo/csA
AAFqSaRkyQAABAMARzBFAiEAuovTHM3SEWQRyktGXvtm1hLHd7gxhPNzdzrzkJFX
rWMCIAPideB1BqUSUcpRME6NxIXJD7066ldWuSqgPkOiPtwLAHYAh3W/51l8+IxD
mV+9827/Vo1HVjb/SrVgwbTq/16ggw8AAAFqSaRl4wAABAMARzBFAiBiIpO59m6U
bmlmuQ8cL7WzoDkHiyE+UloEKZXiDpqCfQIhAPIKRdaJfh/5IZHFq31oJVd/TZ3g
pTQ6RpHe0BseSSefMA0GCSqGSIb3DQEBCwUAA4IBAQARaNWOJbAI7Rv6QPChPeWL
Mqryk+tOlterdxYZay6tr3Ea8VOqSS7YdVtvdkR1/k4k87H5AwCQT60/yu4N5J7M
Vkzmqo3tVQTtzVFo0SavgARY12XuU0jhG3LGFI0a43CgfMYMcZ0DiylhYUM48GWz
/axza5uangnIQxBwv+4KXGUfplJujv8WfBepeh+tqPgS8qCqn6e0+sdkUN7yHcA/
O24DiQajtMXG5nR6qHdZhRLCFRXRghYdvVKrkOVFogYqwa4dViyuP/6EFDkuMwDs
7XrxJIjL8qp9Lrw2sHN1F+USKhlPRaNBtWzDELf54zVgAIAeFUriqtER8ZWBWgp4
-----END CERTIFICATE-----
```

#### 11.6.1.2 中级机构颁发的证书

若证书是通过中级 CA 机构颁发的证书，则拿到的证书文件包含多份证书，需要人为将服务器证书与中间证书合并在一起填写或上传，俗称证书链。

证书链的拼接规则为：用户证书放第一份，中间证书放第二份，中间不可有空行；每行 64 个字符且证书内容不能包含空格，最后一行长度可以不足 64 个字符，格式规范及证书示例如下所示：

```
-----BEGIN CERTIFICATE-----
用户证书(BASE64编码)
-----END CERTIFICATE-----
!!!中间不可有空行!!!
-----BEGIN CERTIFICATE-----
中级签发机构证书(BASE64编码)
-----END CERTIFICATE-----
```

```
-----BEGIN CERTIFICATE-----
MIIFnDCCBISgAwIBAgIQD1pxAmxfzY+R4k4Ua1cVWDANBgkqhkiG9w0BAQsFADBy
MQswCQYDVQQGEwJDTjElMCMGA1UEChMcVHJ1c3RBc2lhIFRlY2hub2xvZ2llcywg
SW5jLjEdMBsGA1UECxMURG9tYWluIFZhbGlkYXRlZCBTU0wxHTAbBgNVBAMTFFRy
dXN0QXNpYSBUTFMgUlNBIENBMB4XDTE5MDQyMzAwMDAwMFoXDTIwMDQyMjEyMDAw
MFowHDEaMBgGA1UEAwwRKi51Y2xvdWRzdGFjay5jb20wggEiMA0GCSqGSIb3DQEB
AQUAA4IBDwAwggEKAoIBAQC2SDT5pJEQhRhQQ98vzuAvK1zUFMD1p1E3YyJGDISY
SINH38QTtVqWbZgmVkU6v2R1GrBz0iMfevO0/sjxefwHmiGYd1ytG9dm8D3fVZox
piST9hoIyjOFRstBLGXuxWSa2LdjVSePaFfxaN3UZLYY6MIHkdqxVZLhM4ANSLNr
PI6cRUZVBU29V3A2znkVEbx5dwKA3SGFVWfqjfzXqC+NTylLKb7H304BxspZlKDi
n+/aV/vSovVM7zg57AOtxjkSNzBDjdz+Ud3wqaT1O4vEG4tqqAnsIyJeaMueFti0
cjiMwLVsFsmV1eVSBiYWGO8U/YRFv+dNg4XG2MqYUFsRAgMBAAGjggKCMIICfjAf
BgNVHSMEGDAWgBR/05nzoEcOMQBWViKOt8ye3coBijAdBgNVHQ4EFgQUJYEWLiyn
YgqKaGaT8thKWAnuWfEwLQYDVR0RBCYwJIIRKi51Y2xvdWRzdGFjay5jb22CD3Vj
bG91ZHN0YWNrLmNvbTAOBgNVHQ8BAf8EBAMCBaAwHQYDVR0lBBYwFAYIKwYBBQUH
AwEGCCsGAQUFBwMCMEwGA1UdIARFMEMwNwYJYIZIAYb9bAECMCowKAYIKwYBBQUH
AgEWHGh0dHBzOi8vd3d3LmRpZ2ljZXJ0LmNvbS9DUFMwCAYGZ4EMAQIBMH0GCCsG
AQUFBwEBBHEwbzAhBggrBgEFBQcwAYYVaHR0cDovL29jc3AuZGNvY3NwLmNuMEoG
CCsGAQUFBzAChj5odHRwOi8vY2FjZXJ0cy5kaWdpdGFsY2VydHZhbGlkYXRpb24u
Y29tL1RydXN0QXNpYVRMU1JTQUNBLmNydDAJBgNVHRMEAjAAMIIBBAYKKwYBBAHW
eQIEAgSB9QSB8gDwAHYA7ku9t3XOYLrhQmkfq+GeZqMPfl+wctiDAMR7iXqo/csA
AAFqSaRkyQAABAMARzBFAiEAuovTHM3SEWQRyktGXvtm1hLHd7gxhPNzdzrzkJFX
rWMCIAPideB1BqUSUcpRME6NxIXJD7066ldWuSqgPkOiPtwLAHYAh3W/51l8+IxD
mV+9827/Vo1HVjb/SrVgwbTq/16ggw8AAAFqSaRl4wAABAMARzBFAiBiIpO59m6U
bmlmuQ8cL7WzoDkHiyE+UloEKZXiDpqCfQIhAPIKRdaJfh/5IZHFq31oJVd/TZ3g
pTQ6RpHe0BseSSefMA0GCSqGSIb3DQEBCwUAA4IBAQARaNWOJbAI7Rv6QPChPeWL
Mqryk+tOlterdxYZay6tr3Ea8VOqSS7YdVtvdkR1/k4k87H5AwCQT60/yu4N5J7M
Vkzmqo3tVQTtzVFo0SavgARY12XuU0jhG3LGFI0a43CgfMYMcZ0DiylhYUM48GWz
/axza5uangnIQxBwv+4KXGUfplJujv8WfBepeh+tqPgS8qCqn6e0+sdkUN7yHcA/
O24DiQajtMXG5nR6qHdZhRLCFRXRghYdvVKrkOVFogYqwa4dViyuP/6EFDkuMwDs
7XrxJIjL8qp9Lrw2sHN1F+USKhlPRaNBtWzDELf54zVgAIAeFUriqtER8ZWBWgp4
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIErjCCA5agAwIBAgIQBYAmfwbylVM0jhwYWl7uLjANBgkqhkiG9w0BAQsFADBh
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBD
QTAeFw0xNzEyMDgxMjI4MjZaFw0yNzEyMDgxMjI4MjZaMHIxCzAJBgNVBAYTAkNO
MSUwIwYDVQQKExxUcnVzdEFzaWEgVGVjaG5vbG9naWVzLCBJbmMuMR0wGwYDVQQL
ExREb21haW4gVmFsaWRhdGVkIFNTTDEdMBsGA1UEAxMUVHJ1c3RBc2lhIFRMUyBS
U0EgQ0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCgWa9X+ph+wAm8
Yh1Fk1MjKbQ5QwBOOKVaZR/OfCh+F6f93u7vZHGcUU/lvVGgUQnbzJhR1UV2epJa
e+m7cxnXIKdD0/VS9btAgwJszGFvwoqXeaCqFoP71wPmXjjUwLT70+qvX4hdyYfO
JcjeTz5QKtg8zQwxaK9x4JT9CoOmoVdVhEBAiD3DwR5fFgOHDwwGxdJWVBvktnoA
zjdTLXDdbSVC5jZ0u8oq9BiTDv7jAlsB5F8aZgvSZDOQeFrwaOTbKWSEInEhnchK
ZTD1dz6aBlk1xGEI5PZWAnVAba/ofH33ktymaTDsE6xRDnW97pDkimCRak6CEbfe
3dXw6OV5AgMBAAGjggFPMIIBSzAdBgNVHQ4EFgQUf9OZ86BHDjEAVlYijrfMnt3K
AYowHwYDVR0jBBgwFoAUA95QNVbRTLtm8KPiGxvDl7I90VUwDgYDVR0PAQH/BAQD
AgGGMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjASBgNVHRMBAf8ECDAG
AQH/AgEAMDQGCCsGAQUFBwEBBCgwJjAkBggrBgEFBQcwAYYYaHR0cDovL29jc3Au
ZGlnaWNlcnQuY29tMEIGA1UdHwQ7MDkwN6A1oDOGMWh0dHA6Ly9jcmwzLmRpZ2lj
ZXJ0LmNvbS9EaWdpQ2VydEdsb2JhbFJvb3RDQS5jcmwwTAYDVR0gBEUwQzA3Bglg
hkgBhv1sAQIwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29t
L0NQUzAIBgZngQwBAgEwDQYJKoZIhvcNAQELBQADggEBAK3dVOj5dlv4MzK2i233
lDYvyJ3slFY2X2HKTYGte8nbK6i5/fsDImMYihAkp6VaNY/en8WZ5qcrQPVLuJrJ
DSXT04NnMeZOQDUoj/NHAmdfCBB/h1bZ5OGK6Sf1h5Yx/5wR4f3TUoPgGlnU7EuP
ISLNdMRiDrXntcImDAiRvkh5GJuH4YCVE6XEntqaNIgGkRwxKSgnU3Id3iuFbW9F
UQ9Qqtb1GX91AJ7i4153TikGgYCdwYkBURD8gSVe8OAco6IfZOYt/TEwii1Ivi1C
qnuUlWpsF1LdQNIdfbW3TSe0BhQa7ifbVIfvPWHYOu3rkg1ZeMo6XRU9B4n5VyJY
RmE=
-----END CERTIFICATE-----
```

#### 11.6.1.3 RSA 私钥

在上传服务器证书时，需要用户同时上传证书的私钥内容。

* 以 `-----BEGIN RSA PRIVATE KEY-----` 开头，以` -----END RSA PRIVATE KEY-----` 结尾。
* 每行 64 个字符，最后一行长度可以不足 64 个字符。
* 证书内容不能包含空格。

证书 RSA 私钥内容的格式规范如下，可参考以下文本内容和证书示例：

```
-----BEGIN RSA PRIVATE KEY-----
证书私钥(BASE64编码)
-----END RSA PRIVATE KEY-----
```

```
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAtkg0+aSREIUYUEPfL87gLytc1BTA9adRN2MiRgyEmEiDR9/E
E7Valm2YJlZFOr9kdRqwc9IjH3rztP7I8Xn8B5ohmHdcrRvXZvA931WaMaYkk/Ya
CMozhUbLQSxl7sVkmti3Y1Unj2hX8Wjd1GS2GOjCB5HasVWS4TOADUizazyOnEVG
VQVNvVdwNs55FRG8eXcCgN0hhVVn6o3816gvjU8pSym+x99OAcbKWZSg4p/v2lf7
0qL1TO84OewDrcY5EjcwQ43c/lHd8Kmk9TuLxBuLaqgJ7CMiXmjLnhbYtHI4jMC1
bBbJldXlUgYmFhjvFP2ERb/nTYOFxtjKmFBbEQIDAQABAoIBAAbLqdftu+/A+n9R
jHJIlOCFThRlAq2V04gMVNSGNnJD78r/61wtvGcTxmKVgEa4qGraOB5VRPRxPcEv
Z3fjK5Nv+lUoDAczHMRsa+4Vz6YOstnmSKGvwhxzn3O6T0GHz+Ca+DlGjS9CPVcV
aQG4UHacxNEJ7byDO3LUW++C2JeEjg2LVLJt+jRwFIAwmk8XjM/jyOn5kCj2kvz6
w/yHbmwAac2mfA42CQN78o1bvEHlHH1cVDRHZ482pNlfp8WBGgCFWHBGeMpLOq9R
YXEt+SyJ84o80mTeR2DgswpW577uZLGfPyFUwKPc/XGZSzbfKX5L9ctGQrr4lsQ+
F2stOk0CgYEA5JyQ5S7qPf8YcczQfXblVueslDL56Zt1/KUdUQ4L9i2as+5LkiN+
7gVK8INhvYi8dRAqZxqXLqU5dXEWbkcnFbenjoQyPCfYI5lZE2+cZriLtO3I0YKP
nc9NwSE+gRR9kXbgGSiANJmGC5TxOU99hR7Nx6wUMAflatCaSmP5RbUCgYEAzB67
MOWzeVD8Eq/DhEE5N0o3hpyhiMy++A/LC8lAjFAi6ldc70zMYMUjfh+eTNK89Z6H
1z3xBaQMMlHAy8pU5uI9LOgm/xWaPNZ034Xx4fWftBnEGFtBgLfbNphoUz3Df5vK
XvXhjdKEkwevcLoZWHfNZIJnennlEV26Tk1DGW0CgYBYCKaPasqPRy2NnRZoSiG0
npBJnXu5ZsE/ogGxFdyrVxJs2YXGZ97YH7ek+KLpzr7rwWbiv02ai8udmwfNPZ8i
cM+YRPXnTlygEMxJfMBYmhZKfQrJCyLs3UiO55NfN5nHK2TOq1b7amdBDID71c17
Nsp9apl3iYLh6CSSIv95xQKBgCHmKKhiPYA0VuizkADy5BGunbIZaSpS9pQz60C1
16Z12Jaak7CaTIb1toNHtP6FMSSJg33Xp6OMLwpcUWyG2brOb+J5W6CZcdgQtbA5
ioZASJmcfdidry81WY6jmQ/Z/hG/ScijhSYMhD/20sgh3/u1ScMbdRv+CnDr4/kF
E9OxAoGBAK0mCJyyKNkWSdOg7fbBwYJKQ1BBZ6lh1gVpc7recSreNPRFWTd6l+cw
eCxXqbSJJw4oYYF4IoBX1fCfFd82engRkwmkDykGMwpomnJoZqjFhmVtDb81xRQL
pscHorV4flpOcSwg6b3jq0N6+PN85XI9XIFImXXHJqqKSFBBSPrf
-----END RSA PRIVATE KEY-----
```

若 RSA 私钥内容已进行加密，如私钥以 ``-----BEGIN PRIVATE KEY-----` 或 `-----BEGIN ENCRYPTED PRIVATE KEY-----` 开头，以 `-----END PRIVATE KEY-----` 或 `-----END ENCRYPTED PRIVATE KEY-----` 结尾，需对证书私钥内容进行转换。在 Linux 系统中操作如下所示：

```
openssl rsa -in old_server_key.pem -out new_server_key.pem
```

#### 11.6.1.4 客户端证书

客户端证书格式要求和 Root CA 机构颁发的证书要求一致，以 `-----BEGIN CERTIFICATE-----` 开始，以 `-----END CERTIFICATE-----` 结尾， 每行64字符，最后一行可以不足64字符。如下规范所示：

```
-----BEGIN CERTIFICATE-----
客户端CA证书(BASE64编码)
-----END CERTIFICATE-----
```

### 11.6.2 创建 SSL 证书

用户上传 SSL 证书用于部署 HTTPS 协议的负载均衡业务，支持上传服务器证书和客户端证书。上传证书时需检测 SSL 证书的格式及有效性，若 SSL 证书内容不符合格式规范，则无法成功生成 SSL 证书。

#### 11.6.2.1 创建服务器证书

支持本地上传证书文件和手动输入证书内容两种方式创建服务器证书，用户可通过负载均衡控制台切换至 SSL 证书标签页，进入 SSL 证书管理控制台，通过创建 SSL 证书进入上传证书向导页面，选择服务器证书进行创建。

**（1）本地上传证书文件的方式创建如下图所示：**

![CreateServerSSL](../images/userguide/CreateServerSSL.png)

本地上传时需要上传用户证书文件和证书私钥文件，其中用户证书文件仅支持 `crt` 和 `pem` 格式的文件，证书私钥仅支持上传 `.key` 格式的文件。

* 用户证书：用户的授权证书内容，包括公钥和签名等信息，支持证书链，一般为 `.crt` 和 `.pem` 格式的文件。
* 证书私钥：加密证书的私钥内容，一般为 `.key` 格式的文件。

点击上传证书，即可将本地已生成的证书文件读取到平台，并通过确认进行证书创建，创建过程中，平台会检测证书内容的合法性。

**（2）手动输入证书内容创建如下图所示：**

![CreateServerSSL1.png](../images/userguide/CreateServerSSL1.png.png)

手动输入证书同样需要输入用户证书和证书私钥的文本内容，需参考文本框中的格式规范输入证书内容和私钥内容，通过确认进行证书创建，创建过程中，平台会检测证书内容的合法性。

#### 11.6.2.2 创建客户端证书

支持本地上传证书文件和手动输入证书内容两种方式创建客户端证书，用户可通过负载均衡控制台切换至 SSL 证书标签页，进入 SSL 证书管理控制台，通过创建 SSL 证书进入上传证书向导页面，选择客户端证书进行创建。

**（1）本地上传证书文件的方式创建如下图所示：**

![CreateCASSL](../images/userguide/CreateCASSL.png)

本地上传时需要上传客户端 CA 公钥证书文件，仅支持 `crt` 和 `pem` 格式的文件。点击上传证书，即可将本地已生成的证书文件读取到平台，并通过确认进行证书创建，创建过程中，平台会检测证书内容的合法性。

**（2）手动输入证书内容创建如下图所示：**

![CreateCASSL1](../images/userguide/CreateCASSL1.png)

手动输入证书同样需要输入 CA 客户端证书的文本内容，需参考文本框中的格式规范输入证书内容和私钥内容，通过确认进行证书创建，创建过程中，平台会检测证书内容的合法性。

### 11.6.3 查看 SSL 证书

通过导航栏进入负载均衡控制台，切换至 SSL 证书标签页可查看 SSL 证书的资源列表，并可通过列表上名称和 ID 进入详情页面查看证书的详细信息及已绑定资源信息。

#### 11.6.3.1 SSL 证书列表

SSL 证书列表可查看当前账户下所有 SSL 证书的资源列表信息，包括名称、资源 ID、证书类型、域名、MD5 值、创建时间、证书过期时间及操作项，如下图所示：

![SSLList](../images/userguide/SSLList.png)

* 名称/ID ：SSL 证书的名称及全局唯一标识符。
* 证书类型：SSL 证书的类型，包括服务器证书和和客户端证书，仅在 VServer 监听器的 SSL 解析模式为双向认证时才需上传客户端证书。
* 域名：SSL 证书的主域名和备用域名信息，分别对应证书的 CommonName 和 Subject Alternative Name 字段信息，代表该证书可进行加解密服务的域名。
* MD5 值：SSL 证书的 MD5 较验值，用于验证 SSL 证书的准确性。
* 创建时间：SSL 证书在平台的创建时间。
* 证书过期时间：SSL 证书本身的过期时间，若证书已过期，需要重新为域名申请或制作新的证书，否则 HTTPS 协议访问会被认为不可信，即 HTTPS 失效。

列表上的操作项是指对单个证书的操作，包括查看证书和删除证书，可通过搜索框对证书列表进行搜索和筛选，支持模糊搜索。为方便租户对资源的维护，同时支持对 SSL 证书进行批量删除操作。

#### 11.6.3.2 SSL 证书详情

在证书资源列表上，点击名称或 ID 可进入概览页面查看当前证书的详信细信及已绑定的资源信息，如概览所示：

![sslinfos](../images/userguide/sslinfos.png)

**（1）基本信息**

SSL 证书的基本信息，包括资源 ID、名称、证书类型、主域名、备域名、MD5 值、证书内容、创建时间及证书的过期时间。用户可通过资源列表上或基本信息中的【查看证书】按钮查询当前证书的内容，如下图所示：

![sslinfo](../images/userguide/sslinfo.png)

> 若证书已过期，可通过点击已过期查看证书内容本身的具体过期时间。

**（2）关联资源**

通过已关联资源信息列表，可查看当前 SSL 证书已被关联的负载均衡及 VServer 信息，包括负载均衡名称、LBID、VServerID、VServer 的协议端口，如概览页所示，证书已关联 1 个 资源（HTTPS:443）。

#### 11.6.4 删除 SSL 证书

用户删除 SSL 证书，仅允许删除未被使用的的 SSL 证书。若一个 SSL 证书已关联一个负载均衡的 VServer ，则不可进行删除。

![sslrm](../images/userguide/sslrm.png)

证书被删除后即在平台彻底销毁，不可进行恢复，可重新进行上传并关联负载均衡进行使用。
# 12 NAT 网关

## 12.1 NAT 网关简介

### 12.1.1 概述

NAT 网关（ NAT Gateway ）是一种类似 [NAT](https://zh.wikipedia.org/wiki/网络地址转换) 网络地址转换协议的 VPC 网关，为云平台资源提供 SNAT 和 DNAT 代理，支持互联网地址转换能力，并支持普通和白名单两种资源网络出口模式。

用户可通过 NAT 网关让 VPC 子网中未绑定外网 IP 的虚拟机访问外网，同时可配置端口转发规则使虚拟机对外提供服务。作为一个虚拟网关设备，需要绑定外网 IP 作为 NAT 网关的默认统一出口，支持 VPC 、子网、虚拟机三种级别的 SNAT 规则，使不同维度的资源通过 NAT 网关访问外网。

同时网关提供 DNAT 能力，支持配置基于 TCP 和 UDP 两种协议的端口转发，将 VPC 内的云资源内网端口映射到 NAT 网关所绑定的外网 IP，对互联网或 IDC 数据中心网络提供服务。NAT 网关具有地域（数据中心）属性，仅支持相同数据中心下同 VPC 虚拟资源的 SNAT 和 DNAT 转发服务。

虚拟机通过 NAT 网关可访问的网络取决于绑定的外网 IP 所属网段在物理网络上的配置，若所绑定的外网 IP 可通向互联网，则虚拟机可通过 NAT 网关访问互联网；若所绑定的外网 IP 可通向 IDC 数据中心的物理网络，则虚拟机通过 NAT 网关访问 IDC 数据中心的物理网络。

### 12.1.2 应用场景

用户在平台使用虚拟机部署应用服务时，有访问外网或通过外网访问虚拟机的应用场景，通常我们会在每一台虚拟机上绑定一个外网 IP 用于和互联网或 IDC 数据中心网络进行通信。真实环境和案例中，可能无法分配足够的公网 IP ，即使公网 IP 足够也无需在每一台需要访问外网的虚拟机上绑定外网 IP 地址。

- 共享 EIP ：通过 SNAT 代理，使多台 VPC 内网虚拟机共享 1 个 外网 IP 地址访问互联网或 IDC 数据中心的物理网络。
- 屏蔽真实 IP ：通过 SNAT 代理，多台 VPC 内网虚拟机使用代理 IP 地址通信，自动屏蔽真实 IP 内网地址。
- VPC 内网虚拟机提供外网服务：通过 DNAT 代理，配置 IP 及端口转发，对互联网或 IDC 数据中心的网络提供业务服务。

### 12.1.3 架构原理

平台产品服务底层资源统一，NAT 网关实例为主备高可用集群架构，可实现 NAT 网关故障自动切换，提高 SNAT 和 DNAT 服务的可用性。同时结合外网 IP 地址，根据 SNAT 和 DNAT 规则为租户虚拟资源提供 SNAT 和 DNAT 代理服务。

在产品层面，租户通过申请一个 NAT 网关，指定 NAT 网关可允许通信的 VPC 网络，通过绑定【外网 IP】使多子网下虚拟机与互联网或 IDC 数据中心物理网进行通信，具体逻辑架构图如下：

![natgw](../images/userguide/natgw.png)

- 平台支持同 VPC 多子网虚拟机使用 NAT 网关访问互联网或 IDC 数据中心网络。
- 当多个子网中未绑定外网 IP 的虚拟机关联 NAT 网关时，平台将自动在虚拟机中下发访问外网的路由。
- 虚拟机通过下发的路由，将访问外网的数据通过 NAT 网关透传至已绑定的【外网 IP】。
- 透传至外网 IP 的数据通过平台 OVS 及物理网卡将数据包发送至物理交换机，完成数据 SNAT 的通信。
- 当外网需要访问 VPC 中的虚拟机时，可通过 NAT 网关端口转发，使互联网或 IDC 物理网通过 NAT 网关已绑定的 IP+端口 访问 VPC 内网服务。

### 12.1.4 功能特性

云平台提供高可用 NAT 网关服务，并支持网关的全生命周期管理，包括多外网 IP 、SNAT 规则及 DNAT 端口转发及监控告警，同时为 NAT 网关提供网络及资源隔离的安全保障。

一个 VPC 允许创建 20 个 NAT 网关，相同 VPC 下所有 NAT 网关中 SNAT 规则不可重复，即 20 个 NAT 网关中的 SNAT 规则不允许重复。场景举例：

* 当 NATGW  (VPC：192.168.0.0/16）中创建了子网（192.168.0.1/24）的 SNAT 规则，则相同 VPC 下 NATGW 不可在创建子网（192.168.0.1/24）为源地址的 SNAT 规则，当 NATGW01 中该子网规则删除后，才可进行创建。
* 当 NATGW  (VPC：192.168.0.0/16）中创建了 VPC 级别的规则，则相同 VPC 下不可在创建 VPC 级别的规则。
* 当 NATGW  (VPC：192.168.0.0/16）中创建了 虚拟机（192.168.1.2） 的 SNAT 规则，则相同VPC 下 NATGW 不可在创建虚拟机（192.168.1.2） 为源地址的 SNAT 规则。

#### 12.1.4.1 多外网 IP 支持

NAT 网关支持绑定多个外网 IP 地址，使 SNAT 规则中的资源可通过多个外网 IP 地址访问外网，DNAT 端口转发规则中的虚拟资源，可通过指定的外网 IP 地址访问 VPC 内网服务。

一个 NAT 网关支持绑定 50 个默认路由类型的 IPv4 外网 IP 地址，为 NAT 网关指定子网的虚拟资源提供共享的外网 IP 资源池，以提供更加灵活便捷的 SNAT 及 DNAT 能力。

支持用户查看已绑定至 NAT 网关的所有外网 IP 地址，同时支持对外网 IP 地址的解绑，解绑后相关联的 SNAT 规则和 DNAT 规则网络通信都将失效。用户可通过修改 SNAT 和 DNAT 规则，分别设置新的出口 IP 及入口源 IP 地址。

#### 12.1.4.2 SNAT 规则

NAT 网关通过 SNAT 规则支持 SNAT（Source Network Address Translation 源地址转换）能力，每条规则由源地址和目标地址组成，即将源地址转换为目标地址进行网络访问。平台 SNAT 规则支持多种场景的出外网场景，即源地址包括 VPC、子网、虚拟机三种类型：

- VPC 级别：指 NAT 网关所属 VPC 下的所有虚拟机可通过 NAT 网关访问外网。
- 子网级别：指 NAT 网关所属 VPC 下被指定子网中的所有虚拟机可通过 NAT 网关访问外网。
- 虚拟机级别：指 NAT 网关所属 VPC 下被指定的虚拟机才可通过 NAT 网关访问外网。

规则的目标地址为 NAT 网关绑定的外网 IP 地址，通过规则策略即可将源地址在 VPC 、子网、虚拟机的 IP 地址转换为网关绑定的外网 IP 进行网络通信，即通过 SNAT 规则虚拟机可在不绑定外网  IP 的情况下与平台外网进行通信，如访问 IDC 数据中心网络或互联网。

SNAT 规则中不同源地址类型的规则优先级不同，以优先级高的规则为准：

**（1）源地址为 VPC ** 

- NAT 网关所属 VPC 下所有虚拟机均可通过 NAT 网关访问外网。
- 一个 NAT 网关仅允许创建一条源地址为 ALL 的 SNAT 规则。
- 源地址为 ALL 规则的优先级最低，在未匹配到精确规则时，以源地址为 ALL 的规则访问外网。

**（2）源地址为子网 CIDR**

- 子网下虚拟机可通过 NAT 网关访问外网，子网 SNAT 规则优先级高于源地址为 ALL 的规则。
- 每个子网仅可创建一条 SNAT 规则，不允许重复。
- 支持为子网下虚拟机单独配置 SNAT 规则，优先级高于源地址为子网的 SNAT 规则。

**（3）源地址为虚拟机IP**

- 虚拟机可通过 NAT 网关访问外网。
- 每个虚拟机 IP 仅可创建一条 SNAT 规则，不允许重复。
- 源地址为虚拟机 IP 的 SNAT 规则优先级高于源地址为 ALL 和 子网的 SNAT 规则。

SNAT 规则的目标地址可以为 NAT 网关已绑定的一个或多个外网 IP ，当目标外网 IP 为 ALL 时，源地址资源从网关上所有外网 IP 池中随机选择 IP 访问外网。

> 一个 NAT 网关默认可创建 100条 SNAT 规则。

用户配置 SNAT 规则后，NAT 网关会自动下发默认路由至源地址匹配的虚拟机，使虚拟机通过 SNAT 规则的外网 IP 访问外网。具体通信逻辑如下：

- 虚拟机未绑定 IPv4 外网 IP ，则默认通过 NAT 网关访问外网。
- 虚拟机已绑定 IPv4 外网 IP 且存在默认网络出口，则通过虚拟机默认网络出口访问外网。
- 虚拟机已绑定 IPv4 外网 IP 且无默认网络出口，则通过 NAT 网关访问外网。

虚拟机通过 NAT 网关访问外网时，使用的外网 IP 取决于 SNAT 规则的配置，若规则配置的外网 IP 为多个，则会从多个外网 IP 中随机选择 IP 地址作为虚拟机的出口。

#### 12.1.4.3 DNAT 规则

NAT 网关支持 DNAT（Destination Network Address Translation 目的地址转换），也称为端口转发或端口映射，即将外网 IP 地址转换为 VPC 子网的 IP 地址提供网络服务。

- 支持 TCP 和 UDP 两种协议的端口转发，支持对端口转发规则进行生命周期管理。
- 支持批量进行多端口转发规则配置，即支持映射端口段，如 TCP:1024~TCP:1030 。
- NAT 网关绑定外网 IP 时，端口转发规则为 VPC 子网内的虚拟机提供互联网外网服务，可通过外网访问子网内的虚拟机服务。

#### 12.1.4.4 监控告警

平台支持对 NAT 网关进行监控数据的收集和展示，通过监控数据展示每一个 NAT 网关的指标数据，同时支持为每一个监控指标设置阈值告警及通知策略。支持的监控指标包括网络出/带宽、网络出/包量及连接数。

支持查看一个 NAT 网关多时间维度的监控数据，包括 1 小时、6 小时、12 小时、1 天、7 天、15 天及自定义时间的监控数据。默认查询数提成为 1 小时的数据，最多可查看 1 个月的监控数据。

#### 12.1.4.5 NAT 网关高可用

NAT 网关实例支持高可用架构，即至少由 2 个虚拟机实例构建，支持双机热备。当一个 NAT 网关的实例发生故障时，支持自动在线切换到另一个虚拟机实例，保证 NAT 代理业务正常。同时基于外网 IP 地址的漂移特性，支持在物理机宕机时，保证 SNAT 网关出口及 DNAT 入口的可用性。

### 12.1.5 NAT 网关安全

NAT 网关的网络访问控制可以关联安全组给予安全保障，通过安全组的规则可控制到达 NAT 网关 所绑定外网 IP 的入站流量及出站流量，支持 TCP、UDP、ICMP、GRE 等协议数据包的过滤和控制。

安全组及安全组的规则支持对已关联安全组的 NAT 网关的流量进行限制，仅允许安全组规则内的流量透传安全组到达目的地。为保证 NAT 网关的资源和网络安全，平台为 NAT 网关提供资源隔离及网络隔离机制：

* 资源隔离
  * NAT 网关具有数据中心属性，不同数据中心间 NAT 网关资源物理隔离；
  * NAT 网关资源在租户间相互隔离，租户可查看并管理账号及子账号下所有 NAT 网关资源；
  * 一个租户内的 NAT 网关资源，仅支持绑定租户内同数据中心的 VPC 子网资源；
  * 一个租户内的 NAT 网关资源，仅支持绑定租户内同数据中心的外网 IP 资源；
  * 一个租户内的 NAT 网关资源，仅支持绑定租户内同数据中心的安全组资源。

* 网络隔离
  * 不同数据中心间 NAT 网关资源网络相互物理隔离；
  * 同数据中心 NAT 网关网络采用 VPC 进行隔离，不同 VPC 的 NAT 网关资源无法相互通信；
  * NAT 网关绑定的外网 IP 网络隔离取决于用户物理网络的配置，如不同的 Vlan 等。

## 12.2 使用流程

在使用 NAT 网关服务前，需根据业务需求规划 NAT 网关的 VPC 网络及外网 IP 网络，并根据业务需求配置 SNAT 和 DNAT 规则。具体流程如下：

1. 租户根据需求创建 VPC 和 子网，并在多个子网中创建虚拟机；
2. 租户根据需求创建 外网 IP 地址，并通过 API 或控制台指定网络类型、关联子网及绑定的出口 IP 地址，创建一个 NAT 网关；
3. 通过 SNAT 规则添加 VPC、子网或虚拟机类型的 SNAT 规则，则关联的虚拟机可通过 NAT 网关访问外网；
4. 通过 DNAT 规则配置需要通过对外提供服务的虚拟机规则，则外网可访问 VPC 网络中未绑定外网 IP 的资源；
5. 如需对 NAT 网关的进出流量进行限制，可通过 NAT 网关绑定的安全组进行配置；
6. 可为 NAT 网关绑定多个外网 IP 地址，配置多外网 IP 的 SNAT 规则和 DNAT 规则。

## 12.3 创建 NAT 网关

用户在平台创建 NAT 网关需指定机型、VPC 网络、子网、外网 IP 、安全组及 NAT 网关名称和备注信息。一个 VPC 允许创建 20 个 NAT 网关，相同 VPC 下所有 NAT 网关中 SNAT 规则不可重复，即 20 个 NAT 网关中的 SNAT 规则不允许重复。

用户可通过导航栏进入【NAT 网关】资源控制台，通过“创建 NAT 网关”进入创建向导页面，如下图所示：

![createnat](../images/userguide/createnat.png)

1. 选择并配置 NAT 网关基础配置及网络设置信息：

- 机型：NAT 网关实例所在宿主机的集群类型，由平台管理员自定义，如 x86 机型和 ARM 机型，通过 ARM 机型创建的实例为 ARM 版 NAT 网关实例，已适配国产芯片、服务器及操作系统。
- 名称/备注：NAT 网关的名称及备注信息。
- VPC 网络：NAT 网关所服务的 VPC 网络，即 NAT 网关仅为所选择的 VPC 内资源提供 SNAT 和 DNAT 服务，同时仅支持添加所属 VPC 网络的资源作为 SNAT 规则的源地址及 DNAT 规则的目标地址。
- 子网：NAT 网关实例所在子网，通常建议选择可用 IP 数量充足的子网。
- 外网 IP ：NAT 网关地址所使用的外网 IP 地址，VPC 网络内绑定的资源均通过 NAT 网关所绑定的外网 IP 地址访问互联网或 IDC 物理网络，仅支持绑定有默认路由的外网 IP 地址。
- 安全组：NAT 网关的外网 IP 地址所使用的安全组，控制可进入 NAT 网关的流量。

2. 选择并配置以上信息后，可选择购买数量和付费方式，确认订单金额并点击“立即购买” 进行 NAT 网关创建：

- 购买数量：按照所选配置及参数批量创建 NAT 网关实例，一次仅支持创建 1 个 NAT 网关实例。
- 付费方式：选择 NAT 网关的计费方式，支持按时、按年、按月三种方式，可根据需求选择适合的付费方式。
- 合计费用：用户选择 NAT 网关资源按照付费方式的费用展示。

确认订单无误后点击立即购买，点击立即购买后，会返回 NAT 网关资源列表页，在列表页可查看 NAT 网关的创建过程，通常会先显示“创建中”的状态，创建成功后转换为“**运行**”。

> 允许在一个 VPC 下创建多个 NAT 网关，将 VPC 下的虚拟机分批添加至多个 NAT 网关中，实现 NAT 网关分流，应对大批量虚拟机共享外网 IP 地址访问外网的场景。

## 12.4 查看 NAT 网关

通过导航栏进入 NAT 网关资源控制台，可查看 NAT 网关资源列表，并可通过列表上名称和 ID 进入详情页面查看 NAT 网关的概览及监控信息，同时可切换至白名单标签页对 NAT 网关的白名单进行管理。

### 12.4.1 NAT 网关列表

NAT 网关列表可查看当前账户下所有 NAT 网关的资源信息，包括名称、资源 ID、VPC、子网、安全组、外网 IP、创建时间、过期时间、计费方式、状态及操作项，如下图所示：

![natlist](../images/userguide/natlist.png)

- 名称/ID：NAT 网关的名称及全局唯一标识符。
- 外网 IP：NAT 网关所绑定的外网 IP 地址，若 NAT 网关绑定多个外网 IP ，则会展示多个外网 IP 地址。
- VPC 网络：NAT 网关所服务的 VPC 网络，即 NAT 网关仅为 VPC 内的资源提供 SNAT 和 DNAT 服务，同时仅支持添加所属 VPC 网络的资源作为 SNAT 规则的源地址及 DNAT 规则的目标地址。
- 子网：仅代表 NAT 网关实例所在子网
- 状态：NAT 网关的运行状态，包括创建中、运行、删除中等。
- 创建时间/过期时间：指当前 NAT 网关的创建时间和费用过期时间。
- 计费方式：指当前 NAT 网关创建时指定的计费方式。

列表上操作项是指对单个 NAT 网关实例的操作，包括删除及修改安全组等，可通过搜索框对 NAT 网关资源列表进行搜索和筛选，支持模糊搜索。

为方便租户对资源的统计及维护，平台支持下载当前用户所拥有的所有 NAT 网关资源列表信息为 Excel 表格；同时支持对 NAT 网关进行批量删除操作。

### 12.4.2 NAT 网关详情

在 NAT 网关资源列表上，点击“**名称**” 可进入概览页面查看当前 NAT 网关实例的详细信息，同时可切换至 SNAT 规则、DNAT 规则、外网 IP 管理页面，分别管理当前 NAT 网关的 SNAT 规则、DNAT 规则及绑定的外网 IP 管理，如概览页所示：

![natdetails](../images/userguide/natdetails.png)

**（1）基本信息**

NAT 网关的基本信息，包括名称、ID、VPC 网络、子网、外网 IP、安全组、状态、计费方式、创建时间、过期时间及告警模板信息，可点击告警模板右侧按钮修改 NAT 网关所关联的告警模板。

**（2）监控信息**

NAT 网关实例相关的监控图表及信息，包括网卡入/出带宽、网卡入/出包量及连接数，支持查看 1 小时、6 小时、12 小时、1 天及自定义时间的监控数据。

**（3）SNAT 规则**

NAT 网关的 SNAT 规则管理，即可通过 NAT 网关访问外网的虚拟资源及出口 IP 管理，包括 SNAT 规则 的添加、查看、修改及删除操作，详见 [SNAT规则](#_1210-SNAT-规则)。

**（4）DNAT 规则**

NAT 网关的 DNAT 规则管理，即可通过 NAT 网关外网 IP 访问 VPC 内虚拟资源的端口映射管理，包括 DNAT 规则的添加、查看、修改及删除操作，详见 [DNAT规则](#_1211-DNAT-规则)。

**（5）外网 IP 管理**

NAT 网关的外网 IP 管理，即已绑定至 NAT 网关的外网 IP 地址管理，包括外网 IP 查看、绑定及解绑操作，详见  [外网 IP 管理](#_1212-外网-IP-管理)。

## 12.5 修改告警模板

修改告警模板是对 NAT 网关的监控数据进行告警的配置，通过告警模板定义的指标及阈值，可在 NAT 网关相关指标故障及超过指标阈值时，触发告警，通知相关人员进行故障处理，保证 NAT 网关及业务的网络通信。

用户可通过 NAT 网关详情概览页的操作项进行告警模板修改操作，在修改告警模板向导中选择新 NAT 网关告警模板进行修改。

## 12.6 删除 NAT 网关

用户可通过控制台或 API 的方式删除不需要的 NAT 网关实例，删除时会自动解绑已绑定的外网 IP 地址，并清除NAT 网关已添加的 SNAT/DNAT 规则及路由策略。

![rmnatgw](../images/userguide/rmnatgw.png)

NAT 网关被删除后即直接销毁，请在删除前确保 NAT 网关无业务流量访问外网，否则可能影响业务访问。

## 12.7 修改名称和备注

修改 NAT 网关资源的名称和备注，在任何状态下均可进行操作。可通过点击 NAT 网关资源列表页面每个 NAT 网关名称右侧的“编辑”按钮进行修改。

## 12.8 修改安全组

绑定至 NAT 网关的安全组策略作用于 NAT 网关出口的外网 IP ，用于限制通过 NAT 网关出口流量。支持修改 NAT 网关的安全组，用户可通过 NAT 网关列表操作项中的“**修改安全组**”进行修改操作，如下图所示：

![natgwbindsg](../images/userguide/natgwbindsg.png)

一个 NAT 网关仅支持绑定一个安全组，修改成功安全组即时生效，平台会以新的安全组策略对进出 NAT 网关的流量进行限制，用户可通过 NAT 网关列表及详细信息查看已修改的安全组信息。

## 12.9 NAT 网关续费

支持用户手动对 NAT 网关进行续费，续费操作只针对资源本身，不对资源额外关联的资源进行续费，如绑定的外网 IP 资源。额外关联的资源到期后，会自动从 NAT 网关进行解绑，为保证业务正常使用，需及时对相关资源进行续费操作。

NAT 网关续费时会按照续费时长收取费用，续费时长与资源的计费方式相匹配，当 NAT 网关的计费方式为【小时】，则续费时长可选择 1 至 24 小时；当 NAT 网关的计费方式为【按月】，则续费时长可选择 1 至 11 月；当 NAT 网关的计费方式为【按年】，则续费时长为 1 至 5 年。

## 12.10 SNAT 规则

NAT 网关通过 SNAT 规则支持 SNAT（Source Network Address Translation 源地址转换）能力，每条规则由源地址和目标地址组成，即将源地址转换为目标地址进行网络访问。

平台 SNAT 规则支持多种场景的出外网场景，即源地址包括 VPC、子网、虚拟机三种类型。通常只需要指定一条 VPC 类型的 SANT 规则，即可实现 NAT 网关所属 VPC 网络下所有虚拟机访问外网的能力。

SNAT 规则仅支持 SNAT 能力，不对 DNAT 端口转发能力进行限制，即添加至 SNAT 规则 的虚拟机可通过 NAT 网关访问外网或 IDC 物理网；若虚拟机需要同时对外网提供业务服务， 则可同时针对虚拟机配置 DNAT 规则。

### 12.10.1 创建 SNAT 规则

用户创建一条 SNAT 规则，为指定虚拟资源指定访问外网的 IP 地址，规则内的源地址资源必须与 NAT 网关处于相同的 VPC 网络。用户可通过 NAT 网关详情页面 “SNAT规则” 控制台中的“创建SNAT规则”进入规则添加向导页面，如下图所示：

![addsnat](../images/userguide/addsnat.png)

在向导页面，用户需指定 SNAT 规则的源地址类型、子网、虚拟机及外网 IP ，源地址是需要通过 NAT 网关访问外网的资源类型；子网是指通过 NAT 网关访问外网的子网 CIDR ；虚拟机指通过 NAT 网关访问外网的虚拟机 IP 地址；外网 IP 是指资源访问外网时的出口 IP 地址。

**（1）源地址类型**：指定 SNAT 规则的源地址类型，包括 VPC 级别、子网级别、虚拟机级别，一条规则仅支持一种类型的规则。

* VPC 级别：指当前 NAT 网关所属 VPC 下所有的虚拟机均可通过 NAT 网关访问外网，一个 VPC 下所有 NAT 网关仅支持指定一条 VPC 级别的 SNAT 规则。
* 子网级别：指当前指定的子网下所有虚拟机均可通过 NAT 网关访问外网，子网 SNAT 规则优先级高于源地址类型为 VPC 类型的规则。
* 虚拟机级别：指当前指定的虚拟机可通过 NAT 网关访问外网，虚拟机类型的 SNAT 规则优先级高于 VPC 和子网类型的 SNAT 规则。

**（2）子网：**仅当源地址类型为子网时指定，可指定 NAT 网关所属 VPC 的子网，每个子网仅可创建一条 SNAT 规则，如 VPC CIDR 为 192.168.0.0/16 ，子网可指定 192.168.1.1/24 。

**（3）虚拟机：**仅当源地址类型为虚拟机时指定，可指定 NAT 网关所属 VPC 的虚拟机，每个虚拟机 IP 仅可创建一条 SNAT 规则，如 VPC CIDR 为 192.168.0.0/16 ，虚拟机可指定 192.168.1.2 。

**（4）外网 IP**：指当前 SNAT 规则源地址访问外网时指定的出口 IP 地址，仅支持选择绑定至 NAT 网关的外网 IP；同时支持用户指定外网 IP 为 ALL ，代表源地址资源从网关上绑定的所有外网 IP 池中随机选择 IP 访问外网。

添加 SNAT 规则成功后，平台会自动下发默认路由至规则中指定的虚拟机，使虚拟机可通过 NAT 网关访问互联网或 IDC 数据中心网络，可通过 netstat -rn  命令在 Linux 虚拟机中查看 NAT 网关自动下发的路由信息，并在虚拟机中检测与外网的联通性。

> SNAT 规则添加成功后，平台仅会下发默认路由至无 IPv4 默认路由的虚拟机，针对有默认路由的虚拟机会自动通过虚拟机自身的默认路由访问外网。

### 12.10.2 查看 SNAT 规则

用户通过 NAT 网关详情页面的“SNAT 规则” 可查看已添加至当前网关的 SNAT 规则列表及信息，包括资源 ID、源地址类型、源地址、外网 IP、状态、创建时间及操作项，如下图所示：

![snatlist](../images/userguide/snatlist.png)

- 资源ID ：已添加 SNAT 规则 的全局唯一标识符。
- 源地址类型：指当前 SNAT 规则的源地址类型，如子网级别、虚拟机级别。
- 源地址：当前指 SNAT 规则的源地址资源的 CIDR 或 IP 地址：
  - 当源地址类型为 VPC 时，源地址为 VPC 的 CIDR 网段和名称；
  - 当源地址类型为子网时，源地址为指定的子网 CIDR 网段和名称；
  - 当源地址类型为虚拟机时，源地址为指定的虚拟机内网 IP 和名称。
- 外网 IP：当前 SNAT 规则的目标外网 IP 地址，若外网 IP 为 ALL 时，代表当前 SNAT 规则的目标出口为当前网关绑定的所有外网 IP 地址。
- 状态：指当前 SNAT 规则的状态，包括创建中、有效、删除中。
- 创建时间：指当前 SNAT 规则的创建时间。

列表上操作项是指对单条 SNAT 规则的操作，包括修改和删除，可通过搜索框对 SNAT 规则进行搜索和筛选，支持模糊搜索。同时为方便租户对资源的维护支持对 SNAT 规则进行批量删除操作。

### 12.10.3 修改 SNAT 规则

用户修改一条 SNAT 规则的外网 IP 地址，规则修改后即时生效，当前规则的源地址资源访问外网会使用新外网 IP 地址作为出口。如下图所示：

![updatesnat](../images/userguide/updatesnat.png)

修改 SNAT 规则的外网 IP 时，仅支持选择已绑定至 NAT 网关的外网 IP 地址。

### 12.10.4 删除 SNAT 规则

支持用户删除 SNAT 规则，规则删除后将会立即销毁，规则关联的 SNAT 能力即时失效。可在控制台 SNAT 规则列表上删除 SNAT 规则，并支持批量删除，如下图所示：

![rmsnat](../images/userguide/rmsnat.png)

删除过程中，SNAT 规则的状态为【删除中】，待列表上 SNAT 规则被清除即代表删除成功。删除 SNAT 规则不影响虚拟机本身的正常运行，自动下发的路由将被清除，即不可通过 NAT 网关访问外网，可通过重新添加 SNAT 规则或绑定外网 IP 地址访问外网。

## 12.11 DNAT 规则

DNAT 规则是 NAT 网关提供 DNAT 服务的入口，支持 TCP 和 UDP 两种转发协议。用户可通过端口转发为 NAT 网关配置端口映射，将 VPC 子网内虚拟机内网端口映射到 NAT 网关的外网 IP，使虚拟机可对外网提供服务。

每条规则由协议、源 IP（外网 IP） 、端口、目的 IP（虚拟机 IP）、目的端口五元组组成，即将源 IP 的端口请求转发至目的 IP 的端口，使用户直接通过源 IP 地址访问 VPC 内网虚拟机提供的服务。

### 12.11.1 添加 DNAT 规则

用户为一个 NAT 网关添加转发规则，用于支持 DNAT 代理。转发规则添加成功后，若目的 IP 虚拟机上运行服务正常，用户可通过 NAT 网关绑定的外网 IP 访问目的 IP 虚拟机提供的应用服务。

添加转发规则需用户指定 NAT 网关名称、协议、源 IP 、源端口、目标 IP 、目标端口及多端口，可通过 NAT 网关详情的【DNAT 规则】列表添加 DNAT 规则，如下图所示：

![adddnat](../images/userguide/adddnat.png)

* 协议：指 DNAT 端口转发规则的转发协议，支持 TCP 和 UDP ，创建时必须指定，默认为 TCP 。
* 源 IP：DNAT 端口转发规则的源 IP 地址，即 NAT 网关的所绑定的外网 IP ，一条规则仅支持一个外网 IP 。
* 源端口：DNAT 端口转发规则的源端口，即 NAT 网关所绑定的外网 IP 暴露出来的端口。
  * 创建时必须指定源端口，端口范围为 1~65535。
  * 仅支持指定未创建的源端口，相同协议下不支持重复的源端口规则。
* 目的 IP：DNAT 端口转发规则的目的 IP，即 NAT 网关所属 VPC 网络下虚拟机的内网 IP 地址。
  * 创建时必须指定目的 IP 地址，仅支持指定 NAT 所属 VPC 下的虚拟机 IP 地址。
  * 目的 IP 地址不受 SNAT 规则限制，即一台虚拟机可同时添加 SNAT 规则和 DNAT 规则。
* 目的端口：DNAT 端口转发规则的目的端口，即目的 IP 虚拟机对外提供服务的端口。
  * 创建时必须指定目的端口，端口范围为 1~65535。
  * 目的端口可与源端口相同或不同，如源端口为TCP:80 ，目的端口为 TCP:8080 ，即代表将源 IP 地址的 TCP 80 端口流量转发至目的 IP 地址 TCP 8080 端口。
  * 支持创建同一目的 IP 重复的目的端口，如将两个源地址为的 80 端口均转发至同一个目的地址的相同端口进行业务数据处理。

* 端口范围：DNAT 规则还支持多端口映射规则，即支持指定源端口为连续范围，如 1024~1030；指定端口范围时，目的端口范围的数量必须与源端口一致。

相同协议情况，不支持重复的源端口规则。添加 DNAT 规则成功后，用户即可通过源 IP 地址访问目的虚拟机提供的应用服务。

### 12.11.2 查看 DNAT 规则

用户查看已添加的端口转发规则列表信息，包括转发规则协议、源 IP、源端口、目的IP、目的端口、状态及操作项，如下图所示：

![dnatlist](../images/userguide/dnatlist.png)

* 协议：当前 DNAT 规则的协议，如 TCP 或 UDP 。
* 源 IP：当前 DNAT 规则的源 IP 地址，即当前规则所指定的外网 IP 。
* 源端口：DNAT 规则源 IP 地址的源端口。
* 目的 IP：DNAT 规则端口转发的目的 IP 地址，即当前规则所指定的虚拟机 IP 。
* 目的端口：DNAT 规则目的 IP 地址的目的端口，即最终处理流量的端口。
* 状态：当前 DNAT 规则的状态，包括创建中、有效、删除中。

列表上操作项是指对单条 DNAT 规则的操作，包括修改和删除；同时为方便租户对资源的维护支持对 DNAT 规则进行批量删除操作。

### 12.11.3 修改 DNAT 规则

用户修改已添加 DNAT 规则，包括协议、源 IP 、源端口、目的 IP、目的端口，如下图所示：

![updatedant](../images/userguide/updatednat.png)

用户修改源 IP 必须为 NAT 网关中已绑定的外网 IP 地址，修改后即时生效。

### 12.11.4 删除 DNAT 规则

用户可删除一条或多条 DNAT 转发规则，删除后即时生效，不可通过 DNAT 规则指定的外网 IP 地址访问目标 IP 地址的业务服务。如下图所示：

![rmdnat](../images/userguide/rmdnat.png)

支持批量删除多条转发规则，规则被删除后即被销毁，删除前需谨慎操作。

## 12.12 外网 IP 管理

NAT 网关支持绑定 50 个默认路由类型的 IPv4 外网 IP 地址，为 NAT 网关指定子网的虚拟资源提供共享的外网 IP 资源池，以提供更加灵活便捷的 SNAT 及 DNAT 能力。

用户可通过外网 IP 管理查看 NAT 网关已绑定的外网 IP 地址及信息，同时支持对 NAT 网关的外网 IP 进行绑定和解绑操作。

### 12.12.1 查看绑定的外网 IP

用户可通过 NAT 网关详情【外网 IP 管理】标签页查看已绑定至 NAT 网关的外网 IP 地址列表及信息，包括资源 ID、IP、带宽、状态及操作项等，如下图所示：

![nateiplist](../images/userguide/nateiplist.png)

* 资源 ID ：当前已绑定至 NAT 网关的 EIP  全局唯一标识符。
* IP 地址： 外网 IP 地址。
* 带宽：外网 IP 地址的当前带宽，单位 Mb 。
* 状态：当前外网 IP 地址的状态，包括绑定中、已绑定、解绑中。

列表上操作项是指对单个外网 IP 地址的解绑操作，同时为方便租户对资源的维护，支持对已绑定的外网 IP 地址进行批量解绑操作。

### 12.12.2 绑定外网 IP

支持用户为 NAT 网关绑定 50 个默认路由类型的 IPv4 外网 IP 地址，为 NAT 网关的指定的虚拟资源提供共享外网 IP 池，提供灵活便捷的 SNAT 及 DNAT 能力。具体绑定操作如下图所示：

![natbondeip](../images/userguide/natbondeip.png)

绑定成功后，用户添加 SNAT 和 DNAT 规则时，即可选择绑定的 IP 地址为 SNAT 的外网 IP 或 DNAT 的源 IP 地址。**注：不支持绑定 IPv6 及非默认路由类型的 IPv4 外网 IP 地址。**

### 12.12.3 解绑外网 IP

支持用户解绑 NAT 网关的外网 IP 地址，解绑后相关联的 SNAT 规则和 DNAT 规则网络通信都将失效。

- 解绑后，外网 IP 会自动从 SNAT 规则的外网 IP 池中清除。
- 解绑后，外网 IP 会自动从 DNAT 规则的源 IP 中清除。

![natunbondeip](../images/userguide/natunbondeip.png)

用户可通过修改 SNAT 和 DNAT 规则，分别设置新的出口 IP 及入口源 IP 地址。

# 13 IPSecVPN 服务 

## 13.1 产品简介

### 13.1.1 背景

用户在使用云平台部署并管理应用服务时，会有部分业务部署于 IDC 数据中心环境的内网或第三方公/私有云平台上，如 Web 服务部署于公有云平台，应用和数据库等应用部署于私有云，构建公有云和私有云混合部署环境。

在混合云的应用场景中，可以可通过专线的方式将两端网络的内网直接打通，且较好的保证网络可靠性和性能。但由于专线成本较高，仅适用于部分对网络时延要求较高的业务，为节省成本并与第三方平台建立点对点的网络通信，云平台提供 VPN 网关-IPsecVPN 连接的服务能力，允许平台侧 VPC 子网的资源直接与第三方平台内网的主机进行通信，同时也可为平台不同 VPC 网络间提供连接服务。

### 13.1.2 概述

IPsec VPN 是一种采用 IPsec 协议加密的隧道技术，由 Internet Engineering Task Force（[IETF](https://ietf.org/)）定义的安全标准框架，在互联网上为两个私有网络提供安全通道，通过加密保证连接的安全。有关 IPsec 可参考 [RFC2409](https://tools.ietf.org/html/rfc2409) （IKE—Internet Key Exchange 因特网密钥交换协议）和 [RFC4301](https://tools.ietf.org/html/rfc4301) （IPsec 架构）。

云平台 IPsecVPN 服务是基于 Internet 的网络连接服务，采用 IPsec（**I**nternet **P**rotocol **Sec**urity）安全加密通道实现企业数据中心、办公网络与平台 VPC 私有网络的安全可靠连接，同时也可使用 VPN 网关在 VPC 之间建立加密内网连接。网关服务为可容灾的高可用架构，同时支持用户选择多种加密及认证算法，并提供 VPN 连接健康检测及连接日志，保证隧道连接的可靠性、安全性及管理便捷性。

通过 IPsecVPN 服务，用户可将本地数据中心、企业分支机构与私有云平台的 VPC 私有网络通过加密通道进行连接，也可将用于不同 VPC 之间的加密连接。对端设备或系统仅需支持 IPsec 的 IKEv1 或 IKEv2 ，即可通过配置与平台的 VPN 网关进行互连，如通用网络设备或配置 IPsecVPN 的服务器。

### 13.1.3 逻辑架构

VPN 网关 IPsecVPN 服务由 VPN 网关、对端网关及 VPN 隧道连接三部分组成。

![ipsecvpnarch](../images/userguide/ipsecvpnarch.png)

- VPN 网关

  平台侧 VPC 网络建立 IPsecVPN 连接的出口网关，通过关联 VPC 和外网 IP 与对端网关的 IPsecVPN 进行连接，用于平台私有网络和外部网络（如 IDC、公有云、私有云）之间建立安全可靠的加密网络通信。

- 对端网关

  运行于外部网络端 IPsecVPN 网关的公网 IP 地址，即与私有云平台 VPN 网关进行隧道连接的网关 IP 地址，支持 NAT 转发的网关地址。

- VPN 隧道

  连接 VPN 网关和对端网关的加密隧道，结合相应的加密认证算法及策略，为平台 VPC 私有网络和外部私有网络建立加密通信的隧道连接。

一个 VPN 网关有且必须关联 1 个 VPC 网络和 1 个外网 IP 地址，与对端网关相对应，通过 VPN 隧道进行连接。IPsecVPN 支持点到多点的连接特性，使得 VPN 网关与对端网关可以为一对一或一对多的连接关系，即一个 VPN 网关可以同时与多个对端网关建立隧道。VPN 隧道支持平台多个 VPC 子网与对端网络的多个网段通过隧道进行加密通信，平台 VPC 子网的网段与对端网络的网络不可重叠（本端与对端子网重叠会影响网络的正常通信）。

![ipsecvpnsubnet](../images/userguide/ipsecvpnsubnet.png)

如上图案例所示，在云平台中的 VPC 网络已拥有 2 个子网，分别为 subnet1（`192.168.1.0/24`）和 subnet2（`192.168.2.0/24`）。在远端 IDC 数据中心下有 2 个内网网段，分别为 subnet3（`192.168.3.0/24`）和 subnet4（`192.168.4.0/24`）。

- 私有云平台 VPN 网关绑定 VPC 子网，并使用外网 IP 地址作为网络出口及远端数据中心的对端网关。
- 远端数据中心的平台的网关绑定数据中心子网，并使用另一个公网 IP 地址作为网络出口及私有云平台的的对端网关。
- 两端 VPN 网关分别建立 IPsecVPN 隧道，使用相同的预共享密钥及加密认证策略，经过第一阶段的 IKE 认证及第二阶段的 IPsec 认证，建立 VPN 连接通道。
- 两端网络的子网分别通过 VPN 隧道与对端网络的子网进行通信，打通跨数据中心、跨云平台的内网，构建混合云环境。

> IPsecVPN 通道在 Internet 网络中构建并运行，公网的带宽、网络阻塞、网络抖动会直接影响 VPN 网络通信的质量。

### 13.1.4 VPN 隧道建立

在建立 IPsecVPN 安全通道时，需要先在两个网关间建立 SA（Security Association 安全联盟）。SA 是 IPsec 的基础，是通信网关间对连接条件的约定，如网络认证协议（AH、ESP）、协议封装模式、加密算法（DES、3DES 和 AES）、认证算法、协商模式（主模式和野蛮模式）、共享密钥及密钥生存周期等。**SA 安全联盟的建立需要在两端网关上均约定并配置相同的条件，以确保 SA 可以对两端网关进行双向数据流通信保护。**

标准 IPsecVPN 建立 SA 的方式有手工配置和 IKE 自动协商两种，**私有云平台 VPN 网关服务使用 IKE 协议来建立 SA** 。IKE 协议建立在由 ISAKMP（Internet Security Association and Key Management Protocol，互联网安全联盟和密钥管理协议）定义的框架上，具有一套自保护机制，可在不安全的网络上安全地认证身份、交换及密钥分发，为 IPsec 提供自动协商交换密钥并建立 SA 服务。

- 身份认证：支持预共享密钥（pre-shared-key）认证，确认通信两端的身份，并在密钥产生之后对身份数据进行加密传送，实现对身份数据的安全保护。
- 交换及密钥分发：DH（Diffie-Hellman，交换及密钥分发）算法是一种公共密钥算法，通信两端在不传输密钥的情况下通过交换一些数据，计算出共享的密钥。

**IKE 通过两个阶段为 IPsec 进行密钥协商并建立 SA ：**

1. 第一阶段：通信两端彼此间建立一个已通过身份认证和安全保护的通道，即建立一个 IKE SA ，作用是为两端之间彼此验证身份，并协商出 IKE SA ，保护第二阶段中 IPsec SA 协商过程。支持 IKE V1 和 V2 版本，其中 V1 版本支持主模式（Main Mode）和野蛮模式（Aggressive Mode）两种 IKE 交换方法。

2. 第二阶段：用第一阶段建立的 IKE SA 为 IPsec 协商安全服务，即为 IPsec 协商具体的 SA ，建立用于最终的 IP 数据安全传输的 IPsec SA 。

IKE 为 IPsec 协商建立 SA，并将建立的参数及生成的密钥交给 IPsec ，IPsec 使用 IKE 协议建立的 SA 对最终 IP 报文加密或认证处理。通过 IKE 协议可为 IPsecVPN 提供端与端之间的动态认证及密钥分发，通过自动建立 IPsec 参数，降低手工配置参数的复杂度；同时由于 IKE 协议中每次 SA 的建立均需运行 DH 交换过程，可有效保证每个 SA 所使用密钥的互不相关，增加 VPN 通道的安全性。

**VPN 隧道成功建立连接后，将自动为所属 VPC 关联的本端子网下发到对端子网的路由，使本端子网访问远端私有网络的请求通过 VPN 网关及隧道进行转发，完成整个链路的打通。**

### 13.1.5 VPN 隧道参数

IPsecVPN 隧道 SA 协商建立需要配置相应的参数信息，包括隧道的基本信息、预共享密钥、IKE 策略及 IPsec 策略配置信息。两端的 VPN 在建立的过程中，需保证预共享密钥、IKE 策略及 IPsec 策略配置一致，IKE 策略指定 IPSec 隧道在协商阶段的加密和认证算法，IPSec 策略指定 IPSec 在数据传输阶段所使用的协议及加密认证算法。具体参数信息如下表所示：

**（1）基本信息**

* **名称/备注**：VPN 隧道连接的名称和备注。
* **VPN 网关**：VPN 隧道挂载的 VPN 网关，即隧道运行在云平台端的所属 VPN 网关。
* **对端网关**：VPN 隧道挂载的对端网关，即对端网关的互联网出口 IP 地址，如 IDC 数据中心的 VPN 网关。
* **本端网段**：VPN 网关所在 VPC 网络内需要和对端网络（如 IDC 数据中心）互通的子网，如 192.168.1.0/24 。本端网段用于第二阶段协商，不可与对端网段重叠。
* **对端网段**：IDC 数据中心或第三方云平台中需要与本端网段 VPN 通信的子网，如 192.168.2.0/24 。对端网段用于第二阶段协商，不可与本端网段重叠。

**（2）预共享密钥**

* **Pre Shared Key** ：IPsecVPN 连接的秘钥，用于 VPN 连接的协商，在 VPN 连接协商过程中，需保证本端与对端的密钥一致。

**（3）IKE 策略**

* **版本**：IKE 密钥交换协议的版本，支持 V1 和 V2 。V2 版对 SA 的协商过程进行简化且更加适应多网段场景，推荐选择 V2 版本。
* **认证算法**：为 IKE 协商过程中的报文提供认证，支持 md5、sha1 和 sha2-256 三种认证算法。
* **加密算法**：为 IKE 协商过程中的报文提供加密保护，支持 3des、aes128、aes192、aes256 四种加密算法。
* **协商模式**：IKE v1 的协商模式，支持主模式（main）和野蛮模式（aggressive）。
  * 主模式在 IKE 协商时需经过 SA 交换、密钥交换、身份验证三个双向交换阶段（6 个消息），而野蛮模式仅需要经过 SA 生成/密钥交换和身份验证两次交换阶段 （3 个消息）。
  * 由于野蛮模式密钥交换与身份认证一起进行无法提供身份保护，因此主模式的协商过程安全性更高，协商成功后信息传输安全性一致。
  * 主模式适用于两端设备的公网 IP 固定的场景，野蛮模式适用于需要 NAT 穿越及 IP 地址不固定的场景。

* **DH 组**：指定 IKE 交换密钥时使用的 Diffie-Hellman 算法，密钥交换的安全性及交换时间随 DH 组的扩大而增加，支持 1、2、5、14、24 。
  * 1：采用 768-bit 模指数（Modular Exponential，MODP ）算法的 DH 组。
  * 2：采用 1024-bit MODP 算法的 DH 组。
  * 5：采用 1536-bit MODP 算法的 DH 组。
  * 14：采用 2048-bit MODP 算法的 DH 组。
  * 24：带 256 位的素数阶子群的 2048-bit MODP算法 DH 组。
* **本端标识**：VPN 网关的标识，用于 IKE 第一阶段协商。支持 IP 地址和 FQDN（全称域名）。
* **对端标识**：对端网关的标识，用于 IKE 第一阶段协商。支持 IP 地址和 FQDN（全称域名）
* **生存周期**：第一阶段 SA 的生存时间，在超过生存周期后， SA 将被重新协商，如 86400 秒。

**（4）IPSec 策略**

* **安全传输协议：**IPSec 支持 AH 和 ESP 两种安全协议，AH 只支持数据的认证保护，ESP 支持认证和加密，推荐使用 ESP 协议。
* **IPSec 认证算法：**为第二阶段用户数据提供的认证保护功能，支持 md5 和 sha1 两种认证算法。
* **IPSec 加密算法：**为第二阶段用户数据提供的加密保护功能，支持 3des、aes128、aes192 和 aes256 四种加密算法 ，使用 AH 安全协议时不可用。
* **PFS DH 组：**PFS （Perfect Forward Secrecy，完善的前向安全性）特性是一种安全特性，指一个密钥被破解，并不影响其他密钥的安全性。PFS 特性为第二阶段协商的 Diffie-Hellman密钥交换算法，支持的 DH 组为支持 1、2、5、14、24 与关闭（Disable），Disable 适用于不支持 PFS 的客户端 。
* **生存周期：**第二阶段 SA 的生存时间，在超过生存周期后， SA 将被重新协商，如 86400 秒。

### 13.1.6 应用场景

VPN 网关 IPsecVPN 服务是基于 Internet 的网络连接服务，通过 IPsec 安全加密通道实现企业数据中心、办公网络与平台 VPC 私有网络的安全可靠连接，同时用户也可使用 VPN 网关在 VPC 之间建立加密内网连接。网关服务为可容灾的高可用架构，同时支持用户选择多种加密及认证算法，并提供 VPN 连接健康检测及连接日志，可满足不同的应用场景。

- VPC 到本地数据中心的连接：通过 IPsecVPN 服务将本地数据中心的内网主机和 VPC 网络的虚拟资源进行连接，构建混合云服务模式。
- VPC 到公有云 VPC 的连接：通过 IPsecVPN 服务将第三方公有云 VPC 私有网络和私有云 VPC 网络的虚拟资源进行连接，构建多云混合服务模式。
- VPC 到第三方私有云内网的连接：通过 IPsecVPN 服务将第三方私有云的 VPC 私有网络和 UCloudStack VPC 网络的虚拟资源进行连接，构建多云混合服务模式。
- VPC 到 VPC 的连接：通过 IPsecVPN 服务将 VPC 与的另一个 VPC 网络进行连接，实现 VPC 打通的场景。

## 13.2 使用流程

使用 VPN 网关 IPsec 服务前，需要明确场景并根据不同场景部署 VPN 及连接：

- 租户根据需要创建本端 VPC 网络及子网，并在子网中部署虚拟机。
- 租户根据需求指定 VPN 网关所在的 VPC 网络外网 IP 地址、安全组等参数创建高可用 VPN 网关。
- 租户根据对端网关的 IP 地址创建对端网关。
- 租户根据需求指定 VPN 隧道基本参数、预共享密钥、IKE 策略及 IPsec 策略部署 IPsev VPN 隧道。
- 用户使用一致的 VPN 隧道参数对远端网关设备的 VPN 进行配置。（远端网关设备指 IDC 数据中心的 VPN 路由设备、不同于本端 VPC 的 VPN 网关或第三方云平台的 VPN 网关等）
- 根据需求配置 VPC 私有网络中需要通信主机的路由，若可以自动下发路由，则无需配置路由。
- 测试网络连通性，如本端 VPC 子网中虚拟机 `ping` 远端私有网络中的 IP 地址，验证通信是否正常。

通常情况下，IKE 协议采用 UDP 的 500 和 4500 端口进行通信，IPsec 的 AH 和 ESP 协议分别使用 51 或 50 号协议来工作，因此为保障 IKE 和 IPsec 的正常运行，需要确保应用 IKE 和 IPsec 配置的网关设备或防火墙已开放以上端口和协议的流量。

> **IPSecVPN 服务是基于互联网的加密通信服务，在使用 IPSecVPN 前需确认两端网关均有固定或 NAT 后的互联网 IP 地址。**

## 13.3 VPN 网关

用户根据网络规划需求创建 VPN 网关，用于和对端网关建立 IPSecVPN 隧道连接，提供安全加密的 VPN 专属网络通道。

## 13.3.1 创建 VPN 网关

创建 VPN 网关时需指定机型、VPC 网络、子网、外网 IP、安全组及 VPN 网关名称和备注信息，可通过导航栏 "IPSecVPN" 进入【 VPN 网关】资源控制台，通过“创建 VPN 网关”进入创建向导页面，如下图所示：

![createvpngw](../images/userguide/createvpngw.png)

1. 选择并配置 VPN 网关基础配置及网络设置信息：

- 机型：VPN 网关实例所在宿主机的集群类型，由平台管理员自定义，如 x86 机型和 ARM 机型，通过 ARM 机型创建的实例为 ARM 版 IPsecVPN 网关实例，已适配国产芯片、服务器及操作系统。
- 名称/备注：VPN 网关的名称及备注信息。
- VPC 网络：VPN 网关所服务的 VPC 网络，即 VPN 网关仅为所选择的 VPC 内资源提供 IPSecVPN 通信服务，仅支持添加相同 VPC 网络的子网到关联隧道的本端网关。
- 子网：VPN 网关实例所在子网，通常建议选择可用 IP 数量充足的子网。
- 外网 IP ：VPN 网关所使用的外网 IP 地址，即对端网关建立 IPSecVPN 隧道的本端网关地址，仅支持绑定相同数据中心且有默认路由的外网 IP 地址。

2. 选择并配置以上信息后，可选择购买数量和付费方式，确认订单金额并点击“立即购买” 进行 VPN 网关创建：

- 购买数量：按照所选配置及参数批量创建 VPN 网关实例，一次仅支持创建 1 个 VPN 网关实例。
- 付费方式：选择 VPN 网关的计费方式，支持按时、按年、按月三种方式，可根据需求选择适合的付费方式。
- 合计费用：用户选择 VPN 网关资源按照付费方式的费用展示。

确认订单无误后点击立即购买，点击立即购买后，会返回 VPN 网关资源列表页，在列表页可查看 VPN 网关的创建过程，通常会先显示“创建中”的状态，创建成功后转换为“**运行**”。

> 允许在一个 VPC 下创建多个 VPN 网关，将 VPC 下子网分别与不同的对端网关建立隧道，实现同 VPC 下不同子网与对端不同子网建立隧道的通信场景。

### 13.3.2 查看 VPN网关

通过导航栏进入 VPN 网关资源控制台，可查看 VPN 网关资源列表，并可通过列表上名称和 ID 进入详情页面查看 VPN 网关的概览及监控信息。

### 13.3.2.1 VPN 网关列表

VPN 网关列表可查看当前账户下所有 VPN 网关的资源信息，包括名称、资源 ID、VPC、子网、外网 IP、隧道数量、创建时间、过期时间、计费方式、状态及操作项，如下图所示：

![vpngwlist](../images/userguide/vpngwlist.png)

* 名称/ID：VPN 网关的名称及全局唯一标识符。
* VPC 网络：VPN 网关所服务的 VPC 网络，即 VPN 网关仅为所选择的 VPC 内资源提供 IPSecVPN 通信服务，仅支持添加相同 VPC 网络的子网到关联隧道的本端网关。
* 子网：VPN 网关实例所在子网。
* 外网 IP：VPN 网关所使用的外网 IP 地址，即对端网关建立 IPSecVPN 隧道的本端网关地址。以远端数据中心或云平台与当前网关建立隧道时必须指定该 IP 地址或 SNAT 后的地址作为对端网关 IP 地址。
* 隧道数量：当前 VPN 网关上已创建的隧道数量。
* 状态：VPN 网关的运行状态，包括创建中、运行、删除中等。

列表上操作项是指对单个 VPN 网关实例的删除操作，可通过搜索框对负载均衡资源列表进行搜索和筛选，支持模糊搜索。

为方便租户对资源的统计及维护，平台支持下载当前用户所拥有的所有 VPN 网关资源列表信息为 Excel 表格；同时支持对 VPN 网关进行批量删除操作。

### 13.3.2.2 VPN 网关详情

在 VPN 网关资源列表上，点击“**名称**” 可进入概览页面查看当前 VPN 网关实例的详细信息，如概览页所示：

![vpngwinfos](../images/userguide/vpngwinfos.png)

**（1）基本信息**

VPN 网关的基本信息，包括名称、ID、VPC 网络、子网、外网 IP、隧道数量、计费方式、状态、创建时间、过期时间及告警模板信息，可点击告警模板右侧按钮修改 VPN 网关所关联的告警模板。

**（2）监控信息**

VPN 网关实例相关的监控图表及信息，包括网卡入/出带宽、网卡入/出包量及 VPN 网关的出带宽使用率，支持查看 1 小时、6 小时、12 小时、1 天及自定义时间的监控数据。

### 13.3.3 修改名称和备注

修改 VPN 网关资源的名称和备注，在任何状态下均可进行操作。可通过点击 VPN 网关资源列表页面每个 VPN 网关名称右侧的“编辑”按钮进行修改。

### 13.3.4 修改告警模板

修改告警模板是对 VPN 网关的监控数据进行告警的配置，通过告警模板定义的指标及阈值，可在 VPN 网关相关指标故障及超过指标阈值时，触发告警，通知相关人员进行故障处理，保证 VPN 网关及业务的网络通信。

用户可通过 VPN 网关网关详情概览页的操作项进行告警模板修改操作，在修改告警模板向导中选择新 VPN 网关告警模板进行修改。

### 13.3.5 删除 VPN 网关

用户可通过控制台或 API 的方式删除不需要的 VPN 网关实例，删除时会自动解绑已绑定的外网 IP 地址。仅支持删除未关联任何 VPN 隧道的网关，删除前需将 VPN 网关已关联的隧道连接进行删除。

![rmvpngw](../images/userguide/rmvpngw.png)

VPN 网关被删除后即直接销毁，请在删除前确保 VPN 网关无业务流量访问请求，否则可能影响业务访问。

### 13.3.6 VPN 网关续费

支持用户手动对 VPN 网关进行续费，续费操作只针对资源本身，不对资源额外关联的资源进行续费，如绑定的外网 IP 资源。额外关联的资源到期后，会自动从 VPN 网关进行解绑，为保证业务正常使用，需及时对相关资源进行续费操作。

VPN 网关续费时会按照续费时长收取费用，续费时长与资源的计费方式相匹配，当 VPN 网关的计费方式为【小时】，则续费时长可选择 1 至 24 小时；当 VPN 网关的计费方式为【按月】，则续费时长可选择 1 至 11 月；当 VPN网关的计费方式为【按年】，则续费时长为 1 至 5 年。

## 13.4 对端网关

运行于外部网络端 IPsecVPN 网关的公网 IP 地址，即与私有云平台 VPN 网关进行隧道连接的网关。对端网关可以认为是与当前平台建立 VPN 连接的第三方私有云平台、IDC 数据中心及公有云平台的 VPN 网关 IP 地址。

### 13.4.1 创建对端网关

创建对端网关需指定对端网关的公网 IP 地址。由于 **IPSecVPN 服务是基于互联网的加密通信服务，在使用前需确认两端网关均有固定或 NAT 后的互联网 IP 地址。**用户在输入正确定的 IP 地址后即可创建对端网关，用于创建隧道连接。

![createremotegw](../images/userguide/createremotegw.png)

若远端网络 VPN 网关使用的是内网地址，需提供内网地址被 SNAT 后的固定公网 IP 地址。**若远端网络 SNAT 后的地址为非固定公网 IP 地址，如 IP 地址池，则将对端网关录入为 `0.0.0.0` ，即代表和任意的对端网关 IP 地址建立隧道连接，在认证算法、密钥、本端子网和对端子网都一致的情况下，连接即可建立，使两端网络透传 NAT 进行 IPSecVPN 通信。**

### 13.4.2 查看对端网关

在 VPN 网关资源控制台可切换至对端网关查看当前账户下所有对端网关的资源信息，包括名称、ID、公网 IP 地址、隧道数量、创建时间及操作项，如下图所示：

![remotegwlist](../images/userguide/remotegwlist.png)

* 公网 IP 地址：指对端网关的公网 IP 地址，指定对端网关创建的隧道将以该 IP 地址为对端 IP 地址发起 VPN 连接请求，需确保该 IP 地址为正确定的远端 VPN 网关 IP 地址。
* 隧道数量：当前对端网关上已创建的隧道数量。

列表上操作项是指对单个对端网关实例的删除操作，可通过搜索框对对端网关资源列表进行搜索和筛选，支持模糊搜索。

为方便租户对资源的统计及维护，平台支持下载当前用户所拥有的所有对端网关资源列表信息为 Excel 表格；同时支持对对端网关进行批量删除操作。

### 13.4.3 修改名称和备注

修改对端网关资源的名称和备注，在任何状态下均可进行操作。可通过点击对端网关资源列表页面每个对端网关名称右侧的“编辑”按钮进行修改。

### 13.4.4 删除对端网关

用户可通过控制台或 API 的方式删除不需要的对端网关实例，仅支持删除未关联任何 VPN 隧道的对端网关，删除前需将对端网关已关联的隧道连接进行删除。

![rmremotegw](../images/userguide/rmremotegw.png)

对端网关被删除后即直接销毁，请在删除前确保对端网关无业务流量访问请求，否则可能影响业务访问。

## 13.5 VPN 隧道

连接 VPN 网关和对端网关的加密隧道，结合相应的加密认证算法及策略，为平台 VPC 私有网络和外部私有网络建立加密通信的隧道连接，**单个 VPN 网关或对端网关最多可创建 20 条 VPN 隧道**。在使用 VPN 隧道与远端网关进行连接时，需要具备一些前提条件：

* 远端数据中心或云平台的网关设备需支持 IKEv1 和 IKEv2 版本的协议，如华为、华三、山石、深信服、Cisco ASA、Juniper 等品牌的路由器或防火墙设置，也可以为使用 Linux 系统搭建的 IPSecVPN 服务器。
* 远端数据中心、云平台的网关或 IPSecVPN 服务器必须配置有固定或经过 SNAT 转换的公网 IP 地址。
* 远端数据中心和本端云平台必须在网络上放通 UDP 500、UDP 4500、UDP 50 及 UDP 51 端口，保障 IKE 和 IPSec 的正常通信。
* 云平台需要和远端数据中心打通 VPN 的网段不可重复且不可重叠。

### 13.5.1 VPN 隧道配置流程

1. 在本端云平台创建 VPN 网关和对端网关；
2. 在本端云平台使用已创建的 VPN 网关和对端网关创建 VPN 隧道；
3. 配置远端数据中心、第三方云平台或公有云平台上的 VPN 网关及相关隧道配置；
4. 等待两端网关进行 SA 协商并建立 VPN 连接；
5. 在本端云平台上创建一台与 VPN 网关相同 VPC 且被指定本端网段的虚拟机，通过虚拟机 Ping 远端网络内网的一台主机，验证网络的连通性。

### 13.5.2 创建 VPN 隧道

用户创建 VPN 隧道用于连接 VPN 网关和对端网关，并支持配置 IKE 及 IPsec 策略。创建时需指定 VPN 隧道的基本配置、预共享密钥、IKE 策略及 IPSec 策略，通常用户仅需指定基本配置及预共享密钥，即可快速创建。

可通过 IPSecVPN 资源控制台进入 【VPN 隧道】标签页，进行 VPN 隧道的创建操作，创建隧道向导页面的基本配如下图所示：

![createtunnel1](../images/userguide/createtunnel1.png)

1. 选择亲配置 VPN 隧道的基本配置及预共享密钥信息：

* **名称/备注**：VPN 隧道连接的名称和备注。
* **VPN 网关**：VPN 隧道挂载的 VPN 网关，即隧道运行在云平台端的所属 VPN 网关，也可称为本地网关。
* **对端网关**：VPN 隧道挂载的对端网关，即对端网关的互联网出口 IP 地址，如 IDC 数据中心的 VPN 网关。
* **本端网段**：VPN 网关所在 VPC 网络内需要和对端网络（如 IDC 数据中心）互通的子网，如 192.168.1.0/24 。本端网段用于第二阶段协商，不可与对端网段重叠，仅可选择 VPN 网关归属 VPC 包含的子网网段。
* **对端网段**：IDC 数据中心或第三方云平台中需要与本端网段 VPN 通信的子网，如 192.168.2.0/24 。对端网段用于第二阶段协商，不可与本端网段重叠，支持配置多个网段，每个网段间用回车进行分隔，最多支持 20 个对端网段。
* **预共享密钥**：IPsecVPN 连接的秘钥，用于 VPN 连接的协商，在 VPN 连接协商过程中，**需保证本端与对端的密钥一致**。由a-z, A-Z, 数字，特殊字符组成，但是不能包含'?'和空格，长度为128 个字符。

> 注意：在对端建立隧道配置时，由于从对端网关设备的角度出发，在配置网段时需将本端网段和对端网段调换进行配置。

2. 根据需求配置用于 VPN 隧道连接协商一阶段的 IKE 策略及二阶段的 IPSec 策略。**在建立连接时，需保证两端的 IKE 策略必须保持一致（本端和对端标识在对端配置相反）**。通常选择默认值即可创建隧道，只需要在对端建立隧道配置时，使用相同的配置参数即可将两条隧道通过两端网关进行连接。

![createtunnel2](../images/userguide/createtunnel2.png)

**IKE 策略：**

* **版本**：IKE 密钥交换协议的版本，支持 V1 和 V2 。V2 版对 SA 的协商过程进行简化且更加适应多网段场景，推荐选择 V2 版本。若对端 VPN 设备仅支持 V1 ，则必须选择 V1 版本进行创建。
* **认证算法**：为 IKE 协商过程中的报文提供认证，支持 md5、sha1 和 sha2-256 三种认证算法，默认为 sha1。
* **加密算法**：为 IKE 协商过程中的报文提供加密保护，支持 3des、aes128、aes192、aes256 四种加密算法，默认算法为 aes128 。
* **协商模式**：IKE v1 的协商模式，支持主模式（main）和野蛮模式（aggressive）。
  * 主模式在 IKE 协商时需经过 SA 交换、密钥交换、身份验证三个双向交换阶段（6 个消息），而野蛮模式仅需要经过 SA 生成/密钥交换和身份验证两次交换阶段 （3 个消息）。
  * 由于野蛮模式密钥交换与身份认证一起进行无法提供身份保护，因此主模式的协商过程安全性更高，协商成功后信息传输安全性一致。
  * 主模式适用于两端设备的公网 IP 固定的场景，野蛮模式适用于需要 NAT 穿越及 IP 地址不固定的场景。
* **DH 组**：指定 IKE 交换密钥时使用的 Diffie-Hellman 算法，密钥交换的安全性及交换时间随 DH 组的扩大而增加，支持 1、2、5、14、24 ，默认值为 2 ，值越大所占用的计算性能越高。
  * 1：采用 768-bit 模指数（Modular Exponential，MODP ）算法的 DH 组。
  * 2：采用 1024-bit MODP 算法的 DH 组。
  * 5：采用 1536-bit MODP 算法的 DH 组。
  * 14：采用 2048-bit MODP 算法的 DH 组。
  * 24：带 256 位的素数阶子群的 2048-bit MODP算法 DH 组。
* **本端标识**：VPN 网关的标识，用于 IKE 第一阶段协商，支持 IP 地址和 FQDN（全称域名），默认为 VPN 网关的外网 IP 地址。
* **对端标识**：对端网关的标识，用于 IKE 第一阶段协商。支持 IP 地址和 FQDN（全称域名），默认为对端网关的 IP 地址。若对端为 NAT 透传模式（对端网关的 IP 地址为 0.0.0.0） ，需要将标识 IP 修订为真正的对端网关 IP 地址，即在对端 VPN 网关设备中配置的本端网关 IP 地址。
* **生存周期**：第一阶段 SA 的生存时间，在超过生存周期后， SA 将被重新协商，取值范围为 3600~86400 ，默认值为 86400 秒。

> 注意：在对端建立隧道配置时，由于从对端网关设备的角度出发，在配置标识时需将本端标识和对端标识调换进行配置。

**IPSec 策略**

* **安全传输协议：**IPSec 支持 AH 和 ESP 两种安全协议，AH 只支持数据的认证保护，ESP 支持认证和加密，推荐使用 ESP 协议。
* **IPSec 认证算法：**为第二阶段用户数据提供的认证保护功能，支持 md5 和 sha1 两种算法，默认为 sha1。
* **IPSec 加密算法：**为第二阶段用户数据提供的加密保护功能，支持 3des、aes128、aes192 和 aes256 四种加密算法 ，默认为 aes128 ，使用 AH 安全协议时不可用。
* **PFS DH 组：**PFS （Perfect Forward Secrecy，完善的前向安全性）特性是一种安全特性，指一个密钥被破解，并不影响其他密钥的安全性。PFS 特性为第二阶段协商的 Diffie-Hellman密钥交换算法，支持的 DH 组为支持 1、2、5、14、24 与关闭（Disable），默认值为 2  ，Disable 适用于不支持 PFS 的客户端 。
* **生存周期：**第二阶段 SA 的生存时间，在超过生存周期后， SA 将被重新协商，取值范围为 3600~86400 ，默认值为 86400 秒。

3. 选择并配置以上信息后，点击“立即创建” 进行 IPSecVPN 隧道的创建，可返回至隧道列表页面查看隧道的创建过程及 VPN 连接过程。

创建过程中，VPN 隧道的资源状态为“创建中”，待隧道创建成功后，资源状态流转为“运行” 。创建成功后平台会根据隧道所配置的参数与对端网关进行 VPN 连接，即进行 IPSecVPN 两个 SA 的阶段协商，VPN 隧道的连接状态为“连接中”  ，待连接状态流转为“已连接” 后，证明 VPN 隧道已连接成功。若 VPN 隧道连接失败，则会进行重试，3 次重试依然失败，则显示阶段 1 失败或阶段 2 失败，系统会在连接失败后，每隔 12 秒重新进行连接尝试。

**VPN 隧道的连接状态处在已连接时，平台会根据隧道配置的对端网段，在关联的本端 VPC 子网中包含虚拟机里自动下发到对端网段的网络路由，保证网络连通性。**

### 13.5.2 查看 VPN 隧道

VPN 隧道创建成功后，用户可通过导航栏进入【VPN 网关】控制台，切换至 VPN 隧道标签页可查看隧道的资源列表，并可通过列表上名称和 ID 进入详情页面查看 VPN 隧道的详细配置信息及监控信息。

#### 13.5.2.1 VPN 隧道列表

VPN 隧道列表可查看当前账户下所有隧道的资源列表信息，包括名称、资源 ID、VPN 网关、对端网关、创建时间、资源状态、连接状态及操作项，如下图所示：

![tunnellist](../images/userguide/tunnellist.png)

* 名称/ID：VPN 隧道的名称及全局唯一标识符。
* VPN 网关：VPN 隧道所关联的 VPN 网关名称及 IP 地址。
* 对端网关：VPN 隧道所关联的对端网关名称及 IP 地址。
* 创建时间：VPN 隧道的创建时间。
* 资源状态：VPN 隧道的资源运行状态，包括创建中、运行、删除中等。
* 连接状态：VPN 隧道的连接状态，包括连接中、已连接、阶段 1 失败及阶段 2 失败。
  * 阶段 1 失败代表 VPN 隧道在协商第一阶段 IKE SA 时失败，需要检查两端隧道的 VPN 网关 IP、对端网关 IP、对端网段、本端网段、预共享密钥及 IKE 配置参数是否一致；
  * 阶段 2 失败通常代表第 1 阶段的 IKE SA 已协商成功，但第 1 阶段的 IPSec SA 协商失败，需要检查两端隧道的第二阶段的 IPSec 配置参数是否一致。

列表上操作项是指对单个隧道的操作，包括下载隧道配置及删除操作，可通过搜索框对隧道资源列表进行搜索和筛选，支持模糊搜索。

为方便租户对资源的统计及维护，平台支持下载当前用户所拥有的所有隧道资源列表信息为 Excel 表格；同时支持对隧道进行批量删除操作。

#### 13.5.2.2 VPN 隧道详情

在 VPN 隧道资源列表上，点击“**名称**” 或 ID 可进入概览页面查看当前 VPN 隧道的详细配置信息和监控信息：

![tunnelinfos](../images/userguide/tunnelinfos.png)

**（1）基本信息**

VPN 隧道基本信息，包括资源 ID、名称、VPN 网关、对端网关、资源状态、连接状态、创建时间及告警模板信息，可点击告警模板右侧按钮修改负载均衡所关联的告警模板。

**（2）网段信息**

VPN 隧道已配置的网段匹配信息，包括本端网段和对端网段，仅展示网段间可通过 VPN 隧道建立的连接进行通信。可通过编辑按钮对本端和对端网段进行修改，详见[修改隧道网段策略](#_1354-修改隧道网段策略) 。

**（3）IKE 配置信息**

VPN 隧道的 IKE 配置信息，包括预共享密钥、IKE 版本、协商模式、IKE 认证算法、IKE 加密算法、DH 组、本端标识、对端标识及生存周期等信息。可通过编辑按钮对 IKE 配置信息进行修改，详见[修改 IKE 策略](#_1355-修改-IKE-策略配置) 。

**（4）IPSec 配置信息**

VPN 隧道的 IPSec 配置信息，包括安全传输协议、IPSec 认证算法、IPSec 加密算法、PFS DH 组及生存周期等信息。可通过编辑按钮对 IKE 配置信息进行修改，详见[修改 IPSec 策略](#_1356-修改-IPsec-策略配置) 。

**（5）监控信息**

负载均衡实例相关的监控图表及信息，包括隧道出/入带宽、隧道出/入包量及隧道健康状态，支持查看 1 小时、6 小时、12 小时、1 天及自定义时间的监控数据。

用户也可直接通过隧道健康状态的监控图表查看隧道的连接状态，若图表数据全为 1 代表已连接，为 0 代表连接中或连接失败国。

### 13.5.3 下载 VPN 隧道配置

支持用户下载隧道的配置信息至本地，可参照下载的配置文件进行远端数据中心或云平台的 VPN 隧道配置。下载的配置文件为 `conf` 格式，包括整个 VPN 隧道 VPN 网关、对端网关、本端网段、对端网关、预共享密钥及 IKE 和 IPsec 的策略相关配置信息。

可通过隧道列表上的【下载隧道配置】按钮进行配置文件的下载，点击后会直在本地下载一个 `.conf` 的文件，在文件中会列举当前隧道的相关配置：

```
conn ipsvpn_tunnel-MQcK-cVMR
    keyingtries=3
    authby=psk
    auto=start
    type=tunnel
    pfs=no

    keyexchange=ikev2

    # IPSecProtocol

    esp=aes128-sha1-modp1024!

    ike=aes128-sha1-modp1024!
    ikelifetime=86400s
    lifetime=86400s
    left=192.168.93.46
    leftid=192.168.93.46
    leftsubnet=172.16.1.0/24
    leftnexthop=%defaultroute
    right=106.75.234.78
    rightid=106.75.234.78
    rightsubnet=10.0.192.0/20
    rightnexthop=%defaultroute
    dpdaction=hold
    dpddelay=8s
    dpdtimeout=13s
```

* keyexchange 代表当前隧道使用的 IKE 版本为 V2 。
* IKE 及 esp 分别代表 IKE 策略和 IPSec 策略的认证及加密算法。
* left 和 right 分别代表 VPN 网关和对端网关的外网 IP 地址，示例配置文件中 VPN 网关使用的是内网地址，通过 SNAT 与对端网关 106.75.234.78 进行通信。
* leftid 和 rightid 代表 IKE 配置项中的本端标识和对端标识。
* leftsubnet 和 rightsubnet 分别代表本端网段和对端网段。

如果用户需要根据此配置文件进行远端数据中心或云平台的 VPN 配置，从对端网关设备的角度出发，本端网关和本端网段指自己的网关设备和网段，对端网关和对端网段指私有平台的 VPN 网关及 VPC 子网，故在配置对端网关时需要分别将将 VPN 网关&对端网关、本端网段&对端网关、本端标识&对端标识进行对调。

### 13.5.4 修改隧道网段策略

用户可根据业务需求对隧道的网段策略进行修改，如增加本端网段或减少对端网段。通过隧道详情概览页面的网段信息可进行网段策略的修改，如下图所示：

![updatetunnelsubnet](../images/userguide/updatetunnelsubnet.png)

支持自定义修改本端网段和对端网段，本端网段和对端网段不允许重复且不允许重叠。

* 本端网段仅允许选择 VPN 网关所属 VPC 内包含的子网网段。
* 支持输入多个对端网段，每行一个网段，必须符合网段的输入规范。
* 同一个隧道内最多支持 20 个对端网段。

确认修改后，平台会自动对隧道进行重新连接，即隧道的连接状态为连接中，待状态流转至已连接，代表配置修改成功，此时平台会自动下发对端网段为目标的路由至关联子网的虚拟机中，使虚拟机可以和对端网段进行通信。

> 在同一个 VPC 下，本端网段和对端网段的对应规则仅允许存在一条，即两个相同 VPC 的 VPN 网段关联的隧道不可有相同的网段策略，否则可能会影响路由下发导致网络中断。

### 13.5.5 修改 IKE 策略配置

当网络配置发生变更或隧道连接状态为阶段 1 失败时，可通过校验并修改 IKE 策略配置，重新进行连接。通过隧道详情概览页面的 IKE 可进行 IKE 策略的修改，如下图所示：

![updatetunnelike](../images/userguide/updatetunnelike.png)

支持修改预共享密钥 及 IKE 策略的所有配置参数，两端隧道的预共享密钥 、IKE 版本、协商模式（IKEv1）、认证算法、加密算法、DH 组、本端标识、对端标识必须保持一致，生存周期可以不一致。

在本端标识处通常建议使用本端网关和对端网关的 IP 地址，若对端网关使用的是 `0.0.0.0` 时，通常建议配置对端网关的内网 IP 地址，只要两端配置的标识是一致的就可以正常连接。

确认修改后，平台会自动对隧道进行重新连接，即隧道的连接状态为连接中，待状态流转至已连接，代表 IKE 策略修改成功。

### 13.5.6 修改 IPSec 策略配置

当网络配置发生变更或隧道连接状态为阶段 2 失败时，可通过校验并修改 IPSec 策略配置，重新进行连接。通过隧道详情概览页面的 IPSec 可进行 IPSec 策略的修改，如下图所示：

![updatetunnelipsec](../images/userguide/updatetunnelipsec.png)

支持修改 IPSec 策略的所有配置参数，两端隧道的安全传输协议、认证算法、加密算法及 PFS DH 组必须保持一致，生存周期可以不一致。

确认修改后，平台会自动对隧道进行重新连接，即隧道的连接状态为连接中，待状态流转至已连接，代表 IPSec 策略修改成功。

### 13.5.7 修改名称和备注

修改 VPN 隧道资源的名称和备注，在任何状态下均可进行操作。可通过点击 VPN 隧道资源列表页面每个 VPN 隧道名称右侧的“编辑”按钮进行修改。

### 13.5.8 修改告警模板

修改告警模板是对 VPN 隧道的监控数据进行告警的配置，通过告警模板定义的指标及阈值，可在 VPN 隧道相关指标故障及超过指标阈值时，触发告警，通知相关人员进行故障处理，保证 VPN 网关及业务的网络通信。

用户可通过 VPN 隧道详情概览页的操作项进行告警模板修改操作，在修改告警模板向导中选择新 VPN 隧道告警模板进行修改。

### 13.5.9 删除 VPN 隧道

用户可通过控制台或 API 的方式删除不需要的 VPN 隧道，删除后 VPN  隧道会自动中断，同时会清除已配置在本端子网虚拟机中的路由。

![rmtunnel](../images/userguide/rmtunnel.png)

VPN 隧道被删除后即直接销毁，请在删除前确保 VPN 隧道无业务流量访问请求，否则可能影响业务访问。

## 13.6 VPN 管理员指南

在私有云平台端 VPN 网关和隧道创建成功后，还需要管理员配置远端 VPN 设备或网络平台，实现远端数据中心或云平台的内网与本端私有云平台的 VPC 子网互联互通。

远端 VPN 设备或网络平台即本端 UCloudStack 私有云平台标记的对端网关，可以是物理硬件或和软件系统，如路由器、防火墙、VPN 设备或使用 `OpenSwan`和`StrongSwan`搭建在 Linux 系统上的 VPN 服务器系统；同样也可以是其它云平台的 VPN 服务，如 UCloud 公有云 VPN 网关服务或阿里云的 IPSecVPN 连接等。

为演示方便，本文主要通过以下几种示例环境与 UCloudStack IPsecVPN 网关建立连接：

* UCloud 公有云 IPSecVPN 
* Cisco 防火墙配置
* StrongSwan 配置
* VPC 到 VPC 的 VPN 连接

### 13.6.1 UCloud 公有云 IPSecVPN

通过在 UCloud 公有云和 UCloudStack 之间建立  IPSecVPN 连接，实现私有云和公有云混合构建及数据传输。

UCloud 公有云  IPSecVPN 目前仅支持 IKEv1 ，本文描述在私有云和 UCloud 公有云间建立基于 IKEv1 版本的 IPSecVPN 连接。

#### 13.6.1.1 前提条件

在建立 IPSecVPN 连接进行通信前，需确认两端要建立 IPSecVPN 连接的网络拓扑关系及配置参数信息。

| 网络配置和配置参数   | UCloudStack 私有云              | UCloud 公有云                   |
| -------------------- | ------------------------------- | ------------------------------- |
| VPN 网关公网 IP 地址 | 106.75.234.78                   | 113.31.115.114                  |
| VPC 网段             | 10.0.192.0/20                   | 10.23.0.0/16、10.25.0.0/16      |
| 客户虚拟机 IP        | 10.0.192.32                     | 10.23.228.173                   |
| 预共享密钥           | ucloud.1231                     | ucloud.1231                     |
| IKE 版本             | V1——协商模式为主模式            | V1——协商模式为主模式            |
| IKE 策略             | 认证 SHA1、加密 AES128、DH 组 2 | 认证 SHA1、加密 AES128、DH 组 2 |
| IPSec 安全传输协议   | ESP                             | ESP                             |
| IPSec 策略           | 认证 SHA1、加密 AES128、PFSDH 2 | 认证 SHA1、加密 AES128、PFSDH 2 |

> 本文假设已在 UCloudStack 私有云上部署 VPN 网关和对端网关，并已通过以上配置参数创建 VPN 隧道，等待 UCloud 公有云配置好 VPN 隧道后，即可进行 VPN 连接。

#### 13.6.1.2 配置公有云网关

UCloud 公有云 IPSecVPN 服务与 UCloudStack VPN 服务的配置过程相同，均需创建 VPN 网关、客户网关，并建立配置 VPN 隧道进行 VPN 连接。

确保配置前已创建 VPC 网络的子网为 10.23.0.0/16 和 10.25.0.0/16 ，并已在 VPC 内创建云主机 10.23.228.173。

1. 使用 113.31.115.114 外网 IP 地址创建 VPN 网关，如下图所示：

   ![ucloudvpngw](../images/userguide/ucloudvpngw.png)

2. 使用 UCloudStack 侧 VPN 网关的公网 IP 地址创建客户网关，本示例假设 UCloudStack 环境 VPN 网关的出口 IP 为固定公网 IP 地址，如下图所示：

   ![ucloudremotegw](../images/userguide/ucloudremotegw.png)

   > 注意：如果 UCloudStack 侧 VPN 网关使用的公网 IP 地址为 SNAT 后的地址池，即 VPN 网关的出口非固定公网 IP ，则需要将对端网关创建为 0.0.0.0 ，使 UCloud 公有云可以通过任意地址连接 UCloudStack 侧的 VPN 网关并建立 VPN 连接。

3. 使用已创建的 VPN 网关和客户网关，采用前提条件中的 IKE 和 IPSec 策略创建 VPN 隧道，如下图所示：

   ![ucloudtunnelinfo](../images/userguide/ucloudtunnelinfo.png)

   * 本端网段和对端网段与 UCloudStack 平台侧隧道正好相反，UCloudStack 平台侧隧道配置的本端网段为`10.0.192.0/20` ，对端网段为`10.23.0.0/16 ` 和 `10.25.0.0/16`  。
   * 本端 ID 和对端 ID 即对应 UCloudStack 平台侧的本端标识和对端标识，如图所示与 UCloudStack 侧的配置正好相反，UCloudStack 侧配置的本端标识为 `106.75.234.78` ，对端标识为 `113.31.115.114` 。
   * IKE 策略的版本、加密算法、认证算法、预共享密钥 、DH 组 均与 UCloudStack 侧保持一致。
   * IPSec 策略安全协议、加密算法、认证算法、PFS DH 组与 UCloudStack 侧保持 一致。

4. 分别查看 UCloudStack 侧和 UCloud 公有云侧的 VPN 隧道连接状态，等待隧道自动连接。UCloudStack 侧可通过列表上连接状态直接查看隧道是否已连接，UCloud 公有云侧需进入隧道详情页面查看"VPN 隧道状态"的监控，如下图所示：

   ![ucloudtunnelmonitor](../images/userguide/ucloudtunnelmonitor.png)

5. 在 UCloud 公有云的隧道监控中查看 VPN 隧道状态已变为 1 ，代表 VPN 已连接，同时在 UCloudStack 中隧道的连接状态流转为“已连接” ，如下图所示：

   ![tunnelstatus1](../images/userguide/tunnelstatus1.png)

#### 13.6.1.3 配置验证

在已连接状态时，UCloudStack 侧会自动下发对端网段为目标地址的路由至本端网段内的虚拟机中，可登入提前准备的本端虚拟机查看相关网络及路由配置信息。

如下图所示，本端虚拟机的 IP 地址为 `10.0.192.32` ，下发的路由为 `10.23.0.0/16`  及 `10.25.0.0/16` ，即代表虚拟机可与 UCloud 公有云侧的两个网段进行通信。

![vpnvmroute](../images/userguide/vpnvmroute.png)

可通过 ping 命令检测与 UCloud 公有云虚拟机的网络连通性，如下图代表两端内网的虚拟机网络互通。

![vpnucloudping](../images/userguide/vpnucloudping.png)

根据以上的配置过程，即可通过 IPSecVPN 的方式将 UCloudStack 和与 UCloud 公有云内网打通。

### 13.6.2 Cisco 防火墙配置

通过在 IDC 数据中心的 Cisco 防火墙与 UCloudStack 之间建立  IPSecVPN 连接，实现私有云和 IDC 数据中心网络互通和数据交互。

Cisco 防火墙支持 IKEv1 和 IKEv2 ，本文仅介绍私有云平台和 Cisco 防火墙建立基于 IKEv2 的 IPSecVPN 连接。

#### 13.6.2.1 前提条件

在建立 IPSecVPN 连接进行通信前，需确认两端要建立 IPSecVPN 连接的网络拓扑关系及配置参数信息。

| 网络配置和配置参数   | UCloudStack 私有云              | Cisco 防火墙                    |
| -------------------- | ------------------------------- | ------------------------------- |
| VPN 网关公网 IP 地址 | 106.75.234.78                   | 1.1.1.1                         |
| VPC 网段/本地网段    | 10.0.192.0/24                   | 192.168.1.0/24                  |
| 客户虚拟机 IP        | 10.0.192.32                     | 192.168.1.2                     |
| 预共享密钥           | ucloud.1231                     | ucloud.1231                     |
| IKE 版本             | V2                              | V2                              |
| IKE 策略             | 认证 SHA1、加密 AES128、DH 组 2 | 认证 SHA1、加密 AES128、DH 组 2 |
| IPSec 安全传输协议   | ESP                             | ESP                             |
| IPSec 策略           | 认证 SHA1、加密 AES128、PFSDH 2 | 认证 SHA1、加密 AES128、PFSDH 2 |

> 本文假设已在 UCloudStack 私有云上部署 VPN 网关和对端网关，并已通过以上配置参数创建 VPN 隧道，等待数据中心的 Cisco 防火墙配置好 VPN 隧道后，即可进行 VPN 连接。

#### 13.6.2.2 配置防火墙

1. 配置 IKE 第一阶段算法。

   ```
   crypto ikev2 proposal test 
   encryption aes-cbc-128
   integrity sha1
   group 2
   ```

2. 配置 IKEv2 策略并应用至 proposal 。

   ```
   crypto ikev2 policy ipsecpro64_v2
   proposal test
   ```

3. 配置预共享密钥。

   ```
   crypto ikev2 keyring ipsecpro64_v2 
   peer vpngw 
   address 106.75.234.78
   pre-shared-key 0 ucloud.1231
   ```

4. 配置身份认证。

   ```
   crypto ikev2 profile ipsecpro64_v2
   match identity remote address 106.75.234.78 255.255.255.255
   identity local address 192.168.1.1 
   authentication remote pre-share     
   authentication local pre-share 
   keyring local ipsecpro64_v2
   ```

5. 配置 IPSec 安全协议。

   ```
   crypto ipsec transform-set ipsecpro64_v2 esp-aes esp-sha-hmac
   mode tunnel
   ```

6. 配置 ACL ，定义需要 VPN 保护并透传的数据流，即本端网段和对端网段。若有多个网段，则需要分别对多个网段添加 ACL 策略，以确保 VPN 可透传网段流量。

   ```
   access-list 200 permit ip 192.168.1.0 0.0.0.255 10.0.192.0/24 0.0.0.255
   ```

7. 配置 IPSec 策略并应用 IPSec 策略

   ```
   crypto map ipsecpro64_v2 10 ipsec-isakmp
   set peer 106.75.234.78
   set transform-set ipsecpro64_v2 
   set ikev2-profile ipsecpro64_v2
   match address 200
   
   interface g0/1
   crypto map ipsecpro64_v2
   ```

   > interface g0/1 代表防火墙网关公网 IP 地址的接口，即防火墙的公网接口。

8. 配置静态路由

   ```
   ip route 10.0.192.0 255.255.255.0 106.75.234.78
   ```

#### 13.6.2.3 配置验证

通过 IDC 数据中心防火墙下 `192.168.1.0/24` 网段的主机 `Ping` 云平台的虚拟机`10.0.192.32` ，测试连通性。

### 13.6.3 StrongSwan 配置

通过在任意有公网 IP 地址的 Linux 主机上安装并配置 StrongSwan 与 UCloudStack 之间建立  IPSecVPN 连接，实现私有云和安装 IPSec 软件的主机对接，使相同网段的客户主机通过 IPSec 主机与 UCloudStack 平台虚拟机进行通信。

#### 13.6.3.1 前提条件

在建立 IPSecVPN 连接进行通信前，需确认两端要建立 IPSecVPN 连接的网络拓扑关系及配置参数信息。

| 网络配置和配置参数   | UCloudStack 私有云              | IDC 侧 StrongSwan                   |
| -------------------- | ------------------------------- | ----------------------------------- |
| VPN 网关公网 IP 地址 | 106.75.234.78                   | 113.31.113.78（内网 10.23.228.173） |
| VPC 网段/本地网段    | 10.0.192.0/20                   | 10.23.0.0/16                        |
| 客户虚拟机 IP        | 10.0.192.32                     | 10.23.112.177                       |
| 预共享密钥           | ucloud.1231                     | ucloud.1231                         |
| IKE 版本             | V2                              | V2                                  |
| IKE 策略             | 认证 SHA1、加密 AES128、DH 组 5 | 认证 SHA1、加密 AES128、DH 组 5     |
| IPSec 安全传输协议   | ESP                             | ESP                                 |
| IPSec 策略           | 认证 SHA1、加密 AES128、PFSDH 5 | 认证 SHA1、加密 AES128、PFSDH 5     |

> 本文假设已在 UCloudStack 私有云上部署 VPN 网关和对端网关，并已通过以上配置参数创建 VPN 隧道，等待数据中心的 StrongSwan 配置好 VPN 隧道后，即可进行 VPN 连接。

#### 13.6.3.2 配置 StrongSwan

本节介绍安装配置 StrongSwan 软件，安装环境为 Centos 7.4 。

1. 安装 StrongSwan

   ```
   yum install strongswan
   strongswan version
   ```

2. 开启操作系统数据转发配置并进行相关网络配置

   ```
   echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf
   echo 'net.ipv4.conf.default.rp_filter = 0' >> /etc/sysctl.conf
   echo 'net.ipv4.conf.all.accept_redirects = 0' >> /etc/sysctl.conf
   echo 'net.ipv4.conf.all.send_redirects = 0' >> /etc/sysctl.conf
   echo 0 > /proc/sys/net/ipv4/conf/lo/rp_filter
   echo 0 > /proc/sys/net/ipv4/conf/eth0/rp_filter
   echo 0 > /proc/sys/net/ipv4/conf/eth1/rp_filter
   echo 0 > /proc/sys/net/ipv4/conf/all/rp_filter
   sysctl -a | egrep "ipv4.*(accept|send)_redirects" | awk -F "=" '{print$1"= 0"}' >> /etc/sysctl.conf
   
   sysctl -p     //执行命令，生效转发配置命令
   ```

3. 配置 StrongSwan 参数

   ```
   vi /etc/strongswan/ipsec.conf           //编辑ipsec.conf文件
                        
   conn test                               //定义连接名称为 test
     authby=psk
     type=tunnel                           //开启隧道模式
   	keyexchange=ikev2                     // ike密钥交换方式为版本2	
     auto=start
     leftid=113.31.113.78                         //本端标识ID
     left=10.23.228.173                        //本地IP，nat场景选择真实的主机地址
     leftsubnet=10.23.0.0/16               //本地子网  
     rightid=106.75.234.78                   //远端标识ID
     right=106.75.234.78                     //远端VPN网关IP
     rightsubnet=10.0.192.0/20               //远端子网
     ike=aes128-sha1-modp1024               //按照对端配置定义ike阶段算法和group
     esp=aes128-sha1-modp1024             //按照对端配置定义ipsec阶段算法和group
     ikelifetime=86400s                             // ike阶段生命周期
     lifetime=86400s                                //二阶段生命周期 
     dpdaction=restart
     dpddelay=8s
     dpdtimeout=13s
   ```

> 本文搭建 StrongSwan 的主机是通过 NAT 网关模式，即使用 NAT 网关的 IP 地址访问互联网，或真实的搭建环境中 StrongSwan 主机有真实的公网 IP 地址，则 left 的值为真实公网 IP 地址。

4. 配置 ipsec.secrets 文件，定义预共享密钥

   ```
   vi /etc/strongswan/ipsec.secrets
   
   113.31.113.78 106.75.234.78 : PSK ucloud.1231
   ```

5. 启动 StrongSwan  并加入开机启动

   ```
   systemctl enable strongswan
   systemctl start strongswan
   ```

#### 13.6.3.3 配置验证

1. 通过 `strongswan statusall` 命令查询 strongswan 的连接状态，若出现类似  `ESTABLISHED 6 minutes ago`的信息，证明已连接成功，如下所示：

```
[root@10-23-228-173 ~]# strongswan statusall
Status of IKE charon daemon (strongSwan 5.7.2, Linux 3.10.0-957.27.2.el7.x86_64, x86_64):
  uptime: 6 minutes, since Jul 30 19:13:57 2020
  malloc: sbrk 2666496, mmap 0, used 609168, free 2057328
  worker threads: 11 of 16 idle, 5/0/0/0 working, job queue: 0/0/0/0, scheduled: 5
  loaded plugins: charon pkcs11 tpm aesni aes des rc2 sha2 sha1 md4 md5 mgf1 random nonce x509 revocation constraints acert pubkey pkcs1 pkcs7 pkcs8 pkcs12 pgp dnskey sshkey pem openssl gcrypt fips-prf gmp curve25519 chapoly xcbc cmac hmac ctr ccm gcm curl attr kernel-netlink resolve socket-default farp stroke vici updown eap-identity eap-sim eap-aka eap-aka-3gpp eap-aka-3gpp2 eap-md5 eap-gtc eap-mschapv2 eap-dynamic eap-radius eap-tls eap-ttls eap-peap xauth-generic xauth-eap xauth-pam xauth-noauth dhcp led duplicheck unity counters
Listening IP addresses:
  10.23.228.173
Connections:
        test:  10.23.228.173...106.75.234.78  IKEv2, dpddelay=8s
        test:   local:  [113.31.113.78] uses pre-shared key authentication
        test:   remote: [106.75.234.78] uses pre-shared key authentication
        test:   child:  10.23.0.0/16 === 10.0.192.0/20 TUNNEL, dpdaction=restart
Security Associations (1 up, 0 connecting):
        test[1]: ESTABLISHED 6 minutes ago, 10.23.228.173[113.31.113.78]...106.75.234.78[106.75.234.78]
        test[1]: IKEv2 SPIs: 8285787a9e1b8ae2_i* 22543e6225ea8e59_r, pre-shared key reauthentication in 23 hours
        test[1]: IKE proposal: AES_CBC_128/HMAC_SHA1_96/PRF_HMAC_SHA1/MODP_1024
        test{1}:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: c22520e2_i c30646c8_o
        test{1}:  AES_CBC_128/HMAC_SHA1_96, 35364 bytes_i (421 pkts, 1s ago), 35364 bytes_o (421 pkts, 1s ago), rekeying in 23 hours
        test{1}:   10.23.0.0/16 === 10.0.192.0/20
```

2. 在 IDC 数据中心 StrongSwan下 `10.23.0.0/16` 网段的主机内添加到达 UCloudStack 侧网段的路由，使两端主机可以互相通信。

   ```
   ip route add 10.0.192.0/20 via 10.23.228.173
   ```

3. 通过 IDC 数据中心 StrongSwan下 `10.23.0.0/16` 网段的主机 `Ping` 云平台的虚拟机`10.0.192.32` ，测试连通性。

   ![StrongSwanping](../images/userguide/StrongSwanping.png)

### 13.6.4 VPC 到 VPC 的 VPN 连接

通过 VPN 网关将 UCloudStack 平台建立 VPC 到 VPC 的 VPN 连接，实现两个 VPC 内虚拟机互问及数据传输入。

平台  IPSecVPN 支持 IKEv1 和 IKIEv2 ，本文描述在两个 VPC 网络间建立基于 IKEv2 版本的 IPSecVPN 连接。

#### 13.6.4.1 前提条件

本操作以同一个账号下的两个 VPC 网络为例，在建立 IPSecVPN 连接进行通信前，需确认两端要建立 IPSecVPN 连接的网络拓扑关系及配置参数信息。

| 网络配置和配置参数   | UCloudStack 私有云 VPC1         | UCloudStack 私有云 VPC2         |
| -------------------- | ------------------------------- | ------------------------------- |
| VPN 网关公网 IP 地址 | 106.75.234.78                   | 106.75.234.74                   |
| VPC 网段             | 10.0.192.0/20                   | 192.168.0.0/16                  |
| 客户虚拟机 IP        | 10.0.192.32                     | 192.168.0.16                    |
| 预共享密钥           | ucloud.1231                     | ucloud.1231                     |
| IKE 版本             | V2                              | V2                              |
| IKE 策略             | 认证 SHA1、加密 AES128、DH 组 2 | 认证 SHA1、加密 AES128、DH 组 2 |
| IPSec 安全传输协议   | ESP                             | ESP                             |
| IPSec 策略           | 认证 SHA1、加密 AES128、PFSDH 2 | 认证 SHA1、加密 AES128、PFSDH 2 |

#### 13.6.4.2 配置 VPN 网关和隧道

本操作需要在两个 VPC 内分别创建 VPC 网关，并针对两个 VPC 的网关分别创建对应的对端网关和隧道，即需要创建  VPN 网关-VPC1、 VPN 网关-VPC2、对端网关1、对端网关 2、VPN 隧道 1、VPN 隧道 2，并使 VPN 隧道 1 和 隧道 2 建立连接。

1. 分别在 VPC1 和 VPC2 中创建 VPN 网关，并确认两个网关地址分别为 `106.75.234.78` 和 `106.75.234.74`，如下图所示；

   ![vpngwlist2](../images/userguide/vpngwlist2.png)

2. 分别针对两个 VPN 网关创建对应的对端网关，VPN 网关-VPC1 的对端网关 IP 为  `106.75.234.74` ，VPN 网关-VPC2 的对端网关 IP 为  `106.75.234.78` ，如下图所示：

   ![remotegwlist1](../images/userguide/remotegwlist1.png)

3. 使用 VPN 网关-VPC1 和 对端网关 1 结合前提条件中的网段信息及参数配置创建 VPN 隧道 1 ，如下图所示：

   ![tunnel001](../images/userguide/tunnel001.png)

4. 使用 VPN 网关-VPC2 和 对端网关 2 结合前提条件中的网段信息及参数配置创建 VPN 隧道 2 ，需确保网段信息与 隧道1 匹配，同时保证 IKE 策略、IPSec 策略与隧道 1 保持一致才可正常建立连接，如下图所示：

   ![tunnel002](../images/userguide/tunnel002.png)

   如图所示，隧道 2 的对端网段为 隧道的本端网段，IKE 及 IPSec 策略配置均和 隧道 1 一致，均使用 IKEv2 版本，IKE 策略均为：认证 SHA1、加密 AES128、DH 组 2 ，IPSec 策略均为：认证 SHA1、加密 AES128、PFSDH 2。

5. 查看两个隧道的连接状态，等待隧道连接成功后，即可进行连通性验证，如下图所示两个隧道均已连接，且已向所选择了子网的虚拟机中下发路由，如下图所示：

   ![tunnelcon](../images/userguide/tunnelcon.png)

#### 13.6.4.3 配置连接验证

在已连接状态时，平台会分别对两个隧道所关联的本端子网虚拟机中下发对端网段为目标地址的路由，可登入个 VPC 的客户虚拟机中查看相关网络及路由配置信息：

![vpcconvpc](../images/userguide/vpcconvpc.png)

* VPC1 的客户虚拟机 IP 地址为 `10.0.192.32` ，下发的目标路由为 `192.168.0.0/16` 

* VPC2 的客户虚拟机 IP 地址为 `192.168.0.16` ，下发的目标路由为 `10.0.192.0/20` 

如上图所示通过 Ping 命令检测到不同 VPC 虚拟机可相互通信，代表 VPC1 和 VPC2 在 VPN 网关中指定的子网已通过 IPSecVPN 打通网络。

## 13.7 常见问题

1. **是否可以通过 VPN 网关绑定的外网 IP 访问互联网或外网 IP 通向的其它外网？**

   不可以，通过 VPN 网关建立的 VPN 隧道，仅可透传隧道内指定的本端网段和对端网段的流量，不提供互联网访问能力。

2. **远端数据中心通过平台的 IPSecVPN 服务打通 VPC 网络的前提条件是什么？**

   远端数据中心或平台必须具有固定公网 IP 或 通过 NAT 提供公网 IP 的 网关设备，且网关设备必须支持 IKEv1 或 IKEv2 协议的 IPSecVPN，在建立 VPN 隧道时两端需要互通的网段不可重复且不可重叠。

3. **每个 VPN 网关可以建立多少个 VPN 隧道连接？**

   每个 VPN 网关最多可支持 20 个 VPN 隧道连接。

4. **每个 VPN 隧道支持多少个本端网段和对端网段？**

   每个 VPN 隧道支持配置 20 个本端网段和 20 个对端网段。

5. **可以在一个 VPC 内创建两个 VPN 网关用于构建不同流量透传的隧道吗？**

   可以，平台支持在一个 VPC 内创建多个 VPN 网关，但相同 VPC 网关上建立隧道的本端网段和对端网端匹配规则不可相同，否则可能导致影响路由下发及网络通信。

6. **VPN 隧道连接状态为“阶段 1 失败” ，应该如何处理？**

   阶段 1 失败，通常是因为两端 VPN 隧道在建立连接协商 IKE SA 时的配置参数不一致导致，可能原因及解决方案如下：

   （1）预共享密钥不一致：两端设置一致的共享密钥。

   （2）IKE 版本不一致及协商模式不一致：两端设置一致的 IKE 版本，若 IKE 版本为 V1 ，则需保证两端配置的协商模式一致。

   （3）本端标识和对端标识不一致：两端设置一致的本端标识和对端标识，并且保证两端的本端标识和对端标识位置对调，如左侧的本端标识和对端标识分别为 192.168.1.1 & 172.16.1.1 ，则右侧的本端标识和对端标识分别为 172.16.1.1 & 192.168.1.1 。

   （4）加密/认证算法/DH 组不一致：两端设置一致的加密算法、认证算法及一致的 DH 组。

   （5）对端网关未响应：确认与对端网关的网络是否异常，若对端网关的公网 IP 为 NAT 地址，需确保对端网关的公网 IP 地址为固定 IP 地址。若对端网关公网 IP 地址为非固定 IP 地址，则建立隧道时需要使用 IP 地址为 0.0.0.0 的对端网关。

7. **VPN 隧道连接状态为“阶段 2 失败” ，应该如何处理？**

   阶段 1 失败，通常是因为两端 VPN 隧道在建立连接协商 IPSec SA 时的配置参数不一致导致，可能原因及解决方案如下：

   （1）本端网段和对端网段不一致：两端调置一致的本端网段和对端网段，并且保证两端的本端网段和对端网段位置对调，如左侧的本端网段和对端网段分别为 192.168.1.0/24 & 172.16.0.0/16，则右侧的本端网段和对端网段分别为 172.16.0.0/16 & 192.168.1.0/24 。（ StrongSwan 报错 received INVALID_ID_INFORMATION error notify）

   （2）IPSec 参数的安全传输协议不一致：两端设置一致的安全传输协议，如 ESP 或 AH 。

   （3）IPSec 参数的加密/认证算法及 HD 组不一致：两端设置一致的 IPSec 加密算法、认证算法及 DH 组。

8. **VPN 隧道连接状态一直为“连接中” ，应该如何处理？**

   连接中代表 VPN 隧道正在初始化并准备连接对端网关和隧道，若一直卡在连接中，可能需要检测两端网关的网络通信，并确保两端网络已放通 UDP 4500 、UDP 500 、UDP 50  及 UDP51 等端口。

   若有一端环境存在 NAT 透传，通常需要 NAT 端主动发起请求，才可正常建立连接。

9. **两端 VPN 隧道连接状态为“已连接” ，VPC 内的虚拟机无法与对端网段内的主机进行通信，如何处理？**

   平台侧会自动下发路由至 VPC 内的虚拟机，需检查 VPC 虚拟机路由配置，若本端虚拟机路由正常，需要检测是否为对端网关下的内网主机下发路由。
# 14  弹性伸缩

## 14.1 产品简介

### 14.1.1 概述

弹性伸缩（Auto Scaling）是指在业务需求增长时自动增加计算资源（虚拟机）以保证计算能力，在业务需求下降时自动减少计算资源以节省成本；同时可结合负载均衡及健康检查机制，满足请求量波动和业务量稳定的场景。

用户可通过弹性伸缩服务，定制弹性伸缩组及伸缩策略，在伸缩组内资源量达到策略定义的阈值后，根据定制的虚拟机模板自动增减虚拟机数量，提升业务部署及运维的效率。

### 14.1.2 逻辑架构

弹性伸缩从逻辑架构上可分为三部分，分别为伸缩组、伸缩器及虚拟机模板。

![ASArch](../images/userguide/ASArch.png)

* 伸缩组：负责将组内的实例数量维持在“期望”的水位，添加/缩减虚拟机的动作均由伸缩组进行操作，支持“自动伸缩”和“固定数量” 两种模式维护伸缩组内的实例数量。
* 伸缩器：即伸缩策略，用于定义伸缩组内虚拟机伸缩的规则，可为伸缩组定义根据 CPU 使用率的阈值触发伸缩动作，支持定义伸缩组最小及最大实例数量，并可配置是否允许缩容。
* 虚拟机模板：用户根据需求自定义虚拟机模板，用于弹性伸缩时自动创建虚拟机的模板，同时支持通过虚拟机模板手动创建虚拟机。

伸缩组定义好伸缩模式后，伸缩组的实例“期望”值由伸缩策略接管并动态修改，最终由伸缩组负责虚拟机的动态扩容和缩容，新增虚拟机实例时会根据虚拟机模板创建新的虚拟机实例。

### 14.1.3 伸缩组工作流程

伸缩组内的虚拟机实例可定义预热时间，指为虚拟机创建成功后需要一定的时间拉起应用程序以承接业务流量。因此在伸缩组发起创建虚拟机的请求后，在虚拟机创建成功并处于运行中状态时，伸缩组中虚拟机的状态为“启动中”，代表虚拟机在预热中，待超过预热时间后，会自动转换为“运行” ，代表虚拟机为健康状态。

伸缩组每 15 秒 获取一次被其控制的所有虚拟机状态，判断是否需要添加或删除实例。若伸缩组关了负载均衡，则由负载均衡判断伸缩组内的实例是否健康，若不健康具体流程如下：

* 健康实例等于期望值

  伸缩组会自动将不健康（基于三个周期健康检测的判断）的实例移出伸缩组，并执行删除虚拟机操作。

* 健康实例大于期望值

  选择将最晚创建的健康虚拟机实例移出伸缩组，并执行删除虚拟机操作，同时将不健康的实例移出伸缩组并执行删除操作。

* 健康实例小于期望值

  伸缩组会自动以虚拟机模板发起创建实例操作，并将实例数量维持在期望值，同时会将不健康的实例移出伸缩组并执行删除操作。

### 14.1.4 伸缩器工作流程

伸缩器会根据伸缩策略中设置的最小和最大实例值，每 15 秒采集一次伸缩组中健康实例的 CPU 监控数据，用于判断是否需要扩容或缩容伸缩组中的实例。

* 扩容

  若伸缩组中健康实例的 CPU 平均使用率大于伸缩策略定义的阈值，则会触发伸缩组进行扩容实例操作。

* 缩容

  通常伸缩组中健康实例的 CPU 平均使用率小于伸缩策略定义的阈值，则会触发伸缩组进行缩容实例操作。**为避免频繁的缩容导致伸缩组内集群服务震荡，缩容时会获取伸缩组过去 10 分钟内所有健康实例的 CPU 监控数据平均值，用于判断是否需要缩容伸缩组中的实例**。

### 14.1.5 功能特性

弹性伸缩通过伸缩组、伸缩策略及虚拟机模板共同维护集群内虚拟机的实例数量，同时可结合负载均衡对伸缩组内虚拟机实例的业务健康进行检测并及时剔除处于不健康状态的虚拟机实例，保证整体集群业务的可用性和可靠性。

* 支持定义虚拟机模板，用于伸缩组自动创建虚拟机的模板，同时支持通过虚拟机模板手动创建虚拟机。
* 支持伸缩组预热时间，使虚拟机创建成功后有时间拉起应用程序以承接业务流量。
* 支持自动伸缩和固定数量两种伸缩模式，适应多种自动伸缩场景。
  * 自动伸缩模式依据伸缩器的伸缩策略维护伸缩组中的实例数量；
  * 固定数量模式依据用户指定的实例数量维伸缩组中的实例。
* 支持按照伸缩组中健康实例的平均 CPU 使用率作为自动伸缩模式中是否需要扩缩容的依据。
* 支持设置伸缩策略的最大实例数量，避免因 CPU 使用率过高，无限制扩容伸缩组内实例数量，如集群虚拟机被攻击等。
* 支持设置伸缩策略的最小实例数量，避免因 CPU 使率过低而导致伸缩组中实例数量为 0 ，导致业务中断或服务停止等问题。
* 支持设置伸缩策略的缩容策略，即限制一个伸缩组内的实例只允许扩容，不允许缩容。
* 支持用户查看伸缩组的伸缩日志和已添加至伸缩组的实例信息，用于查看自动伸缩组所有执行动作及原因，方便用户对伸缩组集群业务进行维护。
* 支持用户启用或禁用一个伸缩组，伸缩组禁用后即为不可用状态，将不会在触发伸缩策略执行实例伸缩和健康检查，禁用伸缩组不影响伸缩组中已存在实例的正常运行。
* 提供伸缩组中所有实例的平均 CPU 使用率监控数据，并可通过告警模板对监控数据进行告警配置，在使用率过高而触发扩缩容时，为用户发送告警邮件。

支持弹性伸缩与负载均衡进行关联，通过将伸缩组中的实例添加至负载均衡的监听器中，为伸缩组中的虚拟机业务提供负载均衡服务，同时通过监听器的健康检查机制，判断伸缩组中所有实例的业务健康状况，自动剔除业务不健康的实例并新增健康实例到业务集群。

## 14.2 虚拟机模板管理

虚拟机模板是用户根据需求自定义虚拟机模板，用于弹性伸缩时自动创建虚拟机的模板，同时支持通过虚拟机模板手动创建虚拟机，支持虚拟机模板的创建、查看、删除及创建虚拟机等生命周期管理。

### 14.2.1 创建虚拟机模板

用户可根据业务需要通过虚拟机控制台——虚拟机模板资源列表创建适合业务的虚拟机模板，用于伸缩器自动增加虚拟机实例时的模板。虚拟机模板与创建虚拟机一致，只需要额外提供模板名称及模板备注即可，如下图所示：

![createtemplate](../images/userguide/createtemplate.png)

模板名称和备注是指当前要创建的虚拟机模板的名称和描述，基础配置、网络设备、管理配置与创建虚拟机一致，代表使用该模板创建虚拟机时指定的参数，如虚拟机规格和操作系统等；同时虚拟机模板无需指定虚拟机名称，由弹性伸缩组创建时自动生成虚拟机名称。

创建模板时需要指定模板中虚拟机的付费方式，即代表通过该模板创建的虚拟机的付费方式，如按月；同时创建模板时会展示该模板创建虚拟机时需要付的费用。

> 创建模板时并不会真正扣费，仅当弹性伸缩组自动创建实例时才会根据预计费用进行扣费。

### 14.2.2 查看虚拟机模板

用户可通过虚拟机模板列表页面查看虚拟机模板的列表信息，包括名称、ID、VPC、子网、机型、配置、关联资源、计费方式及操作项，如下图所示：

![templatelist](../images/userguide/templatelist.png)

* 名称/ID：指虚拟机模板的名称及全局唯一标识符。
* VPC/子网：指通过虚拟机模板创建的虚拟机所属 VPC 和子网。
* 机型/配置：指通过虚拟机模板创建的虚拟机所属机型及配置。
* 关联资源：指虚拟机模板已关联的弹性伸缩组，即伸缩组会通过虚拟机模板中的配置创建实例。
* 计费方式：指通过虚拟机模板创建的虚拟机的付费方式。

列表上操作项是指通过虚拟机模板手动创建虚拟机，同时用户也可点击虚拟机模板的名称进入虚拟机模板详情，查看虚拟机模板的详细信息，包括基本信息、虚拟机配置、网络配置及存储配置信息。

### 14.2.3 模板创建虚拟机

支持用户通过模板手动创建虚拟机，适用于需要通过模板创建虚拟机的场景。如下图所示：

![templateaddvm](../images/userguide/templateaddvm.png)

通过模板创建虚拟机时需要指定虚拟机名称，也可指定虚拟机的登录密码，如不指定则采用创建模板时指定的登录密码。

### 14.2.4 修改名称和备注

修改虚拟机模板的名称和备注，在任何状态下均可进行操作。可通过点击虚拟机模板列表⻚面每个镜像名称右侧的“编辑”按钮进行修改。

## 14.3 伸缩策略管理

伸缩策略用于定义伸缩组内虚拟机伸缩的规则，可为伸缩组定义根据 CPU 使用率的阈值触发伸缩动作，支持定义伸缩组最小及最大实例数量，并可配置是否允许缩容，支持伸缩策略的创建、查看、修改及删除等生命周期管理。

### 14.3.1 创建伸缩策略

用户在使用弹性伸缩组的前提是账号内必须有虚拟机模板和伸缩策略，用户可根据业务需求通过弹性伸缩控制台——伸缩策略资源列表创建适合业务的伸缩策略，用于定义伸缩组内的实例伸缩规则，如伸缩检测指标、指标阈值、最小实例和最大实例等，如下图所示：

![strategy](../images/userguide/strategy.png)

* 策略名称/备注：当前伸缩策略的名称和备注。
* 伸缩指标：伸缩组检测组内所有实例的监测指标，目前仅支持 CPU 使用率，即伸缩器自动检测组内所有实例的 CPU 使用率。
* 指标阈值：伸缩指标的监控阈值，即超过阈值时，即会自动对伸缩组内的实例进行伸缩，并控制在最小实例和最大实例等。
* 最小实例数：伸缩策略的最小实例数，创建伸缩策略时必须指定，避免因 CPU 使率过低而导致伸缩组中实例数量为 0 ，导致业务中断或服务停止等问题。
* 最大实例数：伸缩策略的最大实例数，创建伸缩策略时必须指定，避免因 CPU 使用率过高，无限制扩容伸缩组内实例数量，如集群虚拟机被攻击等。
* 允许缩容：伸缩策略是否允许缩容，支持允许和不允许。如设置为不允许，则限制一个伸缩组内的实例只允许扩容，不允许缩容。

点击确认后，平台将自动为用户生成一条伸缩策略，可通过伸缩策略列表进行查看，可用于创建伸缩组。

### 14.3.2 查看伸缩策略

用户可通过伸缩策略列表查看已有伸缩策略的列表及相关信息，包括名称、 ID、伸缩规则、最小实例、最大实例、允许缩容、关联资源及操作系统 ，如下图所示：

![strategylist](../images/userguide/strategylist.png)

* 伸缩规则：当前伸缩策略的伸缩规则，包括伸缩指标和伸缩阈值，如 CPU 使用率：80% 。
* 最小/大实例数：创建伸缩策略时指定的最小实例数和最大实例数。
* 关联资源：指伸缩策略已关联的弹性伸缩组，即弹性伸缩组通过伸缩策略的期望值维护组内的虚拟机实例。

列表操作项支持单个伸缩策略的修改和删除操作，同时为方便租户便捷管理伸缩策略，支持伸缩策略的批量删除。

### 14.3.3 修改伸缩策略

平台支持用户即时更新伸缩策略的伸缩指标、指标阈值、最小实例数、最大实例数及缩容策略，用户可通过伸缩策略列表上操作项的更新进入修改向导页面，如下图所示：

![updatestrategy](../images/userguide/updatestrategy.png)

修改伸缩策略后即时生效，若伸缩策略被伸缩组关联，则平台会根据新的伸缩策略的期望值维护伸缩组内的虚拟机实例，保证伸缩策略中业务的有效性。

### 14.3.4 删除伸缩策略

支持平台租户及子账号删除有权限的伸缩策略，支持批量删除。仅支持删除未被伸缩组关联的伸缩策略，被删除的伸缩策略会直接被销毁。可通用伸缩策略列表操作项中的“删除”进行操作，如下图所示：

![rmstrategy](../images/userguide/rmstrategy.png)

## 14.4 伸缩组管理

伸缩组负责将组内的实例数量维持在“期望”的水位，添加/缩减虚拟机的动作均由伸缩组进行操作，支持“自动伸缩”和“固定数量” 两种模式维护伸缩组内的实例数量，适应多种自动伸缩场景。伸缩组是通过伸缩策略中对于伸缩规则及伸缩实例数来维护组内实例的期望水平，并通过虚拟机模板创建新的实例。

* 自动伸缩模式依据伸缩器的伸缩策略维护伸缩组中的实例数量；
* 固定数量模式依据用户指定的实例数量维伸缩组中的实例，即固定数量模式无需指定伸缩策略。

支持伸缩组预热时间，使虚拟机创建成功后，在预热时间内拉起应用程序以承接业务流量；同时支持伸缩组关联负载均衡，为伸缩组中的虚拟机业务提供负载均衡服务，同时通过监听器的健康检查机制，判断伸缩组中所有实例的业务健康状况，自动剔除业务不健康的实例并新增健康实例到业务集群。

作为自动伸缩服务的最核心模块，支持伸缩组的全生命周期管理，包括创建伸缩组、查看伸缩组、修改伸缩组、启动/禁用伸缩组、绑定/解绑负载均衡、查看伸缩日志及删除伸缩组等。

### 14.4.1 创建伸缩组

用户可通过伸缩组控制台，指定虚拟机模板、预热时间、伸缩模式创建一个弹性伸缩组，用于动态扩缩组内的虚拟机实例，适应需要弹性伸缩的业务场景。如下两图创建自动伸缩及固定数量两种伸缩模式的伸缩组示例：

![createscale](../images/userguide/createscale.png)

![createscale1](../images/userguide/createscale1.png)

其中不同的伸缩模式需要指定的实例数量不同，自动伸缩模式时需要指定伸缩策略，固定伸缩模式时只需要指定期望组内的实例数量即可。

* 名称/备注：伸缩组的名称和备注信息，用于标识伸缩组。
* 虚拟机模板：伸缩组为组内新增虚拟机实例时所使用的虚拟机模板，即会根据所选虚拟机模板为组内新增虚拟机实例，创建时必须指定，仅支持选择有权限的虚拟机模板。
* 预热时间：伸缩组内虚拟机实例创建成功后的预热时间，在预热时间内虚拟机可拉起应用程序以承接业务流量，预热中的虚拟机实例在伸缩组中处于【启动中】状态。创建时必须指定，默认为 300s 。
* 伸缩模式：伸缩组维护组内虚拟机实例数量的依据，支持自动伸缩和固定数量两种模式，适应不同的应用场景，默认为自动伸缩模式。
  * 当选择自动伸缩模式时，需要用户指定伸缩策略，即依据伸缩策略中的配置维护伸缩组内的实例数量。
  * 当选择固定数量模式时，需要用户指定实例数量，即通过指定的数量维护伸缩组内的实例数量。
* 伸缩策略：伸缩组关联的伸缩策略，仅当伸缩模式为自动伸缩时可进行选择，一次仅支持选择一个伸缩策略。
* 实例数量：伸缩组中期望的虚拟机数量，仅当伸缩模式为固定数量时可选择，最小为 1 台。

模板配置和策略配置用于展示当前选择的虚拟机模板的实例配置及伸缩策略配置信息，其中模板配置包括机型、镜像、配置、数据盘、外网 IP 等；伸缩配置包括伸缩规则、最大实例数、最小实例数及缩容策略。

点击创建后，平台即会根据指定的配置创建伸缩组，并自动维护伸缩组内的实例数量，同时会扣取新增实例的费用（伸缩组不收取额外费用，但用户需要为伸缩组中创建的虚拟机实例付费），用户可通过伸缩组列表及详情查看伸缩组的实例及相关信息。

### 14.4.2 查看伸缩组

#### 14.4.2.1 伸缩组列表

用户可通过弹性伸缩控制台查看账户内拥有的所有伸缩组的列表及相关信息，并可通过列表的名称进入伸缩组详情查看伸缩组的监控信息、实例信息、伸缩日志，同时可通过伸缩组的负载均衡对伸缩组进行负载均衡的绑定和解绑操作，具体列表信息如下图所示：

![scalelist](../images/userguide/scalelist.png)

* 名称/ID：伸缩组的名称及全局唯一标识符。
* 启动模板：伸缩组关联的虚拟机模板，即组内新增实例时所使用的虚拟机模板。
* 伸缩模式：伸缩组维护组内虚拟机实例数量的模式，包括自动伸缩和固定数量。
* 伸缩策略：仅当伸缩模式为自动伸缩时才会展示关联的伸缩策略名称和 ID 。
* 期望实例：伸缩组的期望虚拟机实例数量。
* 当前实例：伸缩组内当前的虚拟机实例数量，正常情况下等于期望实例数量。
* 状态：指伸缩组的运行状态，包括可用、不可用。

列表上支持对伸组组进行更新、启动、禁用、删除等操作，同时支持对伸缩组进行批量启用、批量禁用及批量删除操作。

#### 14.4.2.2 伸缩组详情

用户可进入伸缩组详情查看伸缩组内的详细信息，包括伸缩组的基本信息、伸缩策略、监控信息、实例信息、伸缩日志及关联的负载均衡信息，如下图所示：

![scaledetails](../images/userguide/scaledetails.png)

（1）基本信息：包括资源 ID、资源名称、虚拟机模板、预热时间、当前实例数量。

（2）伸缩策略：包括伸缩模式和期望寮例数量。

（3）监控信息：伸缩指标的监控信息，用户可通过监控信息查看组内所有虚拟机实例的平均 CPU 使用率，并可通过告警模板对监控数据进行告警配置，在使用率过高而触发扩缩容时，为用户发送告警邮件，默认可查看一小时，可通过时间筛选，查看自定义时间的监控信息。

（4）实例信息：指伸缩组内当前实例的列表信息，包括实例的名称、ID、启动模板、IP 地址、创建时间及状态，详见 [查看伸缩组实例](#_14423-查看伸缩组实例)。

（5）伸缩日志：指伸缩组内的实例伸缩日志，如添加或移除实例的日志信息，详见[查看伸缩日志](#_14424-查看伸缩日志)。

（6）负载均衡：指伸缩组已关联的负载均衡实例，并可通过负载均衡管理绑定或解绑负载均衡，详见[负载均衡管理](#_1445-负载均衡管理)。

#### 14.4.2.3 查看伸缩组实例

用户可通过伸缩组详情中的【实例】标签页查看当前伸缩组中的实例信息，如下图所示：

![scalevm](../images/userguide/scalevm.png)

* 实例的名称为伸缩组自动命名，通常为伸缩组的名称+随机字符串。
* 启动模板为创建当前实例所使用的虚拟机模板，可通过虚拟机模板查看具体配置信息。
* IP 地址为虚拟机实例的 VPC 内网 IP 地址。
* 状态为当前实例的状态信息，包括启动中、运行及其它虚拟机相关状态信息。
  * 其中启动中指伸缩组中的虚拟机正在启动，或在伸缩组预热时间内，实例的状态会一直保持启动中，待超过预热时间后，会自动转换为运行，代表虚拟机为健康状态。
  * 伸缩组每 15 秒 获取一次被其控制的所有虚拟机状态，判断是否需要添加或删除实例。若伸缩组关了负载均衡，则由负载均衡判断伸缩组内的实例是否健康。
* 创建时间指当前实例的创建时间。

#### 14.4.2.4 查看伸缩日志

用哀悼可通过伸缩组详情中【伸缩日志】查看当前伸缩组中的实例变更日志，如添加实例或移除实例，并展示每次变更的详情原因和状态，包括操作时间、执行动作、原因及状态，方便用户对伸缩组集群业务进行维护，如下图所示：

![scalelog](../images/userguide/scalelog.png)

* 操作时间：指当前伸缩组内实例变更日志的操作时间。
* 执行动作：当前缩伸组日志的变更操作，如添加实例、删除实例。
* 原因：当前伸缩日志的变更原因，如实例数小于期望实例数而添加实例，或实例非健康状态而删除实例。
* 状态：当前伸缩实例变更的状态，包括操作成功或操作失败。

### 14.4.3 修改伸缩组

支持用户自定义修改伸缩组的虚拟机模板、预热时间、伸缩模式及实例数量，可通过伸缩组列表操作项中的更新进行操作，如下图所示：

![updatescale](../images/userguide/updatescale.png)

* 虚拟机模板

  若用户修改了伸缩组的虚拟机模板，不影响组内已有的虚拟机实例配置和参数，仅影响新添加实例，即更新后新添加实例时以新的虚拟机模板创建虚拟机。

* 预热时间

  用户修改预热时间后，新添加的实例会根据新的预热时间进行运行状态，并接受业务处理。

* 伸缩模式/实例数量/伸缩策略

  用户修改伸缩模式后，伸缩组会立即依据新的伸缩模式期望的实例数量维护组内虚拟机实例。

### 14.4.4 启用/禁用伸缩组

支持用户启用或禁用一个伸缩组，伸缩组禁用后即为不可用状态，将不会在触发伸缩策略执行实例伸缩和健康检查，禁用伸缩组不影响伸缩组中已存在实例的正常运行。

仅支持在禁用状态启用伸缩组，从禁用状态执行启用后，伸缩组的状态变更为可用，并会根看成伸缩模式期望的实例数量对伸缩组执行实例数量及健康状态维护。

### 14.4.5 负载均衡管理

平台支持伸缩组关联负载均衡，为伸缩组中的虚拟机业务提供负载均衡服务，同时通过监听器的健康检查机制，判断伸缩组中所有实例的业务健康状况，自动剔除业务不健康的实例并新增健康实例到业务集群。

一个伸缩组可支持绑定多个负载均衡的监听器（VServer），使伸缩组对外提供多种业务服务。每一个负载均衡的监听器均会对组内虚拟机实例进行负载均衡的业务健康检查，并会自动剔除非健康实例，并由伸缩组自动启动健康实例到组内。

伸缩组每 15 秒 获取一次被其控制的所有虚拟机状态，判断是否需要添加或删除实例。当伸缩组关了负载均衡，则由负载均衡判断伸缩组内的实例是否健康，若不健康具体流程如下：

* 健康实例等于期望值

  伸缩组会自动将不健康（基于三个周期健康检测的判断）的实例移出伸缩组，并执行删除虚拟机操作。

* 健康实例大于期望值

  选择将最晚创建的健康虚拟机实例移出伸缩组，并执行删除虚拟机操作，同时将不健康的实例移出伸缩组并执行删除操作。

* 健康实例小于期望值

  伸缩组会自动以虚拟机模板发起创建实例操作，并将实例数量维持在期望值，同时会将不健康的实例移出伸缩组并执行删除操作。

平台支持支持对伸缩组的负载均衡进行绑定、解绑及查看已绑定负载均衡等管理，使用户可基于自动伸缩的负载均衡为伸缩组内的虚拟机实例提供负载分发服务，提升业务的可用性。

#### 14.4.5.1 绑定负载均衡

支持用户将一个伸缩组绑定至多个负载均衡的 VServer 监听器，由负载均衡监听器监控伸缩组内虚拟机实例的健康状态，绑定后伸缩组内的所有实例将自动作为服务节点加入至所绑定的负载均衡 VServer ，用户可通过伸缩组详情——负载均衡中的绑定进入向导页面，如下图所示：

![scalebindlb](../images/userguide/scalebindlb.png)

* 负载均衡/ VServer ：需要绑定的负载均衡及 VServer 监听器，必须指定已存在且有权限的负载均衡实例，绑定时必须指定，一次仅允许指定一个。
* Port：伸缩组内加入到负载均衡服务节点的虚拟机实例所提供的业务服务端口，即负载均衡转发流量至虚拟机的后端服务端口。

绑定后伸缩组内的所有实例将自动作为服务节点加入至所绑定的负载均衡 VServer ，由负载均衡负责检查组内虚拟机实例的健康状态。

#### 14.4.5.2 查看已绑定负载均衡

伸缩组绑定负载均衡后，可通过伸缩组内的负载均衡详情查看已绑定的负载均衡信息，包括负载均衡、VServerID、端口、权重及操作项，如下图所示：

![scalelblist](../images/userguide/scalelblist.png)

在列表中负载均衡和 VServer 为已绑定的负载均衡名称及 VServer 的实例 ID ；端口和权重代表伸缩组内虚拟机实例加入至负载均衡服务节点中的后端服务端口及权重。

同时在列表上操作项中可对每一个已绑定的负载均衡进行解绑操作，支持批量解绑，方便资源维护。

#### 14.4.5.3 解绑负载均衡

用户可在业务需求时将伸缩组与负载均衡的关联进行解绑，解绑后伸缩组内的虚拟机实例均会从负载均衡的服务节点中进行移除，不会影响组内虚拟机及业务本身的运行，健康状态由伸缩组进行检查。用户可通过伸缩组详情——负载均衡中的解绑或批量解绑进行操作，如下图所示：

![scaleunbindlb](../images/userguide/scaleunbindlb.png)

### 14.4.6 删除伸缩组

平台支持用户删除不适合业务场景的伸缩组，在任何状态下均可进行删除。如下图所示：

![rmscale](../images/userguide/rmscale.png)

删除后伸缩组会自动与虚拟机模板、伸缩策略、负载均衡进行解绑，同时会自动删除伸缩组创建出来的虚拟机，被伸缩组删除的虚拟机实例会直接销毁，不会进入回收站。

# 15 定时器

## 15.1 产品简介

定时器（Scheduler）是平台为用户提供自动化任务功能，可用于定期执行一系列任务的，如创建快照。可在指定的周期重复执行，也可仅执行一次，且每个任务支持多个资源批量操作。

* 支持定时创建快照，即实现硬盘的自动快照，同时支持为多个硬盘批量创建定时快照任务。
* 支持单次和重复执行定时任务，重复执行支持每天、每周、每月的指定时间执行任务。
* 每天支持单小时或每个小时进行定时任务的执行操作。
* 每周支持星期一至星期日单小时或每个小时进行定时任务的执行操作。
* 每月支持每一天单小时或每个小时进行定时任务的执行操作。
* 平台会保存定时器执行的任务列表及执行结果记录，支持用户在定时器中查看每个任务的执行记录。

平台支持定时器的全生命周期管理，包括创建定时任务、查看定时任务及记录、更新定时任务及删除定时任务。

## 15.2 创建定时任务

用户可通过控制台直接创建一个用于执行创建快照的定时任务，用于云硬盘的备份。创建定时任务时需要指定任务类型、重复周期、执行时间及关联资源，如下图所示：

![createjob](../images/userguide/createjob.png)

* 名称：定时任务的名称，用于标识定时任务。
* 任务类型：定时任务的执行动作，当前仅支持创建快照。
* 重复周期：支持单次和重复执行定时任务，重复执行支持每天、每周、每月的指定时间执行任务：
  * 单次执行：需要指定执行具体时间，24小时制；默认当天执行，若执行时间已过则为次日执行。
  * 每天执行：需要指定每天执行的整点时间，支持从 0 点到 23 点的 24 个整点，支持每个整点均会执行定时任务。
  * 每周执行：需要指定每次执行的日期和执行时间，支持从周一到周日的 0 点到 23 点，支持周一到周日每天执行每个执行时间进行定时任务的执行。
  * 每月执行：需要指定每次执行的日期和执行时间，支持从 1 号到 31 号或月末的 0 点到 23 点，同时每月的每一天每个执行时间进行定时任务的执行。
* 执行时间：任务具体执行的时间，根据重复周期不同，执行时间可支持不同的设置方法。
  * 当重复周期为单次执行时，可支持设置日期的具体时、分、秒。
  * 当重复周期为每天、每周、每月重复执行时，可支持 0 点到 23 点中每一个整点。
* 时区：默认定时任务的时区东八区时间，即 GMT+8（北京时间）
* 关联资源：即设置需要定时任务执行创建快照的云盘资源，支持虚拟机的系统盘和数据盘，并支持批量选择。

点击确认后，系统将自动生成一条定时任务，并立即检测定时任务的执行计划和时间，如果到达约定的时间即会立即执行定时任务，可通过定时任务的详情中的日志查看具体执行情况。

## 15.3 查看定时任务

### 15.3.1 定时任务列表

用户可通过控制台查看账户内拥有的所有定时任务列表及相关信息，并可通过列表的名称进入定时任务详情查看定时任务的基本信息及任务执行记录，具体列表信息如下图所示：

![joblist](../images/userguide/joblist.png)

列表信息包括名称、ID、任务名称、定时器、关联资源、创建时间、更新时间及操作项：

* 名称/ID：当前定时任务的名称及全局唯一标识符。
* 任务名称：当前定时任务的执行动作，当前仅支持创建快照。
* 定时器：定时任务的执行规则，包括重复周期、执行日期及执行时间，其中执行日期仅在重复执行时有效。
* 关联资源：定时任务执行定时任务时的关联资源，即为关联资源执行创建快照或其它操作。
* 创建时间/更新时间：定时任务的创建时间和更新时间。

列表上支持对定时任务的更新及删除操作，同时支持对定时任务的批量删除操作；为方便用户管理定时任务的资源，平台支持对定时任务的搜索，支持模糊搜索。

### 15.3.2 定时任务详情

用户可进入定时任务详情查看定时任务的详细信息，包括基本信息及任务执行记录信息，如下图所示：

![jobdetails](../images/userguide/jobdetails.png)

其中基本信息包括名称、ID、任务类型、重复制期、执行时间、关联资源及创建时间，而任务执行日志全面记录当前定时任务的任务执行计划及执行状态，包括资源 ID、开始时间、结束时间、任务状态及任务结果。

* 资源 ID：定时任务执行记录对应的关联资源。
* 开始时间：定时任务执行的开始时间。
* 结束时间：定时任务执行的结束时间。
* 任务状态：当前定时任务的状态，包括成功和失败。
* 任务结果：当前任务的最终资源操作状态，包括操作成功和操作换败。

通过执行记录可进行定时任务的追溯，用于判断任务执行的成功与否。

## 15.4 更新定时任务

用户可在业务需要时对定时任务进行变更，支持变更定时任务的任务类型、重复周期、执行日期、执行时间及关联资源，如下图所示：

![updatejob](../images/userguide/updatejob.png)

定时任务更新后，不影响定时任务已执行的任务，执行新的任务类型时会根据新的定时策略进行操作。

## 15.5 删除定时任务

平台支持用户删除不适合业务场景的定时任务，在任何状态下均可进行删除。如下图所示：

![rmjob](../images/userguide/rmjob.png)

删除定时任务会立即销毁，同时会自动停止定时任务中的执行计划，但不影响其关联或由其创建出来的资源。

# 16 裸金属服务

## 16.1 产品简介

### 16.1.1 概述

裸金属服务（Bare Metal Server）是平台为用户应用提供专属物理服务器的服务，可保证核心数据库、关键应用系统、高性能计算业务及暂时无法云化业务的高性能和稳定性。

结合云平台对资源的弹性管理，可实现物理机的按需分配、灵活申请、自动安装操作系统，同时结合 IPMI 和 PXE 可支持裸金属设备的批量部署，并通过自动化系统配置，实现远程批量启动和部署。支持自定义安装裸金属设备的操作系统及网络自助配置，并提供物理服务器生命周期管理，包括服务器的启动、关机及释放等。

平台通过部署服务器提供 PXE 远程自助装机服务，引导相同网络中多台物理服务器由 PXE 网络启动，通过部署服务器下载并安装操作系统软件包为物理机安装操作系统，并根据操作系统配置的网络模板信息，配置服务器网络信息，将服务器与平台外网网络打通，结合平台统一管理服务，使用户通过平台即可自助申请并管理物理服务器。具体价值举例如下：

* 通过裸金属服务，平台租户可将虚拟机和物理机混合部署，构建异构基础设施的统一管理和灵活组网，物理机的网络可与平台虚拟机的外网网络互通，满足虚拟机业务与物理机互访等场景的诉求。
* 租户可根据需求自助申请平台管理者提供的物理机，并独享物理服务器的计算、网络及本地磁盘资源，可充分满足对高性能、稳定性、数据安全性的要求；结合物理服务器的独享网络，可满足对网络的低时延和高吞吐业务场景。

租户通过申请平台的裸金属物理机，可应用于核心数据库、大数据服务及关键应用等应用场景，如可将数据库集群 OracleRAC 部署于裸金属服务，将业务应用部署于平台虚拟机，并使用虚拟机的外网 IP 与物理机直接通过物理设备进行互联，提升业务性能和稳定性的同时提升资源管理的便捷性。

### 16.1.2 使用流程

在使用裸金属服务前，必须提前准备好裸金属设备，并根据需求将裸金属服务器的 IPMI 网络及业务网络与平台网络进行打通，在通过平台录入设备信息，将设备分配给租户，由租户自助申请后，自动安装操作系统并配置服务器网络。裸金属服务的使用流程分为【平台管理员流程】和【租户流程】两大部分，其中前 6 步为平台管理员进行操作，具体如下：

1. **硬件环境装备**

   准备好硬件环境，配置物理网络交换机及服务器 IPMI 网络，使平台物理网络与 IPMI 网络可互相通信。

2. **管理物理机资源池**

   由【平台管理员】创建并管理物理机资源池，用于定义一批物理机服务器操作系统使用的网段及 Vlan 信息，同时也用于定义网卡配置模板。

3. **管理网卡配置模板**

   由【平台管理员】创建并管理网卡配置模板，用于定义一批物理机服务器操作系统具体的网卡配置信息，如双网卡聚合及网卡使用的 Vlan 和 CIDR 网段，可在安装操作系统时根据模板自动配置网卡并配置 IP 等信息。

4. **为资源池添加物理机**

   由【平台管理员】为物理机资源池添加物理机信息，包括服务器的 SN 序列号、IPMI 用户名、密码及服务器操作系统的网卡模板，支持批量导入物理机信息。

5. **PXE 引导初始化**

   物理机信息录入后，如果 IPMI 网络及登录信息可正常访问，平台将通过 IPMI 和 PXE 自动引导录入的物理机重新启动并进行平台准备好的部署系统并对服务器进行初始化。初始化过程中物理机的状态为【准备中】，待服务器初始化成功后，服务器的状态置为【正常】，此时可在物理机的详情中查看物理服务器的详细硬件配置，如 CPU、内存、磁盘信息、网卡信息等。

6. **物理服务器分配**

   由【平台管理员】将已初始化的裸金属设备分配给租户，一个物理机同一时间仅支持分配给一个租户，有权限的租户可至控制台自助申请物理机并安装操作系统。

7. **租户申请物理机**

   由【平台租户】通过控制台物理机功能，根据需求自助申请有权限的物理机，可指定需要申请的特定物理机，并可指定物理机的系统盘、操作系统、IP 地址及管理员登录密码。

8. **自动化装机**

   平台根据用户指定的系统盘及操作系统，通过 PXE 远程自动安装操作系统，并在系统安装成功后，根据申请时指定的配置信息自动配置网络及密码，使用户可管理已安装好的物理机。

9. **裸金属物理机管理**

   由【平台租户】对已申请的物理机进行全生命周期管理，支持重装系统、关机、开机，并可在不用物理机时将设备重新释放给平台，由平台重新分配给其它租户。

平台租户在使用裸金属服务的前提是物理机准备好并分配给租户，租户只需要简单的申请，即可便捷的使用平台提供的裸金属设备，并可灵活部署业务系统至裸金属，组建混合异构的基础设施环境。

## 16.2 申请物理机

在平台已提供裸金属服务并已分配物理机给租户时，租户的主账号和子账号可在平台上直接申请有权限的物理机进行装机使用。用户可登录控制台，通过控制台导航栏【物理机】中的申请物理机操作进入向导页面，如下图所示：

![applybms](../images/userguide/applybms.png)

* 资源池：选择需要申请的物理机所属的物理机资源池，即代表物理机操作系统的网络所属网段和 Vlan 。
* 物理机：选择需要申请的物理机，可通过物理机名称和序列号定位需要的物理机，同时也可通过物理机配置信息查看物理机的 CPU、内存、磁盘数量及磁盘容量配置。
* 系统盘：选择物理机操作系统安装的系统盘，如 sda(hdd) 。
* 操作系统：选择需要安装的操作系统，如 Centos 7.4 ，不同型号的物理机需要适配操作系统略有区别。
* 网络：输入物理机需要配置的 IP 地址，IP 地址必须在物理机所属资源池网络中，并且不可与物理网络中的其它 IP 地址冲突，在使用前需先检测 IP 地址的可用性。
* 密码：输入物理机操作系统的登录密码。

仅在平台管理员为租户分配物理机时才可进行申请，申请提交后列表将生成一条【申请中】的物理机信息，待申请成功后，会置为【已完成】状态，此时用户可使用安装操作系统触发平台自动安装操作系统。

## 16.3 查看物理机

租户的主账号和拥有权限的子账号可通过物理机列表及详情查看账号下已申请的物理机列表及相关详细信息，并可查看物理机的详细配置及当前状态，如下图所示：

![bmslist](../images/userguide/bmslist.png)

* 名称/资源 ID：物理机的名称和全局资源唯一标识符。
* SN：物理机的整机序列号。
* IP：物理机的 IP 地址。
* 配置：物理机的硬件配置信息，包括 CPU、内存及磁盘容量。
* 申请时间：物理机的申请时间。
* 状态：当前物理机的资源状态，如申请中、装机中、运行中、开机中、关机中、已关机等。
* 电源状态：当前物理机的电源状态。

列表上的操作项中可对单台物理机进行开机、关机、装机及删除等操作，支持批量删除物理机，其中删除为将物理机释放至云平台，可重新进行申请或分配给其它租户。

租户也可通过列表上物理机的名称进入物理机的详情页面，查看物理机的详细信息，包括基本信息和配置信息：

* 基本信息包括：物理机的名称、ID、IP 地址、SN 序列号、申请时间、状态及电源状态。
* 配置信息包括：物理机的 CPU 架构、 CPU 核数、内存规格、系统盘规格、数据盘规格及操作系统版本等。

## 16.4 物理机开机/关机

平台支持租户对已申请的物理机进行关机和启动操作，用于维护和管理物理机的生命周期。电源状态为已开启时，才可执行关机操作；电源状态为已关机时，才可执行开机操作。

物理机开启过程中，物理机的状态为开机中，待开机成功后流转为运行中；当用户触发关机时，物理机的状态为关机中，待关机成功后流转为已关机。

## 16.5 物理机装机

租户可对物理机进行重装操作，仅当物理机为【运行中】时支持装机操作。用户触发装机操作后，需要用户目标操作系统，并会根据新的目标操作系统，重新通过 PXE 安装物理机的操作系统。

物理机重装时使用的网络和密码与申请物理机时相同，可在重装完成后登录物理机修改登录密码。

## 16.6 删除物理机

平台支持租户删除已申请的物理机，即租户将物理机释放至云平台，可重新进行申请或由平台管理员重新分配给其它租户，物理机被删除后，会直接进行释放，不会进入回收站。

物理机删除并不会真正从平台删除物理资源池的物理机，仅会将物理机从租户控制台进行释放，同时不影响物理机内已运行的操作系统及业务服务。

# 17 审批流程

## 17.1 概述

### 17.1.1 产品简介

随着信息化数字转型在政企、教育、金融、制造等行业的实践和应用，企业对资源管理的标准化、流程化管理需求日益旺盛，对于云化资源同样需要设置标准的审批流程，满足平台资源的申请、审批的业务使用流程的需求。

针对企业云化资源的管理，云平台为为企业管理者提供的自助模式的资源审批服务，用于制定信息系统云化资源的标准使用流程，在租户或子账号需要使用或管理资源时，按照流程中定义的审批人和审批层级完成审批后，由平台自动化交付用户需要业务资源。

平台审批流程由平台管理员进行定义和发布，并由平台管理者设置是否为一个租户设置开通审批流程，支持手动审批和自动审批。

* 手动审批：租户下主账号和子账号进行虚拟资源操作时需要走申请、审批流程，待审批通过后，平台会自动为用户创建或操作所需资源，并生一条审批记录用于追溯。
* 自动审批：租户下主账和子账号进行虚拟资源操作无需人工介入，系统将自动审批通过，并自动生成一条审批记录用于保留相关申请记录和审批记录。

开通资源审批的前提是设置审批流程，用于定义租户申请资源时，需要多少层级的审批，每一层级由谁进行审批，所有层级均通过后才可进行资源的创建和变更操作。为满足企业多种场景的审批业务，平台内置默认审批流程。

默认审批流程提供简单的审批逻辑，仅支持 1 级审批，当平台管理者为租户开启资源审批流程后，租户及子账号下资源的创建及变更申请统一由【平台管理员】进行审批，即平台管理员审批通过后，平台将自动执行资源的变更操作。

审批流程支持多种资源的变更操作，包括虚拟机、云硬盘、VPC 网络、外网 IP 及负载均衡 ，支持的变更如下：

* 虚拟机：创建虚拟机、修改配置、扩容系统盘、扩容数据盘；
* 云硬盘：创建云硬盘、扩容磁盘；
* VPC 网络：创建 VPC ；
* 外网 IP：创建外网 IP、调整带宽；
* 负载均衡：创建负载均衡。

### 17.1.2 审批使用流程

本文以申请虚拟机为示例描述手工审批的使用流程：

**（1）前置条件：管理员为租户开启审批流程。**

**（2）申请入口：创建虚拟机。**

* 进入虚拟机控制台，通过【创建虚拟机】进入虚拟机创建引导页面，如下图所示：

  ![vmapprove](../images/userguide/vmapprove.png)

* 填写申请名称和申请备注，按照虚拟机的创建要求输入其它必填信息，点击【立即购买】提交申请。

* 提交申请后，页面会自动跳转至【申请管理】页面，并在申请列表中自动新增一条待审批的申请记录。

  ![approvelist](../images/userguide/approvelist.png)

**（3）管理员审批**：由平台管理员 admin 账号进行审批。

* 若平台管理员通过申请，则申请状态变更为【已申请】，并会自动执行虚拟机的创建操作，可通过虚拟机列表查看正在创建的虚拟机资源，待资源创建成功后，申请状态变更为【成功】。
* 若平台管理员拒绝申请，则申申请状态变更为【已拒绝】，申请的资源变更将不被执行，可联系平台管理员或查看审批备注了解拒绝原因。

## 17.2 申请管理

租户在对资源进行变更并提交申请后，可通过申请管理控制台查看申请记录及申请状态。

### 17.2.1 查看申请列表

用户通过我的申请列表可查看租户下所有已提交的申请记录，包括手工审批和自动审批的所有记录。如下图所示：

![applicationlist](../images/userguide/applicationlist.png)

* 申请名称：本次申请的名称。
* 资源类型：本次申请的资源类型，包括虚拟机、硬盘、VPC、外网IP、负载均衡等五类资源。

* 操作：针对资源的操作。比如创建虚拟机，创建 VPC 。

* 账号邮箱：申请人的账号邮箱。

* 账号 ID：申请人的账号 ID 。

* 状态：申请的状态，包括已申请、成功、已拒绝。

* 当前节点：申请的当前节点，快速了解申请的进展。

* 当前处理人：申请的当前处理人，默认流程均为平台管理员。

* 创建日期：本次资源变更的申请时间。

### 17.2.2 查看申请详情

用户通过申请记录右侧“详情”按钮可进入申请的概览页面。在此页面可查看申请信息、申请涉及到的资源的信息、申请的处理记录、申请的关联资源。

![applicaitondetail](../images/userguide/applicaitondetail.png)

（1）申请信息：描述本次申请的详细信息，如申请名称、申请资源类型、申请的变更操作及申请的状态及时间。

（2）关联资源：描述本次申请的关联资源信息。**管理员审批通过的申请记录会存在关联资源，被拒绝的申请将不执行资源操作，不会产生关联资源信息。**

（3）资源信息：代表本次申请时提交的资源变更具体配置信息，如申请创建虚拟机时的规格、VPC 网络、镜像等，同时包括资源的申请时的计费信息。

（4）处理记录：当前申请记录的处理记录，并可查看所有处理节点的流程节点、处理人、备注及处理时间。

* 流程节点：指当前申请记录所使用的审批流程的所有节点，如平台默认的审批流程包括提交申请、默认审核节点、资源操作等。
* 处理人：指每一个流程节点的处理人，如提交申请人的邮件地址为 cinder.lv@ucloud.cn ，默认审核节点的处理人为 admin@ucloud.cn 。
* 备注：指每一流程节点的备注，如平台管理员通过或拒绝申请时给予的说明。
* 处理时间：指每一个流程节点人的处理时间。

> 有关租户审批流程开通、变更及平台管理者审批管理，可参考平台管理员手册中【审批流程】章节。





































# 18 监控告警

监控告警是 UCloudStack 平台全线产品的运维监控及告警服务，提供全线资源实时监控数据及图表信息，可根据监控数据批量为资源设置告警策略，并在资源故障或监控指标超过告警阈值时，以短信、邮件及电话的方式给予通知及预警；同时监控告警服务还为用户提供历史资源告警记录，让用户实时、精准掌控业务和各云产品的健康状况，全方位保障业务的可靠性和安全性。

监控告警服务提供监控图表、告警模板、通知组及告警记录四大架构功能，整体架构功能均以监控数据为基准：

- 云平台通过智能化数据采集系统，对虚拟机、云硬盘、弹性网卡、EIP 、负载均衡、NAT 网关、弹性伸缩、MySQL、Redis、VPN 网关等资源指定的监控指标数据进行完整挖掘；
- 将采集来的监控数据存储至数据库中，并根据指定规则对数据进行检索及统计，通过指定的时间维度及数据粒度以图形化的方式显示监控图表；
- 基于已有的监控数据，用户可通过配置告警模板，为指定的监控指标指定告警阈值及告警设置，可通过设置告警重复频次，判定区分不同等级的告警及通知；
- 为告警模板配置通知组，指定在发生告警时通知事件的通知人及通知方式；
- 在告警期间或故障结束后，可通过告警记录查询历史告警记录信息，以判断故障的发生时间和发生频率。

## 18.1 监控图表

监控图表指平台将智能化采集的资源运行数据，根据指定的资源及指标等筛选规则进行检索并统计，通过指定的数据粒度及时间维度以图形化的方式显示监控图表。通过监控图表，用户可以直观的查看并了解平台上已运行虚拟资源的性能、容量及网络状态等状态，及时了解资源的健康状况及故障节点。

平台为用户构建的虚拟机、弹性 EIP 、负载均衡、NAT 网关、弹性伸缩、MySQL、Redis、VPN 网关分别提供多种监控指标的实时和历史监控图表，并可根据监控指标项配置相关告警模板，用于阈值超标时给予告警及通知。

- 虚拟机监控图表：通过虚拟机详情页面的监控信息栏可查看单台虚拟机的监控信息，包括 网卡出/入带宽、网卡出/入包量、磁盘读/写吞吐、磁盘读/写次数、平均负载、空间使用率、内存使用率、CPU使用率；
- 弹性 EIP 监控图表：通过 EIP 详情页面的监控信息可查看单个 EIP 资源的监控信息，包括网卡出带宽使用率、入带宽、出带宽、入包量、出包量；
- 负载均衡监控图表：通过负载均衡详情页面的监控信息可分别查看负载均衡实例和VServer监听器的监控信息，监控图表包括LB每秒连接数、LB每秒网卡出/入流量、LB每秒网卡出包数量、VServer 连接数、HTTP 2XX、HTTP 3XX、HTTP 4XX、HTTP 5XX；
- NAT 网关监控图表：通过 NAT 网关详情页面的监控信息可查看单个 NAT 网关的监控信息，包括网卡入带宽、网卡出带宽、连接数、网卡入包量、网卡出包量。
- MySQL 服务监控图表：通过 MySQL 服务详情页面的监控信息可查看单个 MySQL 服务的监控信息，包括CPU使用率、内存使用率、磁盘使用率、TPS、网卡出/入带宽、表锁、QPS、DeletePS、InsertPS、全表扫描、SelectPS、UpdatePS、连接数、慢查询、线程活跃数、连接线程数等。
- Redis 服务监控图表：通过 Redis 服务详情页面的监控信息可查看单个 Redis 服务的监控信息，包括内存使用量、内存使用率、连接数量、QPS、RedisKeys、RedisExpiredKeys、RedisEvictedKeys、命中数量、未命中数量、命中率、网卡出/入带宽等。
- VPN 网关监控图表：通过 VPN 网关服务详情页面的监控信息可查看单个网关的监控信息，包括网关出/入带宽、网关出带宽使用率、网关出/入包量。
- VPN 隧道监控图表：通过 VPN 隧道服务详情页面的监控信息可查看单个隧道的监控信息，包括隧道出/入带宽、隧道出/入包量及隧道健康状态。

监控图表可根据时间维度展示实时监控数据，同时支持查看 1 小时、6 小时、12 小时、1 天及自定义时间的监控数据及图表信息。

## 18.2 告警模板

告警模板是 UCloudStack 平台监控告警服务为用户提供的一种批量设置资源告警的功能，通过预先定义模板中的告警规则及通知规则，将模板中定义的规则应用到虚拟资源；若虚拟资源的监控指标数据达到或超过告警规则中设定的阈值及条件，则根据通知规则中定义的通知方式发送告警通知到指定的通知联人。

根据不同的资源类型，可定制不同监控指标及阈值的告警规则，并可选择将监控指标应用至关联资源的单个网卡或磁盘设备，满足多种应用场景下的监控报警需求。

- 告警模板是由多条告警规则及关联资源构成的；
- 一个告警模板仅支持绑定一种类型资源，包括虚拟机、外网弹性 IP、NAT 网关、负载均衡、Redis、MySQL 及 VPN 网关等；
- 每个告警模板可包含多条告警规则，每条告警规则包含监控对象、设备名称、对比方式、告警阈值、探测周期、触发周期、收敛策略及通知组；
- 每个告警模板仅支持绑定一个通知组，每个通知组可包含 多个通知人，支持短信和邮件的通知方式。

### 18.2.1 创建告警模板

用户可指定资源类型、模板名称及备注快速创建一个告警模板，在告警规则管理中创建配置适用于业务需求的告警规则，最后将告警模板关联至虚拟资源，完成监控告警的配置。用户可通过控制台导航栏“监控”进入监控告警配置控制台，通过“告警模板”页面的“**创建**“按钮进入告警模板创建向导页面，如下图所示：

![createalarm](../images/userguide/createalarm.png)

- 资源类型：告警模板需绑定资源的类型，包括虚拟机、外网弹性 IP、NAT 网关、负载均衡、Redis、MySQL 及 VPN 网关等，一个告警模板仅支持一种资源类型；
- 模板名称/备注：告警模板的名称标识及全局唯一标识符；

点击确定后，向导页面即返回告警模板列表，通过告警模板列表即可查看已创建的资源列表及信息。

### 18.2.2 查看告警模板

用户可通过导航栏进入告警模板资源控制台查看告警模板的资源列表，同时可通过点击列表上告警模板的名称进入模板详情页面，用于查看告警模板的详细信息、告警规则管理及绑定资源的管理。

#### 18.2.2.1 告警模板列表

告警模板列表页面可查看当前账号下已拥有的模板列表，包括名称、ID、资源类型、绑定资源数量及操作项，如下图所示：

![alarmlist](../images/userguide/alarmlist.png)

- 名称/ID ：当前告警模板的名称和全局唯一标识符；
- 资源类型：当前告警模板创建时所指定的资源类型；
- 绑定资源数量：当前告警模板已关联的资源数量；
- 操作：对单个告警模板的操作项，包括详情、查看资源及删除；
- 可通过搜索框对资源列表进行搜索和筛选，支持模糊搜索。

#### 18.2.2.2 告警模板详情

通过告警模板列表的“名称”进入模板详情页面，可查看当前告警模板的详情信息，如下图所示，详情页面分为基本信息、告警规则管理及资源绑定管理：

![alarmdetails](../images/userguide/alarmdetails.png)

- 基本信息：当前告警模板的基本信息，包括名称、ID、资源类型、已绑定的资源数量等信息，其中已绑定的资源数量若为空时，显示为 “0” ；
- 告警规则管理：当前告警模板的告警规则管理，包括告警规则的创建、查看、更新、删除等，具体管理操作详见：[告警规则管理](#13.2.5 告警规则管理) ；
- 资源绑定管理：当前告警模板关联资源的管理，即告警模板中的规则可生效的资源，包括绑定资源、已绑定资源查看及解绑资源，具体管理操作详见：[绑定资源管理](#13.2.6 绑定资源管理) 。

### 18.2.3 查看资源

查看资源指查看当前告警模板已绑定资源的信息，点击后可进入 [绑定资源管理](#13.2.6 绑定资源管理) 。

### 18.2.4 删除告警模板

仅当告警模板中未绑定任何资源时才可进行删除操作，被成功删除的告警模板将直接被销毁。用户可通过监控告警模板资源控制台中的“**删除**”进行模板的删除操作，如下图所示：

![rmalarm](../images/userguide/rmalarm.png)

删除告警模板操作被确认后，系统自动返回至告警模板列表页面，在列表页面可查看删除过程，待该资源被清空时即成功删除。

### 18.2.5 告警规则管理

告警规则是告警模板的核心，每个告警模板均由 1 条或多条告警规则组成。被绑定至告警模板的资源监控指标数据会根据告警规则中定义的阈值触发相关告警策略，并通过告警规则中的通知方式进行告警信息的通知，以便快速入处理告警或故障。

#### 18.2.5.1 创建规则

用户可通过告警模板详情页面的“**创建**”功能进行告警规则的创建，创建告警规则时需指定监控对象、设备名称、对比方式、告警阈值、探测周期、触发周期、收敛策略及通知组等参数，如图所示：

![alarmrule](../images/userguide/alarmrule.png)

- 监控对象：即监控指标，仅可选择告警模板资源类型所包含的监控指标，一条告警规则仅支持一个监控指标：
- 对比方式：指监控指标的实际数据与告警阈值的比较方式，代表当前告警规则的告警逻辑，包括 `>=` 或 `<=` ：
  - 当选择 `>=` 时，即代表监控数据大于或等于阈值时触发一次告警周期；
  - 当选择 `<=` 时，即代表监控数据小于或等于阈值时触发一次告警周期；
- 告警阈值：指监控指标数据的临界值，与监控指标数据进行对比，符合对比方式即触发一次告警周期，如 CPU 使用率的告警阈值为 80，对比方式为大于等于，即 CPU 使用率大于等于 80% 即触发一次告警周期；
- 探测周期：对监控指标的数据检测的最小周期，即每隔多长时间收集一次监控数据，默认值为 30s ；
- 触发周期：监控数据达到阈值条件的连续周期，即监控指标数据连续 N 次符合阈值条件即触发一次告警周期；若触发周期为 1 次，即代表触发一次告警周期就进行告警；
- 收敛策略：发生告警后发送通知给通知组的频率，可选择连续告警、指数递增、单次告警：
  - 连续告警：即每次到达触发周期即发送告警通知；
  - 指数递增：即以 2^N 时间递增告警延迟；
  - 单次告警：触发告警周期后，仅告警并通知一次，告警恢复后重新激活；
- 通知组：即触发告警周期且需要发送通知时，发送告警通知的方式及联系人。

选择并配置完成后，点击确定可返回告警模板详情页面，通过告警规则列表可查看已创建成功的告警规则。

#### 18.2.5.2 查看规则

可通过告警模板详情页面查看当前模板包含的规则列表，列表信息包括监控对象、设备名称、对比方式、告警阈值、探测周期、触发周期、收敛策略、通知对象及操作项，如下图所示：

![alarmrulelist](../images/userguide/alarmrulelist.png)

其中操作项是指对单条通知规则的操作，包括更新及删除，分别指对单条告警规则的修改和删除。

#### 18.2.5.3 更新规则

更新规则是指对单条告警规则的修改，修改项的选择与配置与创建告警规则相同，可参考 [创建规则](#_17251-创建规则) 。

#### 18.2.5.4 删除规则

删除告警规则指对单条告警规则的删除。规则被删除后即直接销毁，可重新添加该监控指标的告警规则。

### 18.2.6 查看绑定资源

通过告警模板详情的资源标签，进入告警模板资源绑定管理页面，可查看已绑定资源的列表及信息，包括绑定资源的 ID、类型、地址、可用区等，如下图所示：

![relist](../images/userguide/relist.png)

## 18.3 通知组管理

通知组是指监控报警发送告警通知的方式及联系人信息，通过对用户邮箱电话信息的收集，将不同资源告警通过邮件或短信的方式通知给通知人，以便划分全责，精细化处理告警通知。

- 通知组是一组通知人的组合，可以包含一个或多个联系人；
- 同一个联系人，可以加入多个通知组；
- 通知方式包括邮件通知、短信和邮件通知。

在使用监控告警模板时，需要先创建一个通知组，添加相关联系人信息，并设置通知组的通知方式，以便关联告警模板，通知组具体管理详见下文。

### 18.3.1 创建通知组

用户可通过控制台导航栏“监控”进入监控告警配置控制台，切换至“**通知组**”页面进行通知组管理页面的“**创建**”按钮进入通知组的创建向导页面，如下图所示指定通知组名称及通知方式进行创建操作：

![createnotice](../images/userguide/createnotice.png)

- 通知组名称：当前需要创建的通知组名称及标识；
- 通知方式：当前需要创建的通知组通知方式，即触发告警通知时通过什么渠道通知用户，包括邮件通知和短信通知等方式；

点击确定后，进入通知组列表页面，可查看已创建的通知组信息，并对通知组进行相关操作及管理。

### 18.3.2 查看通知组

用户可通过监控告警控制台进入通知组页面查看通知组列表信息，同时可通过点击列表上通知组的 ID 进入详情页面，用于查看通知组的详细信息及通知人的管理。

#### 18.3.2.1 通知组列表

通知组列表页面可查看当前账号下已拥有的通知组列表，列表信息包括 ID、名称、通知方式及对单个通知组的操作项，如下图所示：

![noticelist](../images/userguide/noticelist.png)

- 名称/ID ：通知组的名称标识及全局唯一标识符；
- 通知方式：当前通知组的通知方式；
- 操作：对单个通知组的操作项，包括详情、更新、删除等。

#### 18.3.2.2 通知组详情

通过通知组列表的 `ID` 进入通知组详情页面，可查看当前通知组的基本信息，并可通过通知人管理进行通知联系人的管理，如下图所示：

![noticedetails](../images/userguide/noticedetails.png)

- 基本信息：当前通知组的基本信息，包括通知组 ID、名称及通知方式；
- 通知人管理：当前通知组的通知联系人管理，包括通知人的创建、查看、更新及删除，详见[通知人管理](#13.3.5 通知人管理) 。

### 18.3.3 更新通知组

更新通知组是指对单个通知组的修改，修改项的选择与配置与创建通知组相同，可参考 [创建通知人](#13.3.1 创建通知组) 。

### 18.3.4 删除通知组

删除通知组前需确认通知组未被绑定至任何一个告警规则中，若已被添加至一个告警规则，则无法删除。被成功删除的通知组即被销毁，需用户确认才可成功删除。用户可通过通知组控制台列表操作项中的“删除”进行通知组删除，如下图所示：

![noticerm](../images/userguide/noticerm.png)

### 18.3.5 通知人管理

通知人是指告警规则发送通知的具体联系人，包括联系人姓名、手机、邮箱等信息。每个通知组可添加 1 个或多个通知人，根据通知组通知方式的不同，在资源发生告警时会发送邮件或短信至所有通知人。

#### 18.3.5.1 添加通知人

用户可通过通知组详情页面的“**创建**”功能进行通知人的添加，创建通知人时需指定通知人姓名、电话、邮箱等参数，如下图所示：

![contact](../images/userguide/contact.png)

- 通知人名称：指当前需要创建的联系人姓名或昵称；
- 通知人邮箱：指当前需要创建的联系人邮箱地址；
- 通知人电话：指当前需要创建的联系人手机号码。

点击确定后，即可成功创建一个通知联系人，可通过通知组详情的通知人列表查看联系人信息。

#### 18.3.5.2 更新通知人信息

更新通知人信息是指对单个通知人的信息进行修改，睡改项的配置与创建通知人规则相同，可参考[创建通知人](#13.3.5.1 添加通知人)。

#### 18.3.5.3 删除通知人

删除通知人指对单个通知人进行删除，通知人删除后即直接销毁，可重新添加联系人信息。

## 18.4 告警记录

告警记录是指当前账户所有告警记录及信息，通过告警记录可查看 1 小时、6 小时、12 小时、1 天、7 天、15 天及自定义时间周期的历史告警信息：

![alarmrecord](../images/userguide/alarmrecord.png)

如上图所示，告警记录列表信息包括告警的 ID、指标名称、资源ID、资源类型、地域、可用区、告警时间、恢复时间、阈值及当前值：

- 告警 ID ：指当前告警记录的全局唯一标识符；
- 指标名称：触发当前告警记录的资源监控指标项，即数据来源；
- 资源类型/资源：触发当前告警记录的资源类型及资源；
- 地域/可用区：触发当前告警记录的资源所在地域和可用区；
- 告警时间：即当前告警记录的告警触发时间：
  - 当前值达到阈值条件时，则展示具体告警时间；
  - 当前值未达到阈值条件，即告警恢复后，告警时间展示“**解除告警**”；
- 恢复时间：即当前告警记录资源监控指标数据恢复正常的时间：
  - 当前值达到阈值条件，即告警中时，显示为“告警”；
  - 当告警恢复后，则展示资源监控指标数据恢复正常的时间；
- 阈值：触发当前告警记录的资源告警规则中设置的阈值；
- 当前值：即触发告警或恢复告警时当前告警记录监控指标的数据值。

# 19 操作日志

操作日志是指用户在控制台或 API 对资源进行的操作行为及登录登出平台的审计信息。操作日志会记录用户在平台中的所有资源操作，提供操作记录查询及筛选，通过操作日志可实现安全分析、资源变更追踪以及合规性审计。

租户通过操作日志控制台可查看整个平台属于用户所有的资源操作及平台登录登出审计日志等，同时也可通过 API 查询租户内所有资源的操作日志及审计信息。支持查看 1 小时及自定义时间的日志信息，最长可查询 6 个月的操作日志信息。具体信息包括操作（API）名称、所属模块、关联资源、操作者、操作结果、备注及操作时间，如下图所示：

![log](../images/userguide/log.png)

* 操作（API）名称：指操作日志的操作名称，包括调用 API 的接口名称及操作的界面展示名称，如调整带宽。
* 所属模块：指操作日志操作的资源类型，包括裸金属、虚拟机、虚拟机模板、镜像、VPC、云硬盘、弹性网卡、外网 IP、安全组、负载均衡、NAT 网关、VPN 网关、自动伸缩、监控告警模板、定时器、账户等。
* 关联资源：操作日志对应的资源标识符，并可查看一个操作中所有关联的资源标识，如绑定弹性 IP 对应的虚拟机 ID 和外网 IP 的 ID 。
* 操作者：操作日志对应的操作者，可追溯到具体的主账号和子账号。
* 操作结果：操作日志的结果，如操作成功、操作失败、参数异常、存储集群物理资源不足等。
* 备注：操作日志的备注信息。
* 操作时间：操作日志的操作时间。

**为方便用户便捷的查看操作审计日志，控制台支持日志的筛选和搜索检索，同时支持对导出用户的操作审计日志为 本地 Excel 表格，方便账户管理和运营。**

操作日志查询筛选功能可支持所属模块、操作状态及查询时间范围等纬度。所属模块支持所有产品模块的筛选，同时支持查看全部资源的日志及审计信息，即不对所属模块进行筛选；操作状态支持状态为成功、失败的日志筛选，同时也支持查看全部状态的日志和审计信息；查询时间范围支持 1 小时及自定义时间的日志筛选，最长可查询半年的操作日志。

> **操作日志不记录用户在虚拟机内部进行的操作和审计**。

# 20 回收站

## 20.1 回收站概述

回收站是指资源删除或欠费自动释放的暂时保留区，用户删除的资源包括虚拟机、磁盘、EIP、自制镜像等资源，会在删除后自动进入回收站中。

进入回收站中的资源会默认保留一个时间，平台默认保留时间为 360000 秒，可通过云平台管理员进行自定义保留时间的设置。**保留期间可对资源进行恢复、续费及销毁操作，保留时间到期后，资源会被彻底销毁，不可恢复。**

## 20.2 查看回收站资源

云平台资源被用户手动删除及费用过期时，会自动进入回收站暂时留存。在留存期间可到回收站控制台查看已进入回收站的资源列表，如下图所示：

![recycle](../images/userguide/recycle.png)

通过回收站资源列表可查看当前账户下已被删除或释放的留存资源信息，包括资源 ID、资源名称、资源类型、过期时间、删除时间、是否自动销毁、预定销毁时间及操作项：

- 资源名称/ID：当前留存资源的名称及全局唯一标识符；
- 资源类型：当前留存资源的资源类型，包括虚拟机、硬盘、外网 IP、自制镜像等；
- 过期时间：指当前资源的费用过期时间，仅当资源类型为需计费的资源时有效，如虚拟机、磁盘、外网 IP ；
- 删除时间：指当前留存资源被手动删除或费用过期进入回收站的时间；
- 是否自动销毁：指当前留存资源是否会在留存期间自动销毁，可通过云平台管理控制台设置保留期后是否自动销毁资源：
  - 若云平台全局配置为回收站资源自动销毁，则到达保留期后，将自动销毁资源；
  - 若云平台全局配置为回收站资源不自动销毁，则资源将永久留存在回收站，可通过手动恢复或销毁资源；
- 销毁时间：指当前留存资源将被自动销毁的时间，仅当云平台全局配置为回收站资源自动销毁时有效。

列表上操作项是指对单个资源的操作，包括恢复、续费及立即续费等操作，其中续费操作仅在资源类型为需计费的资源时有效，可通过搜索框对资源列表进行搜索和筛选，支持模糊搜索。

为方便租户对回收站资源的维护，支持对进入回收站的资源进行批量操作，包括批量恢复资源、批量销毁资源及批量续费资源。其中批量续费资源会按照资湖泊 的计费方式自动续费一个周期，如按时计费的资源，则自动续费一个小时；按月购买的资源，则自动续费一个月。

## 20.3 恢复资源

恢复资源是指手动恢复被误删而进入回收站的资源。

- 若资源被用户手动删除且无欠费的情况下，可直接通过恢复资源操作进行恢复；
- 若资源因账户欠费而自动进入回收站，则恢复资源时，需联系云平台管理员对账号进行充值后，通过“**续费**”操作对资源进行续费后，在进行资源恢复；
- 若全局未开启资源自动续费且账户余额充足，资源过期后会自动进入回收站，恢复资源时，需要先通过“**续费**”操作对资源进行续费后，在进行资源恢复。

用户可通过回收站留存资源列表的“**恢复**”操作项进行资源的恢复，若资源资源费用已过期，需要先进行续费才可进行恢复操作。具体恢复操作如下图所示：

![restore](../images/userguide/restore.png)

点击确定后，当前资源会自动恢复至被删除前的资源列表，可通过相关资源列表进行查看。若资源为欠费状态，则界面会提示用户，资源已欠费，需要先进行充值或续费，才可进行资源恢复。

## 20.4 续费资源

续费资源是指对资源的费用周期进行续费，仅支持需计费的资源进行“**续费**”操作。因欠费或费用到期自动进入回收站的资源被成功续费后，才可进行恢复操作。资源续费的周期根据计费方式会有所区别：

- 资源按按小时计费时：一次续费操作可续费 1 个小时，N 次续费操作即续费 N 个小时；
- 资源按月计费时：一资续费操作可续费 1 个月，N 次续费操作即续费 N 个月；
- 资源按年计费时：一资续费操作可续费 1 年，N 次续费操作即续费 N 年的费用周期。

用户可通过回收站留存资源列表的“**续费**”操作项进行资源续费操作，若账户已欠费，需先联系管理员对账户进行充值后在进行续费操作。具体续费操作如下图所示：

![renew](../images/userguide/renew.png)

点击确定后，返回至回收站留存资源列表，在列表页可查看被续费资源的过期时间被延长一个计费周期。

## 20.5 销毁资源

销毁资源是指手动销毁留存在回收站的资源，资源被销毁后无法恢复，需确认是否有必要销毁资源。具体操作如下图所示：

![destroy](../images/userguide/destroy.png)

点击确定后，该资源将从留存资源列表清空，无法恢复，请慎重操作。

# 21 组织和账号管理

组织和账号管理主要为企业用户提供组织架构管理，支持多租户模式，每个租户可代表一个组织/公司/子公司/部门。

**概念解释**

- **租户**

  平台支持多租户模式，用于有多级组织架构的企业，可将租户作为一个单独的公司/子公司/部门进行运营，有效实现权限管理，除低总公司、子公司及不同部门资源混用可能造成的风险，并可实现资源审计。

  租户是平台中一组资源的集合，提供资源隔离、子账号、权限控制、配额及价格配置等能力。不同租户间资源通过 VPC 网络及权限实现强隔离；租户内所有主账号和子账号的资源、费用、配额及审批均归属于租户。

- **账号**
  - **主账号**：一个租户默认有一个主账号，主账号即为租户下的初始管理人员，默认有租户下所有资源的管理权限以及组织管理权限。主账号可通过创建子账号，并管理子账号的权限。
  - **子账号**：子账号是主账号创建的用户，子账号在租户下的权限由主账号控制。一个租户可拥有多个子账号，支持对子账号进行资源管理的权限控制。
- **人员**：企业中的人员，人员需要使用账号登录云平台使用资源。
- **角色**：权限的集合，为用户和成员组赋予权限可获得调用相关API进行资源操作的能力。
- **项目组**：以项目组为维度进行资源规划，可为一个具体项目或者业务建立独立的资源池，实现资源更细粒度地管理。同时针对子账号的授权也是基于项目组维度进行授权。项目组只是逻辑上面的分组，不具有资源隔离的作用。
- **流程审批**：为了满足企业对核心云资源，如虚拟机、云硬盘、外网IP等资源使用的管控需求所引入的云资源工单审批流程。
- **审批管理**：审批管理仅平台管理员admin可以进行操作。

## 21.1 我的账号

可在账号和组织/我的账户页面可以查看账户基本信息并进行账号安全设置。

账户基本信息包括账户 ID、角色 ID、账户名称、账户邮箱、手机号码、现金余额、赠送余额、信用余额及创建时间等信息。

- 账号 ID /角色 ID：当前登录平台账号的 ID 及角色 ID ；
- 账户名称：当前登录平台账号的账户名称或昵称，可直接通过编辑按钮进行修改，支持中文、英文或字符；
- 账户邮箱：当前登录平台账户的邮箱地址；
- 现金余额：指通过支付宝、微信、银行及新浪支付充值的金额；
- 赠送余额：指优惠券及其它渠道赠送的余额，一般由平台管理员进行充值；
- 信用余额：指优惠券及其它渠道赠送的余额，一般由平台管理员进行充值；
- 创建时间：指当前账户的注册时间或创建时间。

账户安全是平台为用户账户提供的安全防护功能，可通过定期修改登录密码、开启双子因验证登录保护，设置访问限制以保证登录账号的安全。对于需要调用API 用户，云平台可为开发者提供 API 公钥和私钥信息，可通过复制密钥信息用于操作 API 指令，具体操作方式可参考 API 开发者手册。

### 21.1.1 修改登录密码

平台支持用户修改账号登录密码，可在我的账户页面对密码进行修改。

> 修改密码需要验证旧密码，若忘记旧密码，可联系管理员在后台帮助修改密码。

### 21.1.2 开通登录保护

平台提供基于 TOTP（Time-Based One-Time Password Algorithm）的免费登录二次认证服务，开通本服务后，账号登录控制台均需通过授权认证。开通登录保护的前提条件如下：

（1）开通对象为独立主账号或子账号；

（2）移动设备上安装有 FortiToken 或其他基于 TOTP 技术的令牌工具；

（3）推荐使用 FortiToken 。

![openfortitoken](../images/userguide/openfortitoken.png)

> 为了降低用户账号密码泄漏造成的风险，建议您开通账号登录二次认证

#### 21.1.2.1 开通步骤

1. 登录控制台并进入账号与组织管理页面，在我的账户页面，可查看当前登录保护设置。未设置情况下，可点击“设置”按钮开启登录保护。

2. 检查移动设备上是否安装 FortiToken ：

   - 页面提供 IOS 和 Android 用户工具下载地址，若您未安装 FortiToken 可通过扫码下载。
   - 安卓手机用户也可以通过手机品牌商提供的应用商店搜索和下载 FortiToken 。

3. 打开 FortiToken 工具，扫码获取授权码，也可手动输入密钥获取授权码。

4. 在页面方框内输入获取到的授权码，完成绑定。

#### 21.1.2.2 关闭登录保护

登录控制台并进入账号与组织管理页面，在我的账户页面，可查看当前登录保护设置。已设置情况下，如果需要关闭登录保护设置，可点击“设置”按钮。按照页面提示获取并输入授权码即可关闭二次认证功能。

#### 21.1.2.3 功能应用

二次认证服务开通后，账号密码登录平台时会要求输入认证码，系统判断认证码有效后，即可成功登录平台。

#### 21.1.2.4 登录保护 FAQ

Q：如何下载 FortiToken ？

A：账号绑定页面提供 ISO 和 Android 工具下载链接，可选择通过移动设备扫码下载。若使用的是基于 Android 系统的移动设备，可通过移动设备本身提供的应用下载市场搜索和下载 FortiToken 身份认证器。

------

Q：FortiToken 无法扫描获取授权码怎么办？

A：可切换至手动获取，手动输入账号密钥绑定并获取授权码。

------

Q：是否可以用其他工具绑定账号？

A：若使用的是 FortiToken 身份认证方式，可以用基于 TOTP 算法的其他动态令牌工具绑定账号，如微信小程序“二次验证码”等，75为安全起见，推荐使用谷歌官方 “FortiToken” 。

### 21.1.3 登录访问限制

为进一步保障账号安全，平台提供登录访问限制能力，主账号可为租户设置可登录控制台和访问平台API的客户端API地址。配置后租户下的所有账号只能从指定的 IP 登录或发起 API 访问，有效保证账户登录及资源的安全性。

* 支持配置多个 IP 地址或 IP 地址段，多个 IP 地址/段间使用英文逗号进行分隔。
* 配置的 IP 地址 或 IP 地址段为白名单模式，即配置的 IP 地址/段客户端才可正常登录控制台或访问 API 。
* 默认不指定任何 IP ，代表不限制登录控制台和访问 API 的客户端 IP 地址，即默认全网可访问登录控制台。

> 如果出现登录 IP 地址设置错误，导致租户下所有账号均无法登录时，可联系平台管理员通过管理控制台侧修改租户的登录访问限制策略。

主账号可通过【账户安全】中“登录访问限制”功能进行登录策略配置，如下图所示，默认为空代表全网无限制。

可在登录访问范围内输入可登录平台的 IP 地址或 IP 地址段，点击确认即可生效。配置成功后，用户使用账号在未指定的 IP 网络中无法正常登录控制台，并提示当前的 IP 地址，如下图所示：

平台仅可限制访问控制台的 IP 地址，即直接请求到控制台 URL 地址的客户端 IP 地址，如用户访问平台的客户端地址在 NAT 路由内，则平台配置登录策略时，需要放通 NAT 后的 IP 地址，即需要将 NAT 后的出口地址配置在登录访问策略的白名单中，保证 NAT 路由器内的客户端均可正常访问控制台。

### 21.1.4 API 密钥

通过账户安全租户可查看属于当前账号的 API 密钥 ，用于管理并使用 API 接口。可通过点击复制按钮进行公私密钥的信息复制，以方便 API 指令的调用。

## 21.2 查看租户配额

可在账号和组织/配额信息页面查看租户下配额限制以及配额当前使用情况。

**配额（quota**）是一个租户在单个地域下可创建的云资源上限。通过限制每个账户拥有的资源配额，可合理分配云平台资源，提升资源利用率的同时，满足云平台上每一个账户的资源需求。租户初始化时，在每个数据中心都拥有默认配额。同时，云平台管理员可自定义每个租户的资源配额。

租户下的每个人员在使用账号创建资源时，创建数量的上限不能够超过租户下配额上限。如租户中云硬盘的配额为 10 ，则主账号和子账号可创建的云硬盘数量上限不可超过 10 个。配额列表的字段如下：

- 产品类型：当前配额信息的资源类型，平台支持的资源配额包括虚拟机、镜像、VPC、硬盘、弹性网卡、外网 IP 、负载均衡、安全组、 NAT 网关、Redis、MySQL、VPN 网关、VPN 隧道。
- 地域：当前配额信息的地域信息，代表一个地域可创建的资源配额，支持某个地域或全部地域；
- 数量：当前配额项在一个地域或全部地域可创建的资源数量；
- 更新时间：当前配额项的修改更新时间。

## 21.3 项目组管理

在账号和组织管理/项目组管理页面，可对项目组进行查看和管理。项目组可以帮助进行资源分组管理，帮助解决资源的精细化管理以及授权管理等复杂性问题。

> 未被分组的资源所有用户都对其具有查看和管理的权限，分组的资源根据用户的角色授权决定用户是否对组中资源具有权限。

### 21.3.2 创建项目组

项目组可以帮助您进行资源编组管理，并且可以配合项目组对租户下人员进行精细化权限管理，建议您在租户开通后，就为租户规划好项目组。

创建项目组时输入参数：名称和备注。创建完毕后，可以通过转入/转出资源管理项目组内对资源。

> 租户下有项目组时，主账号创建资源可以指定项目组或者选择不分组，不分组的资源只有主账号能够查看和管理。子账号创建资源时，必须选择项目组。

### 21.3.3 项目组管理

支持对项目组进行资源管理，通过转入转出资源来管理项目组下的资源。转入资源到项目组时，可以选择不在当前项目组下的所有资源，可以在资源列表处查看到资源所属项目组。

转出资源到其他项目组时，只能够指定当前项目组下的资源，且转出到的项目组只能够时其他项目组。资源被转出到其他项目组后，有该项目组授权的用户将无法再查看和管理此资源。
![transferresource1](../images/userguide/transferresource1.png)

> 资源转入/转出时以产品类型为维度，一次可以转入/转出同一产品类型下的多个资源。VPN网关、负载均衡、伸缩组中有多个维度的资源，请在转入转出时注意将关联资源分配到同一组内。

支持修改项目组名称和备注。

支持删除项目组，删除项目组不会影响资源，删除项目组后所有资源不再归属于任何项目组。您可以再将资源转入到其他项目组中。

> 项目组下存在角色授权时，需要先移除角色授权后，才能够删除项目组。

## 21.4 角色管理

在账号和组织管理/角色管理页面可查看和管理租户下所有的角色。角色分为两种类型，系统内置角色和自定义角色。其中，系统内置角色是平台提供给用户，以快速授权的角色给子账号，不能够编辑和删除。目前内置角色包括管理员和只读用户两个：
- 管理员
此角色中包含了租户下所有云资源操作和组织管理操作的授权。如果您不需要对子账号进行精细地权限管理，可直接使用系统管理员为子账号进行角色授权，更快捷地进行操作。
- 只读用户
此角色仅包含所有资源和组织管理功能的查看权限。

### 21.4.1 创建角色

可通过创建角色创建出一个自定义角色，创建角色时需要输入以下信息：
名称：为角色设置合适的名称。
备注：可选项
权限设置：可分产品类型，按照查看、增加、编辑、删除的四个维度授权每个产品的操作权限，也可以根据实际使用需求，只勾选某几项权限。

> 创建角色时，系统默认勾选的操作，为各个模块必须要授权上的操作，建议不要取消，避免影响授权的完整性。如果您不需要为用户授权某个模块的权限，可以取消默认勾选的操作。
![CreateRole](../images/userguide/CreateRole.png)

### 21.4.2 管理角色

可对角色进行编辑、修改名称和备注、删除、查看角色详情以及查看角色的授权记录。

点击进入详情页面，查看和更新角色的权限集合，可以更新每个产品类别下的任意权限的授权。

> 更新角色授权的权限集合后，用此角色授权的用户，在授权范围下的权限也会更新。

![roledetails](../images/userguide/roledetails.png)

## 21.5 人员管理

支持通过人员管理对租户下所有账号进行管理，建议谨慎地创建和管理组织下的账号，并为账号添加上适当的角色授权，防止权限扩大化，导致资源管理的混乱，影响企业IT资源使用的安全。

### 21.3.1 创建子账号

具有子账号创建权限的账号，可以在账号和组织管理/人员管理页面创建子账号。创建子账号需要输入以下参数：

- 账户名称: 为账户指定一个具有标志性的名称
- 邮箱：账户的电子邮件地址，必须实际有效的邮箱地址；
- 密码/确认密码：新建子账号的登录密码，密码须包含有大小写字母、数字、符号中的两种，密码长度为 `6-20` 个字符。
- 首次登录强制修改密码：可设置账号首次登录是否需要强制修改密码。
- 授权范围：可以选择可子账号授权所有项目组资源/指定项目组资源。当资源没有项目组时
- 角色：为子账号在授权范围下授权合适的角色，支持同时授权多个角色，最后生效的权限为多个角色所允许操作的集合。

![createsubaccount](../images/userguide/createsubaccount.png)

> 创建子账号前，建议先通过项目组对资源进行编组，并配置好子账号需要授权的角色。如果不需要授权自定义角色，可直接使用系统内置角色。

用户使用子账号登录后，可以正常查看一切操作，在进行相关操作时，会提示“权限不足”。比如一个用户未被授权查看虚拟机的权限，则在虚拟机列表处看到如下提示。
![nopermit](../images/userguide/nopermit.png)

### 21.3.2 查看账号列表

可在人员管理界面查看租户下所有账号列表和详情信息。租户下默认有一个主账号，可以有多个子账号。列表参数如下：

- 账户ID ：当前账号在云平台全局的唯一标识符；
- 账户名称：当前账号的名称；
- 邮箱：当前账号的登录邮箱地址；
- 类型：标识账号为主账号还是子账号
- 状态：当前账号的状态，包括使用中、冻结中、删除中：
  - 使用中的用户可登录控制台，并可使用并管理资源；
  - 冻结中的用户无法登录控制台，并禁使使用并管理资源；
- 操作项：对单个账号的操作项，包括查看详情、冻结和解冻、添加角色授权、删除

#### 21.3.2.2 子账号详情

子账号详情页面可查看基本信息和角色授权记录，并管理子账号的角色授权

- 基本信息：当前子账号的基本信息，包括 ID、角色、账户邮箱及创建时间、更新时间；
- 角色管理：可管理子账号的角色授权，包括添加新的角色授权和移除已有的授权角色。

### 21.3.3 冻结账户

冻结账户是指将一个子账号进行锁定，冻结后将不允许登录控制台。仅支持状态为“**使用中**”的账号进行冻结操作，用户可点击子账号列表操作项中的“冻结”对子账号进行冻结。

> 租户下的主账号不能够进行冻结和解冻操作，平台管理员可对租户进行冻结，冻结后主账号和所有子账号都被冻结。

### 21.3.4 解冻账户

解冻账户是指解冻一个已冻结的账号，被成功解冻的的用户，可登录管理控制台。仅支持状态为“**冻结中**”的账号进行解冻操作，用户可点击子账号列表操作项中的“解冻”对子账号进行解冻。

###21.3.4 删除账户

可对账户进行删除，删除账号后用户无法再使用此账号密码登录平台。删除后，可以再使用账号邮箱在平台注册或者创建新的账号。

# 22 计费管理

计费管理为用户资源分配和使用提供计量计费服务，需计费的资源均支持按时、按年、按月三种计费方式，支持资源的计费、扣费、续费及过期回收等订单管理操作，同时基于基于账户提供充值、扣费等交易管理。子账号共享主账号的账户余额，通过子账号创建的资源可直接通过共享余额进行扣费，并可通过主账号或子账号查看账户的交易流水及订单明细。

平台资源计费均为预付费模式，即无论按时、按年、按月付费，在资源创建时都需保证账户余额可满足一个计费周期的扣费，下一个计费周期开始前即进行扣费。

- 按时计费：一小时为一个计费周期，资源按照每小时的单价进行预扣费；
- 按月计费：一个月（非自然月）为一个计费周期，资源按照每个月的单价进行预扣费；
- 按年计费：一年（顺延年）为一个计费周期，资源按照每年的单进行预扣费；

> 按年按月购买的资源支持随时升降级配置并在升级配置后自动补齐差价。

账户余额不足下一个计费周期时，资源即会自动进入回收站，需要对资源账号及资源进行续费操作后，才可恢复使用；对于 NAT 网关和负载均衡资源，账户余额不足下一个计费周期时，资源会自动进行删除。

云平台管理员在全局开启"**资源自动续费**"且**账户余额充足时**，则资源在下一个计费周期会进行自动续费操作；若云平台管理员在全局关闭"**资源自动续费**"且**账户余额充足时**，则资源在下一个计费周期会自动进入回收站，需在回收站对资源进行续费操作，并恢复资源。

资源在创建时，所有计费资源的计费计价均会通过资源计价器按照计费方式进行展示，用于确认订单的费用。每个计费周期内的资源均支持释放和删除，当账户余额不足时，可通过云平台管理员进行充值。

## 22.1 资源计价器

资源计价器为用户提供资源付费方式的选择，并展示付费模式下所有资源的费用信息及资源的"**购买**"确认按钮，如下图示例所示：

![buy](../images/userguide/buy.png)

- 计价器中付费方式支持用户选择时、月、年，分别代表按时计费、按月计费、按年计费，其中选择月和年时，可以选择购买的月份数量和年份数量。
  - 月份可选择 1 ~ 11 ，分别代表 1 个月或 11 个月；
  - 年份可选择 1~ 5 ，分别代表 1 年或 5 年；
- 合计费用指当前订单中所有计费资源一个计费周期的费用合计，如一个虚拟机订单中，包括指定的 CPU 内存、云盘(若有)、EIP(若有)等资源按照付费方式的费用合计。

点击立即购买后，即从账号余额扣除合计费用金额，并产生一个新购订单及一笔扣费的交易流水；若账号余额不足一个计费周期时，无法点击立即购买，需要先对账号进行充值，才可进行购买和创建资源操作。

## 22.2 订单管理

订单管理是平台为用户提供的订单查询及统计服务，通过订单管理可以查看平台账号及子账号所有订单记录，支持查看 1 天、3天、 7 天、14 天、1 个月及自定义时间的历史订单记录。对资源进行创建、续费或变更配置时，会分别产生新购、续费及升级等类型订单，如下图所示：

![orderlist](../images/userguide/orderlist.png)

- 订单号：指当前订单的全局唯一标识符；
- 资源 ID ：产生当前订单的资源标识符；
- 地域：当前订单资源所在的区域；
- 订单类型：当前订单的类型，包括新购、续费及升级三种类型；
  - 新购是指用户新创建的计费资源，包括虚拟机、云硬盘、弹性 IP、 NAT 网关及负载均衡等；
  - 续费是指预付费资源每一个计费周期续费时产生的订单，包括手动续费和系统自动续费；
  - 升级是指按月按年计费的资源变更配置时产生的续费订单，如升级带宽、升级虚拟机配置等；
- 订单金额：当前订单金额，即订单在新购所付的费用或升级时补的差价；
- 创建时间：当前订单记录的生成时间，如图上所示，一个按时计费的资源，每小时产生一条续费订单。

> 主账号与所有子账号的订单管理及数据相同，可通过一个账号查看所有订单记录。

## 22.3 交易管理

交易管理是平台为用户提供的账号金额相关的收支明细，包括扣费、充值及统计服务。通过交易管理可查看平台账号及子账号所有交易流深水记录，支持查看 1 天、3天、 7 天、14 天、1 个月及自定义时间的历史交易记录，如下图：

![translist](../images/userguide/translist.png)

- 交易单号：当前交易记录在全局唯一的 ID 标识符，一般扣费以 `trans` 开头，充值以 `trade` 作为开头；
- 交易类型：当前交易记录的类型，根据平台对资源的不同操作，分别包括充值和扣费：
  - 充值指平台管理员通过后台为租户进行的充值操作；
  - 扣费指系统针对每个资源的计费方式，在每个计费周期自动从账号余进行的扣费操作，如按小时计费的虚拟机，每小时按照单价进行一次扣费；
- 支出：当前交易记录所扣费的金额，仅当交易类型为扣费时有效，充值类型显示为 `0.00` ；
- 收入：当前交易记录进账的金融，仅当交易类型为充值时有效，扣费类型显示为`0.00` ；
- 免费余额：当前账户在当前交易记录发生后的当前余额；
- 交易时间：当前交易记录发生时间。

> 主账号与所有子账号的交易流水记录相同，可通过一个账号查看租户的整体收支记录。

# 23 容器服务

## 23.1 产品介绍
UCloudStack提供稳定可靠、通过CNCF一致性认证的，基于Kubernetes的容器应用管理服务。提供容器化应用的全生命周期管理，并与UCloudStack提供的分布式存储、负载均衡深度集成，让你轻松高效地在私有场景下构建云原生应用。

## 23.2 产品架构
虽然Kubernetes支持诸如NetworkPolicy、LimitRange、Quota、RBAC、Taint等隔离机制，但其本质上依然属于软隔离(Soft Multi-tenancy)，不能够有效地阻挡恶意用户（程序）对集群内部的其他用户（程序）发起攻击。
考虑到私有场景下依然会存在跨组织，跨企业的协作，需要防范不同租户（程序）之间互相攻击的情况出现，UCloudStack提供的容器服务需要具备强隔离(Hard Multi-tenancy)特性，每个UCloudStack上的租户均可申请自己的Kubernetes集群，不同租户之间的Kuberneters集群网络、权限、计算、存储完全隔离。

![k8sarch](../images/userguide/k8s_Service.png)

​																										UCloudStack容器服务逻辑架构



Master 默认三节点，节点为UCloudStack的虚拟机，通过keepalive实现apiserver高可用。Node 支持虚拟机和物理机，物理机必须是由UCloudStack纳管的物理机，否则无法加入集群。

另提供统一镜像仓库服务，不同租户无需另行搭建容器镜像仓库，只需要在仓库中创建私有命名空间即可。

![k8sarch](../images/userguide/k8s_arch.png)

​																												UCloudStack容器服务实现架构






## 23.3 相关概念

| 名称     | 对应字段    | 解释                                                         |
| -------- | ----------- | ------------------------------------------------------------ |
| 容器     | Containers  | Docker容器是通过镜像创建的可运行实例，一个节点可运行多个容器，容器之间相互隔离。 |
| Pod      | Pod         | Pod是Kubernetes管理的最小单位，一个Pod中可以有一个或多个容器。 |
| 命名空间 | Namespace   | 命名空间为Kubernetes提供虚拟的隔离作用。                     |
| 镜像     | Image       | Docker镜像是容器应用打包的标准方式，在部署容器化应用的时候选择。 |
| 集群     | Cluster     | 集群指运行所有容器时所需要的云资源的总合。                   |
| 节点     | Node        | 节点是运行工作负载的平台，其可以是虚拟机或物理机。每个节点都由Kubernetes控制平台管理。 |
| 管理节点 | Master Node | Kubernetes集群的管理节点，运行诸如调度器、控制器、ETCD等服务，一般情况下为3节点。 |
| 工作节点 | Worker Node | Kubernetes集群的工作节点，运行容器服务、公共服务等，至少为1节点. |



## 23.4 功能列表

| 序号 | 模块          | 功能                                                         |
| ---- | ------------- | ------------------------------------------------------------ |
| 1    | 集群管理      | 创建集群                                                     |
| 2    | 集群管理      | 删除集群                                                     |
| 3    | 集群管理      | 查看集群详情                                                 |
| 4    | 集群管理      | 查看/更新集群凭证                                            |
| 5    | 节点管理      | 添加节点                                                     |
| 6    | 节点管理      | 节点详情                                                     |
| 7    | 节点管理      | 删除节点                                                     |
| 8    | 节点管理      | 开启/关闭节点可调度性                                        |
| 9    | 命名空间管理  | 创建命名空间                                                 |
| 10   | 工作负载管理  | 支持表单创建或者YAML创建部署、守护进程集、任务、计时任务、有状态副本集、容器组 |
| 11   | 工作负载管理  | 支持删除、编辑、查看部署、守护进程集、任务、计时任务、有状态副本集、容器组 |
| 12   | 服务&路由管理 | 支持表单创建或者YAML创建服务&路由                            |
| 13   | 服务&路由管理 | 支持删除、编辑、查看服务&路由                                |
| 14   | 配置管理      | 支持表单创建或者YAML创建配置字典、保密字典                   |
| 15   | 配置管理      | 支持删除、编辑、查看配置字典、保密字典                       |




## 23.5 操作指南

### 23.5.1 集群管理

#### 23.5.1.1 创建集群

登陆UCloudStack控制台  — 导航栏【容器服务】— 【集群】— 【创建】

输入创建集群信息点击确认即可完成创建。


#### 23.5.1.2 删除集群

在集群概览页面勾选想要删除的集群，点击【删除】，完成二次确认后即可删除。



#### 23.5.1.3 查看集群详情

在集群概览页面点击想要查看集群的【详情】，进入集群查看页面。



#### 23.5.1.4 查看/更新集群凭证

集群凭证存放了用户访问和管理容器服务的配置文件信息，一般称为kubeconfig。凭证包含以下几个重要信息：

a. 集群名称及apiserver地址

b. 用户身份

c. 用户访问apiserver的证书



在集群详情界面，点击下方访问信息处的【更新凭证】即可进行更新；点击【内网】/【外网】即可查看对应凭证。

### 23.5.2 节点管理

#### 23.5.2.1 添加节点

登陆UCloudStack控制台  — 导航栏【容器服务】— 【集群】— 【节点管理】—【添加】

输入添加节点信息点击确认即可完成添加。



#### 23.5.2.2 节点详情

在节点管理界面点击想要查看节点的【详情】，即可进入节点详情界面。



#### 23.5.2.3 删除节点

在删除节点前，将率先驱逐该节点上的所有Pod，如果Pod驱逐失败，5分钟后将进行节点删除的操作，同时随Node节点一起创建的数据盘会被默认删除。

为了保证业务稳定运行，建议在删除节点前，人工驱逐该节点上的Pod。



在节点管理界面勾选想要删除的节点，点击【删除】，二次确认后即可删除该节点。



#### 23.5.2.4 开启/关闭节点可调度性

关闭可调度性将会阻止新的Pod调度至该节点，并不会影响已运行在该节点上的Pod。



在节点管理界面，点击开启/关闭按钮可以开关节点可调度性。

#### 23.5.2.5 Pod信息查看

在节点管理界面，点击【Pod信息】可以查看该节点内所有Pod的概览。

点击想要查看的Pod的【详情】，即可查看Pod详细情况。



### 23.5.3 命名空间管理

#### 23.5.3.1 创建命名空间

登陆UCloudStack控制台  — 导航栏【容器服务】— 【集群】— 【命名空间】—【创建】

输入命名空间名称后点击创建即可完成添加。



### 23.5.4 工作负载管理

Deployment ：适用于管理和部署无状态应用

StatefulSet：适用于管理和部署有状态应用

DaemonSet：适用于管理和部署用于本节点的功能性应用

CronJob：适用于管理和部署周期性应用

Job：适用于管理和部署一次性应用



#### 23.5.4.1 创建工作负载

登陆UCloudStack控制台 — 导航栏【容器服务】 — 【工作负载】 — 点击想要创建的工作负载类型

点击【创建】 进入工作负载创建界面

[基本设置] — [存储设置] — [容器设置] — [高级设置]

按顺序完成以上四步设置后，完成工作负载创建。

​	

#### 23.5.4.2 删除工作负载

进入想要删除的工作负载类型界面，勾选想要删除的工作负载，点击【删除】。

进行二次删除确认后，完成删除。



#### 23.5.4.3 查看工作负载

进入想要查看的工作负载类型界面，点击想要查看的工作负载的【详情】按钮。



#### 23.5.4.4 编辑工作负载

进入想要编辑的工作负载类型界面，点击想要编辑的工作负载的【编辑】按钮。

进入编辑界面后，可以选择[基本设置] — [存储设置] — [容器设置] — [高级设置]中的内容进行修改。

点击【保存】修改即可生效。



### 23.5.5 服务&路由管理

#### 23.5.5.1 创建服务&路由管理

登陆UCloudStack控制台 — 导航栏【容器服务】 — 【服务&路由】 — 点击【创建】



#### 23.5.5.2 删除服务&路由

进入想要删除的服务&路由界面，勾选想要删除的资源，点击【删除】。

进行二次删除确认后，完成删除。



#### 23.5.5.3 编辑服务&路由

进入想要编辑的服务&路由类型界面，点击想要编辑的资源的【编辑】按钮。

点击【保存】修改即可生效。



### 23.5.6 配置管理

#### 23.5.6.1 创建配置字典 & 保密字典

登陆UCloudStack控制台 — 导航栏【容器服务】 — 【配置】 — 点击【创建】



#### 23.5.6.2 删除配置字典 & 保密字典

进入想要删除的服务&路由界面，勾选想要删除的资源，点击【删除】。

进行二次删除确认后，完成删除。



#### 23.5.6.3 编辑配置字典 & 保密字典

进入想要编辑的服务&路由界面，点击想要编辑的资源后方的【编辑Yaml】。

进入该资源的Yaml文件编辑界面。



## 23.6 排障指南

### 23.6.1 入门必读

Kubernetes 提供了一系列的命令行工具来辅助我们调试和定位问题，本指南列举一些常见的命令来帮助应用管理者快速定位和解决问题。

**定位问题**

在开始处理问题之前，我们需要确认问题的类型，是 Pod ，Service ，或者 Controller（Deployment、StatefulSet） 的问题，然后分别使用不同的命令来查看故障原因。


**Pod常见命令**	

当我们发现 Pod 处于 Pending 状态，或者反复 crash，无法接受流量，可以使用以下命令来快速定位问题：

1. 获取 Pod 状态

```bash
kubectl -n ${NAMESPACE} get pod  -o wide 
```

2. 查看 Pod 的 yaml 配置

```bash
kubectl -n ${NAMESPACE} get pod ${POD_NAME}  -o 
```

3. 查看 Pod 事件

```bash
kubectl  -n ${NAMESPACE} describe pod ${POD_NAME}
```

4. 查看 Pod 日志

```bash
kubectl  -n ${NAMESPACE} logs ${POD_NAME} ${CONTAINER_NAME}
```

5. 登录 Pod

```
kubectl -n ${NAMESPACE} exec -it  ${POD_NAME} /bin/bash
```


**Controller 常见命令**

控制器负责 Pod 的生命周期管理，一般 Pod 无法被注册时，可以通过 Controller 来查看原因。这里以 Deployment 为例，介绍 Kubernetes Controller 的常用命令,其他 Controller 的命令类型与其一致。

1. 查看 Deployment 状态

```bash
kubectl -n ${NAMESPACE} get deploy -o wide
```

2. 查看 Deployment yaml 配置

```bash
kubectl -n ${NAMESPACE} get deploy ${DEPLOYMENT_NAME} -o yaml
```

3. 查看 Deployment 事件

```bash
kubectl -n ${NAMESPACE} describe deployment ${DEPLOYMENT_NAME}
```

**Service常见命令**

Service 描述了一组 Pod 的访问方式，当我们发现应用无法访问时，则需要使用 Service 命令来查看故障原因。

1. 查看 Service 状态

```bash
kubectl  -n ${NAMESPACE} get svc -o wide 
```

我们可以通过上述命令查看到 Service 的类型、集群内部和外部IP、暴露的端口，以及 Selector 信息。

2. 查看 Service 事件及负载均衡信息

```bash
kubectl  -n ${NAMESPACE} describe svc ${SERVICE_NAME} 

Name:              example-app
Namespace:         default
Labels:            app=example-app
Annotations:       <none>
Selector:          app=example-app
Type:              ClusterIP
IP:                10.2.192.27
Port:              web  8080/TCP
TargetPort:        8080/TCP
Endpoints:         192.168.59.207:8080,192.168.75.87:8080,192.168.84.90:8080
Session Affinity:  None
Events:            <none>
```

如上所示，我们可以通过这个命令查看到 Service 的 Endpoints 信息，Endpoints信息如果为空，则说明 Service 的配置信息有误，Service 无法将流量转发到相应的 Pod. 另外还有 Port 及 TargetPort 信息，确保与业务实际暴露的端口一致。



### 23.6.2 Pod故障处理

在Kubernetes中发布应用时，我们经常会遇到Pod出现异常的情况，如Pod长时间处于Pending状态，或者反复重启，下面介绍下Pod 的各种异常状态及处理思路。

**常见错误**

| 状态                  | 状态说明                         | 处理办法                                                    |
| --------------------- | -------------------------------- | ----------------------------------------------------------- |
| Error                 | Pod 启动过程中发生错误。         | 一般是由于容器启动命令、参数配置错误所致，请联系镜像制作者  |
| NodeLost              | Pod 所在节点失联。               | 检查 Pod 所在节点的状态                                     |
| Unkown                | Pod 所在节点失联或其他未知异常。 | 检查 Pod 所在节点的状态                                     |
| Pending               | Pod 等待被调度。                 | 资源不足等原因导致，通过 kubectl describe 命令查看 Pod 事件 |
| Terminating           | Pod 正在被销毁。                 | 可增加 --fore参数强制删除                                   |
| CrashLoopBackOff      | 容器退出，Kubelet 正在将它重启。 | 一般是由于容器启动命令、参数配置错误所致                    |
| ErrImageNeverPull     | 策略禁止拉取镜像。               | 拉取镜像失败，确认imagePullSecret是否正确                   |
| ImagePullBackOff      | 正在重试拉取。                   | 镜像仓库与集群的网络连通性问题                              |
| RegistryUnavailable   | 连接不到镜像仓库。               | 联系仓库管理员                                              |
| ErrImagePull          | 拉取镜像出错。                   | 联系仓库管理员，或确认镜像名是否正确                        |
| RunContainerError     | 启动容器失败。                   | 容器参数配置异常                                            |
| PostStartHookError    | 执行 postStart hook 报错。       | postStart 命令有误                                          |
| NetworkPluginNotReady | 网络插件还没有完全启动。         | cni 插件异常，可检查cni状态                                 |


### 23.6.3 Node故障处理

| 节点情况           | 说明                                                         |
| ------------------ | ------------------------------------------------------------ |
| Ready              | True 表示节点是健康的，False 表示节点不健康，Unkown 表示节点失联 |
| DiskPressure       | True 表示节点磁盘容量紧张，False 反之                        |
| MemoryPressure     | True 表示节点内存使用率过高，False 反之                      |
| PIDPressure        | True 表示节点有太多进程在运行，False 反之                    |
| NetworkUnavailable | True 表示节点网络配置不正常，False 反之                      |



# 24  容器镜像服务

## 24.1 文档目录

1. [产品介绍](/UCloudStack/userguide/containerimage?id=产品解释)
2. [名词解释](/UCloudStack/userguide/containerimage?id=名词解释)
3. [使用流程](/UCloudStack/userguide/containerimage?id=使用流程)
4. [实现原理](/UCloudStack/userguide/containerimage?id=实现原理)
5. [功能列表](/UCloudStack/userguide/containerimage?id=功能列表)
6. [操作指南](/UCloudStack/userguide/containerimage?id=操作指南)

## 24.2 产品介绍

容器镜像服务（UCloudStack Container Registry）是一项面向容器镜像的安全托管及分发平台， 提供容器镜像的全生命周期管理，简单易用、安全可靠，与容器服务（UCloudStack Container Service）无缝集成，帮助降低打造云原生应用的交付复杂度。

## 24.3 名词解释

1. 命名空间（NameSpace）： 命名空间用于管理多个具有关联属性的镜像仓库，不直接存储容器镜像，可理解为企业内部的组织团队、产品项目或个人，命名空间的名称全局唯一（平台级别）。
2. 镜像仓库（Repository）：仓库用于直接管理容器镜像，单个镜像仓库可包含不同版本（Tag）的容器镜像。镜像仓库归属于命名空间，并从命名空间继承了公开、私有属性及未来其他的特性。
3. 标签（Tag）：同一个容器镜像可以包含多个标签，代表镜像源的不同版本，如 ubuntu 仓库源里，有 15.10、14.04 等多个不同的版本，你可以通过 REGISTRY_ADDRESS/NAMESPACE/REPOSITORY:TAG 下载一个特定的容器镜像。
4. 私有&公开(Private&Public)： 私有的命名空间/镜像仓库只允许有权限的用户拉取和推送镜像，公开的命名空间/镜像仓库中的镜像允许任意人拉取，且无需是UCloudStack用户，前提是网络可达。


## 24.4 使用流程

容器镜像服务为你提供容器镜像的存储及分发能力，下面我们从头开始描述下如何使用容器镜像服务，方便你使用。

你在本地或者UCloudStack虚拟机上构建好一个容器镜像后，则可以选择在容器镜像服务中创建一个命名空间和镜像仓库，如果你希望匿名用户也可以拉取你的镜像，则可以将镜像仓库的类型设置为公开，反之则设置为私有。 对于私有属性的镜像，你还可以设置是否允许其他子账号拉取或推送镜像。最后，在上传镜像的时候，你需要登录容器镜像，地址可以在访问凭证中获取，用户名和密码为你在UCloudStack的登录账号一致。

如果你的云平台没有配置TLS证书，镜像仓库的地址会是HTTP，出于安全考虑，Docker或者其他容器运行时默认采用HTTPS，HTTP被认为不可信的，因此如果你在虚拟机上往仓库推送镜像，需要修改一下daemon.json，一般为/etc/docker/daemon.json文件,添加如下行即可。
```bash
{
"insecure-registries": ["$YOUR_REGISTRY_ADDRESS"],
}
```
UCloudStack的容器服务（K8S）集群节点已默认配置该参数，因此你无需单独配置。

将镜像推送到镜像仓库后，则可以通过UCloudStack提供的容器服务或者自建的容器集群来拉起应用。

![registryarch](../images/userguide/registry.png)

## 24.5 实现原理

下图为UCloudStack容器镜像服务的技术架构图，为了实现业务的高可用，所有模块均是高可用架构，下面分别说明下每个模块的作用。

1. Docker auth作为Docker Registry外置认证服务，提供认证鉴权服务；

2. sync service模块同步用户数据（用户名/密码）到docker auth服务的数据中，同步服务存在的意义是使Docker Auth不依赖User Service的认证服务，实现独立部署；

3. ApiServer服务提供gRPC接口，从Docker Registry API和Docker auth DB中拉取数据；

4. S3为对象存储服务，提供镜像的存储支持；

![registryarch](../images/userguide/registry_arch.png)


## 24.6 功能列表
|序号|所属模块|功能点|功能详细说明|
|---|-------|-----|----------|
|1|命名空间|创建命名空间|命名空间必须全局唯一，长度为2~30个字符，可为英文字母、数字、可使用连接符“-”、“_”，连接符不可以位于开始或结束。|
|2|命名空间|删除命名空间|删除命名空间，命名空间下有镜像仓库也可以删除。|
|3|命名空间|更新命名空间|更新命名空间类型,将命名空间由公有变更为私有，或反之|
|4|命名空间|授权|授权哪些子账号拥有命名空间（私有）下的推送或下载权限|
|5|镜像仓库|创建镜像仓库|创建一个镜像仓库，长度为2-64个字符，可使用小写英文字母、数字，可使用分隔符“_”、“-”、“.”（分隔符不能在首位或末位）|
|6|镜像仓库|删除镜像仓库|删除镜像仓库，有镜像也可以删除。|
|7|镜像仓库|更新仓库信息|可修改镜像仓库的摘要、备注信息、以及类型（公有、私有）|
|8|镜像仓库|查看镜像仓库信息|获取镜像仓库的基本信息（仓库地址、备注、Tag列表等）|
|9|镜像仓库|获取镜像Tag|获取该镜像下的全部Tag|
|10|访问凭证|获取访问凭证|查看镜像仓库地址及使用方式、登录账号和密码|
|11|镜像中心|获取镜像信息|查看系统公开或其他用户共享的镜像|

## 24.7操作指南

这里以Docker作为默认容器运行时作为操作指南的教程示例，对于Containerd等，只需要更换成对应的命令即可。

### 24.7.1 创建私有镜像库

**step1: 进入到容器镜像产品页，点击”创建命名空间“**

命名空间是一组容器镜像的集合，你可以按应用或者团队来创建命名空间；

命名空间的名称全局唯一，长度为2~30个字符，可为英文字母、数字、可使用连接符“-”、“_”，连接符不可以位于开始或结束。

命名空间分为私有和公开两种类型，一般建议设置为私有，其下所有的镜像仓库默认继承其开放属性，也可以单独设置，无论是私有还是公开，推送镜像都需要登录，公开类型的镜像库，下载则无需登录和身份校验。

另外你还可以设置是否允许外网访问，如果开启，则平台外部的客户端也可以上传和下载容器镜像，反之则不行。

**step2: 点击镜像仓库TAB，进入到仓库列表页，点击”创建镜像仓库“**

镜像仓库是一类容器镜像的集合，可包含不同版本（Tag）的容器镜像。镜像仓库归属于命名空间，并从命名空间继承了公开、私有属性及未来其他的特性。

同一命名空间下的镜像仓库全局唯一，可使用小写英文字母、数字，可使用分隔符“_”、“-”、“.”（分隔符不能在首位或末位）。

镜像仓库继承了其上的命名空间的开放属性，你也可以单独设置，即在某个开放属性为私有的命名空间下，将某个镜像的开放属性设置为公开，建议对外开放的镜像不包含业务信息。

完成了上述步骤后，就可以将制作好的镜像推送到你专有的镜像仓库了。

### 24.7.2 登录镜像仓库

在装有docker (版本要求1.10 以上版本) 机器上通过docker login执行登录，通过域名访问服务:

```bash
docker login $UCloudStack_Container_Registry_Addr -u $Your_UCloudStack_UserName
```
$UCloudStack_Container_Registry_Addr 为你的镜像仓库地址，可在访问凭证处获取；

$Your_UCloudStack_UserName 为你的云平台登录账号，可在访问凭证处获取，同时密码为你的云平台登录密码；

!> 如果你的云平台没有配置TLS证书，镜像仓库的地址会是HTTP，出于安全考虑，Docker或者其他容器运行时默认采用HTTPS，HTTP被认为不可信的，因此如果你在虚拟机上往仓库推送镜像，需要修改一下daemon.json，一般为/etc/docker/daemon.json文件,添加如下行即可。
```bash
{
"insecure-registries": ["$YOUR_REGISTRY_ADDRESS"],
}
```

### 24.7.3 推送（push）镜像

Step 1: 对本地已有镜像打一个tag，如一个nginx镜像，可通过docker images 查看所有本地镜像。

```bash
docker tag nginx:latest $UCloudStack_Container_Registry_Addr/{已创建命名空间}/{已创建镜像仓库名称}:tag
```

Step2：提交镜像到仓库。

```bash

docker push $UCloudStack_Container_Registry_Addr/{已创建命名空间}/{已创建镜像仓库名称}:tag

```

### 24.7.4 下载（pull）镜像

```bash 
docker pull $UCloudStack_Container_Registry_Addr/{已创建命名空间}/{已创建镜像仓库名称}:tag

```

# 25 数据库审计

## 25.1  产品简介

### 25.1.1 产品概述

数据库审计对审计和事务日志进行审查，从而跟踪各种对数据库操作的行为。一般审计主要记录对数据库的操作、对数据库的改变、执行该项目操作的人以及其他的属性。这些数据库被记录到数据库审计独立的平台中，并且具备较高的准确性和完整性。针对数据库活动或状态进行取证检查时，审计可以准确的反馈数据库的各种变化，通过监控数据库的状态和通信内容，准确评估数据库所面临的风险，并通过完善的日志记录为违规、异常行为提供时候追溯机制。


### 25.1.2 支持范围

云主机上部署的数据库类型支持常见的数据库，Oracle、DB2、MySQL、sqlserver、INFORMIX、SYBASE、POSTGRESQL、达梦、人大金仓、南大通用等，以及Cache后关系型数据库。
以上数据库类型均需要安装主机入侵检测的插件以后才能使用数据库审计产品。
本系统支持IE8及以上浏览器、chrome浏览器、Firefox火狐浏览器、360浏览器、opera。为了保证良好的浏览效果，推荐使用chrome浏览器。

### 25.1.3 功能特性

#### 25.1.3.1 平台高可用性设计

审计平台异常操作记录和告警：当有人非法操作或者破坏设备时，系统会实时发送短信或邮件，并作详细记录。24小时自动监控。

系统运营监控： 监控数据库审计系统运行状态，当设备出现问题或者磁盘空间不足时，将通知相关负责人处理。

#### 25.1.3.2 数据库审计功能

**智能规则库**：支持自定义规则，通过不同规则配置让系统更加符合每个企业不同的管理要求。

**多维度身份指纹**：系统支持工号、源IP、MAC、用户名、进程、操作系统类型、操作系统用户名、身份标识和审计，多重定位。

**数据库异常操作记录和回溯**：记录数据库上的所有详细操作，何时、何人、何种方式操作，支持事件的回溯。

**审计日志**：支持审计日志的查询、分析、统计和打印等。

**三权分立**：提供审计管理员、规则管理员、系统管理员，实现三权分立，互相制约，满足等保要求。

**统计报表**：包括源IP访问排行、数据库登录失败排行等。

**高级审计**：支持绑定变量及嵌套语句的复杂组合的数据库命令审计。支持三层模糊关联和HTTP协议的审计。

**审计加密协议的MS SQL**：支持MS SQL Server加密身份信息破译，解决MS SQL Server 2005及以上数据库看不到身份的难题。

#### 25.1.3.3 管理范围

支持自建数据库

提供Openstack接口方案，支持对大数据平台的安全审计



## 25.2 部署指南

1.	使用数据库审计之前，需要在访问数据库审计的客户端主机上先安装主机入侵检测，控制台页面有配置指导

2.	数据库审计不支持删除退费

3.	数据库审计各平台默认账号密码：

审计管理平台：auditadmin/!1fw@2soc#3vpn 
规则管理平台：ruleadmin/!1fw@2soc#3vpn 
系统管理平台：admin/!1fw@2soc#3vpn



### 25.2.1 购买数据库审计

（1） 在导航栏点击访问路径： 安全->数据库审计。进入数据库审计界面后，点击【创建数据库审计】
（2） 根据需求选择设置数据库审计的名称、版本、集群、项目组、VPC、子网、外部线路
（3） 选择完成后，会展示价格，点击【立即购买】进行支付，完成购买流程。

### 25.2.2 申请并导入授权

系统软件授权需要人工单独申请，请联系技术支持或相应产品负责人

申请使用系统管理平台的账号登录，在基础配置-基础配置模块，下载注册信息文件并发送技术支持或产品负责人

系统管理平台：admin/!1fw@2soc#3vpn

### 25.2.3 导入授权

未配置授权文件，也可同时进行下一步操作

访问路径：系统管理平台->基本配置->证书管理



### 25.2.4 安装Agent

**支持的操作系统：**

- CentOS
- Ubuntu
- Debian
- RedHat
- Open Suse
- Gentoo



### 25.2.5 配置镜像流量策略

Console控制台点击配置按钮，选择需要被审计的数据库和访问数据库客户端主机（需在主机上先部署主机入侵检测agent，此处才可选择访问主机）

### 25.2.6 添加审计对象

前提条件：自建的数据库需要跟数据库审计同一个VPC，且已安装主机入侵检测的agent插件。

登录规则管理平台：用户名和密码为：ruleadmin/!1fw@2soc#3vpn

添加审计对象：进入规则管理平台->对象设置->审计对象，点击添加，审计对象信息请保持和实际信息一致，等保客户可直接选择等级保护规则，自用客户请根据自身情况进行规则的制定和选择，扩展配置非必填项（需要查看数据库实时返回信息的请填写）

### 25.2.7 查看审计结果

登录数据库审计-审计管理平台，用户名和密码：auditadmin/!1fw@2soc#3vpn ，点击审计管理-日常行为查询， 输入或选择查询条件后，滚动鼠标到最下方，点击查询。

**参数说明**

| 参数         | <center>说明<center>                                         |
| ------------ | ------------------------------------------------------------ |
| 审计对象名称 | 设置业务对象的名称，可以自定义，建议设置的名称最好体现该对象的特点 |
| 状态         | 禁用或者启用                                                 |
| 数据库类型   | 选择数据库类型，如 Oracle、Cache、SQL Server、Sybase 等等    |
| 版本号       | 选定数据库服务器类型后，这里选择数据库的版本号               |
| 服务地址     | 数据库服务器所在的 IP 地址                                   |
| 端口         | 数据库服务器设置的数据库的端口号，默认 SQL Server:1433       |
| 应用规则组   | 规则组设置，请参阅 规则组管理                                |
| 数据库编码   | 根据数据库服务器数据库设置的编码字符集选择。 Oracle:GB2312;SQLServer:936;其他:UTF-8 |
| 应用部门     | 默认选择根部门                                               |
| 关联对象     | 可将该审计对象与其他的审计对象进行关联                       |



## 25.3 操作指南

### 25.3.1 UCloudStack控制台

#### 25.3.1.1 自定义列表

在进入数据库审计界面后，可以选择自定义列表，根据需求选择需要在列表页展示的字段信息。



#### 25.3.1.2 IP解绑/绑定

在数据库审计界面的操作按钮下拉菜单中，可以选择绑定IP/解绑IP。可以对已绑定外网IP的数据库审计进行解绑或者对未绑定外网IP的数据库审计进行外网IP的绑定（在已有空闲外网IP的情况下）。



#### 25.3.1.3更改配置

若当前所使用的数据库审计资源或者授权数量不足，可在更改配置中进行添加，扩容数据盘容量或者进行数据库审计授权版本的升级（授权版本升级默认会进行虚拟机配置升级）。



#### 25.3.1.4关闭/启动/重启

在数据库审计界面中可对目前所使用的数据库审计进行关闭、启动和重启，以上操作均需要进行二次确认。



#### 25.3.1.5续费

在数据库审计界面的操作按钮下拉菜单中，可对当前数据库审计进行续费操作。



#### 25.3.1.6 查看详情

在数据库审计界面中，可以查看数据库审计的基本信息、网络信息、付费信息以及监控信息。



#### 25.3.1.7 删除

在数据库审计界面中，可删除不再使用的数据库审计，再确认删除后，授权、配置等信息将会同步删除。



### 25.3.2 系统管理平台

#### 25.3.2.1 登陆系统 

打开浏览器，在地址栏输入审计设备的管理IP地址或输入 https://数据库审计IP
**初始的登陆账号和登陆密码为：

**审计管理平台：auditadmin/!1fw@2soc#3vpn**

**规则管理平台：ruleadmin/!1fw@2soc#3vpn**

**系统管理平台：admin/!1fw@2soc#3vpn**



#### 25.3.2.2 数据维护

此模块是对审计设备的数据的备份、恢复、磁盘告警、清理等的设置。

##### 25.3.2.2.1 自动备份

点击“数据维护”-“自动备份”，打开“自动备份”界面。

此功能是设置是否开启自动备份，若开启自动备份，需要同时开启FTP上传功能，以及备份的时间、备份的模式、备份的数据、重复周期等的设置，备份好的数据可以在本分文件列表中进行下载。



##### 25.3.2.2.2 数据恢复

点击“数据维护”-“数据恢复”，点击“导入”，就可以将备份到FTP服务器的备份数据，导入系统中，然后进行恢复，同时可以根据恢复状态进行查找。



##### 25.3.2.2.3 磁盘告警

点击“数据维护”-“磁盘告警”，打开“磁盘告警”设置界面，

处理方式：
转存——当磁盘空间达到设定阈值，就转存到配置好的FTP服务器。

覆盖——覆当磁盘空间达到设定阈值，就以覆盖的形式，覆盖早期的数据，保留定义最近多少天的数据。



##### 25.3.2.2.4 手动清理

点击“数据维护”-“手动清理”，打开“手动清理”界面
**参数说明

| 参数              | 说明                                       |
| ----------------- | ------------------------------------------ |
| 风险级别          | 可以针对不同风险级别进行清理               |
| 开始时间/结束时间 | 定义需要清理数据的时间段                   |
| 审计对象          | 可以针对某个审计对象进行清理，也可以不选择 |

此功能是在磁盘空间不足的情况下，对旧风险数据或者可以删除的非风险数据进行手动清理。



#### 25.3.2.3 通知服务

在产生风险时，能以SNMP、SYSLOG的方式通知管理员。

##### 25.3.2.3.1 SNMP配置

点击“通知服务”-“SNMP配置”，打开“添加”界面。此项是针对SNMP服务器的配置，包括状态（是否启用）、SNMP版本、服务器IP、服务器团体名、发送频率。



##### 25.3.2.3.2 SYSLOG配置

点击“通知服务”-“SYSLOG设置”，打开“添加”界面。



#### 25.3.2.4 系统升级

点击“系统升级”-“手动升级”，打开“手动升级”界面
“手动升级”选择需要进行升级的文件，手动升级的文件应该是以.zip、.sql或以audit.tar.gz结尾的文件。



#### 25.3.2.5 日志管理

点击“日志管理”-“系统日志”，打开“系统日志”界面
**查询**
系统日志”可以针对域名（包括审计引擎、备份引擎、守护进程、监听进程、动作引擎等），日志类型（异常日志、其他日志）、处理状态（处理中、未处理等）、事件级别（一般事件、致命告警）等多个查询条件查询系统日志。

**下载**
支持导出为excel和pdf。



#### 25.3.2.6 系统管理

##### 25.3.2.6.1 安全设置

点击“系统管理”-“安全设置”，打开“安全设置”界面，登陆安全参数设置：
**对登录失败的用户进行限制**

| 参数         | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 限制登陆时间 | 与限制登陆次数结合，即在限制登陆时间内限制登陆次数n次        |
| 限制登陆次数 | 参照限制登陆时间说明，尝试登陆但是登陆失败                   |
| 锁定用户时间 | 配合限制登陆时间、限制登陆次数，在限制登陆时间内，超过限制登陆（登陆失败）次数，账户即被锁定多长时间 |
| 安全退出时间 | 在界面无任何的操作下，超过此时间将退出，保护界面信息不被泄露 |

**密码长度参数设置**

| 参数         | 说明                           |
| ------------ | ------------------------------ |
| 密码最短长度 | 设置密码时，最短不能少于该长度 |
| 密码最长长度 | 设置密码时，最长不能大于该长度 |
| 密码过期时间 | 设置的密码将在多长时间内过期   |
| 密码过期状态 | 密码过期之后是继续使用还是禁用 |

**web登录IP白名单**：设置某个IP/网段可以登录web系统管理平台。
**web登录IP黑名单**：设置某个IP/网段不可以登录web系统管理平台。



##### 25.3.2.6.2 FTP设置

点击“系统管理”-“FTP配置”，打开“添加”界面，此功能是对FTP服务器进行配置，设置FTP名称、地址、FTP用户名、密码和存放路径，可以存放备份数据和系统转存数据。



#### 25.3.2.7 基本设置

此模块是对系统证书、管理口、审计口、名称、NTP、节点、邮件服务器、短信平台等的配置，还可以对系统进行设备维护和出厂设置。



### 25.3.3 规则管理平台

#### 25.3.3.1 整体预览

界面分为三大块，左边部分为导航菜单，中间部分规则适用情况，右边部分包括审计状态和IP过滤名单。

| 参数                 | 说明                                             |
| -------------------- | ------------------------------------------------ |
| 导航菜单             | 各功能模块及子菜单，详细信息请查看各功能模块描述 |
| 规则使用情况         | 列出目前系统中已使用的规则数量及被触发的风险条数 |
| 触发风险规则使用情况 | 已触发的规则条数统计                             |
| 规则最近更新记录     | 规则更新记录                                     |



#### 25.3.3.2 全局参数设置

##### 25.3.3.2.1 审计对象别名

**访问路径** 
点击“全局参数设置”-“审计对象别名”，打开“审计对象别名”界面，点击“添加”。

**功能描述**
对审计对象的一些敏感的表、字段、关键字或客户端进程设置一个别名，系统可以进行翻译，设置关键字的目的是因为数据库语句中有些英文字符既不是表，也不是字段，这个时候如果要设置别名，就可以通过关键字来定义。

针对表名、字段名和、关键字或客户端进程设置别名设置，也就是翻译，这里设置的别名会在风险查询和日常行为查询中出现相应的表名、字段名、关键字或客户端进程进行标注翻译之后的，方便识别和查看。



##### 25.3.3.2.2 访问者别名

**访问路径**
点击“全局参数设置”-“访问者别名”，打开“访问者别名”界面，访问者别名设置。

**功能描述**
将访问者的IP地址、MAC地址、操作系统用户名、操作系统主机名、数据库账户、客户端进程翻译成别名，方便在审计结果中直观的看到是谁操作了数据库。



##### 25.3.3.2.3 隐秘数据设置

**访问路径**
点击“全局参数设置”-“隐秘数据设置”，打开“隐秘数据设置”界面

**功能描述**
对审计结果中的某些关键字段和敏感字段进行隐秘设置，防止二次泄密，这里设置之后，在审计结果中将会以加密星号（\*）显示。



#### 25.3.3.3 审计设置

**访问路径**
点击“全局参数设置”-“审计控制”，打开“审计控制”

**功能描述**
该模块是进行“全部审计”还是进行“按规则审计”，以及返回结果长度，对审计的结果进行过滤。

**两种审计状态**

* 全部审计：对所有的操作数据进行审计操作，并将所有操作数据进行保存； * 按审计规则：只有满足审计规则的数据才会被审计到。
 * 零告警通知：启用该功能后，每天早上10点（程序定义）发送一条告警短信到管理员手机中，让管理员知悉前一天的风险告警情况，有无告警系统都会发送。



#### 25.3.3.4 通知策略

**访问路径**
点击“全局参数设置”-“通知策略”，打开“添加”按钮

| 参数     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 风险等级 | 高危事件、中危事件、低危事件分别对应规则设置时的高、中、低   |
| 接收者   | 在“审计管理平台-系统管理-用户管理”中的用户，或者其它新增的用户 |
| 通知方式 | 邮件、syslog、SNMP、短信通知、短信平台                       |
| 审计对象 | 选择需要告警通知的审计对象，可多选                           |
| 状态     | 启用或者禁用                                                 |



#### 25.3.3.5 访问者信息配置

##### 25.3.3.5.1 进程配置

**访问路径**
点击“访问者信息配置”-“进程配置”，打开“进程配置”界面，添加进程集合。

**功能描述**
添加进程集合，进程集合名可以自定义，这里配置为“第三方工具”，然后点“客户端进程”的下拉选项，选择“plsqldev.exe”，最后点“添加”按钮。一个集合中可以添加多个进程。



##### 25.3.3.5.2 驱动级IP过滤

**访问路径**
点击“访问者信息配置”-“驱动级IP过滤”，打开“驱动级IP过滤”界面，设置源IP地址和目的IP地址。

**功能描述**
设置过滤某些IP后，将不对其IP产生的数据进行审计。



##### 25.3.3.5.3 IP监控

**访问路径**
点击“访问者信息配置”-“IP监控”，打开“IP监控”配置界面（应用到规则管理，在审计控制中选择按规则审计，就可以监控这个IP或IP段）

**功能描述**
这部分功能是设置相应的客户端IP集合，将一些IP加入某个集合中，在设置规则时可以针对该集合配置规则。

先添加应用服务器IP，选择“来访客户IP”，输入应用服务器的IP地址“192.168.10.207”，点“添加”，再点“保存”；继续添加上面需求中提到的IP网段，1.1.1.1-192.168.10.206，类型选择“来访客户网段”，把起始IP和终止IP输入后，点击添加，保存即可。

**来访客户IP：**客户端IP；

**来访客户地址段：**客户地址段，配置起始IP和终止IP



##### 25.3.3.5.4 规则生效时间

**访问路径**
点击“访问者信息配置”-“规则生效时间”，打开“添加”配置界面

**功能描述**
此功能是定义规则生效时间，可以定义某个时间段内，规则处于告警或者不告警的状态。



#### 25.3.3.6 对象设置

点击“对象配置”-“审计对象”，新建审计策略 点击对象设置-->审计对象，点击“添加”，输入需要被审计数据库服务器的相关信息，输入完成以后点击保存。



#### 25.3.3.7 规则配置

模块主要功能是规则管理和规则组管理。

##### 25.3.3.7.1 操作类型

**访问路径** 
点击“规则配置”-“操作类型”，打开“操作类型”界面（应用到规则管理）



##### 25.3.3.7.2 组合规则

**访问路径**
点击“规则配置”-“组合规则”，打开“组合规则”界面，此项是配置组合规则或统计规则。组合规则是根据几个规则在一定时间段内被触发是就会触发风险；统计规则是一定时间内一条规则达到触发的次数就会触发风险。



##### 25.3.3.7.3 规则管理

**访问路径**
点击“规则配置”-“规则管理”，打开“规则管理”界面
此功能是设置规则，包括风险的级别、何种操作类型以及针对的对象（操作系统主机名、子对象、客户端IP集、客户端进程集、关键字等）。

针对数据库的操作：各种操作语句，例select、insert、update等，在审计结果中触发对应的操作时，出现告警。

风险级别：高风险、中风险、低风险、关注行为、一般行为、高级白名单。
**规则属性内容**

| 参数             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 操作系统主机名   | 客户端的操作系统主机名                                       |
| 操作系统用户名   | 客户端的操作系统用户名                                       |
| 客户端MAC        | 客户端的网卡地址                                             |
| 子对象名         | 详细信息 查看子对象设置                                      |
| 进程集合名       | 详细信息 查看进程配置                                        |
| 客户端IP集       | 详细信息请参阅IP监控配置中的来访客户IP配置                   |
| 数据库账户       | 数据库服务器的账户                                           |
| 来访客户网络     | 详细信息请参阅IP监控配置中的来访客户网段的配置               |
| 最大操作语句长度 | 客户端的最大的操作语句长度，超过此值时，出现告警             |
| 语句执行回应     | 客户端操作数据库的SQL语句的执行回应，结果为成功或失败        |
| 返回内容         | 查询结果返回的行数大于该值时，将报警                         |
| 返回行数或阈值   | 设置一个返回结果的行数，当审计到的返回结果行数一致时出现报警 |
| 语句执行时间     | SQL语句中表的操作，当审计结果中执行时间大于该值时，出现告警  |
| 规则生效时间     | 详细信息请参阅规则生效时间配置                               |
| 关键字审计       | 关键字之间使用“&”                                            |



##### 25.3.3.7.4 白名单管理

**访问路径**

点击“规则配置”-“白名单管理”，打开“白名单管理”界面，

**功能描述**

功能是将某个IP、MAC地址、疑似风险经确认正常的操作语句等加入白名单，在以后的审计中将不做审计，这样可以方便管理员对真正的风险的处理，提高工作效率。手动添加或者在审计结果中右键添加。



##### 25.3.3.7.5 规则组管理

**访问路径**

点击“规则配置”-“规则组管理”，打开“规则组管理”界面。

**功能描述**

“规则组管理”是方便对规则的管理，可以将几个规则一起加入规则组，然后在“对象设置”-“审计对象”中加入该规则组，则规则启用。



##### 25.3.3.7.5 系统语句

**访问路径**

点击“规则配置”-“系统语句”，打开“系统语句”界面。

**功能描述**

“系统语句”是将确认正常的操作的sql语句标注为系统语句，在以后的审计中将不做审计，这样可以方便管理员对真正的风险的处理，提高工作效率。



### 25.3.4 审计管理平台

#### 25.3.4.1 登陆系统

打开web浏览器，在地址栏输入审计设备的管理IP地址，打开登陆界面。默认的审计管理员的用户名和密码为ruleadmin/\!1fw@2soc\#3vpn

<WRAP center round box 100%> 审计管理平台：auditadmin/!1fw@2soc#3vpn

规则管理平台：ruleadmin/!1fw@2soc#3vpn

系统管理平台：admin/!1fw@2soc#3vpn



#### 25.3.4.2 预览

预览界面分为三大块，左边为导航菜单，中间部分为本月风险级别分布，右下角部分为最近系统事件。点击对应的柱形图，对当天产生的风险数据进行详细查看。



#### 25.3.4.3 风险管理

**访问路径**

点击“风险管理”-“风险查询”，打开“风险查询”界面，在基本配置中，可以根据查询条件进行风险查询。

配置好查询条件，点击 “查询”，打开“查询结果”界面，查询结果会打开一个新的页面，选择一条结果，下方会显示详细的信息，包括客户端信息、服务器端信息、操作语句、回应信息等。选择一条记录，右键“事件分析”，弹出“事件分析”对话框，通过此对话框也可以查看。

同时可以将查询结果“导出word”、“导出excel”、“导出pdf”、文件导出。



#### 25.3.4.4 审计管理

此模块功能是进行日常的查询、结果的回放以及客户端进程的统计信息。



#### 25.3.4.5 报表管理

报表管理是对审计结果进行分类统计，并以图形和图标的方式展示给管理员，便于管理员查看；同时可以将报表“导出word”、“导出excel”、“导出pdf”。

##### 25.3.4.5.1 等级保护报表

以柱形图的方式将“数据库账户/访问次数”展示出来，并在下方显示详细的信息，包括数据库账户、数据库名、操作类型、结果、操作次数。



##### 25.3.4.5.2 用户登录注销报表

以柱形图的方式将“数据库账户/用户登录注销次数”展示出来，而在下方会显示数据库账户、访问者IP、数据库名、操作类型、结果、操作次数等详细信息。



##### 25.3.4.5.3 表对象访问情况报表

对某IP在一段时间内对数据库中哪些表进行了哪些操作，以及操作了多少次，以柱形图的形式展现出了。



##### 25.3.4.5.4 用户操作情况统计

使用某个数据库账户操作次数，详细信息以柱形图的形式展示出来。



##### 25.3.4.5.5 访问失败次数排行

对使用数据库账户访问数据库，并且是失败的情况进行汇总。



##### 25.3.4.5.6 用户访问情况统计

对于客户端（IP）访问数据库的次数进行统计分析。



##### 25.3.4.5.7 每天平均数据统计

对审计对象在当天访问数据库产生数据的级别和次数进行统计。



##### 25.3.4.5.8 月度风险统计报表

查询当月高风险数以及高风险占所有风险的比例和返回行数大于50以及所占的比例，并在报表中详细显示。



##### 25.3.4.5.9 自定义报表设置

用户可以根据自己需求，自定义字段，显示想要看到的报表。



## 25.4 用户手册下载

[数据库审计用户手册](http://das-userguide.cn-bj.ufileos.com/UCloud数据库审计系统用户手册.pdf)

