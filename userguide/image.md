# 4 自制镜像管理

自制镜像归属于云平台租户，用户从虚拟机导出的自制镜像及自定义上传导入的镜像均属于自制镜像，平台管理员、租户及有权限的子账号均有权限查看和管理。

自制镜像可用于创建虚拟机，并支持用户下载虚拟机镜像到本地，同时镜像管理支持查看镜像、修改名称和备注、从镜像创建虚拟机、导入镜像、下载镜像及删除镜像等生命周期管理。

## 4.1 查看自制镜像

通过导航栏进入虚拟机控制台，切换至镜像管理页面可查看当前账户下自制镜像资源的列表及相关详细信息，包括镜像名称、资源 ID、系统类型、操作系统、状态及操作项，如下图所示：

![selfimage1](../images/userguide/selfimage1.png)

- 镜像名称/资源 ID：当前自制镜像的名称及全局唯一 ID 标识；
- 系统类型：代表当前自制镜像的操作系统类型，如 Linux、 Windows、Kylin 等；
- 操作系统：指当前自制镜像的基础操作系统发行版，如 CentOS 7.4 x86_64 ；
- 状态：当前自制镜像的状态，包括创建中、导入中、导入失败、可用、删除中、已删除；
  - 创建中：通过虚拟机自制镜像过程中，镜像的状态为创建中；
  - 导入中：用户通过导入镜像功能导入镜像的过程中，镜像的状态为导入中；
  - 导入失败：指用户导入镜像失败；
  - 可用：指当前镜像为可用状态，可创建虚拟机或进行下载；
  - 删除中：指当前镜像被删除中；
  - 已删除：指当前镜像已被删除，并进入回收站。
- 操作：对单个自制镜像的操作，包括从镜像创建虚拟机、下载镜像及删除镜像；

为方便租户对镜像资源进行维护和操作，平台支持下载当前用户所拥有的所有自制镜像资源列表信息为 Excel 表格，同时支持对自制镜像进行批量删除操作，可通过选中多个自制镜像，点击批量删除按钮进行批量操作。

平台支持用户导入自定义镜像，列表上为用户提供自行制作镜像文档，可通过查看文档阅读镜像制作及格式转换的操作步骤，方便镜像导入和业务迁移。

## 4.2 从镜像创建虚拟机

从镜像创建主机指通过自制或自定义导入的镜像重新创建一台虚拟机，创建的虚拟机使用自制镜像启动，虚拟机中的程序及数据保持自制镜像的创建时的状态。

用户可通过镜像管理资源列表的操作项“从镜像创建主机”进行创建，如下图所示，虚拟机创建向导自动为用户选择指定的自制镜像。

![selfimage](../images/userguide/selfimage.png)

使用自制镜像创建虚拟机的过程与基础镜像相同，可根据提示进行操作。从镜像创建虚拟机时设置的管理员密码会覆盖原镜像操作系统中的密码，需使用新密码登录创建的虚拟机。

## 4.3 导入镜像

导入镜像是指租户或平台管理员将第三方业务虚拟机以镜像的方式迁移到平台镜像仓库，使租户可以在通过导入的镜像创建并部署业务虚拟机，是用户将业务迁移的重要通道。

支持用户导入 Linux 和 Windows 发行版及自定义镜像，并支持 X86 架构和 aarch64 两种系统架构镜像的导入；云平台的镜像格式默认为 RAW ，用户上传 VHD、VMDK、QCOW2、OVA、ISO 等格式的镜像时，需先将镜像转换为 QCOW2 格式的镜像才可导入，有关转换镜像及自定义镜像的具体操作可参考自制镜像列表上展示的[自定义镜像指南]() 。 

用户制作好自定义镜像后，可通过镜像管理控制台资源列表上方的【导入镜像】功能，进入导入镜像向导页面：

![importimage](../images/userguide/importimage_1.png)
![importimage](../images/userguide/importimage_url.png)

* 镜像名称/描述：镜像的名称及相关描述信息；
* 导入方法：用户可以自行选择本地文件或者是URL导入 QCOW2 格式的镜像文件；
* 镜像文件：在选择导入方法为本地文件时，可以选择当前浏览器选择的本地文件进行上传；
* 镜像地址：在选择导入方法为URL时，平台导入镜像时读取并下载镜像的 URL 地址，导入镜像时必须提供，平台会从提供的 URL 地址自动下载镜像并自动导入至镜像仓库，用于创建虚拟机。
  * 当前仅支持 HTTP、HTTPS 等协议的 URL 地址，格式包括 `https://path/file` 或`ftp://hostname[:port]/path/file` 或 `ftp://user:password@hostname[:port]/path/file` ；
  * 镜像的地址必须从云平台可达，即云平台组件可访问的 URL 地址，建议使用云平台相同外网的 IP 地址或外网 IP 地址可通信的地址。
* 操作系统：导入镜像的操作系统类型，包括 Linux 和 Windows ，需根据导入镜像 OS 类型进行选择；
* 系统架构：导入镜像的系统架构，包括 `x86_64` 和 `aarch64` ，需根据导入镜像进行选择；
* 系统平台：指导入镜像的操作系统平台；
  * Linux 操作系统的系统平台包括 Centos 和 Ubuntu ；
  * Windows 操作系统的系统平台仅支持 Windows ；
* 系统版本：当前需导入镜像的操作系统版本；
  * CentOS x86_64 架构支持  `6.5~6.10` 及 `7.0~7.9` 版本；
  * CentOS aarch64 架构支持 `7.6~7.9` 版本；
  * Ubuntu x86_64 架构支持 `14.04` 和 `16.04` 版本；
  * Ubuntu aarch64 架构支持 `16.04` 和 `18.04` 版本；
  * Windows  支持 `2008、2008R2、2012、2012R2` 及 `2016` 版本；
* 目标镜像大小：当前导入镜像的目标大小，最小 20GB ，最大不能超过 500GB ；
* SHA256 ：用于校验文件完整性的值，默认无需指定。

镜像导入后，自制镜像列表生成一条状态为 “导入中” 的镜像，由于平台需要先下载镜像至镜像仓库且镜像通常较大，导入镜像的时间通常比较长。

镜像状态转换为可用时，即代表镜像导入成功，可进行虚拟机创建或进行镜像下载操作；若镜像导入过程中出现意外导致失败，则镜像的状态会转换为“导入失败” ，可对失败的镜像进行删除并重新导入镜像。

> 导入镜像前需确保镜像地址可被访问且可读取并下载到镜像。

## 4.4 下载镜像

下载镜像指用户将平台自制的镜像下载至本地，用于备份或迁移。虚拟机镜像通过为 GB 级别文件，为保证下载镜像的断点续传等功能，平台以提供下载地址的方式支持镜像下载；可通过 FTP、 SFTP 及相关工具进行镜像下载，以保证断点续传功能，提升镜像下载的成功率。

用户如果需要下载镜像至本地时，可通过自制镜像列表操作项中的【下载】进入镜像下载向导页面，如下图所示：

![downloadimage](../images/userguide/downloadimage.png)

点击生成下载地址后，平台会跳转至下载地址展示向导页面，通过向导页面，用户通过复制下载地址链接，通过 HTTP、FTP 及相关下载工具下载镜像。

![downloadimage1](../images/userguide/downloadimage1.png)

> 镜像下载地址有效期为 24 小时，需在 24 小时内进行镜像下载。若镜像下载地址过期，则无法进行下载，需到平台重新生成镜像下载地址。

## 4.5 删除自制镜像

用户可对自制镜像进行删除操作，被删除的自制镜像会自动进入“**回收站**”，可进行还原和销毁操作。用户可通过自制镜像管理控制台的“删除”功能进行自制镜像的删除，删除后可到回收站中查看已删除的自制镜像。

![rmimage](../images/userguide/rmimage.png)

仅支持删除状态为可用或导入失败的的自制镜像；若已通过自制镜像创建虚拟机，则不可删除自制镜像，需要将虚拟机删除，才可进行自制镜像的删除。

## 4.6 修改名称和备注

修改自制镜像的名称和备注，在任何状态下均可进行操作。可通过点击自制镜像列表页面每个镜像名称右侧的“编辑”按钮进行修改。
