# 数据库审计用户手册

## 一. 产品简介

### 1.1 产品概述

数据库审计对审计和事务日志进行审查，从而跟踪各种对数据库操作的行为。一般审计主要记录对数据库的操作、对数据库的改变、执行该项目操作的人以及其他的属性。这些数据库被记录到数据库审计独立的平台中，并且具备较高的准确性和完整性。针对数据库活动或状态进行取证检查时，审计可以准确的反馈数据库的各种变化，通过监控数据库的状态和通信内容，准确评估数据库所面临的风险，并通过完善的日志记录为违规、异常行为提供时候追溯机制。


### 1.2 支持范围

云主机上部署的数据库类型支持常见的数据库，Oracle、DB2、MySQL、sqlserver、INFORMIX、SYBASE、POSTGRESQL、达梦、人大金仓、南大通用等，以及Cache后关系型数据库。
以上数据库类型均需要安装主机入侵检测的插件以后才能使用数据库审计产品。
本系统支持IE8及以上浏览器、chrome浏览器、Firefox火狐浏览器、360浏览器、opera。为了保证良好的浏览效果，推荐使用chrome浏览器。

### 1.3功能特性

#### 1.3.1平台高可用性设计

审计平台异常操作记录和告警：当有人非法操作或者破坏设备时，系统会实时发送短信或邮件，并作详细记录。24小时自动监控。

系统运营监控： 监控数据库审计系统运行状态，当设备出现问题或者磁盘空间不足时，将通知相关负责人处理。

#### 1.3.2数据库审计功能

**智能规则库**：支持自定义规则，通过不同规则配置让系统更加符合每个企业不同的管理要求。

**多维度身份指纹**：系统支持工号、源IP、MAC、用户名、进程、操作系统类型、操作系统用户名、身份标识和审计，多重定位。

**数据库异常操作记录和回溯**：记录数据库上的所有详细操作，何时、何人、何种方式操作，支持事件的回溯。

**审计日志**：支持审计日志的查询、分析、统计和打印等。

**三权分立**：提供审计管理员、规则管理员、系统管理员，实现三权分立，互相制约，满足等保要求。

**统计报表**：包括源IP访问排行、数据库登录失败排行等。

**高级审计**：支持绑定变量及嵌套语句的复杂组合的数据库命令审计。支持三层模糊关联和HTTP协议的审计。

**审计加密协议的MS SQL**：支持MS SQL Server加密身份信息破译，解决MS SQL Server 2005及以上数据库看不到身份的难题。

#### 1.3.3管理范围

支持自建数据库

提供Openstack接口方案，支持对大数据平台的安全审计



## 二. 部署指南

1.	使用数据库审计之前，需要在访问数据库审计的客户端主机上先安装主机入侵检测，控制台页面有配置指导

2.	数据库审计不支持删除退费

3.	数据库审计各平台默认账号密码：

审计管理平台：auditadmin/!1fw@2soc#3vpn 
规则管理平台：ruleadmin/!1fw@2soc#3vpn 
系统管理平台：admin/!1fw@2soc#3vpn



### 2.1 购买数据库审计

（1） 在导航栏点击访问路径： 安全->数据库审计。进入数据库审计界面后，点击【创建数据库审计】
（2） 根据需求选择设置数据库审计的名称、版本、集群、项目组、VPC、子网、外部线路
（3） 选择完成后，会展示价格，点击【立即购买】进行支付，完成购买流程。

### 2.2 申请并导入授权

系统软件授权需要人工单独申请，请联系技术支持或相应产品负责人

申请使用系统管理平台的账号登录，在基础配置-基础配置模块，下载注册信息文件并发送技术支持或产品负责人

系统管理平台：admin/!1fw@2soc#3vpn

### 2.3 导入授权

未配置授权文件，也可同时进行下一步操作

访问路径：系统管理平台->基本配置->证书管理



### 2.4 安装Agent

**支持的操作系统：**

- CentOS
- Ubuntu
- Debian
- RedHat
- Open Suse
- Gentoo



### 2.5 配置镜像流量策略

Console控制台点击配置按钮，选择需要被审计的数据库和访问数据库客户端主机（需在主机上先部署主机入侵检测agent，此处才可选择访问主机）

### 2.6 添加审计对象

前提条件：自建的数据库需要跟数据库审计同一个VPC，且已安装主机入侵检测的agent插件。

登录规则管理平台：用户名和密码为：ruleadmin/!1fw@2soc#3vpn

添加审计对象：进入规则管理平台->对象设置->审计对象，点击添加，审计对象信息请保持和实际信息一致，等保客户可直接选择等级保护规则，自用客户请根据自身情况进行规则的制定和选择，扩展配置非必填项（需要查看数据库实时返回信息的请填写）

### 2.7 查看审计结果

登录数据库审计-审计管理平台，用户名和密码：auditadmin/!1fw@2soc#3vpn ，点击审计管理-日常行为查询， 输入或选择查询条件后，滚动鼠标到最下方，点击查询。

**参数说明**

| 参数         | <center>说明<center>                                         |
| ------------ | ------------------------------------------------------------ |
| 审计对象名称 | 设置业务对象的名称，可以自定义，建议设置的名称最好体现该对象的特点 |
| 状态         | 禁用或者启用                                                 |
| 数据库类型   | 选择数据库类型，如 Oracle、Cache、SQL Server、Sybase 等等    |
| 版本号       | 选定数据库服务器类型后，这里选择数据库的版本号               |
| 服务地址     | 数据库服务器所在的 IP 地址                                   |
| 端口         | 数据库服务器设置的数据库的端口号，默认 SQL Server:1433       |
| 应用规则组   | 规则组设置，请参阅 规则组管理                                |
| 数据库编码   | 根据数据库服务器数据库设置的编码字符集选择。 Oracle:GB2312;SQLServer:936;其他:UTF-8 |
| 应用部门     | 默认选择根部门                                               |
| 关联对象     | 可将该审计对象与其他的审计对象进行关联                       |



## 三. 操作指南

### 3.1 UCloudStack控制台

#### 3.1.1 自定义列表

在进入数据库审计界面后，可以选择自定义列表，根据需求选择需要在列表页展示的字段信息。



#### 3.1.2 IP解绑/绑定

在数据库审计界面的操作按钮下拉菜单中，可以选择绑定IP/解绑IP。可以对已绑定外网IP的数据库审计进行解绑或者对未绑定外网IP的数据库审计进行外网IP的绑定（在已有空闲外网IP的情况下）。



#### 3.1.3更改配置

若当前所使用的数据库审计资源或者授权数量不足，可在更改配置中进行添加，扩容数据盘容量或者进行数据库审计授权版本的升级（授权版本升级默认会进行虚拟机配置升级）。



#### 3.1.4关闭/启动/重启

在数据库审计界面中可对目前所使用的数据库审计进行关闭、启动和重启，以上操作均需要进行二次确认。



#### 3.1.5续费

在数据库审计界面的操作按钮下拉菜单中，可对当前数据库审计进行续费操作。



#### 3.1.6 查看详情

在数据库审计界面中，可以查看数据库审计的基本信息、网络信息、付费信息以及监控信息。



#### 3.1.7 删除

在数据库审计界面中，可删除不再使用的数据库审计，再确认删除后，授权、配置等信息将会同步删除。



### 3.2 系统管理平台

#### 3.2.1 登陆系统 

打开浏览器，在地址栏输入审计设备的管理IP地址或输入 https://数据库审计IP
**初始的登陆账号和登陆密码为：

**审计管理平台：auditadmin/!1fw@2soc#3vpn

**规则管理平台：ruleadmin/!1fw@2soc#3vpn

**系统管理平台：admin/!1fw@2soc#3vpn



#### 3.2.2 数据维护

此模块是对审计设备的数据的备份、恢复、磁盘告警、清理等的设置。

##### 3.2.2.1 自动备份

点击“数据维护”-“自动备份”，打开“自动备份”界面。

此功能是设置是否开启自动备份，若开启自动备份，需要同时开启FTP上传功能，以及备份的时间、备份的模式、备份的数据、重复周期等的设置，备份好的数据可以在本分文件列表中进行下载。



##### 3.2.2.2 数据恢复

点击“数据维护”-“数据恢复”，点击“导入”，就可以将备份到FTP服务器的备份数据，导入系统中，然后进行恢复，同时可以根据恢复状态进行查找。



##### 3.2.2.3 磁盘告警

点击“数据维护”-“磁盘告警”，打开“磁盘告警”设置界面，

处理方式：
转存——当磁盘空间达到设定阈值，就转存到配置好的FTP服务器。

覆盖——覆当磁盘空间达到设定阈值，就以覆盖的形式，覆盖早期的数据，保留定义最近多少天的数据。



##### 3.2.2.4 手动清理

点击“数据维护”-“手动清理”，打开“手动清理”界面
**参数说明

| 参数              | 说明                                       |
| ----------------- | ------------------------------------------ |
| 风险级别          | 可以针对不同风险级别进行清理               |
| 开始时间/结束时间 | 定义需要清理数据的时间段                   |
| 审计对象          | 可以针对某个审计对象进行清理，也可以不选择 |

此功能是在磁盘空间不足的情况下，对旧风险数据或者可以删除的非风险数据进行手动清理。



#### 3.2.3 通知服务

在产生风险时，能以SNMP、SYSLOG的方式通知管理员。

##### 3.2.3.1 SNMP配置

点击“通知服务”-“SNMP配置”，打开“添加”界面。此项是针对SNMP服务器的配置，包括状态（是否启用）、SNMP版本、服务器IP、服务器团体名、发送频率。



##### 3.2.3.2 SYSLOG配置

点击“通知服务”-“SYSLOG设置”，打开“添加”界面。



#### 3.2.4 系统升级

点击“系统升级”-“手动升级”，打开“手动升级”界面
“手动升级”选择需要进行升级的文件，手动升级的文件应该是以.zip、.sql或以audit.tar.gz结尾的文件。



#### 3.2.5 日志管理

点击“日志管理”-“系统日志”，打开“系统日志”界面
**查询**
系统日志”可以针对域名（包括审计引擎、备份引擎、守护进程、监听进程、动作引擎等），日志类型（异常日志、其他日志）、处理状态（处理中、未处理等）、事件级别（一般事件、致命告警）等多个查询条件查询系统日志。

**下载**
支持导出为excel和pdf。



#### 3.2.6 系统管理

##### 3.2.6.1 安全设置

点击“系统管理”-“安全设置”，打开“安全设置”界面，登陆安全参数设置：
**对登录失败的用户进行限制**

| 参数         | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 限制登陆时间 | 与限制登陆次数结合，即在限制登陆时间内限制登陆次数n次        |
| 限制登陆次数 | 参照限制登陆时间说明，尝试登陆但是登陆失败                   |
| 锁定用户时间 | 配合限制登陆时间、限制登陆次数，在限制登陆时间内，超过限制登陆（登陆失败）次数，账户即被锁定多长时间 |
| 安全退出时间 | 在界面无任何的操作下，超过此时间将退出，保护界面信息不被泄露 |

**密码长度参数设置**

| 参数         | 说明                           |
| ------------ | ------------------------------ |
| 密码最短长度 | 设置密码时，最短不能少于该长度 |
| 密码最长长度 | 设置密码时，最长不能大于该长度 |
| 密码过期时间 | 设置的密码将在多长时间内过期   |
| 密码过期状态 | 密码过期之后是继续使用还是禁用 |

**web登录IP白名单**：设置某个IP/网段可以登录web系统管理平台。
**web登录IP黑名单**：设置某个IP/网段不可以登录web系统管理平台。



##### 3.2.6.2 FTP设置

点击“系统管理”-“FTP配置”，打开“添加”界面，此功能是对FTP服务器进行配置，设置FTP名称、地址、FTP用户名、密码和存放路径，可以存放备份数据和系统转存数据。



#### 3.2.7 基本设置

此模块是对系统证书、管理口、审计口、名称、NTP、节点、邮件服务器、短信平台等的配置，还可以对系统进行设备维护和出厂设置。



### 3.3 规则管理平台

#### 3.3.1 整体预览

界面分为三大块，左边部分为导航菜单，中间部分规则适用情况，右边部分包括审计状态和IP过滤名单。

| 参数                 | 说明                                             |
| -------------------- | ------------------------------------------------ |
| 导航菜单             | 各功能模块及子菜单，详细信息请查看各功能模块描述 |
| 规则使用情况         | 列出目前系统中已使用的规则数量及被触发的风险条数 |
| 触发风险规则使用情况 | 已触发的规则条数统计                             |
| 规则最近更新记录     | 规则更新记录                                     |



#### 3.3.2 全局参数设置

##### 3.3.2.1 审计对象别名

**访问路径** 
点击“全局参数设置”-“审计对象别名”，打开“审计对象别名”界面，点击“添加”。

**功能描述**
对审计对象的一些敏感的表、字段、关键字或客户端进程设置一个别名，系统可以进行翻译，设置关键字的目的是因为数据库语句中有些英文字符既不是表，也不是字段，这个时候如果要设置别名，就可以通过关键字来定义。

针对表名、字段名和、关键字或客户端进程设置别名设置，也就是翻译，这里设置的别名会在风险查询和日常行为查询中出现相应的表名、字段名、关键字或客户端进程进行标注翻译之后的，方便识别和查看。



##### 3.3.2.2 访问者别名

**访问路径**
点击“全局参数设置”-“访问者别名”，打开“访问者别名”界面，访问者别名设置。

**功能描述**
将访问者的IP地址、MAC地址、操作系统用户名、操作系统主机名、数据库账户、客户端进程翻译成别名，方便在审计结果中直观的看到是谁操作了数据库。



##### 3.3.2.3 隐秘数据设置

**访问路径**
点击“全局参数设置”-“隐秘数据设置”，打开“隐秘数据设置”界面

**功能描述**
对审计结果中的某些关键字段和敏感字段进行隐秘设置，防止二次泄密，这里设置之后，在审计结果中将会以加密星号（\*）显示。



#### 3.3.3 审计设置

**访问路径**
点击“全局参数设置”-“审计控制”，打开“审计控制”

**功能描述**
该模块是进行“全部审计”还是进行“按规则审计”，以及返回结果长度，对审计的结果进行过滤。

**两种审计状态**

* 全部审计：对所有的操作数据进行审计操作，并将所有操作数据进行保存； * 按审计规则：只有满足审计规则的数据才会被审计到。
 * 零告警通知：启用该功能后，每天早上10点（程序定义）发送一条告警短信到管理员手机中，让管理员知悉前一天的风险告警情况，有无告警系统都会发送。



#### 3.3.4 通知策略

**访问路径**
点击“全局参数设置”-“通知策略”，打开“添加”按钮

| 参数     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 风险等级 | 高危事件、中危事件、低危事件分别对应规则设置时的高、中、低   |
| 接收者   | 在“审计管理平台-系统管理-用户管理”中的用户，或者其它新增的用户 |
| 通知方式 | 邮件、syslog、SNMP、短信通知、短信平台                       |
| 审计对象 | 选择需要告警通知的审计对象，可多选                           |
| 状态     | 启用或者禁用                                                 |



#### 3.3.5 访问者信息配置

##### 3.3.5.1 进程配置

**访问路径**
点击“访问者信息配置”-“进程配置”，打开“进程配置”界面，添加进程集合。

**功能描述**
添加进程集合，进程集合名可以自定义，这里配置为“第三方工具”，然后点“客户端进程”的下拉选项，选择“plsqldev.exe”，最后点“添加”按钮。一个集合中可以添加多个进程。



##### 3.3.5.2 驱动级IP过滤

**访问路径**
点击“访问者信息配置”-“驱动级IP过滤”，打开“驱动级IP过滤”界面，设置源IP地址和目的IP地址。

**功能描述**
设置过滤某些IP后，将不对其IP产生的数据进行审计。



##### 3.3.5.3 IP监控

**访问路径**
点击“访问者信息配置”-“IP监控”，打开“IP监控”配置界面（应用到规则管理，在审计控制中选择按规则审计，就可以监控这个IP或IP段）

**功能描述**
这部分功能是设置相应的客户端IP集合，将一些IP加入某个集合中，在设置规则时可以针对该集合配置规则。

先添加应用服务器IP，选择“来访客户IP”，输入应用服务器的IP地址“192.168.10.207”，点“添加”，再点“保存”；继续添加上面需求中提到的IP网段，1.1.1.1-192.168.10.206，类型选择“来访客户网段”，把起始IP和终止IP输入后，点击添加，保存即可。

**来访客户IP：**客户端IP；

**来访客户地址段：**客户地址段，配置起始IP和终止IP



##### 3.3.5.4 规则生效时间

**访问路径**
点击“访问者信息配置”-“规则生效时间”，打开“添加”配置界面

**功能描述**
此功能是定义规则生效时间，可以定义某个时间段内，规则处于告警或者不告警的状态。



#### 3.3.6 对象设置

点击“对象配置”-“审计对象”，新建审计策略 点击对象设置-->审计对象，点击“添加”，输入需要被审计数据库服务器的相关信息，输入完成以后点击保存。



#### 3.3.7 规则配置

模块主要功能是规则管理和规则组管理。

##### 3.3.7.1 操作类型

**访问路径** 
点击“规则配置”-“操作类型”，打开“操作类型”界面（应用到规则管理）



##### 3.3.7.2 组合规则

**访问路径**
点击“规则配置”-“组合规则”，打开“组合规则”界面，此项是配置组合规则或统计规则。组合规则是根据几个规则在一定时间段内被触发是就会触发风险；统计规则是一定时间内一条规则达到触发的次数就会触发风险。



##### 3.3.7.3 规则管理

**访问路径**
点击“规则配置”-“规则管理”，打开“规则管理”界面
此功能是设置规则，包括风险的级别、何种操作类型以及针对的对象（操作系统主机名、子对象、客户端IP集、客户端进程集、关键字等）。

针对数据库的操作：各种操作语句，例select、insert、update等，在审计结果中触发对应的操作时，出现告警。

风险级别：高风险、中风险、低风险、关注行为、一般行为、高级白名单。
**规则属性内容**

| 参数             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 操作系统主机名   | 客户端的操作系统主机名                                       |
| 操作系统用户名   | 客户端的操作系统用户名                                       |
| 客户端MAC        | 客户端的网卡地址                                             |
| 子对象名         | 详细信息 查看子对象设置                                      |
| 进程集合名       | 详细信息 查看进程配置                                        |
| 客户端IP集       | 详细信息请参阅IP监控配置中的来访客户IP配置                   |
| 数据库账户       | 数据库服务器的账户                                           |
| 来访客户网络     | 详细信息请参阅IP监控配置中的来访客户网段的配置               |
| 最大操作语句长度 | 客户端的最大的操作语句长度，超过此值时，出现告警             |
| 语句执行回应     | 客户端操作数据库的SQL语句的执行回应，结果为成功或失败        |
| 返回内容         | 查询结果返回的行数大于该值时，将报警                         |
| 返回行数或阈值   | 设置一个返回结果的行数，当审计到的返回结果行数一致时出现报警 |
| 语句执行时间     | SQL语句中表的操作，当审计结果中执行时间大于该值时，出现告警  |
| 规则生效时间     | 详细信息请参阅规则生效时间配置                               |
| 关键字审计       | 关键字之间使用“&”                                            |



##### 3.3.7.4 白名单管理

**访问路径**

点击“规则配置”-“白名单管理”，打开“白名单管理”界面，

**功能描述**

功能是将某个IP、MAC地址、疑似风险经确认正常的操作语句等加入白名单，在以后的审计中将不做审计，这样可以方便管理员对真正的风险的处理，提高工作效率。手动添加或者在审计结果中右键添加。



##### 3.3.7.5 规则组管理

**访问路径**

点击“规则配置”-“规则组管理”，打开“规则组管理”界面。

**功能描述**

“规则组管理”是方便对规则的管理，可以将几个规则一起加入规则组，然后在“对象设置”-“审计对象”中加入该规则组，则规则启用。



##### 3.3.7.5 系统语句

**访问路径**

点击“规则配置”-“系统语句”，打开“系统语句”界面。

**功能描述**

“系统语句”是将确认正常的操作的sql语句标注为系统语句，在以后的审计中将不做审计，这样可以方便管理员对真正的风险的处理，提高工作效率。



### 3.4 审计管理平台

#### 3.4.1 登陆系统

打开web浏览器，在地址栏输入审计设备的管理IP地址或输入https://IP，IP为审计设备的IP地址，打开登陆界面。默认的审计管理员的用户名和密码为ruleadmin/\!1fw@2soc\#3vpn

<WRAP center round box 100%> 审计管理平台：auditadmin/!1fw@2soc#3vpn

规则管理平台：ruleadmin/!1fw@2soc#3vpn

系统管理平台：admin/!1fw@2soc#3vpn



#### 3.4.2 预览

预览界面分为三大块，左边为导航菜单，中间部分为本月风险级别分布，右下角部分为最近系统事件。点击对应的柱形图，对当天产生的风险数据进行详细查看。



#### 3.4.3 风险管理

**访问路径**

点击“风险管理”-“风险查询”，打开“风险查询”界面，在基本配置中，可以根据查询条件进行风险查询。

配置好查询条件，点击 “查询”，打开“查询结果”界面，查询结果会打开一个新的页面，选择一条结果，下方会显示详细的信息，包括客户端信息、服务器端信息、操作语句、回应信息等。选择一条记录，右键“事件分析”，弹出“事件分析”对话框，通过此对话框也可以查看。

同时可以将查询结果“导出word”、“导出excel”、“导出pdf”、文件导出。



#### 3.4.4 审计管理

此模块功能是进行日常的查询、结果的回放以及客户端进程的统计信息。



#### 3.4.5 报表管理

报表管理是对审计结果进行分类统计，并以图形和图标的方式展示给管理员，便于管理员查看；同时可以将报表“导出word”、“导出excel”、“导出pdf”。

##### 3.4.5.1 等级保护报表

以柱形图的方式将“数据库账户/访问次数”展示出来，并在下方显示详细的信息，包括数据库账户、数据库名、操作类型、结果、操作次数。



##### 3.4.5.2 用户登录注销报表

以柱形图的方式将“数据库账户/用户登录注销次数”展示出来，而在下方会显示数据库账户、访问者IP、数据库名、操作类型、结果、操作次数等详细信息。



##### 3.4.5.3 表对象访问情况报表

对某IP在一段时间内对数据库中哪些表进行了哪些操作，以及操作了多少次，以柱形图的形式展现出了。



##### 3.4.5.4 用户操作情况统计

使用某个数据库账户操作次数，详细信息以柱形图的形式展示出来。



##### 3.4.5.5 访问失败次数排行

对使用数据库账户访问数据库，并且是失败的情况进行汇总。



##### 3.4.5.6 用户访问情况统计

对于客户端（IP）访问数据库的次数进行统计分析。



##### 3.4.5.7 每天平均数据统计

对审计对象在当天访问数据库产生数据的级别和次数进行统计。



##### 3.4.5.8 月度风险统计报表

查询当月高风险数以及高风险占所有风险的比例和返回行数大于50以及所占的比例，并在报表中详细显示。



##### 3.4.5.9 自定义报表设置

用户可以根据自己需求，自定义字段，显示想要看到的报表。